<!DOCTYPE html>
<html lang="fr">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
 <link rel="manifest" href="/manifest.json">
 <meta name="apple-mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
 <meta name="apple-mobile-web-app-title" content="FIDDO">
 <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">
 <meta name="theme-color" content="#0891B2">
 <meta name="apple-mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
 <title>FIDDO â€” Mon compte fidÃ©litÃ©</title>
 <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
 <link rel="icon" href="/logo-fiddo.png">
 <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
 <script>
 function brandQR(container) {
   var old = container.querySelector('.qr-f-overlay');
   if (old) old.remove();
   var cs = window.getComputedStyle(container);
   if (cs.position === 'static') container.style.position = 'relative';
   var el = container.querySelector('canvas') || container.querySelector('img');
   var elSize = el ? el.width : 120;
   var oSize = Math.round(elSize * 0.22);
   var ov = document.createElement('div');
   ov.className = 'qr-f-overlay';
   ov.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:' + (oSize * 1.2) + 'px;height:' + (oSize * 1.2) + 'px;border-radius:50%;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 0 0 2px #fff;z-index:10;pointer-events:none;';
   var inner = document.createElement('div');
   inner.style.cssText = 'width:' + oSize + 'px;height:' + oSize + 'px;border-radius:50%;background:#0891B2;display:flex;align-items:center;justify-content:center;';
   var letter = document.createElement('span');
   letter.textContent = 'F';
   letter.style.cssText = 'color:#fff;font-size:' + Math.round(oSize * 0.65) + 'px;font-weight:800;font-family:-apple-system,BlinkMacSystemFont,sans-serif;line-height:1;';
   inner.appendChild(letter);
   ov.appendChild(inner);
   container.appendChild(ov);
 }
 </script>
 <style>
 * { margin: 0; padding: 0; box-sizing: border-box; }

 :root {
 --bg: #0F172A;
 --surface: #1E293B;
 --surface2: #334155;
 --text: #F1F5F9;
 --muted: #94A3B8;
 --accent: #0891B2;
 --accent-dark: #0E7490;
 --accent-glow: rgba(8,145,178,0.15);
 }

 body {
 font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
 background: var(--bg);
 color: var(--text);
 min-height: 100vh;
 min-height: 100dvh;
 }

 /* â”€â”€ Header â”€â”€ */
 .header {
 padding: 2rem 1.5rem 1rem;
 text-align: center;
 }
 .header .brand {
 font-size: 1.3rem;
 font-weight: 800;
 color: var(--accent);
 letter-spacing: -0.5px;
 }
 .header .subtitle {
 font-size: 0.75rem;
 color: var(--muted);
 margin-top: 2px;
 }

 /* â”€â”€ Main â”€â”€ */
 .main {
 max-width: 440px;
 margin: 0 auto;
 padding: 0 1.25rem 2rem;
 }

 /* â”€â”€ Card â”€â”€ */
 .card {
 background: var(--surface);
 border-radius: 16px;
 padding: 1.5rem;
 border: 1px solid rgba(255,255,255,0.06);
 }

 /* â”€â”€ Form â”€â”€ */
 .form-label {
 display: block;
 font-size: 0.72rem;
 font-weight: 700;
 color: var(--muted);
 text-transform: uppercase;
 letter-spacing: 0.5px;
 margin-bottom: 6px;
 }
 .form-input {
 width: 100%;
 padding: 14px 16px;
 background: var(--surface2);
 border: 2px solid transparent;
 border-radius: 12px;
 font-size: 1rem;
 font-family: inherit;
 color: var(--text);
 transition: all 0.25s;
 }
 .form-input:focus {
 outline: none;
 border-color: var(--accent);
 box-shadow: 0 0 0 4px var(--accent-glow);
 }
 .form-input::placeholder { color: #475569; }

 /* â”€â”€ Button â”€â”€ */
 .btn {
 display: block;
 width: 100%;
 padding: 15px;
 border: none;
 border-radius: 12px;
 font-size: 1rem;
 font-weight: 700;
 font-family: inherit;
 cursor: pointer;
 transition: all 0.25s;
 }
 .btn-accent {
 background: linear-gradient(135deg, var(--accent), var(--accent-dark));
 color: white;
 }
 .btn-accent:hover { transform: translateY(-1px); box-shadow: 0 6px 20px var(--accent-glow); }
 .btn-accent:disabled { opacity: 0.5; transform: none; cursor: not-allowed; }
 .btn-ghost {
 background: none;
 border: 1px solid var(--surface2);
 color: var(--muted);
 font-size: 0.85rem;
 padding: 11px;
 }
 .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }

 /* â”€â”€ Alert â”€â”€ */
 .alert {
 padding: 0.7rem 0.9rem;
 border-radius: 10px;
 font-size: 0.85rem;
 margin-bottom: 0.75rem;
 animation: fadeIn 0.3s ease;
 }
 .alert-error { background: rgba(220,38,38,0.12); color: #FCA5A5; border: 1px solid rgba(220,38,38,0.2); }
 .alert-success { background: rgba(16,185,129,0.12); color: #6EE7B7; border: 1px solid rgba(16,185,129,0.2); }

 @keyframes fadeIn { from { opacity: 0; transform: translateY(-6px); } }

 /* â”€â”€ Screens â”€â”€ */
 .screen { display: none; }
 .screen.active { display: block; }

 /* â”€â”€ Spinner â”€â”€ */
 .spinner {
 width: 36px; height: 36px;
 border: 3px solid var(--surface2);
 border-top-color: var(--accent);
 border-radius: 50%;
 animation: spin 0.7s linear infinite;
 margin: 3rem auto;
 }
 @keyframes spin { to { transform: rotate(360deg); } }

 /* â”€â”€ Login page â”€â”€ */
 .login-icon {
 width: 56px; height: 56px;
 background: var(--accent-glow);
 border-radius: 14px;
 display: flex;
 align-items: center;
 justify-content: center;
 font-size: 1.5rem;
 margin: 0 auto 1rem;
 }
 .login-title {
 font-size: 1.15rem;
 font-weight: 700;
 text-align: center;
 margin-bottom: 0.25rem;
 }
 .login-sub {
 font-size: 0.82rem;
 color: var(--muted);
 text-align: center;
 margin-bottom: 1.25rem;
 }

 /* â”€â”€ Email sent â”€â”€ */
 .sent-icon {
 width: 64px; height: 64px;
 background: rgba(16,185,129,0.12);
 border-radius: 50%;
 display: flex;
 align-items: center;
 justify-content: center;
 font-size: 1.8rem;
 margin: 0 auto 1rem;
 }

 /* â”€â”€ Dashboard â”€â”€ */
 .dash-greeting {
 font-size: 1.25rem;
 font-weight: 700;
 margin-bottom: 0.25rem;
 }
 .dash-sub {
 font-size: 0.8rem;
 color: var(--muted);
 margin-bottom: 1.25rem;
 }

 /* â”€â”€ Loyalty card â”€â”€ */
 .loyalty-card {
 background: var(--surface);
 border: 1px solid rgba(255,255,255,0.06);
 border-radius: 16px;
 overflow: hidden;
 margin-bottom: 0.75rem;
 transition: transform 0.2s;
 }
 .loyalty-card:active { transform: scale(0.98); }

 .lc-header {
 padding: 1rem 1.25rem 0.75rem;
 display: flex;
 justify-content: space-between;
 align-items: flex-start;
 }
 .lc-merchant { font-size: 1rem; font-weight: 700; }
 .lc-visits { font-size: 0.7rem; color: var(--muted); }

 .lc-body { padding: 0 1.25rem; }

 .lc-points {
 font-size: 2.2rem;
 font-weight: 800;
 color: var(--accent);
 line-height: 1;
 }
 .lc-points-label {
 font-size: 0.72rem;
 color: var(--muted);
 margin-top: 2px;
 }

 .lc-progress {
 margin: 0.75rem 0 0.5rem;
 }
 .lc-bar {
 height: 6px;
 background: var(--surface2);
 border-radius: 3px;
 overflow: hidden;
 }
 .lc-fill {
 height: 100%;
 border-radius: 3px;
 background: linear-gradient(90deg, var(--accent), var(--accent-dark));
 transition: width 0.6s ease;
 }
 .lc-progress-text {
 display: flex;
 justify-content: space-between;
 font-size: 0.68rem;
 color: var(--muted);
 margin-top: 3px;
 }

 .lc-reward {
 background: rgba(16,185,129,0.1);
 border-top: 1px solid rgba(16,185,129,0.15);
 padding: 0.65rem 1.25rem;
 font-size: 0.8rem;
 color: #6EE7B7;
 font-weight: 600;
 }

 .lc-footer {
 padding: 0.65rem 1.25rem;
 border-top: 1px solid rgba(255,255,255,0.04);
 display: flex;
 justify-content: space-between;
 align-items: center;
 }
 .lc-reward-desc {
 font-size: 0.72rem;
 color: var(--muted);
 flex: 1;
 }

 /* â”€â”€ QR Button â”€â”€ */
 .btn-qr {
 display: flex;
 align-items: center;
 gap: 6px;
 background: var(--accent-glow);
 border: 1px solid rgba(8,145,178,0.25);
 color: var(--accent);
 padding: 7px 14px;
 border-radius: 10px;
 font-size: 0.78rem;
 font-weight: 700;
 font-family: inherit;
 cursor: pointer;
 transition: all 0.2s;
 white-space: nowrap;
 }
 .btn-qr:hover { background: rgba(8,145,178,0.25); }

 /* â”€â”€ QR Fullscreen â”€â”€ */
 .qr-overlay {
 display: none;
 position: fixed;
 inset: 0;
 z-index: 9999;
 background: #FFFFFF;
 flex-direction: column;
 align-items: center;
 justify-content: center;
 cursor: pointer;
 }
 .qr-overlay.open { display: flex; }
 .qr-overlay .qr-name {
 font-size: 1.15rem;
 font-weight: 700;
 color: #1E293B;
 margin-bottom: 0.25rem;
 }
 .qr-overlay .qr-hint {
 font-size: 0.8rem;
 color: #64748B;
 margin-bottom: 1.5rem;
 }
 .qr-overlay .qr-box {
 padding: 20px;
 background: white;
 border-radius: 16px;
 box-shadow: 0 4px 30px rgba(0,0,0,0.08);
 }
 .qr-overlay .qr-close {
 margin-top: 2rem;
 font-size: 0.75rem;
 color: #94A3B8;
 }

 /* â”€â”€ Empty state â”€â”€ */
 .empty-state {
 text-align: center;
 padding: 2.5rem 1rem;
 }
 .empty-state .icon { font-size: 2.5rem; margin-bottom: 0.75rem; }
 .empty-state h3 { font-size: 1rem; margin-bottom: 0.3rem; }
 .empty-state p { font-size: 0.82rem; color: var(--muted); }

 /* â”€â”€ Footer â”€â”€ */
 .footer {
 text-align: center;
 padding: 1rem;
 font-size: 0.68rem;
 color: #475569;
 }

 /* â”€â”€ Theme overrides for cards â”€â”€ */
 [data-card-theme="navy"] .lc-points, [data-card-theme="navy"] .btn-qr { color: #1E40AF; }
 [data-card-theme="navy"] .lc-fill { background: linear-gradient(90deg, #1E40AF, #1E3A8A); }
 [data-card-theme="violet"] .lc-points, [data-card-theme="violet"] .btn-qr { color: #7C3AED; }
 [data-card-theme="violet"] .lc-fill { background: linear-gradient(90deg, #7C3AED, #6D28D9); }
 [data-card-theme="forest"] .lc-points, [data-card-theme="forest"] .btn-qr { color: #059669; }
 [data-card-theme="forest"] .lc-fill { background: linear-gradient(90deg, #059669, #047857); }
 [data-card-theme="brick"] .lc-points, [data-card-theme="brick"] .btn-qr { color: #DC2626; }
 [data-card-theme="brick"] .lc-fill { background: linear-gradient(90deg, #DC2626, #B91C1C); }
 [data-card-theme="amber"] .lc-points, [data-card-theme="amber"] .btn-qr { color: #D97706; }
 [data-card-theme="amber"] .lc-fill { background: linear-gradient(90deg, #D97706, #B45309); }
 [data-card-theme="slate"] .lc-points, [data-card-theme="slate"] .btn-qr { color: #475569; }
 [data-card-theme="slate"] .lc-fill { background: linear-gradient(90deg, #475569, #334155); }

 /* â•â•â• RESPONSIVE â•â•â• */
 @media (max-width: 480px) {
 .header { padding: 1.25rem 1rem 0.75rem; }
 .header .brand { font-size: 1.1rem; }
 .main { padding: 0 0.75rem 1.5rem; }
 .card { padding: 1.25rem; border-radius: 14px; }
 .lc-header { padding: 0.85rem 1rem 0.6rem; }
 .lc-body { padding: 0 1rem; }
 .lc-footer { padding: 0.6rem 1rem 0.85rem; }
 .lc-points { font-size: 1.9rem; }
 .lc-merchant { font-size: 0.92rem; }
 .btn { min-height: 48px; padding: 14px; }
 .btn-qr { min-height: 40px; }
 .form-input { padding: 13px 14px; }
 .dash-greeting { font-size: 1.1rem; }
 }
 </style>
</head>
<body>

 <div class="header">
 <div class="brand">FIDDO</div>
 <div class="subtitle">Mon compte fidÃ©litÃ©</div>
 </div>

 <div class="main">

 <!-- LOADING -->
 <div id="screen-loading" class="screen active">
 <div class="spinner"></div>
 </div>

 <!-- LOGIN -->
 <div id="screen-login" class="screen">
 <div class="card">
 <div class="login-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg></div>
 <div class="login-title">Connexion</div>
 <div class="login-sub">Recevez un lien de connexion par email</div>

 <div id="login-alert"></div>

 <div style="margin-bottom:1rem;">
 <label class="form-label">Adresse email</label>
 <input type="email" id="login-email" class="form-input" placeholder="votre@email.com" autocomplete="email" inputmode="email">
 </div>

 <button class="btn btn-accent" id="btn-login" onclick="doLogin()">Recevoir le lien</button>
 </div>
 </div>

 <!-- EMAIL SENT -->
 <div id="screen-sent" class="screen">
 <div class="card" style="text-align:center;">
 <div class="sent-icon"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></div>
 <h2 style="font-size:1.1rem; margin-bottom:0.5rem;">Email envoyÃ© !</h2>
 <p style="font-size:0.85rem; color:var(--muted); line-height:1.5;">
 VÃ©rifiez votre boÃ®te de rÃ©ception et cliquez sur le lien pour vous connecter.
 </p>
 <p style="font-size:0.75rem; color:#475569; margin-top:1rem;">
 Le lien est valable 15 minutes.
 </p>
 <button class="btn btn-ghost" onclick="showScreen('screen-login')" style="margin-top:1rem;">â† Renvoyer un lien</button>
 </div>
 </div>

 <!-- VERIFYING -->
 <div id="screen-verifying" class="screen">
 <div class="card" style="text-align:center; padding:2rem;">
 <div class="spinner" style="margin-bottom:1rem;"></div>
 <p style="color:var(--muted); font-size:0.85rem;">VÃ©rification en coursâ€¦</p>
 </div>
 </div>

 <!-- VERIFY ERROR -->
 <div id="screen-verify-error" class="screen">
 <div class="card" style="text-align:center;">
 <div style="margin-bottom:0.75rem;"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M16 16s-1.5-2-4-2-4 2-4 2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></div>
 <h2 style="font-size:1.1rem; margin-bottom:0.5rem;" id="verify-error-title">Lien expirÃ©</h2>
 <p style="font-size:0.85rem; color:var(--muted);" id="verify-error-msg">Demandez un nouveau lien de connexion.</p>
 <button class="btn btn-accent" onclick="showScreen('screen-login')" style="margin-top:1rem;">RÃ©essayer</button>
 </div>
 </div>

 <!-- DASHBOARD -->
 <div id="screen-dashboard" class="screen">
 <div class="dash-greeting" id="dash-greeting">Bonjour !</div>
 <div class="dash-sub" id="dash-sub">Vos cartes de fidÃ©litÃ©</div>

 <div id="cards-list"></div>

 <!-- PIN Management -->
 <div class="card" style="margin-top:1rem; padding:1rem 1.25rem;">
 <div style="font-weight:600; font-size:0.85rem; margin-bottom:0.5rem;">
 <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:14px;height:14px;vertical-align:-2px;margin-right:4px;"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
 Code PIN
 </div>
 <div id="pin-status" style="font-size:0.78rem; color:var(--muted); margin-bottom:0.75rem;"></div>
 <div id="pin-form">
 <div id="pin-current-group" style="display:none; margin-bottom:0.5rem;">
 <input type="tel" id="pin-current" class="form-input" placeholder="PIN actuel" maxlength="4" pattern="\d{4}" inputmode="numeric" autocomplete="off" style="text-align:center; font-size:1.1rem; letter-spacing:0.4rem; font-weight:700;">
 </div>
 <div style="margin-bottom:0.5rem;">
 <input type="tel" id="pin-new" class="form-input" placeholder="Nouveau PIN (4 chiffres)" maxlength="4" pattern="\d{4}" inputmode="numeric" autocomplete="off" style="text-align:center; font-size:1.1rem; letter-spacing:0.4rem; font-weight:700;">
 </div>
 <div id="pin-alert" style="font-size:0.75rem; margin-bottom:0.5rem;"></div>
 <button class="btn btn-accent" onclick="savePin()" style="width:100%; padding:0.5rem;" id="pin-save-btn">Enregistrer</button>
 </div>
 </div>

 <button class="btn btn-ghost" onclick="doLogout()" style="margin-top:1rem;">DÃ©connexion</button>
 </div>

 </div>

 <div class="footer">PropulsÃ© par FIDDO</div>

 <!-- QR Fullscreen Overlay -->
 <div class="qr-overlay" id="qr-overlay" onclick="closeQR()">
 <div class="qr-name" id="qr-client-name"></div>
 <div class="qr-hint">Montrez ce QR au commerce</div>
 <div class="qr-box" id="qr-canvas-wrap"></div>
 <div class="qr-close">Appuyez pour fermer</div>
 </div>

 <script>
 // XSS protection helper
 function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 // CONFIG
 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

 const API = window.location.hostname === 'localhost'
 ? 'http://localhost:3000/api/me' : '/api/me';

 let clientToken = null;
 let clientData = null;

 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 // INIT
 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

 (async function init() {
 const path = window.location.pathname;

 // Magic link verification: /me/verify/:token
 if (path.startsWith('/me/verify/')) {
 const token = path.split('/me/verify/')[1];
 if (token) {
 await verifyMagicLink(token);
 return;
 }
 }

 // Hash-based verify fallback (from app-redirect page): /me#verify=TOKEN
 const hash = window.location.hash;
 if (hash.startsWith('#verify=')) {
 const token = decodeURIComponent(hash.substring(8));
 if (token) {
 window.location.hash = '';
 await verifyMagicLink(token);
 return;
 }
 }

 // Check saved session
 const saved = localStorage.getItem('fiddo_me_token');
 if (saved) {
 clientToken = saved;
 const ok = await loadCards();
 if (ok) {
 showDashboard();
 return;
 }
 localStorage.removeItem('fiddo_me_token');
 }

 showScreen('screen-login');
 setTimeout(() => document.getElementById('login-email').focus(), 300);
 })();

 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 // SCREENS
 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

 function showScreen(id) {
 document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
 document.getElementById(id).classList.add('active');
 }

 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 // LOGIN
 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

 async function doLogin() {
 const email = document.getElementById('login-email').value.trim();
 if (!email) {
 showLoginAlert('Saisissez votre adresse email', 'error');
 return;
 }

 const btn = document.getElementById('btn-login');
 btn.disabled = true;
 btn.textContent = 'Envoiâ€¦';

 try {
 const resp = await fetch(`${API}/login`, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({ email }),
 });

 const data = await resp.json();

 if (!resp.ok) {
 showLoginAlert(data.error || 'Erreur', 'error');
 btn.disabled = false;
 btn.textContent = 'Recevoir le lien';
 return;
 }

 showScreen('screen-sent');
 } catch (e) {
 showLoginAlert('Erreur rÃ©seau. RÃ©essayez.', 'error');
 }

 btn.disabled = false;
 btn.textContent = 'Recevoir le lien';
 }

 function showLoginAlert(msg, type) {
 document.getElementById('login-alert').innerHTML =
 `<div class="alert alert-${type}">${esc(msg)}</div>`;
 }

 // Enter key
 document.addEventListener('keydown', (e) => {
 if (e.key === 'Enter' && document.getElementById('screen-login').classList.contains('active')) {
 e.preventDefault();
 doLogin();
 }
 });

 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 // MAGIC LINK VERIFY
 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

 async function verifyMagicLink(token) {
 showScreen('screen-verifying');

 try {
 const resp = await fetch(`${API}/verify`, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({ token }),
 });

 const data = await resp.json();

 if (!resp.ok) {
 document.getElementById('verify-error-title').textContent =
 resp.status === 401 ? 'Lien expirÃ©' : 'Erreur';
 document.getElementById('verify-error-msg').textContent =
 data.error || 'Demandez un nouveau lien de connexion.';
 showScreen('screen-verify-error');
 return;
 }

 // Success â€” save token and show dashboard
 clientToken = data.token;
 localStorage.setItem('fiddo_me_token', clientToken);

 // Clean URL
 window.history.replaceState({}, '', '/me');

 await loadCards();
 showDashboard();

 } catch (e) {
 document.getElementById('verify-error-msg').textContent = 'Erreur rÃ©seau. RÃ©essayez.';
 showScreen('screen-verify-error');
 }
 }

 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 // DASHBOARD
 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

 async function loadCards() {
 try {
 const resp = await fetch(`${API}/cards`, {
 headers: { 'Authorization': 'Bearer ' + clientToken },
 });
 if (!resp.ok) return false;

 clientData = await resp.json();
 return true;
 } catch (e) {
 return false;
 }
 }

 function showDashboard() {
 const c = clientData.client;
 const greeting = c.name ? c.name : (c.email || 'Bonjour');
 document.getElementById('dash-greeting').textContent = 'Bonjour ' + greeting + ' !';

 const n = clientData.cards.length;
 document.getElementById('dash-sub').textContent =
 n === 0 ? 'Aucune carte de fidÃ©litÃ© pour le moment'
 : n === 1 ? '1 carte de fidÃ©litÃ©'
 : n + ' cartes de fidÃ©litÃ©';

 // PIN status
 if (c.hasPin) {
 document.getElementById('pin-status').textContent = 'Votre code PIN est actif. Vous pouvez le modifier ci-dessous.';
 document.getElementById('pin-current-group').style.display = '';
 document.getElementById('pin-new').placeholder = 'Nouveau PIN (4 chiffres)';
 } else {
 document.getElementById('pin-status').innerHTML = '<span style="color:#F59E0B;">Aucun code PIN dÃ©fini.</span> CrÃ©ez-en un pour protÃ©ger vos rÃ©compenses.';
 document.getElementById('pin-current-group').style.display = 'none';
 document.getElementById('pin-new').placeholder = 'Choisissez un PIN (4 chiffres)';
 }

 renderCards();
 showScreen('screen-dashboard');
 }

 async function savePin() {
 const btn = document.getElementById('pin-save-btn');
 const alert = document.getElementById('pin-alert');
 const currentPin = document.getElementById('pin-current').value.trim();
 const newPin = document.getElementById('pin-new').value.trim();

 alert.innerHTML = '';

 if (!/^\d{4}$/.test(newPin)) {
 alert.innerHTML = '<span style="color:#EF4444;">Le PIN doit contenir 4 chiffres</span>';
 return;
 }

 if (clientData.client.hasPin && !currentPin) {
 alert.innerHTML = '<span style="color:#EF4444;">Saisissez votre PIN actuel</span>';
 return;
 }

 btn.disabled = true;
 btn.textContent = 'Enregistrementâ€¦';

 try {
 const resp = await fetch(`${API}/pin`, {
 method: 'POST',
 headers: { 'Authorization': 'Bearer ' + clientToken, 'Content-Type': 'application/json' },
 body: JSON.stringify({ currentPin: currentPin || undefined, newPin }),
 });
 const data = await resp.json();

 if (!resp.ok) {
 alert.innerHTML = '<span style="color:#EF4444;">' + esc(data.error) + '</span>';
 return;
 }

 alert.innerHTML = '<span style="color:#10B981;"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg> Code PIN mis Ã  jour</span>';
 clientData.client.hasPin = true;
 document.getElementById('pin-current-group').style.display = '';
 document.getElementById('pin-current').value = '';
 document.getElementById('pin-new').value = '';
 } catch (e) {
 alert.innerHTML = '<span style="color:#EF4444;">Erreur rÃ©seau</span>';
 } finally {
 btn.disabled = false;
 btn.textContent = 'Enregistrer';
 }
 }

 function renderCards() {
 const el = document.getElementById('cards-list');

 if (!clientData.cards.length) {
 el.innerHTML = '<div class="empty-state"><div class="icon">ğŸƒ</div>' +
 '<h3>Pas encore de carte</h3>' +
 '<p>Vos cartes de fidÃ©litÃ© apparaÃ®tront ici aprÃ¨s votre premiÃ¨re visite.</p></div>';
 return;
 }

 let html = '';
 clientData.cards.forEach(card => {
 const remaining = card.pointsForReward - card.pointsBalance;
 const lastVisit = card.lastVisit
 ? new Date(card.lastVisit).toLocaleDateString('fr-BE', { day: 'numeric', month: 'short' })
 : 'â€”';

 html += `<div class="loyalty-card" data-card-theme="${esc(card.theme)}">
 <div class="lc-header">
 <div>
 <div class="lc-merchant">${esc(card.merchantName)}</div>
 <div class="lc-visits">${card.visitCount} visite(s) Â· DerniÃ¨re : ${lastVisit}</div>
 </div>
 <button class="btn-qr" onclick="showQR('${card.merchantName.replace(/'/g, "\\'")}')">
 â¬¡ QR
 </button>
 </div>
 <div class="lc-body">
 <div class="lc-points">${card.pointsBalance}</div>
 <div class="lc-points-label">points</div>
 <div class="lc-progress">
 <div class="lc-bar"><div class="lc-fill" style="width:${card.progress}%"></div></div>
 <div class="lc-progress-text">
 <span>${card.pointsBalance} / ${card.pointsForReward}</span>
 <span>${remaining > 0 ? 'Encore ' + remaining + ' pts' : 'RÃ©compense !'}</span>
 </div>
 </div>
 </div>
 ${card.canRedeem
 ? '<div class="lc-reward"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg> ' + esc(card.rewardDescription) + ' â€” Disponible !</div>'
 : '<div class="lc-footer"><div class="lc-reward-desc"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg> ' + esc(card.rewardDescription) + '</div></div>'
 }
 </div>`;
 });

 el.innerHTML = html;
 }

 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 // QR CODE DISPLAY
 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

 function showQR(merchantName) {
 if (!clientData?.client?.qrToken) return;

 const baseUrl = window.location.origin;
 const qrUrl = baseUrl + '/c/' + clientData.client.qrToken;

 document.getElementById('qr-client-name').textContent =
 clientData.client.name || clientData.client.email || '';

 const canvas = document.getElementById('qr-canvas-wrap');
 canvas.innerHTML = '';
 new QRCode(canvas, {
 text: qrUrl,
 width: 240,
 height: 240,
 colorDark: '#1E293B',
 colorLight: '#FFFFFF',
 correctLevel: QRCode.CorrectLevel.H,
 });
 brandQR(canvas);

 document.getElementById('qr-overlay').classList.add('open');
 }

 function closeQR() {
 document.getElementById('qr-overlay').classList.remove('open');
 }

 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 // LOGOUT
 // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

 function doLogout() {
 localStorage.removeItem('fiddo_me_token');
 clientToken = null;
 clientData = null;
 document.getElementById('login-email').value = '';
 document.getElementById('login-alert').innerHTML = '';
 showScreen('screen-login');
 }
 </script>
<script>if("serviceWorker"in navigator)navigator.serviceWorker.register("/sw.js").catch(()=>{});</script>
</body>
</html>
