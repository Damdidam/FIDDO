<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clients â€” FIDDO</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    /* â”€â”€ Toolbar â”€â”€ */
    .toolbar { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; margin-bottom: 0.75rem; }
    .toolbar-left { display: flex; gap: 0.5rem; flex: 1; min-width: 200px; flex-wrap: wrap; align-items: center; }
    .toolbar-right { display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }

    .search-compact { flex: 1; min-width: 180px; padding: 8px 10px 8px 32px; border: 2px solid var(--border); border-radius: 6px; font-size: 0.85rem; }
    .search-compact:focus { outline: none; border-color: var(--primary); }
    .search-wrap { position: relative; flex: 1; min-width: 180px; }
    .search-wrap .search-ico { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-size: 0.8rem; }

    /* Date pills */
    .date-pills { display: flex; gap: 4px; flex-wrap: wrap; }
    .date-pill { padding: 4px 10px; border: 1px solid var(--border); border-radius: 20px; font-size: 0.75rem; cursor: pointer; background: white; color: var(--text-light); transition: all 0.15s; white-space: nowrap; }
    .date-pill:hover { border-color: var(--primary); color: var(--primary); }
    .date-pill.active { background: var(--primary); color: white; border-color: var(--primary); }
    .date-range { display: none; gap: 4px; align-items: center; }
    .date-range.show { display: flex; }
    .date-input { padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.75rem; width: 120px; -webkit-appearance: none; }

    /* â”€â”€ Tabs â”€â”€ */
    .client-tabs { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 0.75rem; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none; }
    .client-tabs::-webkit-scrollbar { display: none; }
    .client-tab { padding: 8px 14px; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; font-weight: 500; color: var(--text-light); font-size: 0.85rem; transition: all 0.2s; background: none; border-top: none; border-left: none; border-right: none; white-space: nowrap; }
    .client-tab:hover { color: var(--text); }
    .client-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

    /* â”€â”€ Sortable table â”€â”€ */
    .clients-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .clients-table thead { background: var(--secondary); color: white; }
    .clients-table th { padding: 8px 10px; text-align: left; font-weight: 600; font-size: 0.73rem; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; user-select: none; white-space: nowrap; }
    .clients-table th:hover { background: #374151; }
    .clients-table th .sort-arrow { margin-left: 4px; font-size: 0.65rem; opacity: 0.5; }
    .clients-table th.sorted .sort-arrow { opacity: 1; }
    .clients-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
    .clients-table tbody tr { cursor: pointer; transition: background 0.1s; }
    .clients-table tbody tr:hover { background: #f0fdf4; }
    .table-scroll { overflow-x: auto; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); background: white; scrollbar-width: thin; }
    .table-scroll::-webkit-scrollbar { height: 4px; }
    .table-scroll::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }

    /* Rank */
    .rank { font-weight: 700; color: var(--text-light); text-align: center; min-width: 30px; }
    .rank-1 { color: #F59E0B; } .rank-2 { color: #9CA3AF; } .rank-3 { color: #D97706; }

    /* Points bar mini */
    .pts-bar { display: flex; align-items: center; gap: 6px; }
    .pts-bar-track { width: 40px; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; }
    .pts-bar-fill { height: 100%; background: var(--primary); border-radius: 2px; min-width: 2px; }
    .staff-sm { font-size: 0.75rem; color: var(--text-light); }
    .tab-count { font-size: 0.7rem; background: var(--light); color: var(--text-light); padding: 1px 6px; border-radius: 8px; margin-left: 4px; }

    /* â”€â”€ Modal redesign V2 â”€â”€ */
    .modal-section { margin-bottom: 1rem; }
    .modal-section-title { font-size: 0.78rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.4rem; }

    /* Hero header */
    .client-hero {
      background: linear-gradient(135deg, var(--secondary) 0%, #374151 100%);
      padding: 1.5rem;
      color: white;
      position: relative;
      border-radius: 12px 12px 0 0;
    }
    .client-hero-close { position: absolute; top: 12px; right: 16px; background: rgba(255,255,255,0.15); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
    .client-hero-close:hover { background: rgba(255,255,255,0.3); }
    .client-hero-name { font-size: 1.3rem; font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .client-hero-sub { font-size: 0.82rem; opacity: 0.7; }
    .client-hero-badges { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
    .hero-badge { padding: 3px 10px; border-radius: 20px; font-size: 0.68rem; font-weight: 600; letter-spacing: 0.3px; }
    .hero-badge-custom { background: rgba(8,145,178,0.25); color: #67e8f9; }
    .hero-badge-blocked { background: rgba(239,68,68,0.25); color: #fca5a5; }
    .hero-badge-validated { background: rgba(16,185,129,0.25); color: #6ee7b7; }

    /* Stats row */
    .client-stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      margin: -20px 1.25rem 0;
      position: relative;
      z-index: 2;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .client-stat {
      text-align: center;
      padding: 14px 8px;
    }
    .client-stat:not(:last-child) { border-right: 1px solid var(--border); }
    .client-stat-val { font-size: 1.4rem; font-weight: 800; color: var(--primary); line-height: 1; }
    .client-stat-label { font-size: 0.68rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

    /* Reward card */
    .reward-card {
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 16px;
      position: relative;
    }
    .reward-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .reward-card-label { font-size: 0.72rem; font-weight: 600; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.5px; }
    .reward-card-name { font-size: 0.95rem; font-weight: 600; color: var(--text); }
    .reward-card-edit { background: none; border: 1px solid var(--border); border-radius: 6px; padding: 4px 10px; font-size: 0.72rem; cursor: pointer; color: var(--text-light); transition: all 0.15s; }
    .reward-card-edit:hover { border-color: var(--primary); color: var(--primary); }
    .reward-progress { margin-top: 10px; }
    .reward-progress-bar { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
    .reward-progress-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
    .reward-progress-fill.near { background: linear-gradient(90deg, var(--primary), #06b6d4); }
    .reward-progress-fill.ready { background: linear-gradient(90deg, var(--success), #34d399); }
    .reward-progress-text { display: flex; justify-content: space-between; font-size: 0.72rem; color: var(--text-light); margin-top: 4px; }
    .reward-ready-banner {
      background: linear-gradient(135deg, var(--success), #059669);
      color: white;
      padding: 10px 14px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 0.85rem;
      font-weight: 600;
      text-align: center;
      animation: pulse-glow 2s ease-in-out infinite;
    }
    @keyframes pulse-glow { 0%,100% { box-shadow: 0 0 0 0 rgba(16,185,129,0.3); } 50% { box-shadow: 0 0 12px 4px rgba(16,185,129,0.15); } }
    .reward-edit-area { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }

    /* Action toolbar */
    .action-toolbar {
      display: flex;
      gap: 3px;
      flex-wrap: nowrap;
      padding: 10px 0;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }
    .action-btn {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 5px 8px;
      border: none;
      border-radius: 5px;
      font-size: 0.7rem;
      font-weight: 500;
      cursor: pointer;
      background: #f3f4f6;
      color: var(--text);
      transition: all 0.15s;
      text-decoration: none;
      white-space: nowrap;
    }
    .action-btn:hover { background: #e5e7eb; }
    .action-btn.danger { color: var(--danger); }
    .action-btn.danger:hover { background: #fef2f2; }
    .action-btn.success { color: var(--success); }
    .action-btn.success:hover { background: #f0fdf4; }

    /* Expandable sections */
    .expand-section { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    .expand-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px; cursor: pointer; background: #fafafa;
      font-size: 0.82rem; font-weight: 600; color: var(--text);
      user-select: none; transition: background 0.15s;
    }
    .expand-header:hover { background: #f3f4f6; }
    .expand-arrow { transition: transform 0.2s; font-size: 0.7rem; color: var(--text-light); }
    .expand-section.open .expand-arrow { transform: rotate(90deg); }
    .expand-body { display: none; padding: 12px 14px; border-top: 1px solid var(--border); max-height: 350px; overflow-y: auto; }
    .expand-section.open .expand-body { display: block; }

    /* Notes */
    .notes-area { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.85rem; font-family: inherit; resize: vertical; min-height: 56px; max-height: 120px; }
    .notes-area:focus { outline: none; border-color: var(--primary); }
    .notes-meta { font-size: 0.7rem; color: var(--text-light); text-align: right; margin-top: 4px; }

    /* Timeline V2 */
    .tx-list { display: flex; flex-direction: column; gap: 0; }
    .tx-item {
      display: flex; gap: 12px; align-items: flex-start;
      padding: 10px 0;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.83rem;
    }
    .tx-item:last-child { border-bottom: none; }
    .tx-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 6px; flex-shrink: 0; }
    .tx-dot.credit { background: var(--primary); }
    .tx-dot.reward { background: var(--success); }
    .tx-dot.adjustment { background: var(--warning); }
    .tx-dot.merge { background: #8b5cf6; }
    .tx-body { flex: 1; }
    .tx-top { display: flex; justify-content: space-between; align-items: baseline; }
    .tx-amount { font-weight: 700; }
    .tx-date { font-size: 0.72rem; color: var(--text-light); }
    .tx-detail { font-size: 0.75rem; color: var(--text-light); margin-top: 2px; }

    /* Custom reward indicator in list */
    .cr-star { color: #f59e0b; font-size: 0.7rem; margin-left: 2px; }

    /* Edit form compact */
    .edit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
    .edit-grid .form-group { margin-bottom: 0; }
    .edit-grid .form-label { font-size: 0.75rem; margin-bottom: 2px; }
    .edit-grid .form-control { padding: 6px 10px; font-size: 0.85rem; }
    .edit-grid .full-width { grid-column: 1 / -1; }

    /* Merge search */
    .merge-search-wrap { position: relative; }
    .merge-results { position: absolute; top: 100%; left: 0; right: 0; z-index: 50; background: white; border: 2px solid var(--primary); border-top: none; border-radius: 0 0 8px 8px; max-height: 160px; overflow-y: auto; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .merge-results.open { display: block; }
    .merge-item { padding: 8px 10px; cursor: pointer; font-size: 0.83rem; border-bottom: 1px solid var(--border); }
    .merge-item:hover { background: #ECFEFF; }
    .merge-item .m-name { font-weight: 600; }
    .merge-item .m-detail { font-size: 0.72rem; color: var(--text-light); }
    .merge-selected { background: #F0FDF4; border: 2px solid var(--success); border-radius: 8px; padding: 8px 10px; font-size: 0.83rem; display: none; justify-content: space-between; align-items: center; }
    .merge-selected.show { display: flex; }

    /* Contact links */


    /* Mobile */
    @media (max-width: 768px) {
      .toolbar { flex-direction: column; }
      .toolbar-left, .toolbar-right { width: 100%; }
      .hide-mobile { display: none; }
      .clients-table { font-size: 0.8rem; }
      .clients-table th, .clients-table td { padding: 6px 6px; }
      .date-input { width: 100px; }
      .edit-grid { grid-template-columns: 1fr; }
      .modal-content { width: 95%; max-height: 95vh; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
      .client-hero { padding: 1.25rem 1rem; border-radius: 0; }
      .client-hero-name { font-size: 1.1rem; }
      .client-stats-row { margin: -16px 0.75rem 0; }
      .client-stat-val { font-size: 1.1rem; }
      .action-toolbar { gap: 2px; }
      .action-btn { padding: 4px 6px; font-size: 0.65rem; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="/dashboard" class="navbar-brand">FIDDO<span></span></a>
    <div class="navbar-menu"></div>
  </nav>

  <div class="container">
    <h1 style="margin: 1rem 0 0.5rem; font-size: 1.3rem;">Mes clients</h1>

    <!-- Stats -->
    <div class="stats-grid" style="margin-bottom: 0.75rem;">
      <div class="stat-card"><div class="stat-value" id="total-clients">0</div><div class="stat-label">Clients</div></div>
      <div class="stat-card"><div class="stat-value" id="active-clients">0</div><div class="stat-label">Actifs (30j)</div></div>
      <div class="stat-card"><div class="stat-value" id="total-points">0</div><div class="stat-label">Points Ã©mis</div></div>
      <div class="stat-card"><div class="stat-value" id="reward-ready">0</div><div class="stat-label">ğŸ RÃ©compenses dispo</div></div>
    </div>

    <!-- Tabs -->
    <div class="client-tabs" id="tabs-row">
      <button class="client-tab active" data-tab="all">ğŸ‘¥ Tous <span class="tab-count" id="cnt-all">0</span></button>
      <button class="client-tab" data-tab="top-points">ğŸ† Top Points</button>
      <button class="client-tab" data-tab="top-visits">ğŸ”„ Plus frÃ©quents</button>
      <button class="client-tab" data-tab="recent">ğŸ• RÃ©cents</button>
      <button class="client-tab" data-tab="inactive">ğŸ˜´ Inactifs</button>
    </div>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="toolbar-left">
        <div class="search-wrap">
          <span class="search-ico">ğŸ”</span>
          <input type="text" id="search-input" class="search-compact" placeholder="Rechercher...">
        </div>
      </div>
      <div class="toolbar-right">
        <div class="date-pills" id="date-pills">
          <button class="date-pill active" data-period="all">Tout</button>
          <button class="date-pill" data-period="today">Auj.</button>
          <button class="date-pill" data-period="yesterday">Hier</button>
          <button class="date-pill" data-period="week">Semaine</button>
          <button class="date-pill" data-period="month">Mois</button>
          <button class="date-pill" data-period="custom">ğŸ“…</button>
        </div>
        <div class="date-range" id="date-range">
          <input type="date" id="date-from" class="date-input">
          <span style="font-size:0.75rem;color:var(--text-light)">â†’</span>
          <input type="date" id="date-to" class="date-input">
        </div>
        <button class="btn btn-outline btn-sm" onclick="exportCSV()" id="csv-btn" style="display:none" title="Exporter CSV">ğŸ“¥ CSV</button>
      </div>
    </div>

    <div class="table-scroll"><div id="clients-container"></div></div>
  </div>

  <!-- â•â•â• Client Detail Modal â•â•â• -->
  <div id="detail-modal" class="modal">
    <div class="modal-content" style="max-width:580px;padding:0;overflow:hidden;">
      <div id="modal-body"></div>
    </div>
  </div>

  <!-- â•â•â• Adjust Modal â•â•â• -->
  <div id="adjust-modal" class="modal">
    <div class="modal-content" style="max-width:400px;">
      <div class="modal-header"><h2 style="font-size:1.05rem">Ajuster les points</h2><button class="close-modal" onclick="closeAdjustModal()">Ã—</button></div>
      <div class="modal-body">
        <div id="adjust-alert"></div>
        <div class="form-group"><label class="form-label">Ajustement (+ ou -)</label><input type="number" id="adjust-delta" class="form-control" placeholder="-10 ou +20"></div>
        <div class="form-group"><label class="form-label">Raison *</label><input type="text" id="adjust-reason" class="form-control" placeholder="Correction erreur..."></div>
        <button class="btn btn-primary btn-block" onclick="submitAdjustment()">Confirmer</button>
      </div>
    </div>
  </div>

  <!-- â•â•â• Merge Modal â•â•â• -->
  <div id="merge-modal" class="modal">
    <div class="modal-content" style="max-width:450px;">
      <div class="modal-header"><h2 style="font-size:1.05rem">ğŸ”€ Fusionner</h2><button class="close-modal" onclick="closeMergeModal()">Ã—</button></div>
      <div class="modal-body">
        <div id="merge-alert"></div>
        <div class="alert alert-info" style="font-size:0.78rem;padding:6px 10px;">
          âš ï¸ Le client source sera <strong>supprimÃ©</strong>. Points, visites et historique transfÃ©rÃ©s vers le client cible.
        </div>
        <div class="modal-section">
          <div class="modal-section-title">ğŸ¯ Cible (conservÃ©)</div>
          <div id="merge-target" style="background:var(--light);border-radius:6px;padding:6px 10px;font-size:0.83rem;font-weight:600;"></div>
        </div>
        <div class="modal-section">
          <div class="modal-section-title">ğŸ“¦ Source (sera supprimÃ©)</div>
          <div class="merge-search-wrap">
            <input type="text" id="merge-search" class="form-control" placeholder="Rechercher..." style="font-size:0.83rem;">
            <div class="merge-results" id="merge-results"></div>
          </div>
          <div class="merge-selected" id="merge-selected">
            <span id="merge-selected-name"></span>
            <button class="btn btn-sm" style="padding:2px 8px;font-size:0.72rem;" onclick="clearMergeSelection()">âœ•</button>
          </div>
        </div>
        <div class="form-group" style="margin-bottom:0.75rem;">
          <label class="form-label" style="font-size:0.78rem;">Raison (optionnel)</label>
          <input type="text" id="merge-reason" class="form-control" placeholder="Doublon, couple..." style="font-size:0.83rem;">
        </div>
        <button class="btn btn-danger btn-block" id="merge-confirm-btn" onclick="submitMerge()" disabled>Confirmer la fusion</button>
      </div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    if (!requireManager()) throw 'Not authorized';

    const staff = Auth.getStaff();
    const merchant = Auth.getMerchant();
    const isOwner = staff.role === 'owner';
    const isManager = ['owner', 'manager'].includes(staff.role);
    let allClients = [];
    let currentTab = 'all';
    let currentSort = { key: 'last_visit', dir: 'desc' };
    let currentPeriod = 'all';
    let currentClientId = null;
    let currentClientData = null;
    let mergeSourceId = null;

    // Show CSV button for owner only
    if (isOwner) document.getElementById('csv-btn').style.display = '';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LOAD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadClients() {
      try {
        UI.showLoading('clients-container');
        const data = await API.call('/clients/enriched');
        allClients = data.clients;
        updateStats();
        applyFilters();
      } catch (err) { UI.showError('clients-container', err.message); }
    }

    function updateStats() {
      const total = allClients.length;
      const active = allClients.filter(c => daysSince(c.last_visit) <= 30).length;
      const pts = allClients.reduce((s, c) => s + c.points_balance, 0);
      const merchant = Auth.getMerchant();
      const rewardReady = merchant ? allClients.filter(c => c.points_balance >= merchant.points_for_reward).length : 0;
      document.getElementById('total-clients').textContent = total;
      document.getElementById('active-clients').textContent = active;
      document.getElementById('total-points').textContent = pts.toLocaleString('fr-FR');
      document.getElementById('reward-ready').textContent = rewardReady;
      document.getElementById('cnt-all').textContent = total;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FILTER + SORT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function applyFilters() {
      let clients = [...allClients];
      const q = document.getElementById('search-input').value.trim().toLowerCase();
      if (q.length >= 2) clients = clients.filter(c => (c.email||'').toLowerCase().includes(q) || (c.phone||'').toLowerCase().includes(q) || (c.name||'').toLowerCase().includes(q));

      const { from, to } = getDateRange();
      if (from) clients = clients.filter(c => { const lv = new Date(c.last_visit); return lv >= from && (!to || lv <= to); });

      switch (currentTab) {
        case 'inactive': clients = clients.filter(c => daysSince(c.last_visit) > 30); break;
        case 'recent': clients = clients.filter(c => daysSince(c.last_visit) <= 7); break;
      }

      clients.sort((a, b) => {
        if (currentTab === 'top-points') return b.points_balance - a.points_balance;
        if (currentTab === 'top-visits') return b.visit_count - a.visit_count;
        let va = a[currentSort.key] ?? '', vb = b[currentSort.key] ?? '';
        if (currentSort.key.includes('visit') || currentSort.key.includes('_at')) { va = new Date(va || 0).getTime(); vb = new Date(vb || 0).getTime(); }
        if (typeof va === 'string') va = va.toLowerCase();
        if (typeof vb === 'string') vb = vb.toLowerCase();
        return currentSort.dir === 'asc' ? (va < vb ? -1 : va > vb ? 1 : 0) : (va > vb ? -1 : va < vb ? 1 : 0);
      });

      renderTable(clients);
    }

    function getDateRange() {
      if (currentPeriod === 'all') return {};
      if (currentPeriod === 'custom') {
        const f = document.getElementById('date-from').value, t = document.getElementById('date-to').value;
        return { from: f ? new Date(f) : null, to: t ? endOfDay(new Date(t)) : null };
      }
      const now = new Date(), today = startOfDay(now);
      const ranges = {
        today:     { from: today, to: endOfDay(now) },
        yesterday: { from: (() => { const y = new Date(today); y.setDate(y.getDate()-1); return y; })(), to: (() => { const y = new Date(today); y.setDate(y.getDate()-1); return endOfDay(y); })() },
        week:      { from: (() => { const w = new Date(today); w.setDate(w.getDate()-7); return w; })(), to: endOfDay(now) },
        month:     { from: (() => { const m = new Date(today); m.setMonth(m.getMonth()-1); return m; })(), to: endOfDay(now) },
      };
      return ranges[currentPeriod] || {};
    }

    function startOfDay(d) { const r = new Date(d); r.setHours(0,0,0,0); return r; }
    function endOfDay(d) { const r = new Date(d); r.setHours(23,59,59,999); return r; }
    function daysSince(d) { return (Date.now() - new Date(d)) / 86400000; }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RENDER TABLE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderTable(clients) {
      const container = document.getElementById('clients-container');
      if (clients.length === 0) { container.innerHTML = '<div class="empty-state" style="padding:2rem"><div class="empty-state-icon">ğŸ‘¥</div><p>Aucun client trouvÃ©</p></div>'; return; }

      const showRank = ['top-points', 'top-visits'].includes(currentTab);
      const maxPts = Math.max(...clients.map(c => c.points_balance), 1);

      const cols = [
        ...(showRank ? [{ key: '_rank', label: '#', noSort: true }] : []),
        { key: 'name', label: 'Client' },
        { key: 'points_balance', label: 'Points' },
        { key: 'visit_count', label: 'Visites' },
        { key: 'last_credited_by', label: 'Par', hide: 'hide-mobile' },
        { key: 'last_visit', label: 'DerniÃ¨re visite' },
      ];

      let html = '<table class="clients-table"><thead><tr>';
      cols.forEach(col => {
        const sorted = currentSort.key === col.key;
        const arrow = col.noSort ? '' : `<span class="sort-arrow">${sorted ? (currentSort.dir==='asc'?'â–²':'â–¼') : 'â‡…'}</span>`;
        html += `<th class="${col.hide||''} ${sorted?'sorted':''}" ${col.noSort?'':`onclick="sortBy('${col.key}')"`}>${col.label}${arrow}</th>`;
      });
      html += '</tr></thead><tbody>';

      clients.forEach((c, i) => {
        const display = c.name || c.email || c.phone || 'N/A';
        const sub = (c.name && (c.email || c.phone)) ? (c.email || c.phone) : '';
        const progress = Math.min(c.points_balance / maxPts * 100, 100);
        const medal = showRank ? (i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':(i+1)) : null;

        html += `<tr onclick="showDetails(${c.id})">`;
        if (showRank) html += `<td class="rank ${i<3?'rank-'+(i+1):''}">${medal}</td>`;
        html += `
          <td><strong>${esc(display)}</strong>${c.custom_reward?' â­':''}${sub?`<br><span class="staff-sm">${esc(sub)}</span>`:''}${c.is_blocked?' <span class="badge badge-danger">BloquÃ©</span>':''}</td>
          <td><div class="pts-bar"><strong style="color:var(--primary)">${c.points_balance}</strong><div class="pts-bar-track"><div class="pts-bar-fill" style="width:${progress}%"></div></div></div></td>
          <td>${c.visit_count}</td>
          <td class="hide-mobile"><span class="staff-sm">${esc(c.last_credited_by||'â€”')}</span></td>
          <td><span class="staff-sm">${fmtDate(c.last_visit)}</span>${daysSince(c.last_visit)>30?'<br><span class="badge badge-warning" style="font-size:0.6rem">Inactif</span>':''}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function sortBy(key) {
      if (currentSort.key === key) currentSort.dir = currentSort.dir === 'asc' ? 'desc' : 'asc';
      else currentSort = { key, dir: key === 'name' ? 'asc' : 'desc' };
      applyFilters();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TABS + DATE PILLS + SEARCH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    document.getElementById('tabs-row').addEventListener('click', (e) => {
      const tab = e.target.closest('.client-tab'); if (!tab) return;
      document.querySelectorAll('.client-tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentTab = tab.dataset.tab;
      const defaults = { 'all':'last_visit','top-points':'points_balance','top-visits':'visit_count','recent':'last_visit','inactive':'last_visit' };
      currentSort = { key: defaults[currentTab]||'last_visit', dir: currentTab==='inactive'?'asc':'desc' };
      applyFilters();
    });

    document.getElementById('date-pills').addEventListener('click', (e) => {
      const pill = e.target.closest('.date-pill'); if (!pill) return;
      document.querySelectorAll('.date-pill').forEach(p => p.classList.remove('active'));
      pill.classList.add('active');
      currentPeriod = pill.dataset.period;
      document.getElementById('date-range').classList.toggle('show', currentPeriod==='custom');
      if (currentPeriod !== 'custom') applyFilters();
    });
    document.getElementById('date-from').addEventListener('change', applyFilters);
    document.getElementById('date-to').addEventListener('change', applyFilters);

    let searchTimeout;
    document.getElementById('search-input').addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(applyFilters, 200); });

    function exportCSV() { window.location.href = `${API_BASE_URL}/clients/export/csv`; }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CLIENT DETAIL MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function showDetails(mcId) {
      try {
        currentClientId = mcId;
        const data = await API.clients.getById(mcId);
        const c = data.client;
        const txs = data.transactions;
        currentClientData = c;

        const progress = Math.min((c.points_balance / c.reward_threshold) * 100, 100);
        const isReady = c.can_redeem;
        const hasCustom = !!c.custom_reward;
        const displayName = c.name || c.email || c.phone || `Client #${mcId}`;
        const subLine = (c.name && (c.email || c.phone)) ? (c.email || c.phone) : '';
        const hasEmail = !!c.email;
        const hasPhone = !!c.phone;

        let html = '';

        // â•â•â• HERO HEADER â•â•â•
        html += `<div class="client-hero">
          <button class="client-hero-close" onclick="closeModal()">Ã—</button>
          <div class="client-hero-name">${esc(displayName)}</div>
          ${subLine ? `<div class="client-hero-sub">${esc(subLine)}</div>` : ''}
          <div class="client-hero-badges">
            ${hasCustom ? '<span class="hero-badge hero-badge-custom">â­ RÃ©compense perso</span>' : ''}
            ${c.is_blocked ? '<span class="hero-badge hero-badge-blocked">BloquÃ©</span>' : ''}
            ${c.email_validated ? '<span class="hero-badge hero-badge-validated">âœ“ Email validÃ©</span>' : ''}
          </div>
        </div>`;

        // â•â•â• FLOATING STATS â•â•â•
        html += `<div class="client-stats-row">
          <div class="client-stat"><div class="client-stat-val">${c.points_balance}</div><div class="client-stat-label">Points</div></div>
          <div class="client-stat"><div class="client-stat-val">${c.visit_count}</div><div class="client-stat-label">Visites</div></div>
          <div class="client-stat"><div class="client-stat-val">${Format.date(c.first_visit)}</div><div class="client-stat-label">Depuis</div></div>
        </div>`;

        // â•â•â• BODY CONTENT (padded) â•â•â•
        html += '<div style="padding:1.25rem 1.5rem 2.5rem;">';

        // â•â•â• REWARD CARD â•â•â•
        const rewardDesc = c.reward_description || merchant.reward_description;
        html += `<div class="reward-card">
          <div class="reward-card-header">
            <div>
              <div class="reward-card-label">ğŸ RÃ©compense ${hasCustom ? '<span class="badge badge-info" style="font-size:0.58rem;margin-left:4px">Perso</span>' : ''}</div>
              <div class="reward-card-name">${esc(rewardDesc)}</div>
            </div>
            ${isManager ? '<button class="reward-card-edit" onclick="toggleRewardEdit()">Modifier</button>' : ''}
          </div>
          <div class="reward-progress">
            <div class="reward-progress-bar"><div class="reward-progress-fill ${isReady ? 'ready' : 'near'}" style="width:${progress}%"></div></div>
            <div class="reward-progress-text"><span>${c.points_balance} / ${c.reward_threshold} pts</span><span>${isReady ? 'âœ… PrÃªt !' : `Encore ${c.reward_threshold - c.points_balance}`}</span></div>
          </div>
          ${isReady ? '<div class="reward-ready-banner">ğŸ RÃ©compense disponible !</div>' : ''}
          ${isManager ? `<div class="reward-edit-area" id="reward-edit-section" style="display:none">
            <div id="reward-alert"></div>
            <div style="display:flex;gap:8px;align-items:flex-end">
              <div class="form-group" style="flex:1;margin-bottom:0">
                <label class="form-label" style="font-size:0.75rem">RÃ©compense sur mesure</label>
                <input type="text" id="custom-reward-input" class="form-control" style="font-size:0.85rem"
                  value="${esc(c.custom_reward||'')}" placeholder="${esc(c.default_reward || merchant.reward_description)}" maxlength="150">
                <small class="form-help">Vide = rÃ©compense par dÃ©faut</small>
              </div>
              <button class="btn btn-primary btn-sm" style="margin-bottom:18px" onclick="saveCustomReward()">Enregistrer</button>
            </div>
          </div>` : ''}
        </div>`;

        // â•â•â• ACTION TOOLBAR â•â•â•
        if (isManager) {
          const creditParams = hasEmail ? `email=${encodeURIComponent(c.email)}` : `phone=${encodeURIComponent(c.phone||'')}`;
          html += `<div class="action-toolbar">
            <a href="/credit?${creditParams}${c.name ? '&name='+encodeURIComponent(c.name) : ''}" class="action-btn">â• CrÃ©diter</a>
            <button class="action-btn" onclick="toggleEditForm()">âœï¸ Modifier</button>
            <button class="action-btn" onclick="showAdjustModal()">ğŸ“ Ajuster</button>
            ${isOwner ? '<button class="action-btn" onclick="showMergeModal()">ğŸ”€ Fusionner</button>' : ''}
            ${c.is_blocked
              ? '<button class="action-btn success" onclick="toggleBlock(false)">ğŸ”“ DÃ©bloquer</button>'
              : '<button class="action-btn danger" onclick="toggleBlock(true)">ğŸ”’ Bloquer</button>'}
            ${isOwner ? '<button class="action-btn danger" onclick="deleteClient()">ğŸ—‘ï¸ Supprimer</button>' : ''}
          </div>`;
        }

        // â•â•â• EDIT FORM (hidden) â•â•â•
        if (isManager) {
          html += `<div class="modal-section" id="edit-section" style="display:none;margin-top:1rem">
            <div id="edit-alert"></div>
            <div class="edit-grid">
              <div class="form-group full-width"><label class="form-label">Nom / surnom</label>
                <input type="text" id="edit-name" class="form-control" value="${esc(c.name||'')}"></div>
              <div class="form-group"><label class="form-label">Email</label>
                <input type="email" id="edit-email" class="form-control" value="${esc(c.email||'')}"></div>
              <div class="form-group"><label class="form-label">TÃ©lÃ©phone</label>
                <input type="tel" id="edit-phone" class="form-control" value="${esc(c.phone||'')}"></div>
              <div class="form-group full-width" style="text-align:right">
                <button class="btn btn-sm" onclick="toggleEditForm()" style="margin-right:0.5rem">Annuler</button>
                <button class="btn btn-primary btn-sm" onclick="saveEdit()">Enregistrer</button>
              </div>
            </div>
          </div>`;
        }

        // â•â•â• NOTES (expandable) â•â•â•
        if (isManager) {
          const hasNotes = !!(c.notes_private && c.notes_private.trim());
          html += `<div class="expand-section ${hasNotes ? 'open' : ''}" style="margin-top:1rem" onclick="this.classList.toggle('open')" id="notes-section">
            <div class="expand-header">
              <span>ğŸ“ Notes privÃ©es ${hasNotes ? '' : '<span style="font-size:0.72rem;color:var(--text-light);font-weight:400;margin-left:6px">Aucune</span>'}</span>
              <span class="expand-arrow">â–¶</span>
            </div>
            <div class="expand-body" onclick="event.stopPropagation()">
              <textarea class="notes-area" id="notes-area" placeholder="VIP, allergique noix, couple table 12..." maxlength="500">${esc(c.notes_private||'')}</textarea>
              <div class="notes-meta"><span id="notes-count">${(c.notes_private||'').length}</span>/500
                <button class="btn btn-sm" style="padding:2px 10px;font-size:0.72rem;margin-left:6px" onclick="saveNotes()">Sauver</button>
              </div>
            </div>
          </div>`;
        }

        // â•â•â• TRANSACTIONS (expandable, open by default) â•â•â•
        html += `<div class="expand-section open" style="margin-top:0.75rem" onclick="this.classList.toggle('open')">
          <div class="expand-header">
            <span>ğŸ“œ Historique <span style="font-size:0.72rem;color:var(--text-light);font-weight:400;margin-left:6px">${txs.length} transaction${txs.length !== 1 ? 's' : ''}</span></span>
            <span class="expand-arrow">â–¶</span>
          </div>
          <div class="expand-body" onclick="event.stopPropagation()">`;

        if (txs.length === 0) {
          html += '<p class="text-muted" style="font-size:0.85rem;text-align:center;padding:1rem 0">Aucune transaction</p>';
        } else {
          html += '<div class="tx-list">';
          txs.forEach(t => {
            const sign = t.points_delta >= 0 ? '+' : '';
            const colors = { reward: 'var(--success)', adjustment: 'var(--warning)', merge: '#8b5cf6', credit: 'var(--primary)' };
            const color = colors[t.transaction_type] || 'var(--primary)';
            html += `<div class="tx-item">
              <div class="tx-dot ${t.transaction_type}"></div>
              <div class="tx-body">
                <div class="tx-top">
                  <span class="tx-amount" style="color:${color}">${sign}${t.points_delta} pts</span>
                  <span class="tx-date">${Format.datetime(t.created_at)}</span>
                </div>
                <div class="tx-detail">
                  ${t.amount ? Format.currency(t.amount) + ' Â· ' : ''}${t.transaction_type}${t.staff_name ? ' Â· ' + esc(t.staff_name) : ''}
                  ${t.notes ? '<br>' + esc(t.notes) : ''}
                </div>
              </div>
            </div>`;
          });
          html += '</div>';
        }
        html += '</div></div>';

        // Close padded body
        html += '</div>';

        document.getElementById('modal-body').innerHTML = html;

        // Notes character counter
        const notesEl = document.getElementById('notes-area');
        if (notesEl) notesEl.addEventListener('input', () => { document.getElementById('notes-count').textContent = notesEl.value.length; });

        document.getElementById('detail-modal').classList.add('active');
      } catch (err) { console.error(err); }
    }

    function closeModal() { document.getElementById('detail-modal').classList.remove('active'); }
    document.getElementById('detail-modal').addEventListener('click', (e) => { if (e.target.id === 'detail-modal') closeModal(); });

    // â”€â”€ Edit â”€â”€
    function toggleEditForm() { const el = document.getElementById('edit-section'); if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none'; }

    async function saveEdit() {
      try {
        const name = document.getElementById('edit-name').value.trim();
        const email = document.getElementById('edit-email').value.trim();
        const phone = document.getElementById('edit-phone').value.trim();
        if (!email && !phone) { UI.showAlert('edit-alert', 'Email ou tÃ©lÃ©phone requis', 'error'); return; }
        await API.call(`/clients/${currentClientId}/edit`, { method: 'PUT', body: JSON.stringify({ name: name||null, email: email||null, phone: phone||null }) });
        closeModal(); loadClients();
      } catch (err) { UI.showAlert('edit-alert', err.message, 'error'); }
    }

    // â”€â”€ Notes â”€â”€
    async function saveNotes() {
      try {
        const notes = document.getElementById('notes-area').value;
        await API.call(`/clients/${currentClientId}/notes`, { method: 'PUT', body: JSON.stringify({ notes }) });
        // Update local data
        const idx = allClients.findIndex(c => c.id === currentClientId);
        if (idx >= 0) allClients[idx].notes_private = notes;
      } catch (err) { alert('Erreur : ' + err.message); }
    }

    // â”€â”€ Custom Reward â”€â”€
    function toggleRewardEdit() {
      const el = document.getElementById('reward-edit-section');
      if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    async function saveCustomReward() {
      try {
        const value = document.getElementById('custom-reward-input').value.trim();
        await API.clients.setCustomReward(currentClientId, value || null);
        showDetails(currentClientId); // refresh modal
      } catch (err) { UI.showAlert('reward-alert', err.message, 'error'); }
    }

    // â”€â”€ Resend email â”€â”€
    async function resendEmail() {
      try {
        const result = await API.call(`/clients/${currentClientId}/resend-email`, { method: 'POST' });
        const msg = result.type === 'validation' ? 'Email de validation renvoyÃ© âœ…' : 'RÃ©capitulatif des points envoyÃ© âœ…';
        alert(msg);
      } catch (err) { alert('Erreur : ' + err.message); }
    }

    // â”€â”€ Block / Unblock â”€â”€
    async function toggleBlock(block) {
      if (!confirm(`${block ? 'ğŸ”’ Bloquer' : 'ğŸ”“ DÃ©bloquer'} ce client ?`)) return;
      try {
        if (block) await API.clients.block(currentClientId); else await API.clients.unblock(currentClientId);
        closeModal(); loadClients();
      } catch (err) { alert(err.message); }
    }

    // â”€â”€ Delete â”€â”€
    async function deleteClient() {
      const c = currentClientData;
      const label = c.name || c.email || c.phone || '#'+currentClientId;
      if (!confirm(`ğŸ—‘ï¸ Supprimer "${label}" ?\n\nCette action est irrÃ©versible.\nTous les points et l'historique seront perdus.`)) return;
      if (!confirm(`âš ï¸ DERNIÃˆRE CONFIRMATION\n\nSupprimer dÃ©finitivement "${label}" et toutes ses donnÃ©es ?`)) return;
      try {
        await API.call(`/clients/${currentClientId}`, { method: 'DELETE' });
        closeModal(); loadClients();
      } catch (err) { alert('Erreur : ' + err.message); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADJUST MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function showAdjustModal() {
      document.getElementById('adjust-delta').value = '';
      document.getElementById('adjust-reason').value = '';
      UI.clearAlert('adjust-alert');
      document.getElementById('adjust-modal').classList.add('active');
    }
    function closeAdjustModal() { document.getElementById('adjust-modal').classList.remove('active'); }
    document.getElementById('adjust-modal').addEventListener('click', (e) => { if (e.target.id === 'adjust-modal') closeAdjustModal(); });

    async function submitAdjustment() {
      const delta = parseInt(document.getElementById('adjust-delta').value);
      const reason = document.getElementById('adjust-reason').value.trim();
      if (!delta) { UI.showAlert('adjust-alert', 'Ajustement requis', 'error'); return; }
      if (!reason) { UI.showAlert('adjust-alert', 'Raison requise', 'error'); return; }
      try {
        await API.clients.adjust({ merchantClientId: currentClientId, pointsDelta: delta, reason });
        closeAdjustModal(); showDetails(currentClientId); loadClients();
      } catch (err) { UI.showAlert('adjust-alert', err.message, 'error'); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MERGE MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function showMergeModal() {
      mergeSourceId = null;
      document.getElementById('merge-search').value = '';
      document.getElementById('merge-search').style.display = '';
      document.getElementById('merge-results').classList.remove('open');
      document.getElementById('merge-selected').classList.remove('show');
      document.getElementById('merge-confirm-btn').disabled = true;
      document.getElementById('merge-reason').value = '';
      UI.clearAlert('merge-alert');
      const c = currentClientData;
      document.getElementById('merge-target').innerHTML = `<strong>${esc(c.name||c.email||c.phone||'#'+currentClientId)}</strong> â€” ${c.points_balance} pts, ${c.visit_count} visites`;
      document.getElementById('merge-modal').classList.add('active');
    }
    function closeMergeModal() { document.getElementById('merge-modal').classList.remove('active'); }
    document.getElementById('merge-modal').addEventListener('click', (e) => { if (e.target.id === 'merge-modal') closeMergeModal(); });

    let mergeSearchTimeout;
    document.getElementById('merge-search').addEventListener('input', (e) => {
      clearTimeout(mergeSearchTimeout);
      const q = e.target.value.trim();
      if (q.length < 2) { document.getElementById('merge-results').classList.remove('open'); return; }
      mergeSearchTimeout = setTimeout(() => {
        const results = allClients.filter(c => c.id !== currentClientId && ((c.email||'').toLowerCase().includes(q.toLowerCase()) || (c.phone||'').toLowerCase().includes(q.toLowerCase()) || (c.name||'').toLowerCase().includes(q.toLowerCase()))).slice(0, 8);
        const dd = document.getElementById('merge-results');
        dd.innerHTML = results.length === 0
          ? '<div style="padding:8px 10px;font-size:0.83rem;color:var(--text-light)">Aucun rÃ©sultat</div>'
          : results.map(r => `<div class="merge-item" onclick="selectMergeSource(${r.id})"><div class="m-name">${esc(r.name||r.email||r.phone||'#'+r.id)}</div><div class="m-detail">${r.points_balance} pts Â· ${r.visit_count} vis.</div></div>`).join('');
        dd.classList.add('open');
      }, 200);
    });

    function selectMergeSource(id) {
      mergeSourceId = id;
      const c = allClients.find(x => x.id === id); if (!c) return;
      document.getElementById('merge-results').classList.remove('open');
      document.getElementById('merge-search').style.display = 'none';
      document.getElementById('merge-selected-name').innerHTML = `<strong>${esc(c.name||c.email||c.phone)}</strong> â€” ${c.points_balance} pts, ${c.visit_count} vis.`;
      document.getElementById('merge-selected').classList.add('show');
      document.getElementById('merge-confirm-btn').disabled = false;
    }

    function clearMergeSelection() {
      mergeSourceId = null;
      document.getElementById('merge-selected').classList.remove('show');
      document.getElementById('merge-search').style.display = '';
      document.getElementById('merge-search').value = '';
      document.getElementById('merge-confirm-btn').disabled = true;
    }

    async function submitMerge() {
      if (!mergeSourceId) return;
      const src = allClients.find(x => x.id === mergeSourceId);
      const label = src ? (src.name||src.email||src.phone) : '#'+mergeSourceId;
      if (!confirm(`âš ï¸ ATTENTION\n\n"${label}" sera SUPPRIMÃ‰.\nSes points et historique transfÃ©rÃ©s vers le client actuel.\n\nIrrÃ©versible. Continuer ?`)) return;
      try {
        const reason = document.getElementById('merge-reason').value.trim();
        await API.call(`/clients/${currentClientId}/merge`, { method: 'POST', body: JSON.stringify({ sourceMerchantClientId: mergeSourceId, reason: reason||'Fusion manuelle' }) });
        closeMergeModal(); closeModal(); loadClients();
        setTimeout(() => showDetails(currentClientId), 300);
      } catch (err) { UI.showAlert('merge-alert', err.message, 'error'); }
    }

    document.addEventListener('click', (e) => { if (!e.target.closest('.merge-search-wrap')) document.getElementById('merge-results').classList.remove('open'); });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function fmtDate(d) {
      if (!d) return 'â€”';
      const dt = new Date(d), days = Math.floor((Date.now()-dt)/86400000);
      const time = dt.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' });
      if (days === 0) return `Auj. ${time}`;
      if (days === 1) return `Hier ${time}`;
      if (days < 7) return `${dt.toLocaleDateString('fr-FR',{weekday:'short'})} ${time}`;
      return dt.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit'})+' '+time;
    }

    loadClients();
  </script>
</body>
</html>
