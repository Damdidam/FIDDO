<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clients ‚Äî FIDDO</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-light: #CFFAFE;
      --gradient: linear-gradient(135deg, var(--primary), var(--primary-dark));
    }

    .dash { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; }
    .dash * { box-sizing: border-box; }
    .dash-wrap { max-width: 820px; margin: 0 auto; padding: 1rem; }

    .pg-title {
      font-size: 1.05rem; font-weight: 700; color: #1E293B;
      margin: 0.3rem 0 0.6rem; letter-spacing: -0.3px;
    }

    /* ‚ïê‚ïê‚ïê TOOLBAR ‚ïê‚ïê‚ïê */

    .toolbar {
      display: flex; align-items: center; gap: 0.5rem;
      margin-bottom: 0.9rem;
    }
    .search-wrap {
      flex: 1; position: relative;
    }
    .search-wrap .ico {
      position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
      font-size: 0.8rem; color: #94A3B8; pointer-events: none;
    }
    .search-wrap input {
      width: 100%; padding: 0.4rem 0.6rem 0.4rem 2rem;
      border: 1.5px solid #E2E8F0; border-radius: 16px;
      font-family: inherit; font-size: 0.78rem; color: #334155;
      background: white; transition: border-color 0.15s;
    }
    .search-wrap input:focus { outline: none; border-color: var(--primary); }
    .search-wrap input::placeholder { color: #CBD5E1; }

    .toolbar-count {
      font-size: 0.68rem; color: #94A3B8; font-weight: 500;
      white-space: nowrap;
    }

    .csv-btn {
      padding: 0.3rem 0.65rem; border: 1.5px solid #E2E8F0;
      border-radius: 16px; background: white; font-family: inherit;
      font-size: 0.72rem; font-weight: 500; color: #64748B;
      cursor: pointer; transition: all 0.12s; white-space: nowrap;
    }
    .csv-btn:hover { border-color: var(--primary); color: var(--primary-dark); }

    /* ‚ïê‚ïê‚ïê STAT CARDS ‚ïê‚ïê‚ïê */

    .stats-row {
      display: grid; grid-template-columns: repeat(3, 1fr);
      gap: 0.6rem; margin-bottom: 1rem;
    }
    .st {
      background: white; border-radius: 10px; padding: 0.7rem 0.6rem;
      text-align: center; box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
    .st-val {
      font-size: 1.5rem; font-weight: 700; color: var(--primary);
      line-height: 1.15; letter-spacing: -0.5px;
    }
    .st-val.green { color: #059669; }
    .st-val.amber { color: #D97706; }
    .st-lbl {
      font-size: 0.62rem; color: #94A3B8; text-transform: uppercase;
      letter-spacing: 0.4px; margin-top: 0.15rem; font-weight: 600;
    }

    /* ‚ïê‚ïê‚ïê CLIENTS TABLE ‚ïê‚ïê‚ïê */

    .cl-card {
      background: white; border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05); overflow: hidden;
    }

    /* ‚îÄ‚îÄ Sortable column headers ‚îÄ‚îÄ */
    .col-hdr {
      display: grid;
      grid-template-columns: 1fr 72px 60px 85px 100px;
      gap: 0.3rem;
      padding: 0.4rem 0.85rem;
      background: #F8FAFC;
      border-bottom: 1px solid #E2E8F0;
    }
    .col-th {
      font-size: 0.62rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.4px; color: #94A3B8; cursor: pointer;
      user-select: none; display: flex; align-items: center; gap: 3px;
      transition: color 0.12s; white-space: nowrap;
    }
    .col-th:hover { color: #475569; }
    .col-th.active { color: var(--primary-dark); }
    .col-th .arrow {
      font-size: 0.55rem; opacity: 0; transition: opacity 0.12s;
    }
    .col-th.active .arrow { opacity: 1; }
    .col-th-right { justify-content: flex-end; }
    .col-th-center { justify-content: center; }

    /* ‚îÄ‚îÄ Client rows ‚îÄ‚îÄ */
    .cl-body { max-height: 560px; overflow-y: auto; }

    .cl-row {
      display: grid;
      grid-template-columns: 1fr 72px 60px 85px 100px;
      gap: 0.3rem;
      padding: 0.5rem 0.85rem;
      border-bottom: 1px solid #F8FAFC;
      align-items: center;
      cursor: pointer;
      transition: background 0.1s;
    }
    .cl-row:last-child { border-bottom: none; }
    .cl-row:hover { background: #FAFBFC; }

    .cl-info { min-width: 0; }
    .cl-name {
      font-weight: 600; color: #1E293B; font-size: 0.82rem;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .cl-sub {
      font-size: 0.66rem; color: #94A3B8; margin-top: 1px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .cl-badges { display: flex; gap: 3px; margin-top: 2px; }
    .cl-badge {
      display: inline-block; padding: 1px 6px; border-radius: 8px;
      font-size: 0.55rem; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.2px;
    }
    .cl-badge.active { background: #D1FAE5; color: #047857; }
    .cl-badge.inactive { background: #FEF3C7; color: #92400E; }
    .cl-badge.blocked { background: #FEE2E2; color: #B91C1C; }
    .cl-badge.reward { background: #D1FAE5; color: #047857; }

    .cl-pts { font-weight: 700; font-size: 0.88rem; color: var(--primary); text-align: right; }
    .cl-visits { font-size: 0.82rem; color: #64748B; text-align: center; font-weight: 500; }
    .cl-last { font-size: 0.72rem; color: #64748B; text-align: right; }

    /* ‚îÄ‚îÄ Progression bar ‚îÄ‚îÄ */
    .cl-prog { display: flex; align-items: center; gap: 0.35rem; }
    .prog-bar {
      flex: 1; height: 6px; background: #E2E8F0;
      border-radius: 3px; overflow: hidden;
    }
    .prog-fill {
      height: 100%; border-radius: 3px;
      background: var(--primary);
      transition: width 0.3s;
    }
    .prog-fill.full { background: #059669; }
    .prog-pct {
      font-size: 0.6rem; font-weight: 600; color: #94A3B8;
      min-width: 28px; text-align: right;
    }
    .prog-pct.full { color: #059669; }

    /* ‚îÄ‚îÄ Empty / Loading ‚îÄ‚îÄ */
    .cl-empty { padding: 2.5rem 1rem; text-align: center; color: #94A3B8; font-size: 0.85rem; }
    .cl-empty-icon { font-size: 2rem; margin-bottom: 0.4rem; }
    .cl-loading { padding: 1.5rem; text-align: center; color: #94A3B8; font-size: 0.78rem; }

    /* ‚ïê‚ïê‚ïê MODAL ‚Äî detail ‚ïê‚ïê‚ïê */

    .modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(15,23,42,0.45); z-index: 1000;
      align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }

    .modal-box {
      background: white; border-radius: 12px;
      width: 90%; max-width: 580px; max-height: 88vh;
      overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    .modal-top {
      padding: 0.85rem 1.2rem; border-bottom: 1px solid #F1F5F9;
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal-top h2 {
      font-size: 0.95rem; font-weight: 700; color: #1E293B;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      max-width: calc(100% - 40px);
    }
    .modal-close {
      font-size: 1.3rem; cursor: pointer; color: #94A3B8;
      background: none; border: none; line-height: 1; padding: 0.2rem;
    }
    .modal-close:hover { color: #475569; }
    .modal-inner { padding: 1.2rem; }

    /* ‚îÄ‚îÄ Detail stats ‚îÄ‚îÄ */
    .dt-stats {
      display: grid; grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem; margin-bottom: 1rem;
    }
    .dt-st {
      text-align: center; padding: 0.5rem;
      background: #F8FAFC; border-radius: 8px;
    }
    .dt-st-val { font-size: 1.2rem; font-weight: 700; color: var(--primary); }
    .dt-st-val.green { color: #059669; }
    .dt-st-lbl { font-size: 0.6rem; color: #94A3B8; text-transform: uppercase; letter-spacing: 0.3px; font-weight: 600; }

    /* ‚îÄ‚îÄ Progress section ‚îÄ‚îÄ */
    .dt-prog-wrap { margin-bottom: 1.2rem; }
    .dt-prog-top {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 0.72rem; color: #64748B; margin-bottom: 0.3rem;
    }
    .dt-prog-bar {
      height: 10px; background: #E2E8F0; border-radius: 5px; overflow: hidden;
    }
    .dt-prog-fill {
      height: 100%; border-radius: 5px;
      background: var(--gradient);
      transition: width 0.4s;
    }
    .dt-prog-fill.full { background: linear-gradient(135deg, #10B981, #059669); }
    .dt-reward-banner {
      margin-top: 0.5rem; padding: 0.5rem 0.75rem;
      background: #D1FAE5; border-radius: 8px;
      font-size: 0.78rem; color: #047857; font-weight: 600;
      text-align: center; cursor: pointer; transition: background 0.12s;
    }
    .dt-reward-banner:hover { background: #A7F3D0; }

    /* ‚îÄ‚îÄ Timeline ‚îÄ‚îÄ */
    .dt-section {
      font-size: 0.72rem; font-weight: 700; color: #94A3B8;
      text-transform: uppercase; letter-spacing: 0.4px;
      margin-bottom: 0.6rem;
    }
    .tl { border-left: 2px solid #E2E8F0; padding-left: 1rem; margin-left: 0.4rem; }
    .tl-item { position: relative; margin-bottom: 0.8rem; }
    .tl-item:last-child { margin-bottom: 0; }
    .tl-item::before {
      content: '';
      position: absolute; left: -1.28rem; top: 0.35rem;
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--primary); border: 2px solid white;
      box-shadow: 0 0 0 1.5px #E2E8F0;
    }
    .tl-item.reward::before { background: #10B981; }
    .tl-item.adjustment::before { background: #F59E0B; }
    .tl-item.merge::before { background: #8B5CF6; }
    .tl-date { font-size: 0.66rem; color: #94A3B8; }
    .tl-body {
      background: #F8FAFC; padding: 0.45rem 0.6rem;
      border-radius: 6px; margin-top: 0.15rem;
      font-size: 0.78rem; color: #334155;
    }
    .tl-pts { font-weight: 700; }
    .tl-pts.credit { color: var(--primary); }
    .tl-pts.reward { color: #059669; }
    .tl-pts.adjustment { color: #D97706; }
    .tl-pts.merge { color: #7C3AED; }
    .tl-badge {
      display: inline-block; padding: 1px 6px; border-radius: 6px;
      font-size: 0.58rem; font-weight: 600; text-transform: uppercase;
      margin-left: 0.3rem; vertical-align: middle;
    }
    .tl-badge.credit { background: color-mix(in srgb, var(--primary-light) 50%, white); color: var(--primary-dark); }
    .tl-badge.reward { background: #D1FAE5; color: #047857; }
    .tl-badge.adjustment { background: #FEF3C7; color: #92400E; }
    .tl-badge.merge { background: #EDE9FE; color: #6D28D9; }
    .tl-notes { font-size: 0.66rem; color: #94A3B8; margin-top: 0.15rem; }
    .tl-empty { font-size: 0.78rem; color: #94A3B8; text-align: center; padding: 1rem; }

    /* ‚îÄ‚îÄ Modal footer actions ‚îÄ‚îÄ */
    .modal-foot {
      padding: 0.6rem 1.2rem; border-top: 1px solid #F1F5F9;
      display: flex; gap: 0.5rem; justify-content: flex-end;
    }
    .act-btn {
      padding: 0.3rem 0.65rem; border: 1.5px solid #E2E8F0;
      border-radius: 14px; background: white; font-family: inherit;
      font-size: 0.72rem; font-weight: 500; color: #64748B;
      cursor: pointer; transition: all 0.12s;
    }
    .act-btn:hover { border-color: var(--primary); color: var(--primary-dark); }
    .act-btn.danger { border-color: #FCA5A5; color: #DC2626; }
    .act-btn.danger:hover { background: #FEF2F2; }
    .act-btn.success { border-color: #86EFAC; color: #059669; }
    .act-btn.success:hover { background: #F0FDF4; }

    /* ‚ïê‚ïê‚ïê ADJUST MODAL ‚ïê‚ïê‚ïê */

    .adj-form .form-group { margin-bottom: 0.8rem; }
    .adj-form .form-label {
      display: block; font-size: 0.72rem; font-weight: 600;
      color: #475569; margin-bottom: 0.25rem;
    }
    .adj-form input {
      width: 100%; padding: 0.4rem 0.6rem;
      border: 1.5px solid #E2E8F0; border-radius: 8px;
      font-family: inherit; font-size: 0.82rem; color: #334155;
    }
    .adj-form input:focus { outline: none; border-color: var(--primary); }
    .adj-submit {
      padding: 0.4rem 1rem; border: none; border-radius: 14px;
      background: var(--primary); color: white; font-family: inherit;
      font-size: 0.78rem; font-weight: 600; cursor: pointer;
      transition: background 0.12s;
    }
    .adj-submit:hover { background: var(--primary-dark); }

    /* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */

    @media (max-width: 768px) {
      .dash-wrap { padding: 0.5rem; }
      .stats-row { grid-template-columns: repeat(3, 1fr); gap: 0.45rem; }
      .st-val { font-size: 1.3rem; }
      .cl-body { max-height: 440px; }
      .col-hdr, .cl-row {
        grid-template-columns: 1fr 60px 45px 75px;
        gap: 0.2rem; padding-left: 0.5rem; padding-right: 0.5rem;
      }
      .col-th-prog, .cl-prog-cell { display: none; }
      .cl-last { font-size: 0.66rem; }
      .modal-box { width: 95%; max-height: 92vh; }
      .dt-stats { grid-template-columns: repeat(3, 1fr); gap: 0.4rem; }
    }
    @media (max-width: 480px) {
      .stats-row { gap: 0.35rem; }
      .st { padding: 0.55rem 0.4rem; }
      .st-val { font-size: 1.15rem; }
      .toolbar { gap: 0.3rem; }
      .col-hdr, .cl-row {
        grid-template-columns: 1fr 55px 72px;
        gap: 0.15rem;
      }
      .col-th-visits, .cl-visits-cell { display: none; }
    }
  </style>
</head>
<body class="dash">
  <nav class="navbar">
    <a href="/dashboard" class="navbar-brand">FIDDO<span></span></a>
    <div class="navbar-menu"></div>
  </nav>

  <div class="dash-wrap">
    <h1 class="pg-title">Clients</h1>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOOLBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="toolbar">
      <div class="search-wrap">
        <span class="ico">üîç</span>
        <input type="text" id="search-input" placeholder="Rechercher par email, t√©l√©phone ou nom‚Ä¶">
      </div>
      <span class="toolbar-count" id="result-count"></span>
      <button class="csv-btn" onclick="API.clients.exportCSV()">üì• CSV</button>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="stats-row">
      <div class="st"><div class="st-val" id="s-total">‚Äì</div><div class="st-lbl">Clients</div></div>
      <div class="st"><div class="st-val amber" id="s-active">‚Äì</div><div class="st-lbl">Actifs (30j)</div></div>
      <div class="st"><div class="st-val green" id="s-rewards">‚Äì</div><div class="st-lbl">R√©compenses dispo</div></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CLIENT TABLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="cl-card">
      <div class="col-hdr">
        <div class="col-th active" onclick="sortBy('name',this)">
          Client <span class="arrow">‚ñ≤</span>
        </div>
        <div class="col-th col-th-right" onclick="sortBy('points',this)">
          Points <span class="arrow">‚ñº</span>
        </div>
        <div class="col-th col-th-center col-th-visits" onclick="sortBy('visits',this)">
          Visites <span class="arrow">‚ñº</span>
        </div>
        <div class="col-th col-th-right" onclick="sortBy('last',this)">
          Derni√®re <span class="arrow">‚ñº</span>
        </div>
        <div class="col-th col-th-prog" onclick="sortBy('progress',this)">
          Progression <span class="arrow">‚ñº</span>
        </div>
      </div>
      <div class="cl-body" id="cl-body">
        <div class="cl-loading">Chargement‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DETAIL MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="modal-overlay" id="detail-modal">
    <div class="modal-box">
      <div class="modal-top">
        <h2 id="modal-title">Client</h2>
        <button class="modal-close" onclick="closeDetail()">√ó</button>
      </div>
      <div class="modal-inner" id="modal-body"></div>
      <div class="modal-foot" id="modal-foot"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADJUST MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="modal-overlay" id="adjust-modal">
    <div class="modal-box" style="max-width: 400px;">
      <div class="modal-top">
        <h2>Ajuster les points</h2>
        <button class="modal-close" onclick="closeAdjust()">√ó</button>
      </div>
      <div class="modal-inner">
        <div id="adjust-alert"></div>
        <div class="adj-form">
          <div class="form-group">
            <label class="form-label">Ajustement (positif ou n√©gatif)</label>
            <input type="number" id="adj-delta" placeholder="ex: -10 ou +20">
          </div>
          <div class="form-group">
            <label class="form-label">Raison *</label>
            <input type="text" id="adj-reason" placeholder="Correction erreur de saisie">
          </div>
          <button class="adj-submit" onclick="submitAdjust()">Confirmer</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    if (!requireManager()) throw 'Not authorized';

    const staff = Auth.getStaff();
    const merchant = Auth.getMerchant();
    const rewardThreshold = merchant.points_for_reward;

    let allClients = [];
    let displayedClients = [];
    let currentClientId = null;

    // Sort state
    let sortCol = 'name';
    let sortAsc = true;

    // ‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê

    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function fmtNum(n) { return n >= 1000 ? (n / 1000).toFixed(1) + 'k' : n.toString(); }

    function daysSince(d) {
      if (!d) return 9999;
      return Math.floor((Date.now() - new Date(d)) / 86400000);
    }
    function fmtSince(d) {
      const days = daysSince(d);
      if (days === 0) return "Aujourd'hui";
      if (days === 1) return 'Hier';
      if (days < 7) return days + 'j';
      if (days < 30) return Math.floor(days / 7) + ' sem.';
      if (days < 365) return Math.floor(days / 30) + ' mois';
      return Math.floor(days / 365) + ' an(s)';
    }

    // ‚ïê‚ïê‚ïê LOAD CLIENTS ‚ïê‚ïê‚ïê

    async function loadClients() {
      try {
        const data = await API.clients.getAll();
        allClients = data.clients.map(c => ({
          ...c,
          _label: c.name || c.email || c.phone || 'N/A',
          _sub: c.name ? (c.email || c.phone || '') : (c.phone || ''),
          _days: daysSince(c.last_visit),
          _progress: Math.min(Math.round((c.points_balance / rewardThreshold) * 100), 100),
          _canRedeem: c.points_balance >= rewardThreshold,
        }));
        displayedClients = allClients;
        updateStats();
        renderClients();
      } catch (err) {
        document.getElementById('cl-body').innerHTML =
          '<div class="cl-empty"><div class="cl-empty-icon">‚ö†Ô∏è</div>Erreur de chargement</div>';
      }
    }

    // ‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê

    function updateStats() {
      const total = allClients.length;
      const active = allClients.filter(c => c._days <= 30).length;
      const rewards = allClients.filter(c => c._canRedeem).length;

      document.getElementById('s-total').textContent = fmtNum(total);
      document.getElementById('s-active').textContent = fmtNum(active);
      document.getElementById('s-rewards').textContent = fmtNum(rewards);
    }

    // ‚ïê‚ïê‚ïê SEARCH ‚ïê‚ïê‚ïê

    let searchTimeout;
    document.getElementById('search-input').addEventListener('input', (e) => {
      const q = e.target.value.trim();
      clearTimeout(searchTimeout);

      if (q.length === 0) {
        displayedClients = allClients;
        renderClients();
        return;
      }
      if (q.length < 2) return;

      searchTimeout = setTimeout(async () => {
        try {
          const data = await API.clients.search(q);
          displayedClients = data.clients.map(c => ({
            ...c,
            _label: c.name || c.email || c.phone || 'N/A',
            _sub: c.name ? (c.email || c.phone || '') : (c.phone || ''),
            _days: daysSince(c.last_visit),
            _progress: Math.min(Math.round((c.points_balance / rewardThreshold) * 100), 100),
            _canRedeem: c.points_balance >= rewardThreshold,
          }));
          renderClients();
        } catch (err) { console.error(err); }
      }, 300);
    });

    // ‚ïê‚ïê‚ïê SORTING ‚ïê‚ïê‚ïê

    function sortBy(col, el) {
      if (sortCol === col) {
        sortAsc = !sortAsc;
      } else {
        sortCol = col;
        sortAsc = (col === 'name'); // alpha = asc default, rest = desc
      }
      document.querySelectorAll('.col-th').forEach(th => th.classList.remove('active'));
      el.classList.add('active');
      el.querySelector('.arrow').textContent = sortAsc ? '‚ñ≤' : '‚ñº';
      renderClients();
    }

    function getSorted(list) {
      const sorted = [...list];
      const dir = sortAsc ? 1 : -1;

      sorted.sort((a, b) => {
        switch (sortCol) {
          case 'name':
            return dir * a._label.toLowerCase().localeCompare(b._label.toLowerCase());
          case 'points':
            return dir * (a.points_balance - b.points_balance);
          case 'visits':
            return dir * (a.visit_count - b.visit_count);
          case 'last':
            // ascending = oldest first, descending = newest first
            return dir * (a._days - b._days) * -1;
          case 'progress':
            return dir * (a._progress - b._progress);
          default:
            return 0;
        }
      });
      return sorted;
    }

    // ‚ïê‚ïê‚ïê RENDER TABLE ‚ïê‚ïê‚ïê

    function renderClients() {
      const body = document.getElementById('cl-body');
      const count = document.getElementById('result-count');
      count.textContent = displayedClients.length + ' client(s)';

      if (displayedClients.length === 0) {
        body.innerHTML = '<div class="cl-empty"><div class="cl-empty-icon">üë•</div>Aucun client trouv√©</div>';
        return;
      }

      const sorted = getSorted(displayedClients);
      let html = '';

      sorted.forEach(c => {
        const isActive = c._days <= 30;
        const progClass = c._progress >= 100 ? 'full' : '';

        html += '<div class="cl-row" onclick="showDetail(' + c.id + ')">';

        // Col 1: Client info
        html += '<div class="cl-info">';
        html += '<div class="cl-name">' + esc(c._label) + '</div>';
        if (c._sub) html += '<div class="cl-sub">' + esc(c._sub) + '</div>';
        html += '<div class="cl-badges">';
        if (c.is_blocked) html += '<span class="cl-badge blocked">bloqu√©</span>';
        else if (isActive) html += '<span class="cl-badge active">actif</span>';
        else html += '<span class="cl-badge inactive">inactif</span>';
        if (c._canRedeem) html += '<span class="cl-badge reward">üéÅ</span>';
        html += '</div>';
        html += '</div>';

        // Col 2: Points
        html += '<div class="cl-pts">' + c.points_balance + '</div>';

        // Col 3: Visits
        html += '<div class="cl-visits cl-visits-cell">' + c.visit_count + '</div>';

        // Col 4: Last visit
        html += '<div class="cl-last">' + fmtSince(c.last_visit) + '</div>';

        // Col 5: Progression bar
        html += '<div class="cl-prog cl-prog-cell">';
        html += '<div class="prog-bar"><div class="prog-fill ' + progClass + '" style="width:' + c._progress + '%;"></div></div>';
        html += '<span class="prog-pct ' + progClass + '">' + c._progress + '%</span>';
        html += '</div>';

        html += '</div>';
      });

      body.innerHTML = html;
    }

    // ‚ïê‚ïê‚ïê DETAIL MODAL ‚ïê‚ïê‚ïê

    async function showDetail(mcId) {
      try {
        currentClientId = mcId;
        const data = await API.clients.getById(mcId);
        const c = data.client;
        const txs = data.transactions;

        const progress = Math.min(Math.round((c.points_balance / c.reward_threshold) * 100), 100);
        const progClass = progress >= 100 ? 'full' : '';

        document.getElementById('modal-title').textContent = c.name || c.email || c.phone || 'Client #' + mcId;

        let html = '';

        // Stats row
        html += '<div class="dt-stats">';
        html += '<div class="dt-st"><div class="dt-st-val">' + c.points_balance + '</div><div class="dt-st-lbl">Points</div></div>';
        html += '<div class="dt-st"><div class="dt-st-val">' + c.visit_count + '</div><div class="dt-st-lbl">Visites</div></div>';
        html += '<div class="dt-st"><div class="dt-st-val">' + Format.date(c.first_visit) + '</div><div class="dt-st-lbl">Depuis</div></div>';
        html += '</div>';

        // Progress
        html += '<div class="dt-prog-wrap">';
        html += '<div class="dt-prog-top"><span>Progression vers r√©compense</span><span>' + c.points_balance + '/' + c.reward_threshold + '</span></div>';
        html += '<div class="dt-prog-bar"><div class="dt-prog-fill ' + progClass + '" style="width:' + progress + '%;"></div></div>';
        if (c.can_redeem) {
          html += '<div class="dt-reward-banner" onclick="redeemReward(' + c.id + ')">üéÅ R√©compense disponible ‚Äî cliquez pour appliquer<br><small>' + esc(c.reward_description) + '</small></div>';
        }
        html += '</div>';

        // Timeline
        html += '<div class="dt-section">Historique</div>';
        if (txs.length === 0) {
          html += '<div class="tl-empty">Aucun historique</div>';
        } else {
          html += '<div class="tl">';
          txs.forEach(t => {
            const type = t.transaction_type;
            const sign = t.points_delta >= 0 ? '+' : '';
            const badges = { credit: 'cr√©dit', reward: 'r√©compense', adjustment: 'ajust.', merge: 'fusion' };
            const dt = new Date(t.created_at + 'Z');
            const dateStr = dt.toLocaleString('fr-FR', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit' });

            html += '<div class="tl-item ' + type + '">';
            html += '<div class="tl-date">' + dateStr + (t.staff_name ? ' ‚Äî ' + esc(t.staff_name) : '') + '</div>';
            html += '<div class="tl-body">';
            html += '<span class="tl-pts ' + type + '">' + sign + t.points_delta + ' pts</span>';
            if (t.amount) html += ' pour ' + Format.currency(t.amount);
            html += '<span class="tl-badge ' + type + '">' + (badges[type] || type) + '</span>';
            if (t.notes) html += '<div class="tl-notes">' + esc(t.notes) + '</div>';
            html += '</div>';
            html += '</div>';
          });
          html += '</div>';
        }

        document.getElementById('modal-body').innerHTML = html;

        // Footer actions
        let foot = '';
        if (staff.role === 'owner' || staff.role === 'manager') {
          foot += '<button class="act-btn" onclick="openAdjust()">üìè Ajuster</button>';
          if (c.is_blocked) {
            foot += '<button class="act-btn success" onclick="toggleBlock(false)">üîì D√©bloquer</button>';
          } else {
            foot += '<button class="act-btn danger" onclick="toggleBlock(true)">üîí Bloquer</button>';
          }
        }
        document.getElementById('modal-foot').innerHTML = foot;

        document.getElementById('detail-modal').classList.add('open');
      } catch (err) {
        console.error('Detail error:', err);
      }
    }

    function closeDetail() { document.getElementById('detail-modal').classList.remove('open'); }
    document.getElementById('detail-modal').addEventListener('click', (e) => {
      if (e.target.id === 'detail-modal') closeDetail();
    });

    // ‚ïê‚ïê‚ïê REWARD ‚ïê‚ïê‚ïê

    async function redeemReward(mcId) {
      if (!confirm('üéÅ Appliquer la r√©compense pour ce client ?')) return;
      try {
        await API.clients.reward({ merchantClientId: mcId });
        showDetail(mcId);
        loadClients();
      } catch (err) { alert(err.message); }
    }

    // ‚ïê‚ïê‚ïê BLOCK / UNBLOCK ‚ïê‚ïê‚ïê

    async function toggleBlock(block) {
      if (!currentClientId) return;
      const action = block ? 'bloquer' : 'd√©bloquer';
      if (!confirm((block ? 'üîí' : 'üîì') + ' Voulez-vous ' + action + ' ce client ?')) return;
      try {
        if (block) await API.clients.block(currentClientId);
        else await API.clients.unblock(currentClientId);
        closeDetail();
        loadClients();
      } catch (err) { alert(err.message); }
    }

    // ‚ïê‚ïê‚ïê ADJUST ‚ïê‚ïê‚ïê

    function openAdjust() {
      document.getElementById('adj-delta').value = '';
      document.getElementById('adj-reason').value = '';
      document.getElementById('adjust-alert').innerHTML = '';
      document.getElementById('adjust-modal').classList.add('open');
    }
    function closeAdjust() { document.getElementById('adjust-modal').classList.remove('open'); }
    document.getElementById('adjust-modal').addEventListener('click', (e) => {
      if (e.target.id === 'adjust-modal') closeAdjust();
    });

    async function submitAdjust() {
      const delta = parseInt(document.getElementById('adj-delta').value);
      const reason = document.getElementById('adj-reason').value.trim();
      const alertEl = document.getElementById('adjust-alert');

      if (!delta || delta === 0) {
        alertEl.innerHTML = '<div class="alert alert-error" style="font-size:0.78rem;">Ajustement requis</div>';
        return;
      }
      if (!reason) {
        alertEl.innerHTML = '<div class="alert alert-error" style="font-size:0.78rem;">Raison requise</div>';
        return;
      }

      try {
        await API.clients.adjust({
          merchantClientId: currentClientId,
          pointsDelta: delta,
          reason,
        });
        closeAdjust();
        showDetail(currentClientId);
        loadClients();
      } catch (err) {
        alertEl.innerHTML = '<div class="alert alert-error" style="font-size:0.78rem;">' + esc(err.message) + '</div>';
      }
    }

    // ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê

    loadClients();
  </script>
</body>
</html>
