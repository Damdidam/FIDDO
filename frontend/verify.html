<!DOCTYPE html>
<html lang="fr">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
 <meta name="theme-color" content="#0891B2">
 <title>FIDDO — Connexion</title>
 <link rel="icon" type="image/png" sizes="192x192" href="/app/assets/icon-192.png">
 <link rel="preconnect" href="https://fonts.googleapis.com">
 <link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,600,700,800&display=swap" rel="stylesheet">
 <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&display=swap" rel="stylesheet">
 <style>
 *{margin:0;padding:0;box-sizing:border-box}
 body{font-family:'Satoshi',-apple-system,BlinkMacSystemFont,sans-serif;background:linear-gradient(160deg,#060810 0%,#0a1a24 40%,#0e7490 100%);min-height:100vh;min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:24px;overflow:hidden}
 .orb{position:fixed;border-radius:50%;filter:blur(80px);opacity:.4;animation:orbFloat 8s ease-in-out infinite}
 .orb-1{width:300px;height:300px;background:radial-gradient(circle,#22d3ee,transparent 70%);top:-80px;right:-60px}
 .orb-2{width:250px;height:250px;background:radial-gradient(circle,#0891B2,transparent 70%);bottom:10%;left:-40px;animation-delay:2.5s}
 @keyframes orbFloat{0%,100%{transform:translate(0,0) scale(1)}50%{transform:translate(20px,-30px) scale(1.1)}}

 .card{position:relative;z-index:1;background:rgba(255,255,255,.08);backdrop-filter:blur(20px);border:1.5px solid rgba(255,255,255,.12);border-radius:28px;padding:48px 32px 40px;max-width:380px;width:100%;text-align:center}
 .logo-text{font-family:'Satoshi',-apple-system,sans-serif;font-size:32px;font-weight:800;color:#0891B2;letter-spacing:1px;margin:0 auto 24px}

 /* States */
 .state{display:none}
 .state.active{display:block}

 /* Loading */
 .spinner{width:40px;height:40px;border:3.5px solid rgba(255,255,255,.15);border-top-color:#22d3ee;border-radius:50%;animation:spin .7s linear infinite;margin:0 auto 20px}
 @keyframes spin{to{transform:rotate(360deg)}}
 h2{font-size:20px;font-weight:700;color:#fff;margin-bottom:8px}
 p{color:rgba(255,255,255,.6);font-size:14px;line-height:1.6}

 /* Success */
 .check{width:72px;height:72px;border-radius:50%;background:rgba(5,150,105,.2);display:flex;align-items:center;justify-content:center;margin:0 auto 20px;animation:popIn .5s cubic-bezier(.34,1.56,.64,1)}
 .check .material-symbols-rounded{font-size:40px;color:#34d399}
 @keyframes popIn{from{transform:scale(0)}to{transform:scale(1)}}

 .btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:16px;background:linear-gradient(135deg,#0891B2,#0e7490);color:#fff;font-size:16px;font-weight:700;border-radius:16px;border:none;cursor:pointer;margin-top:24px;box-shadow:0 4px 20px rgba(8,145,178,.3);text-decoration:none;transition:transform .15s}
 .btn:active{transform:scale(.97)}
 .btn .material-symbols-rounded{font-size:20px}

 .hint{margin-top:16px;font-size:12px;color:rgba(255,255,255,.35);line-height:1.5}

 /* Error */
 .err-icon{width:72px;height:72px;border-radius:50%;background:rgba(220,38,38,.2);display:flex;align-items:center;justify-content:center;margin:0 auto 20px}
 .err-icon .material-symbols-rounded{font-size:40px;color:#f87171}
 .err-msg{color:rgba(255,255,255,.5);font-size:14px;margin-top:8px}
 </style>
</head>
<body>
 <div class="orb orb-1"></div>
 <div class="orb orb-2"></div>

 <div class="card">
 <div class="logo-text">FIDDO</div>

 <!-- Loading -->
 <div id="state-loading" class="state active">
 <div class="spinner"></div>
 <h2>Connexion en cours…</h2>
 <p>Vérification de votre lien sécurisé</p>
 </div>

 <!-- Success -->
 <div id="state-success" class="state">
 <div class="check"><span class="material-symbols-rounded">check_circle</span></div>
 <h2>Connexion réussie !</h2>
 <p id="welcome-name"></p>
 <p class="hint" id="hint-app" style="display:none;color:rgba(52,211,153,.8);font-weight:600;font-size:15px;margin-top:20px">
 L'app FIDDO se connecte automatiquement.<br>Vous pouvez fermer cette page.
 </p>
 <a class="btn" href="/app/" id="btn-open-web">
 <span class="material-symbols-rounded">open_in_new</span>
 Ouvrir FIDDO
 </a>
 <p class="hint">Si vous avez installé l'app, ouvrez-la depuis votre écran d'accueil — vous serez connecté automatiquement.</p>
 </div>

 <!-- Error -->
 <div id="state-error" class="state">
 <div class="err-icon"><span class="material-symbols-rounded">error</span></div>
 <h2>Lien expiré</h2>
 <p class="err-msg" id="err-msg">Ce lien de connexion n'est plus valide. Demandez-en un nouveau.</p>
 <a class="btn" href="/app/">
 <span class="material-symbols-rounded">arrow_back</span>
 Retour à FIDDO
 </a>
 </div>
 </div>

 <script>
 (async function() {
 var parts = window.location.pathname.split('/');
 var magicToken = parts[parts.length - 1];

 if (!magicToken || magicToken === 'verify') {
 showError('Lien invalide');
 return;
 }

 try {
 var res = await fetch('/api/me/verify', {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({ token: magicToken })
 });

 var data = await res.json();

 if (!res.ok) {
 showError(data.error || 'Lien expiré ou déjà utilisé');
 return;
 }

 // Store JWT in cookie (shared between Safari and PWA on same domain)
 var jwt = data.token;
 var maxAge = 90 * 24 * 60 * 60; // 90 days
 document.cookie = 'fiddo_jwt=' + encodeURIComponent(jwt) + ';path=/;max-age=' + maxAge + ';SameSite=Lax;Secure';

 // Also store in localStorage for this browser context
 try { localStorage.setItem('fiddo_token', jwt); } catch(e) {}

 // Show success
 var name = (data.client && data.client.name) ? data.client.name.split(' ')[0] : '';
 document.getElementById('welcome-name').textContent = name
 ? 'Bienvenue ' + name + ' !'
 : 'Vous êtes connecté !';

 setState('success');

 // On Android: the native app is polling — show hint
 if (/android/i.test(navigator.userAgent)) {
 document.getElementById('hint-app').style.display = 'block';
 }

 } catch (e) {
 showError('Erreur réseau. Vérifiez votre connexion.');
 }
 })();

 function setState(id) {
 document.querySelectorAll('.state').forEach(function(s) { s.classList.remove('active'); });
 document.getElementById('state-' + id).classList.add('active');
 }

 function showError(msg) {
 document.getElementById('err-msg').textContent = msg;
 setState('error');
 }
 </script>
</body>
</html>
