<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard â€” FIDDO</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .admin-nav { background: #111827; }
    .merchant-row { cursor: pointer; }
    .merchant-row:hover td { background: #f0fdf4; }
    .status-pending { color: var(--warning); }
    .status-active { color: var(--success); }
    .status-suspended { color: var(--danger); }
    .status-rejected { color: var(--text-light); }
    .action-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; }

    /* Announcements */
    .ann-card {
      background: white;
      border-radius: 10px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      border-left: 4px solid var(--primary);
      position: relative;
    }
    .ann-card.priority-warning { border-left-color: var(--warning); }
    .ann-card.priority-urgent { border-left-color: var(--danger); }
    .ann-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
    .ann-title { font-weight: 700; font-size: 1rem; }
    .ann-meta { font-size: 0.8rem; color: var(--text-light); margin-bottom: 0.5rem; }
    .ann-content { font-size: 0.9rem; line-height: 1.5; color: var(--text); white-space: pre-wrap; }
    .ann-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
    .ann-targets { display: flex; gap: 0.3rem; flex-wrap: wrap; margin-top: 0.5rem; }
    .ann-target-chip {
      background: #e0f2fe;
      color: var(--primary-dark);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    /* Merchant checkbox list */
    .merchant-checklist {
      max-height: 200px;
      overflow-y: auto;
      border: 2px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem;
    }
    .merchant-check-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.3rem 0;
    }
    .merchant-check-item label { cursor: pointer; font-size: 0.9rem; }

    .tab-panels { min-height: 400px; }
  </style>
</head>
<body>
  <nav class="navbar admin-nav">
    <a href="/admin/dashboard" class="navbar-brand">FIDDO<span> Admin</span></a>
    <div class="navbar-menu">
      <button class="btn btn-outline btn-sm" onclick="adminLogout()">DÃ©connexion</button>
    </div>
  </nav>

  <div class="container">
    <h1 style="margin: 1.5rem 0;">Administration FIDDO</h1>

    <!-- Global Stats -->
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-value" id="s-merchants">-</div><div class="stat-label">Commerces</div></div>
      <div class="stat-card"><div class="stat-value" id="s-active">-</div><div class="stat-label">Actifs</div></div>
      <div class="stat-card"><div class="stat-value" id="s-pending">-</div><div class="stat-label">En attente</div></div>
      <div class="stat-card"><div class="stat-value" id="s-users">-</div><div class="stat-label">Clients</div></div>
      <div class="stat-card"><div class="stat-value" id="s-revenue">-</div><div class="stat-label">CA total</div></div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('pending')">â³ En attente</button>
      <button class="tab" onclick="switchTab('active')">âœ… Actifs</button>
      <button class="tab" onclick="switchTab('all')">ğŸ“‹ Tous</button>
      <button class="tab" onclick="switchTab('announcements')">ğŸ“¢ Annonces</button>
    </div>

    <div class="tab-panels">
      <div id="merchants-container"></div>
      <div id="announcements-container" style="display: none;"></div>
    </div>
  </div>

  <!-- Merchant Detail Modal -->
  <div id="merchant-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="mm-title">Commerce</h2>
        <button class="close-modal" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body" id="mm-body"></div>
      <div class="modal-footer" id="mm-footer"></div>
    </div>
  </div>

  <!-- Reject Modal -->
  <div id="reject-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Refuser le commerce</h2>
        <button class="close-modal" onclick="closeRejectModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div id="reject-alert"></div>
        <div class="form-group">
          <label class="form-label">Raison du refus</label>
          <input type="text" id="reject-reason" class="form-control" placeholder="Documents manquants, TVA invalide...">
        </div>
        <button class="btn btn-danger" onclick="submitReject()">Confirmer le refus</button>
      </div>
    </div>
  </div>

  <!-- Create/Edit Announcement Modal -->
  <div id="ann-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="ann-modal-title">Nouvelle annonce</h2>
        <button class="close-modal" onclick="closeAnnModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div id="ann-alert"></div>

        <div class="form-group">
          <label class="form-label">Titre *</label>
          <input type="text" id="ann-title" class="form-control" placeholder="Ex: Maintenance prÃ©vue ce weekend">
        </div>

        <div class="form-group">
          <label class="form-label">Contenu *</label>
          <textarea id="ann-content" class="form-control" rows="4" placeholder="DÃ©tails de l'annonce..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">PrioritÃ©</label>
          <select id="ann-priority" class="form-control">
            <option value="info">â„¹ï¸ Info</option>
            <option value="warning">âš ï¸ Important</option>
            <option value="urgent">ğŸš¨ Urgent</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Destinataires</label>
          <select id="ann-target" class="form-control" onchange="toggleMerchantList()">
            <option value="all">ğŸ“¢ Tous les commerces</option>
            <option value="selected">ğŸ¯ Commerces sÃ©lectionnÃ©s</option>
          </select>
        </div>

        <div class="form-group" id="merchant-list-group" style="display: none;">
          <label class="form-label">SÃ©lectionner les commerces</label>
          <div class="merchant-checklist" id="merchant-checklist"></div>
        </div>

        <div class="form-group">
          <label class="form-label">Date d'expiration (optionnel)</label>
          <input type="datetime-local" id="ann-expires" class="form-control">
          <small class="form-help">L'annonce disparaÃ®tra automatiquement aprÃ¨s cette date</small>
        </div>

        <button class="btn btn-primary btn-block" id="ann-submit-btn" onclick="submitAnnouncement()">Publier l'annonce</button>
      </div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    const ADMIN_API = API_BASE_URL + '/admin';
    let currentMerchantId = null;
    let currentTab = 'pending';
    let editingAnnouncementId = null;
    let activeMerchants = [];

    async function adminCall(endpoint, options = {}) {
      const config = { headers: { 'Content-Type': 'application/json' }, credentials: 'include', ...options };
      const resp = await fetch(`${ADMIN_API}${endpoint}`, config);
      if (resp.status === 401 || resp.status === 403) { window.location.href = '/admin'; return; }
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || 'Erreur');
      return data;
    }

    function adminLogout() {
      adminCall('/auth/logout', { method: 'POST' }).finally(() => window.location.href = '/admin');
    }

    // â”€â”€â”€ Stats â”€â”€â”€
    async function loadStats() {
      try {
        const s = await adminCall('/merchants/stats/global');
        document.getElementById('s-merchants').textContent = s.merchants.total;
        document.getElementById('s-active').textContent = s.merchants.active;
        document.getElementById('s-pending').textContent = s.merchants.pending;
        document.getElementById('s-users').textContent = s.endUsers;
        document.getElementById('s-revenue').textContent = Format.currency(s.revenue);
      } catch (e) { console.error(e); }
    }

    // â”€â”€â”€ Tabs â”€â”€â”€
    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      const merchantsEl = document.getElementById('merchants-container');
      const annEl = document.getElementById('announcements-container');

      if (tab === 'announcements') {
        merchantsEl.style.display = 'none';
        annEl.style.display = 'block';
        loadAnnouncements();
      } else {
        merchantsEl.style.display = 'block';
        annEl.style.display = 'none';
        loadMerchants();
      }
    }

    // â”€â”€â”€ Load Merchants â”€â”€â”€
    async function loadMerchants() {
      const container = document.getElementById('merchants-container');
      try {
        UI.showLoading('merchants-container');
        const qs = currentTab === 'all' ? '' : `?status=${currentTab}`;
        const data = await adminCall(`/merchants${qs}`);
        const merchants = data.merchants;

        if (merchants.length === 0) {
          UI.showEmptyState('merchants-container', 'ğŸª', 'Aucun commerce');
          return;
        }

        let html = `<table class="table"><thead><tr>
          <th>Commerce</th><th>PropriÃ©taire</th><th>TVA</th><th>Status</th><th>Clients</th><th>CrÃ©Ã© le</th>
        </tr></thead><tbody>`;

        merchants.forEach(m => {
          html += `<tr class="merchant-row" onclick="showMerchant(${m.id})">
            <td><strong>${m.business_name}</strong><br><small class="text-muted">${m.email}</small></td>
            <td>${m.owner_name || '-'}<br><small class="text-muted">${m.owner_email || '-'}</small></td>
            <td>${m.vat_number}</td>
            <td><span class="status-${m.status} badge badge-${m.status === 'active' ? 'success' : m.status === 'pending' ? 'warning' : m.status === 'suspended' ? 'danger' : 'neutral'}">${m.status}</span></td>
            <td>${m.client_count}</td>
            <td>${Format.date(m.created_at)}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (e) {
        UI.showError('merchants-container', e.message);
      }
    }

    // â”€â”€â”€ Merchant Detail â”€â”€â”€
    async function showMerchant(id) {
      try {
        currentMerchantId = id;
        const data = await adminCall(`/merchants/${id}`);
        const m = data.merchant;
        const staffList = data.staff;
        const stats = data.stats;

        document.getElementById('mm-title').textContent = m.business_name;

        let html = `
          <div class="stats-grid" style="margin-bottom: 1.5rem;">
            <div class="stat-card"><div class="stat-value">${stats.clients}</div><div class="stat-label">Clients</div></div>
            <div class="stat-card"><div class="stat-value">${Format.currency(stats.revenue)}</div><div class="stat-label">CA</div></div>
            <div class="stat-card"><div class="stat-value">${stats.transactions}</div><div class="stat-label">Transactions</div></div>
          </div>

          <h3 class="mb-1">Informations</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem; margin-bottom: 1.5rem;">
            <div><strong>Adresse :</strong> ${m.address}</div>
            <div><strong>TVA :</strong> ${m.vat_number}</div>
            <div><strong>Email :</strong> ${m.email}</div>
            <div><strong>TÃ©l :</strong> ${m.phone}</div>
            <div><strong>Status :</strong> <span class="badge badge-${m.status === 'active' ? 'success' : m.status === 'pending' ? 'warning' : 'danger'}">${m.status}</span></div>
            <div><strong>Inscrit :</strong> ${Format.datetime(m.created_at)}</div>
            <div><strong>Points/â‚¬ :</strong> ${m.points_per_euro}</div>
            <div><strong>RÃ©compense :</strong> ${m.points_for_reward} pts</div>
          </div>
          ${m.rejection_reason ? `<div class="alert alert-warning">Raison de refus : ${m.rejection_reason}</div>` : ''}

          <h3 class="mb-1">Ã‰quipe (${staffList.length})</h3>
        `;

        if (staffList.length > 0) {
          html += '<table class="table" style="margin-bottom: 0;"><thead><tr><th>Nom</th><th>Email</th><th>RÃ´le</th><th>Actif</th></tr></thead><tbody>';
          staffList.forEach(s => {
            html += `<tr>
              <td>${s.display_name}</td>
              <td>${s.email}</td>
              <td><span class="badge badge-info">${s.role}</span></td>
              <td>${s.is_active ? '<span class="badge badge-success">Oui</span>' : '<span class="badge badge-danger">Non</span>'}</td>
            </tr>`;
          });
          html += '</tbody></table>';
        } else {
          html += '<p class="text-muted">Aucun membre</p>';
        }

        document.getElementById('mm-body').innerHTML = html;

        let footer = '<div class="action-btns">';
        if (m.status === 'pending') {
          footer += `<button class="btn btn-success btn-sm" onclick="validateMerchant()">âœ… Valider</button>`;
          footer += `<button class="btn btn-danger btn-sm" onclick="showRejectModal()">âŒ Refuser</button>`;
        } else if (m.status === 'active') {
          footer += `<button class="btn btn-danger btn-sm" onclick="suspendMerchant()">â¸ï¸ Suspendre</button>`;
        } else if (m.status === 'suspended') {
          footer += `<button class="btn btn-success btn-sm" onclick="reactivateMerchant()">â–¶ï¸ RÃ©activer</button>`;
        }
        footer += '</div>';
        document.getElementById('mm-footer').innerHTML = footer;

        document.getElementById('merchant-modal').classList.add('active');
      } catch (e) {
        console.error(e);
      }
    }

    function closeModal() { document.getElementById('merchant-modal').classList.remove('active'); }
    document.getElementById('merchant-modal').addEventListener('click', (e) => { if (e.target.id === 'merchant-modal') closeModal(); });

    // â”€â”€â”€ Merchant Actions â”€â”€â”€
    async function validateMerchant() {
      if (!confirm('âœ… Valider et activer ce commerce ?')) return;
      try {
        await adminCall(`/merchants/${currentMerchantId}/validate`, { method: 'POST' });
        closeModal(); loadMerchants(); loadStats();
      } catch (e) { alert(e.message); }
    }

    function showRejectModal() { document.getElementById('reject-modal').classList.add('active'); }
    function closeRejectModal() { document.getElementById('reject-modal').classList.remove('active'); }
    document.getElementById('reject-modal').addEventListener('click', (e) => { if (e.target.id === 'reject-modal') closeRejectModal(); });

    async function submitReject() {
      const reason = document.getElementById('reject-reason').value.trim();
      try {
        await adminCall(`/merchants/${currentMerchantId}/reject`, {
          method: 'POST',
          body: JSON.stringify({ reason }),
        });
        closeRejectModal(); closeModal(); loadMerchants(); loadStats();
      } catch (e) { UI.showAlert('reject-alert', e.message, 'error'); }
    }

    async function suspendMerchant() {
      if (!confirm('â¸ï¸ Suspendre ce commerce ?')) return;
      try {
        await adminCall(`/merchants/${currentMerchantId}/suspend`, { method: 'POST' });
        closeModal(); loadMerchants(); loadStats();
      } catch (e) { alert(e.message); }
    }

    async function reactivateMerchant() {
      if (!confirm('â–¶ï¸ RÃ©activer ce commerce ?')) return;
      try {
        await adminCall(`/merchants/${currentMerchantId}/reactivate`, { method: 'POST' });
        closeModal(); loadMerchants(); loadStats();
      } catch (e) { alert(e.message); }
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ANNOUNCEMENTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadAnnouncements() {
      const container = document.getElementById('announcements-container');
      try {
        UI.showLoading('announcements-container');

        const data = await adminCall('/announcements');
        const anns = data.announcements;

        let html = `
          <div class="flex-between mb-2">
            <h2 style="margin: 0;">ğŸ“¢ Annonces (${anns.length})</h2>
            <button class="btn btn-primary btn-sm" onclick="showCreateAnn()">+ Nouvelle annonce</button>
          </div>
        `;

        if (anns.length === 0) {
          html += '<div class="empty-state"><div class="empty-state-icon">ğŸ“¢</div><p>Aucune annonce pour le moment</p></div>';
          container.innerHTML = html;
          return;
        }

        anns.forEach(a => {
          const prioIcons = { info: 'â„¹ï¸', warning: 'âš ï¸', urgent: 'ğŸš¨' };
          const isExpired = a.expires_at && new Date(a.expires_at) < new Date();

          html += `
            <div class="ann-card priority-${a.priority}" ${isExpired ? 'style="opacity: 0.5;"' : ''}>
              <div class="ann-header">
                <div>
                  <span class="ann-title">${prioIcons[a.priority]} ${a.title}</span>
                  ${isExpired ? '<span class="badge badge-neutral" style="margin-left: 0.5rem;">ExpirÃ©e</span>' : ''}
                </div>
                <div class="ann-actions">
                  <button class="btn btn-outline btn-sm" onclick="editAnnouncement(${a.id})">âœï¸</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteAnnouncement(${a.id})">ğŸ—‘ï¸</button>
                </div>
              </div>
              <div class="ann-meta">
                ${Format.datetime(a.created_at)} â€” par ${a.author_name}
                Â· <strong>${a.read_count}</strong> lecture(s)
                Â· ${a.target_type === 'all' ? 'ğŸ“¢ Tous' : `ğŸ¯ ${a.targets.length} commerce(s)`}
                ${a.expires_at ? ` Â· Expire le ${Format.datetime(a.expires_at)}` : ''}
              </div>
              <div class="ann-content">${a.content}</div>
              ${a.target_type === 'selected' && a.targets.length > 0 ? `
                <div class="ann-targets">
                  ${a.targets.map(t => `<span class="ann-target-chip">${t.business_name}</span>`).join('')}
                </div>
              ` : ''}
            </div>
          `;
        });

        container.innerHTML = html;
      } catch (e) {
        UI.showError('announcements-container', e.message);
      }
    }

    // â”€â”€â”€ Announcement Modal â”€â”€â”€

    function toggleMerchantList() {
      const val = document.getElementById('ann-target').value;
      document.getElementById('merchant-list-group').style.display = val === 'selected' ? 'block' : 'none';
      if (val === 'selected' && activeMerchants.length === 0) {
        loadMerchantChecklist();
      }
    }

    async function loadMerchantChecklist() {
      try {
        const data = await adminCall('/announcements/merchants');
        activeMerchants = data.merchants;
        const container = document.getElementById('merchant-checklist');
        if (activeMerchants.length === 0) {
          container.innerHTML = '<p class="text-muted text-sm">Aucun commerce actif</p>';
          return;
        }
        container.innerHTML = activeMerchants.map(m => `
          <div class="merchant-check-item">
            <input type="checkbox" id="mc-${m.id}" value="${m.id}" class="merchant-cb">
            <label for="mc-${m.id}">${m.business_name}</label>
          </div>
        `).join('');
      } catch (e) {
        console.error(e);
      }
    }

    function showCreateAnn() {
      editingAnnouncementId = null;
      document.getElementById('ann-modal-title').textContent = 'Nouvelle annonce';
      document.getElementById('ann-title').value = '';
      document.getElementById('ann-content').value = '';
      document.getElementById('ann-priority').value = 'info';
      document.getElementById('ann-target').value = 'all';
      document.getElementById('ann-expires').value = '';
      document.getElementById('merchant-list-group').style.display = 'none';
      document.getElementById('ann-submit-btn').textContent = 'Publier l\'annonce';
      UI.clearAlert('ann-alert');
      document.getElementById('ann-modal').classList.add('active');
    }

    async function editAnnouncement(id) {
      try {
        const data = await adminCall('/announcements');
        const ann = data.announcements.find(a => a.id === id);
        if (!ann) return;

        editingAnnouncementId = id;
        document.getElementById('ann-modal-title').textContent = 'Modifier l\'annonce';
        document.getElementById('ann-title').value = ann.title;
        document.getElementById('ann-content').value = ann.content;
        document.getElementById('ann-priority').value = ann.priority;
        document.getElementById('ann-target').value = ann.target_type;
        document.getElementById('ann-submit-btn').textContent = 'Mettre Ã  jour';

        if (ann.expires_at) {
          const d = new Date(ann.expires_at + 'Z');
          document.getElementById('ann-expires').value = d.toISOString().slice(0, 16);
        } else {
          document.getElementById('ann-expires').value = '';
        }

        if (ann.target_type === 'selected') {
          document.getElementById('merchant-list-group').style.display = 'block';
          await loadMerchantChecklist();
          // Pre-check targeted merchants
          const targetIds = ann.targets.map(t => t.merchant_id);
          document.querySelectorAll('.merchant-cb').forEach(cb => {
            cb.checked = targetIds.includes(parseInt(cb.value));
          });
        } else {
          document.getElementById('merchant-list-group').style.display = 'none';
        }

        UI.clearAlert('ann-alert');
        document.getElementById('ann-modal').classList.add('active');
      } catch (e) {
        console.error(e);
      }
    }

    function closeAnnModal() { document.getElementById('ann-modal').classList.remove('active'); }
    document.getElementById('ann-modal').addEventListener('click', (e) => { if (e.target.id === 'ann-modal') closeAnnModal(); });

    async function submitAnnouncement() {
      const title = document.getElementById('ann-title').value.trim();
      const content = document.getElementById('ann-content').value.trim();
      const priority = document.getElementById('ann-priority').value;
      const targetType = document.getElementById('ann-target').value;
      const expiresRaw = document.getElementById('ann-expires').value;

      if (!title || !content) {
        UI.showAlert('ann-alert', 'Titre et contenu requis', 'error');
        return;
      }

      const merchantIds = [];
      if (targetType === 'selected') {
        document.querySelectorAll('.merchant-cb:checked').forEach(cb => {
          merchantIds.push(parseInt(cb.value));
        });
        if (merchantIds.length === 0) {
          UI.showAlert('ann-alert', 'SÃ©lectionnez au moins un commerce', 'error');
          return;
        }
      }

      const payload = {
        title, content, priority,
        targetType,
        merchantIds,
        expiresAt: expiresRaw ? new Date(expiresRaw).toISOString() : null,
      };

      try {
        if (editingAnnouncementId) {
          await adminCall(`/announcements/${editingAnnouncementId}`, {
            method: 'PUT',
            body: JSON.stringify(payload),
          });
          UI.showAlert('ann-alert', 'Annonce mise Ã  jour !', 'success');
        } else {
          await adminCall('/announcements', {
            method: 'POST',
            body: JSON.stringify(payload),
          });
          UI.showAlert('ann-alert', 'Annonce publiÃ©e !', 'success');
        }

        setTimeout(() => {
          closeAnnModal();
          loadAnnouncements();
        }, 800);
      } catch (e) {
        UI.showAlert('ann-alert', e.message, 'error');
      }
    }

    async function deleteAnnouncement(id) {
      if (!confirm('ğŸ—‘ï¸ Supprimer cette annonce ?')) return;
      try {
        await adminCall(`/announcements/${id}`, { method: 'DELETE' });
        loadAnnouncements();
      } catch (e) {
        alert(e.message);
      }
    }


    // â”€â”€â”€ Init â”€â”€â”€
    loadStats();
    loadMerchants();
  </script>
</body>
</html>
