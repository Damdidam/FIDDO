<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard â€” FIDDO</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .admin-nav { background: #111827; }
    .merchant-row { cursor: pointer; }
    .merchant-row:hover td { background: #f0fdf4; }
    .status-pending { color: var(--warning); }
    .status-active { color: var(--success); }
    .status-suspended { color: var(--danger); }
    .status-rejected { color: var(--text-light); }
    .action-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; }

    /* Health card */
    .health-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }
    .health-item {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    }
    .health-item .label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-light);
      margin-bottom: 0.25rem;
    }
    .health-item .value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text);
    }
    .health-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 0.4rem;
      vertical-align: middle;
    }
    .health-dot.ok { background: var(--success); box-shadow: 0 0 6px rgba(16,185,129,0.4); }
    .health-dot.down { background: var(--danger); box-shadow: 0 0 6px rgba(239,68,68,0.4); }

    /* Backup section */
    .backup-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }
    .backup-row:last-child { border-bottom: none; }
    .backup-row:hover { background: var(--light); }
    .backup-info { display: flex; flex-direction: column; gap: 0.15rem; }
    .backup-name { font-weight: 600; font-size: 0.9rem; font-family: monospace; }
    .backup-meta { font-size: 0.8rem; color: var(--text-light); }
    .backup-actions { display: flex; gap: 0.5rem; }
    .backup-config {
      display: flex;
      gap: 1.5rem;
      font-size: 0.85rem;
      color: var(--text-light);
      margin-bottom: 1rem;
      padding: 0.75rem 1rem;
      background: var(--light);
      border-radius: 6px;
    }
    .backup-config strong { color: var(--text); }
  </style>
</head>
<body>
  <nav class="navbar admin-nav">
    <a href="/admin/dashboard" class="navbar-brand">FIDDO<span> Admin</span></a>
    <div class="navbar-menu">
      <button class="btn btn-outline btn-sm" onclick="adminLogout()">DÃ©connexion</button>
    </div>
  </nav>

  <div class="container">
    <h1 style="margin: 1.5rem 0;">Administration FIDDO</h1>

    <!-- â•â•â• HEALTH CHECK â•â•â• -->
    <div class="card" id="health-card">
      <div class="card-header">
        ğŸ©º SantÃ© du systÃ¨me
        <button class="btn btn-outline btn-sm" onclick="loadHealth()">ğŸ”„ RafraÃ®chir</button>
      </div>
      <div class="health-grid" id="health-grid">
        <div class="health-item">
          <div class="label">Statut</div>
          <div class="value" id="h-status"><span class="health-dot down"></span>...</div>
        </div>
        <div class="health-item">
          <div class="label">Version</div>
          <div class="value" id="h-version">-</div>
        </div>
        <div class="health-item">
          <div class="label">Serveur</div>
          <div class="value" id="h-time">-</div>
        </div>
        <div class="health-item">
          <div class="label">Backups</div>
          <div class="value" id="h-backups">-</div>
        </div>
        <div class="health-item">
          <div class="label">Dernier backup</div>
          <div class="value" id="h-last-backup">-</div>
        </div>
      </div>
    </div>

    <!-- â•â•â• GLOBAL STATS â•â•â• -->
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-value" id="s-merchants">-</div><div class="stat-label">Commerces</div></div>
      <div class="stat-card"><div class="stat-value" id="s-active">-</div><div class="stat-label">Actifs</div></div>
      <div class="stat-card"><div class="stat-value" id="s-pending">-</div><div class="stat-label">En attente</div></div>
      <div class="stat-card"><div class="stat-value" id="s-users">-</div><div class="stat-label">Clients</div></div>
      <div class="stat-card"><div class="stat-value" id="s-revenue">-</div><div class="stat-label">CA total</div></div>
    </div>

    <!-- â•â•â• TABS â•â•â• -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('pending')">â³ En attente</button>
      <button class="tab" onclick="switchTab('active')">âœ… Actifs</button>
      <button class="tab" onclick="switchTab('all')">ğŸ“‹ Tous</button>
      <button class="tab" onclick="switchTab('backups')">ğŸ’¾ Backups</button>
    </div>

    <div id="merchants-container"></div>
    <div id="backups-container" style="display: none;"></div>
  </div>

  <!-- â•â•â• MERCHANT DETAIL MODAL â•â•â• -->
  <div id="merchant-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="mm-title">Commerce</h2>
        <button class="close-modal" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body" id="mm-body"></div>
      <div class="modal-footer" id="mm-footer"></div>
    </div>
  </div>

  <!-- â•â•â• REJECT MODAL â•â•â• -->
  <div id="reject-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Refuser le commerce</h2>
        <button class="close-modal" onclick="closeRejectModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div id="reject-alert"></div>
        <div class="form-group">
          <label class="form-label">Raison du refus</label>
          <input type="text" id="reject-reason" class="form-control" placeholder="Documents manquants, TVA invalide...">
        </div>
        <button class="btn btn-danger" onclick="submitReject()">Confirmer le refus</button>
      </div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    const ADMIN_API = API_BASE_URL + '/admin';
    let currentMerchantId = null;
    let currentTab = 'pending';

    async function adminCall(endpoint, options = {}) {
      const config = { headers: { 'Content-Type': 'application/json' }, credentials: 'include', ...options };
      const resp = await fetch(`${ADMIN_API}${endpoint}`, config);
      if (resp.status === 401 || resp.status === 403) { window.location.href = '/admin'; return; }
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || 'Erreur');
      return data;
    }

    function adminLogout() {
      adminCall('/auth/logout', { method: 'POST' }).finally(() => window.location.href = '/admin');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HEALTH CHECK
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadHealth() {
      try {
        // Health endpoint (public)
        const health = await fetch(API_BASE_URL + '/health', { credentials: 'include' }).then(r => r.json());

        document.getElementById('h-status').innerHTML =
          health.status === 'ok'
            ? '<span class="health-dot ok"></span>En ligne'
            : '<span class="health-dot down"></span>ProblÃ¨me';

        document.getElementById('h-version').textContent = health.version || '-';
        document.getElementById('h-time').textContent = health.timestamp
          ? new Date(health.timestamp).toLocaleTimeString('fr-FR')
          : '-';

        // Backup info
        try {
          const bk = await adminCall('/backups');
          document.getElementById('h-backups').textContent = bk.count + ' / ' + bk.config.maxKeep;

          if (bk.backups.length > 0) {
            const last = bk.backups[0];
            const ago = Format.timeSince(last.created);
            document.getElementById('h-last-backup').textContent = ago;
          } else {
            document.getElementById('h-last-backup').textContent = 'Aucun';
          }
        } catch (e) {
          document.getElementById('h-backups').textContent = '-';
          document.getElementById('h-last-backup').textContent = '-';
        }
      } catch (e) {
        document.getElementById('h-status').innerHTML = '<span class="health-dot down"></span>Hors ligne';
        console.error('Health check error:', e);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STATS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadStats() {
      try {
        const s = await adminCall('/merchants/stats/global');
        document.getElementById('s-merchants').textContent = s.merchants.total;
        document.getElementById('s-active').textContent = s.merchants.active;
        document.getElementById('s-pending').textContent = s.merchants.pending;
        document.getElementById('s-users').textContent = s.endUsers;
        document.getElementById('s-revenue').textContent = Format.currency(s.revenue);
      } catch (e) { console.error(e); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TABS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function switchTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      if (tab === 'backups') {
        document.getElementById('merchants-container').style.display = 'none';
        document.getElementById('backups-container').style.display = 'block';
        loadBackups();
      } else {
        document.getElementById('merchants-container').style.display = 'block';
        document.getElementById('backups-container').style.display = 'none';
        loadMerchants();
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MERCHANTS LIST
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadMerchants() {
      const container = document.getElementById('merchants-container');
      try {
        UI.showLoading('merchants-container');
        const qs = currentTab === 'all' ? '' : `?status=${currentTab}`;
        const data = await adminCall(`/merchants${qs}`);
        const merchants = data.merchants;

        if (merchants.length === 0) {
          UI.showEmptyState('merchants-container', 'ğŸª', 'Aucun commerce');
          return;
        }

        let html = `<table class="table"><thead><tr>
          <th>Commerce</th><th>PropriÃ©taire</th><th>TVA</th><th>Status</th><th>Clients</th><th>CrÃ©Ã© le</th>
        </tr></thead><tbody>`;

        merchants.forEach(m => {
          html += `<tr class="merchant-row" onclick="showMerchant(${m.id})">
            <td><strong>${m.business_name}</strong><br><small class="text-muted">${m.email}</small></td>
            <td>${m.owner_name || '-'}<br><small class="text-muted">${m.owner_email || '-'}</small></td>
            <td>${m.vat_number}</td>
            <td><span class="status-${m.status} badge badge-${m.status === 'active' ? 'success' : m.status === 'pending' ? 'warning' : m.status === 'suspended' ? 'danger' : 'neutral'}">${m.status}</span></td>
            <td>${m.client_count}</td>
            <td>${Format.date(m.created_at)}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (e) {
        UI.showError('merchants-container', e.message);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BACKUPS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadBackups() {
      const container = document.getElementById('backups-container');
      try {
        UI.showLoading('backups-container');
        const data = await adminCall('/backups');

        let html = `
          <div class="card" style="padding-bottom: 0;">
            <div class="card-header">
              ğŸ’¾ Gestion des backups
              <button class="btn btn-primary btn-sm" onclick="createManualBackup()">+ Backup manuel</button>
            </div>

            <div class="backup-config">
              <span>â° FrÃ©quence : <strong>toutes les ${data.config.intervalHours}h</strong></span>
              <span>ğŸ“¦ RÃ©tention : <strong>${data.config.maxKeep} derniers</strong></span>
              <span>ğŸ’¾ Total : <strong>${data.count} backup${data.count > 1 ? 's' : ''}</strong></span>
            </div>
        `;

        if (data.backups.length === 0) {
          html += '<div class="empty-state" style="padding: 2rem;"><div class="empty-state-icon">ğŸ’¾</div><p>Aucun backup disponible</p></div>';
        } else {
          data.backups.forEach(b => {
            const trigger = b.filename.includes('_manual') ? 'ğŸ–ï¸ Manuel'
              : b.filename.includes('_scheduled') ? 'â° Auto'
              : b.filename.includes('_startup') ? 'ğŸš€ DÃ©marrage'
              : 'ğŸ“¦';

            html += `
              <div class="backup-row">
                <div class="backup-info">
                  <span class="backup-name">${b.filename}</span>
                  <span class="backup-meta">${trigger} Â· ${b.sizeMB} MB Â· ${Format.datetime(b.created)}</span>
                </div>
                <div class="backup-actions">
                  <button class="btn btn-outline btn-sm" onclick="downloadBackup('${b.filename}')">â¬‡ï¸ TÃ©lÃ©charger</button>
                  <button class="btn btn-danger btn-sm" onclick="deleteBackup('${b.filename}')">ğŸ—‘ï¸</button>
                </div>
              </div>
            `;
          });
        }

        html += '</div>';
        container.innerHTML = html;
      } catch (e) {
        UI.showError('backups-container', e.message);
      }
    }

    async function createManualBackup() {
      if (!confirm('CrÃ©er un backup manuel maintenant ?')) return;
      try {
        const result = await adminCall('/backups', { method: 'POST' });
        alert(`âœ… Backup crÃ©Ã© : ${result.backup.filename} (${result.backup.sizeMB} MB)`);
        loadBackups();
        loadHealth();
      } catch (e) {
        alert('âŒ Erreur : ' + e.message);
      }
    }

    function downloadBackup(filename) {
      window.location.href = `${ADMIN_API}/backups/${encodeURIComponent(filename)}/download`;
    }

    async function deleteBackup(filename) {
      if (!confirm(`Supprimer le backup "${filename}" ?\nCette action est irrÃ©versible.`)) return;
      try {
        await adminCall(`/backups/${encodeURIComponent(filename)}`, { method: 'DELETE' });
        loadBackups();
        loadHealth();
      } catch (e) {
        alert('âŒ Erreur : ' + e.message);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MERCHANT DETAIL MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function showMerchant(id) {
      try {
        currentMerchantId = id;
        const data = await adminCall(`/merchants/${id}`);
        const m = data.merchant;
        const staffList = data.staff;
        const stats = data.stats;

        document.getElementById('mm-title').textContent = m.business_name;

        let html = `
          <div class="stats-grid" style="margin-bottom: 1.5rem;">
            <div class="stat-card"><div class="stat-value">${stats.clients}</div><div class="stat-label">Clients</div></div>
            <div class="stat-card"><div class="stat-value">${Format.currency(stats.revenue)}</div><div class="stat-label">CA</div></div>
            <div class="stat-card"><div class="stat-value">${stats.transactions}</div><div class="stat-label">Transactions</div></div>
          </div>

          <h3 class="mb-1">Informations</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.9rem; margin-bottom: 1.5rem;">
            <div><strong>Adresse :</strong> ${m.address}</div>
            <div><strong>TVA :</strong> ${m.vat_number}</div>
            <div><strong>Email :</strong> ${m.email}</div>
            <div><strong>TÃ©l :</strong> ${m.phone}</div>
            <div><strong>Status :</strong> <span class="badge badge-${m.status === 'active' ? 'success' : m.status === 'pending' ? 'warning' : 'danger'}">${m.status}</span></div>
            <div><strong>Inscrit :</strong> ${Format.datetime(m.created_at)}</div>
            <div><strong>Points/â‚¬ :</strong> ${m.points_per_euro}</div>
            <div><strong>RÃ©compense :</strong> ${m.points_for_reward} pts</div>
          </div>
          ${m.rejection_reason ? `<div class="alert alert-warning">Raison de refus : ${m.rejection_reason}</div>` : ''}

          <h3 class="mb-1">Ã‰quipe (${staffList.length})</h3>
        `;

        if (staffList.length > 0) {
          html += '<table class="table" style="margin-bottom: 0;"><thead><tr><th>Nom</th><th>Email</th><th>RÃ´le</th><th>Actif</th></tr></thead><tbody>';
          staffList.forEach(s => {
            html += `<tr>
              <td>${s.display_name}</td>
              <td>${s.email}</td>
              <td><span class="badge badge-info">${s.role}</span></td>
              <td>${s.is_active ? '<span class="badge badge-success">Oui</span>' : '<span class="badge badge-danger">Non</span>'}</td>
            </tr>`;
          });
          html += '</tbody></table>';
        } else {
          html += '<p class="text-muted">Aucun membre</p>';
        }

        document.getElementById('mm-body').innerHTML = html;

        // Action buttons based on status
        let footer = '<div class="action-btns">';
        if (m.status === 'pending') {
          footer += `<button class="btn btn-success btn-sm" onclick="validateMerchant()">âœ… Valider</button>`;
          footer += `<button class="btn btn-danger btn-sm" onclick="showRejectModal()">âŒ Refuser</button>`;
        } else if (m.status === 'active') {
          footer += `<button class="btn btn-danger btn-sm" onclick="suspendMerchant()">â¸ï¸ Suspendre</button>`;
        } else if (m.status === 'suspended') {
          footer += `<button class="btn btn-success btn-sm" onclick="reactivateMerchant()">â–¶ï¸ RÃ©activer</button>`;
        }
        footer += '</div>';
        document.getElementById('mm-footer').innerHTML = footer;

        document.getElementById('merchant-modal').classList.add('active');
      } catch (e) {
        console.error(e);
      }
    }

    function closeModal() { document.getElementById('merchant-modal').classList.remove('active'); }
    document.getElementById('merchant-modal').addEventListener('click', (e) => { if (e.target.id === 'merchant-modal') closeModal(); });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MERCHANT ACTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function validateMerchant() {
      if (!confirm('âœ… Valider et activer ce commerce ?')) return;
      try {
        await adminCall(`/merchants/${currentMerchantId}/validate`, { method: 'POST' });
        closeModal(); loadMerchants(); loadStats();
      } catch (e) { alert(e.message); }
    }

    function showRejectModal() { document.getElementById('reject-modal').classList.add('active'); }
    function closeRejectModal() { document.getElementById('reject-modal').classList.remove('active'); }
    document.getElementById('reject-modal').addEventListener('click', (e) => { if (e.target.id === 'reject-modal') closeRejectModal(); });

    async function submitReject() {
      const reason = document.getElementById('reject-reason').value.trim();
      try {
        await adminCall(`/merchants/${currentMerchantId}/reject`, {
          method: 'POST',
          body: JSON.stringify({ reason }),
        });
        closeRejectModal(); closeModal(); loadMerchants(); loadStats();
      } catch (e) { UI.showAlert('reject-alert', e.message, 'error'); }
    }

    async function suspendMerchant() {
      if (!confirm('â¸ï¸ Suspendre ce commerce ? Tous les comptes staff seront dÃ©sactivÃ©s.')) return;
      try {
        await adminCall(`/merchants/${currentMerchantId}/suspend`, { method: 'POST' });
        closeModal(); loadMerchants(); loadStats();
      } catch (e) { alert(e.message); }
    }

    async function reactivateMerchant() {
      if (!confirm('â–¶ï¸ RÃ©activer ce commerce ?')) return;
      try {
        await adminCall(`/merchants/${currentMerchantId}/reactivate`, { method: 'POST' });
        closeModal(); loadMerchants(); loadStats();
      } catch (e) { alert(e.message); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    loadHealth();
    loadStats();
    loadMerchants();

    // Auto-refresh health every 60s
    setInterval(loadHealth, 60000);
  </script>
</body>
</html>
