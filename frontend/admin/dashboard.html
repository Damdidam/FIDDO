<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard ‚Äî FIDDO</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{font-family:'DM Sans',sans-serif}
    :root{--g-from:#1F2937;--g-to:#111827;--gradient:linear-gradient(135deg,var(--g-from),var(--g-to));--primary:#0891B2;--primary-light:#ECFEFF;--primary-dark:#0E7490;--slate-900:#0F172A;--slate-700:#334155;--slate-500:#64748B;--slate-400:#94A3B8;--slate-200:#E2E8F0;--slate-100:#F1F5F9;--slate-50:#F8FAFC;--green-600:#059669;--green-100:#D1FAE5;--red-600:#DC2626;--red-100:#FEE2E2;--amber-600:#D97706;--amber-100:#FEF3C7;--blue-600:#2563EB;--blue-100:#DBEAFE;--radius:10px}
    body{background:var(--slate-50);color:var(--slate-900)}

    .admin-nav{background:#111827}

    /* ‚îÄ‚îÄ‚îÄ Hero ‚îÄ‚îÄ‚îÄ‚îÄ */
    .adm-hero{background:var(--gradient);padding:2rem 2rem 1.6rem;color:#fff;position:relative;overflow:hidden}
    .adm-hero::before{content:'';position:absolute;top:-40%;right:-10%;width:300px;height:300px;background:rgba(255,255,255,.04);border-radius:50%}
    .adm-hero-title{font-size:1.5rem;font-weight:700;margin:0 0 .25rem}
    .adm-hero-sub{font-size:.82rem;opacity:.7;margin:0}

    /* ‚îÄ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ */
    .adm-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:.75rem;margin:-1.8rem 2rem 0;position:relative;z-index:2}
    .adm-stat{background:#fff;border:1.5px solid var(--slate-200);border-radius:var(--radius);padding:1rem 1.2rem;text-align:center;transition:transform .15s}
    .adm-stat:hover{transform:translateY(-2px)}
    .adm-stat-val{font-size:1.6rem;font-weight:700;color:var(--primary)}
    .adm-stat-lbl{font-size:.6rem;text-transform:uppercase;letter-spacing:.5px;color:var(--slate-400);margin-top:.1rem}

    /* ‚îÄ‚îÄ‚îÄ Main Tabs ‚îÄ */
    .main-tabs{display:flex;gap:.5rem;padding:1.5rem 2rem .5rem;flex-wrap:wrap}
    .main-tab{display:inline-flex;align-items:center;gap:.4rem;padding:.6rem 1.15rem;font-size:.78rem;font-weight:600;color:var(--slate-500);background:#fff;border:1.5px solid var(--slate-200);border-radius:8px;cursor:pointer;transition:all .15s}
    .main-tab:hover{border-color:var(--primary);color:var(--primary)}
    .main-tab.active{border-color:var(--primary);background:var(--primary-light);color:var(--primary)}
    .main-tab .cnt{font-size:.6rem;background:var(--slate-200);color:var(--slate-500);padding:1px 6px;border-radius:10px;margin-left:.15rem}
    .main-tab.active .cnt{background:var(--primary);color:#fff}

    /* ‚îÄ‚îÄ‚îÄ Content ‚îÄ‚îÄ */
    .adm-wrap{max-width:1200px;margin:0 auto;padding:1rem 2rem 3rem}
    .panel{display:none}
    .panel.active{display:block}

    /* ‚îÄ‚îÄ‚îÄ Sub-tabs ‚îÄ‚îÄ */
    .sub-tabs{display:flex;gap:.4rem;padding-bottom:1rem;border-bottom:1.5px solid var(--slate-200);margin-bottom:1.2rem;flex-wrap:wrap}
    .sub-tab{padding:.45rem .9rem;font-size:.72rem;font-weight:600;color:var(--slate-500);background:none;border:none;border-bottom:2.5px solid transparent;cursor:pointer;margin-bottom:-1.5px;transition:all .15s}
    .sub-tab:hover{color:var(--primary)}
    .sub-tab.active{color:var(--primary);border-bottom-color:var(--primary)}

    /* ‚îÄ‚îÄ‚îÄ Card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .adm-card{background:#fff;border:1.5px solid var(--slate-200);border-radius:var(--radius);padding:1.2rem 1.5rem;margin-bottom:1rem}
    .adm-card-title{font-size:.85rem;font-weight:700;color:var(--slate-900);margin-bottom:1rem}

    /* ‚îÄ‚îÄ‚îÄ Form ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .fg{margin-bottom:1rem}
    .fg label{display:block;font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--slate-500);margin-bottom:.35rem}
    .fg input,.fg select,.fg textarea{width:100%;padding:.55rem .75rem;border:1.5px solid var(--slate-200);border-radius:8px;font-size:.82rem;font-family:inherit;transition:border-color .2s}
    .fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--primary)}
    .fg textarea{resize:vertical;min-height:80px}
    .fg .help{font-size:.62rem;color:var(--slate-400);margin-top:.25rem}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}

    /* ‚îÄ‚îÄ‚îÄ Type pills ‚îÄ */
    .type-pills{display:flex;gap:.4rem;flex-wrap:wrap}
    .type-pill{padding:.4rem .85rem;font-size:.7rem;font-weight:600;border:1.5px solid var(--slate-200);border-radius:8px;background:#fff;cursor:pointer;transition:all .15s}
    .type-pill:hover{border-color:var(--primary)}
    .type-pill.active{border-color:var(--primary);background:var(--primary-light);color:var(--primary)}
    .type-pill.t-info.active{border-color:var(--blue-600);background:var(--blue-100);color:var(--blue-600)}
    .type-pill.t-maint.active{border-color:var(--amber-600);background:var(--amber-100);color:var(--amber-600)}
    .type-pill.t-urgent.active{border-color:var(--red-600);background:var(--red-100);color:var(--red-600)}

    /* ‚îÄ‚îÄ‚îÄ Target ‚îÄ‚îÄ‚îÄ‚îÄ */
    .target-section{margin-top:.75rem;padding:.75rem;background:var(--slate-50);border-radius:8px;border:1px solid var(--slate-200);display:none}
    .target-section.visible{display:block}
    .merch-chips{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.5rem}
    .merch-chip{padding:.3rem .7rem;font-size:.68rem;font-weight:600;border:1.5px solid var(--slate-200);border-radius:20px;cursor:pointer;transition:all .15s}
    .merch-chip:hover{border-color:var(--primary)}
    .merch-chip.selected{border-color:var(--primary);background:var(--primary-light);color:var(--primary)}

    /* ‚îÄ‚îÄ‚îÄ Save btn ‚îÄ‚îÄ */
    .save-btn{display:inline-flex;align-items:center;gap:.4rem;padding:.6rem 1.4rem;background:linear-gradient(135deg,var(--primary),#06B6D4);color:#fff;border:none;border-radius:8px;font-size:.75rem;font-weight:700;cursor:pointer;transition:all .2s;font-family:inherit}
    .save-btn:hover{opacity:.9;transform:translateY(-1px)}
    .save-btn:disabled{opacity:.45;transform:none;cursor:not-allowed}
    .save-btn.red{background:linear-gradient(135deg,var(--red-600),#F87171)}
    .save-btn.green{background:linear-gradient(135deg,var(--green-600),#34D399)}
    .save-row{display:flex;justify-content:flex-end;gap:.5rem;margin-top:1rem}

    /* ‚îÄ‚îÄ‚îÄ Alert ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .adm-alert{padding:.6rem 1rem;border-radius:8px;font-size:.78rem;font-weight:500;margin-bottom:1rem;border-left:3px solid}
    .adm-alert.success{background:var(--green-100);color:var(--green-600);border-color:var(--green-600)}
    .adm-alert.error{background:var(--red-100);color:var(--red-600);border-color:var(--red-600)}

    /* ‚îÄ‚îÄ‚îÄ Tables ‚îÄ‚îÄ‚îÄ‚îÄ */
    .adm-table{width:100%;border-collapse:collapse;font-size:.75rem}
    .adm-table thead{background:var(--slate-100)}
    .adm-table th{text-align:left;padding:.6rem .75rem;font-weight:600;font-size:.65rem;text-transform:uppercase;letter-spacing:.5px;color:var(--slate-500);border-bottom:1.5px solid var(--slate-200)}
    .adm-table td{padding:.6rem .75rem;border-bottom:1px solid var(--slate-100);color:var(--slate-700)}
    .adm-table tbody tr:hover{background:var(--slate-50)}
    .adm-table tbody tr.clickable{cursor:pointer}
    .adm-table tbody tr.clickable:hover td{background:#f0fdf4}

    .badge-sm{display:inline-block;padding:1px 8px;border-radius:10px;font-size:.6rem;font-weight:700;text-transform:uppercase}
    .badge-sm.info{background:var(--blue-100);color:var(--blue-600)}
    .badge-sm.warning{background:var(--amber-100);color:var(--amber-600)}
    .badge-sm.critical,.badge-sm.urgent{background:var(--red-100);color:var(--red-600)}
    .badge-sm.active{background:var(--green-100);color:var(--green-600)}
    .badge-sm.pending{background:var(--amber-100);color:var(--amber-600)}
    .badge-sm.suspended{background:var(--red-100);color:var(--red-600)}
    .badge-sm.rejected,.badge-sm.cancelled{background:var(--slate-100);color:var(--slate-500)}
    .badge-sm.paid{background:var(--green-100);color:var(--green-600)}
    .badge-sm.overdue{background:var(--red-100);color:var(--red-600)}

    .del-btn{background:none;border:none;color:var(--red-600);cursor:pointer;font-size:.72rem;font-weight:600;padding:.2rem .5rem;border-radius:4px}
    .del-btn:hover{background:var(--red-100)}
    .edit-btn{background:none;border:none;color:var(--primary);cursor:pointer;font-size:.72rem;font-weight:600;padding:.2rem .5rem;border-radius:4px}
    .edit-btn:hover{background:var(--primary-light)}
    .status-select{padding:.2rem .4rem;font-size:.68rem;border:1px solid var(--slate-200);border-radius:4px;font-family:inherit}

    /* ‚îÄ‚îÄ‚îÄ File upload ‚îÄ */
    .file-zone{border:2px dashed var(--slate-200);border-radius:8px;padding:1.5rem;text-align:center;cursor:pointer;transition:all .2s}
    .file-zone:hover,.file-zone.drag{border-color:var(--primary);background:var(--primary-light)}
    .file-zone p{font-size:.75rem;color:var(--slate-400);margin:.3rem 0 0}
    .file-name{font-size:.72rem;color:var(--primary);font-weight:600;margin-top:.5rem}

    /* ‚îÄ‚îÄ‚îÄ Empty ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .adm-empty{text-align:center;padding:2.5rem 1.5rem;color:var(--slate-400);font-size:.82rem}

    /* ‚îÄ‚îÄ‚îÄ Responsive ‚îÄ */
    @media(max-width:768px){
      .adm-hero{padding:1.4rem 1.2rem}
      .adm-stats{margin:-1.5rem 1rem 0;grid-template-columns:repeat(2,1fr)}
      .main-tabs{padding:1.2rem 1rem .5rem}
      .adm-wrap{padding:1rem 1.2rem 2rem}
      .form-row{grid-template-columns:1fr}
      .adm-table{font-size:.7rem}
      .adm-table th,.adm-table td{padding:.45rem .5rem}
    }
  </style>
</head>
<body>
  <nav class="navbar admin-nav">
    <a href="/admin/dashboard" class="navbar-brand">FIDDO<span> Admin</span></a>
    <div class="navbar-menu">
      <button class="btn btn-outline btn-sm" onclick="adminLogout()">D√©connexion</button>
    </div>
  </nav>

  <!-- Hero -->
  <div class="adm-hero">
    <div class="adm-hero-title">Administration FIDDO</div>
    <div class="adm-hero-sub">Commerces, annonces et facturation</div>
  </div>

  <!-- Stats -->
  <div class="adm-stats">
    <div class="adm-stat"><div class="adm-stat-val" id="s-merchants">-</div><div class="adm-stat-lbl">Commerces</div></div>
    <div class="adm-stat"><div class="adm-stat-val" id="s-active">-</div><div class="adm-stat-lbl">Actifs</div></div>
    <div class="adm-stat"><div class="adm-stat-val" id="s-pending">-</div><div class="adm-stat-lbl">En attente</div></div>
    <div class="adm-stat"><div class="adm-stat-val" id="s-users">-</div><div class="adm-stat-lbl">Clients</div></div>
    <div class="adm-stat"><div class="adm-stat-val" id="s-revenue">-</div><div class="adm-stat-lbl">CA total</div></div>
  </div>

  <!-- Main Tabs -->
  <div class="main-tabs">
    <button class="main-tab active" onclick="switchMain('merchants',this)">üè™ Commerces</button>
    <button class="main-tab" onclick="switchMain('annonces',this)">üì¢ Annonces</button>
    <button class="main-tab" onclick="switchMain('factures',this)">üßæ Factures</button>
  </div>

  <div class="adm-wrap">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- PANEL: MERCHANTS                           -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel active" id="panel-merchants">
      <div class="sub-tabs">
        <button class="sub-tab active" onclick="switchMerchantSub('pending',this)">‚è≥ En attente</button>
        <button class="sub-tab" onclick="switchMerchantSub('active',this)">‚úÖ Actifs</button>
        <button class="sub-tab" onclick="switchMerchantSub('all',this)">üìã Tous</button>
      </div>
      <div id="merchants-container"></div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- PANEL: ANNONCES                            -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-annonces">
      <div class="sub-tabs">
        <button class="sub-tab active" onclick="switchAnnSub('compose',this)">‚úèÔ∏è Nouvelle</button>
        <button class="sub-tab" onclick="switchAnnSub('history',this)">üìã Historique</button>
      </div>

      <!-- Compose -->
      <div id="ann-sub-compose">
        <div class="adm-card">
          <div class="adm-card-title">R√©diger une annonce</div>
          <div id="compose-alert"></div>

          <div class="fg">
            <label>Type</label>
            <div class="type-pills">
              <div class="type-pill t-info active" onclick="pickType('info',this)">‚ÑπÔ∏è Information</div>
              <div class="type-pill t-maint" onclick="pickType('warning',this)">‚ö†Ô∏è Maintenance</div>
              <div class="type-pill t-urgent" onclick="pickType('critical',this)">üö® Urgent</div>
            </div>
          </div>

          <div class="fg">
            <label>Titre</label>
            <input type="text" id="ann-title" placeholder="Mise √† jour de la plateforme..." maxlength="200">
          </div>

          <div class="fg">
            <label>Contenu</label>
            <textarea id="ann-content" rows="5" placeholder="D√©tails du message..."></textarea>
          </div>

          <div class="fg">
            <label>Destinataires</label>
            <div class="type-pills">
              <div class="type-pill active" onclick="pickTarget('all',this)">üì¢ Tous les commerces</div>
              <div class="type-pill" onclick="pickTarget('selected',this)">üéØ S√©lection</div>
            </div>
            <div class="target-section" id="target-section">
              <label style="font-size:.68rem;color:var(--slate-500);display:block;margin-bottom:.4rem">S√©lectionnez les commerces :</label>
              <div class="merch-chips" id="merchant-chips"></div>
            </div>
          </div>

          <div class="fg">
            <label>Date d'expiration (optionnel)</label>
            <input type="datetime-local" id="ann-expires">
            <div class="help">Sans expiration = visible ind√©finiment (jusqu'√† suppression)</div>
          </div>

          <div class="save-row">
            <button class="save-btn" id="ann-submit-btn" onclick="submitAnnouncement()">Publier l'annonce</button>
          </div>
        </div>
      </div>

      <!-- History -->
      <div id="ann-sub-history" style="display:none">
        <div class="adm-card" style="padding:.5rem">
          <div id="ann-history"></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- PANEL: FACTURES                            -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-factures">
      <div class="sub-tabs">
        <button class="sub-tab active" onclick="switchInvSub('new',this)">‚ûï Nouvelle</button>
        <button class="sub-tab" onclick="switchInvSub('list',this)">üìã Toutes</button>
      </div>

      <!-- New Invoice -->
      <div id="inv-sub-new">
        <div class="adm-card">
          <div class="adm-card-title">Cr√©er une facture</div>
          <div id="invoice-alert"></div>

          <div class="fg">
            <label>Commerce</label>
            <select id="inv-merchant"><option value="">-- S√©lectionner --</option></select>
          </div>

          <div class="form-row">
            <div class="fg">
              <label>Mois</label>
              <input type="month" id="inv-month">
            </div>
            <div class="fg">
              <label>Montant (EUR)</label>
              <input type="number" id="inv-amount" step="0.01" min="0.01" placeholder="49.00">
            </div>
          </div>

          <div class="fg">
            <label>Libell√©</label>
            <input type="text" id="inv-label" placeholder="Abonnement FIDDO - Janvier 2026" maxlength="200">
          </div>

          <div class="fg">
            <label>Statut</label>
            <div class="type-pills">
              <div class="type-pill active" onclick="pickInvStatus('pending',this)">En attente</div>
              <div class="type-pill" onclick="pickInvStatus('paid',this)">Pay√©e</div>
              <div class="type-pill" onclick="pickInvStatus('overdue',this)">En retard</div>
            </div>
          </div>

          <div class="fg">
            <label>Document PDF (optionnel)</label>
            <div class="file-zone" id="pdf-zone" onclick="document.getElementById('pdf-input').click()">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--slate-400)" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
              <p>Cliquez ou glissez un PDF ici</p>
              <div class="file-name" id="pdf-name" style="display:none"></div>
            </div>
            <input type="file" id="pdf-input" accept=".pdf" style="display:none" onchange="handlePDF(this)">
          </div>

          <div class="fg">
            <label>Notes (optionnel)</label>
            <input type="text" id="inv-notes" placeholder="Remarque pour le marchand...">
          </div>

          <div class="save-row">
            <button class="save-btn" onclick="createInvoice()">Cr√©er la facture</button>
          </div>
        </div>
      </div>

      <!-- Invoice List -->
      <div id="inv-sub-list" style="display:none">
        <div class="adm-card" style="padding:.5rem">
          <div id="inv-list"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- ‚ïê‚ïê‚ïê Merchant Detail Modal ‚ïê‚ïê‚ïê -->
  <div id="merchant-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="mm-title">Commerce</h2>
        <button class="close-modal" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body" id="mm-body"></div>
      <div class="modal-footer" id="mm-footer"></div>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê Reject Modal ‚ïê‚ïê‚ïê -->
  <div id="reject-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Refuser le commerce</h2>
        <button class="close-modal" onclick="closeRejectModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div id="reject-alert"></div>
        <div class="fg">
          <label>Raison du refus</label>
          <input type="text" id="reject-reason" placeholder="Documents manquants, TVA invalide...">
        </div>
        <div class="save-row">
          <button class="save-btn red" onclick="submitReject()">Confirmer le refus</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    const ADMIN_API = API_BASE_URL + '/admin';
    let currentMerchantId = null;
    let merchantSubTab = 'pending';
    let editingAnnId = null;

    // Announcement state
    let selectedPriority = 'info';
    let selectedTarget = 'all';
    let selectedMerchantIds = [];
    let allMerchants = [];

    // Invoice state
    let selectedInvStatus = 'pending';
    let pdfBase64 = null;
    let pdfFileName = null;

    async function adminCall(endpoint, options = {}) {
      const config = { headers: { 'Content-Type': 'application/json' }, credentials: 'include', ...options };
      const resp = await fetch(`${ADMIN_API}${endpoint}`, config);
      if (resp.status === 401 || resp.status === 403) { window.location.href = '/admin'; return; }
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || 'Erreur');
      return data;
    }

    function adminLogout() {
      adminCall('/auth/logout', { method: 'POST' }).finally(() => window.location.href = '/admin');
    }

    function showAlert(id, msg, type) {
      document.getElementById(id).innerHTML = `<div class="adm-alert ${type}">${msg}</div>`;
    }
    function clearAlert(id) { document.getElementById(id).innerHTML = ''; }

    function esc(str) {
      if (!str) return '';
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  MAIN TABS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function switchMain(tab, btn) {
      document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('panel-' + tab).classList.add('active');

      if (tab === 'merchants') loadMerchants();
      if (tab === 'annonces') { /* stays on current sub */ }
      if (tab === 'factures') { /* stays on current sub */ }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  STATS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async function loadStats() {
      try {
        const s = await adminCall('/merchants/stats/global');
        document.getElementById('s-merchants').textContent = s.merchants.total;
        document.getElementById('s-active').textContent = s.merchants.active;
        document.getElementById('s-pending').textContent = s.merchants.pending;
        document.getElementById('s-users').textContent = s.endUsers;
        document.getElementById('s-revenue').textContent = Format.currency(s.revenue);
      } catch (e) { console.error(e); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  MERCHANTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function switchMerchantSub(sub, btn) {
      merchantSubTab = sub;
      btn.closest('.sub-tabs').querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      loadMerchants();
    }

    async function loadMerchants() {
      const container = document.getElementById('merchants-container');
      try {
        container.innerHTML = '<div class="adm-empty">Chargement...</div>';
        const qs = merchantSubTab === 'all' ? '' : `?status=${merchantSubTab}`;
        const data = await adminCall(`/merchants${qs}`);
        const merchants = data.merchants;

        if (merchants.length === 0) {
          container.innerHTML = '<div class="adm-empty">üè™ Aucun commerce</div>';
          return;
        }

        let html = `<table class="adm-table"><thead><tr>
          <th>Commerce</th><th>Propri√©taire</th><th>TVA</th><th>Statut</th><th>Clients</th><th>Cr√©√© le</th>
        </tr></thead><tbody>`;

        merchants.forEach(m => {
          html += `<tr class="clickable" onclick="showMerchant(${m.id})">
            <td><strong>${esc(m.business_name)}</strong><br><span style="font-size:.65rem;color:var(--slate-400)">${esc(m.email)}</span></td>
            <td>${esc(m.owner_name) || '-'}<br><span style="font-size:.65rem;color:var(--slate-400)">${esc(m.owner_email) || '-'}</span></td>
            <td>${esc(m.vat_number)}</td>
            <td><span class="badge-sm ${m.status}">${m.status}</span></td>
            <td>${m.client_count}</td>
            <td>${Format.date(m.created_at)}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (e) {
        container.innerHTML = `<div class="adm-alert error">${e.message}</div>`;
      }
    }

    async function showMerchant(id) {
      try {
        currentMerchantId = id;
        const data = await adminCall(`/merchants/${id}`);
        const m = data.merchant;
        const staffList = data.staff;
        const stats = data.stats;

        document.getElementById('mm-title').textContent = m.business_name;

        let html = `
          <div class="stats-grid" style="margin-bottom:1.5rem">
            <div class="stat-card"><div class="stat-value">${stats.clients}</div><div class="stat-label">Clients</div></div>
            <div class="stat-card"><div class="stat-value">${Format.currency(stats.revenue)}</div><div class="stat-label">CA</div></div>
            <div class="stat-card"><div class="stat-value">${stats.transactions}</div><div class="stat-label">Transactions</div></div>
          </div>
          <h3 class="mb-1">Informations</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;font-size:.9rem;margin-bottom:1.5rem">
            <div><strong>Adresse :</strong> ${esc(m.address)}</div>
            <div><strong>TVA :</strong> ${esc(m.vat_number)}</div>
            <div><strong>Email :</strong> ${esc(m.email)}</div>
            <div><strong>T√©l :</strong> ${esc(m.phone)}</div>
            <div><strong>Status :</strong> <span class="badge badge-${m.status === 'active' ? 'success' : m.status === 'pending' ? 'warning' : 'danger'}">${m.status}</span></div>
            <div><strong>Inscrit :</strong> ${Format.datetime(m.created_at)}</div>
            <div><strong>Points/‚Ç¨ :</strong> ${m.points_per_euro}</div>
            <div><strong>R√©compense :</strong> ${m.points_for_reward} pts</div>
          </div>
          ${m.rejection_reason ? `<div class="alert alert-warning">Raison de refus : ${esc(m.rejection_reason)}</div>` : ''}
          <h3 class="mb-1">√âquipe (${staffList.length})</h3>`;

        if (staffList.length > 0) {
          html += '<table class="table" style="margin-bottom:0"><thead><tr><th>Nom</th><th>Email</th><th>R√¥le</th><th>Actif</th></tr></thead><tbody>';
          staffList.forEach(s => {
            html += `<tr><td>${esc(s.display_name)}</td><td>${esc(s.email)}</td>
              <td><span class="badge badge-info">${s.role}</span></td>
              <td>${s.is_active ? '<span class="badge badge-success">Oui</span>' : '<span class="badge badge-danger">Non</span>'}</td></tr>`;
          });
          html += '</tbody></table>';
        } else {
          html += '<p class="text-muted">Aucun membre</p>';
        }

        document.getElementById('mm-body').innerHTML = html;

        let footer = '<div class="action-btns">';
        if (m.status === 'pending') {
          footer += `<button class="btn btn-success btn-sm" onclick="validateMerchant()">‚úÖ Valider</button>`;
          footer += `<button class="btn btn-danger btn-sm" onclick="showRejectModal()">‚ùå Refuser</button>`;
        } else if (m.status === 'active') {
          footer += `<button class="btn btn-danger btn-sm" onclick="suspendMerchant()">‚è∏Ô∏è Suspendre</button>`;
        } else if (m.status === 'suspended') {
          footer += `<button class="btn btn-success btn-sm" onclick="reactivateMerchant()">‚ñ∂Ô∏è R√©activer</button>`;
        }
        footer += '</div>';
        document.getElementById('mm-footer').innerHTML = footer;

        document.getElementById('merchant-modal').classList.add('active');
      } catch (e) { console.error(e); }
    }

    function closeModal() { document.getElementById('merchant-modal').classList.remove('active'); }
    document.getElementById('merchant-modal').addEventListener('click', e => { if (e.target.id === 'merchant-modal') closeModal(); });

    async function validateMerchant() {
      if (!confirm('‚úÖ Valider et activer ce commerce ?')) return;
      try { await adminCall(`/merchants/${currentMerchantId}/validate`, { method: 'POST' }); closeModal(); loadMerchants(); loadStats(); }
      catch (e) { alert(e.message); }
    }
    function showRejectModal() { document.getElementById('reject-modal').classList.add('active'); }
    function closeRejectModal() { document.getElementById('reject-modal').classList.remove('active'); }
    document.getElementById('reject-modal').addEventListener('click', e => { if (e.target.id === 'reject-modal') closeRejectModal(); });

    async function submitReject() {
      const reason = document.getElementById('reject-reason').value.trim();
      try {
        await adminCall(`/merchants/${currentMerchantId}/reject`, { method: 'POST', body: JSON.stringify({ reason }) });
        closeRejectModal(); closeModal(); loadMerchants(); loadStats();
      } catch (e) { showAlert('reject-alert', e.message, 'error'); }
    }
    async function suspendMerchant() {
      if (!confirm('‚è∏Ô∏è Suspendre ce commerce ?')) return;
      try { await adminCall(`/merchants/${currentMerchantId}/suspend`, { method: 'POST' }); closeModal(); loadMerchants(); loadStats(); }
      catch (e) { alert(e.message); }
    }
    async function reactivateMerchant() {
      if (!confirm('‚ñ∂Ô∏è R√©activer ce commerce ?')) return;
      try { await adminCall(`/merchants/${currentMerchantId}/reactivate`, { method: 'POST' }); closeModal(); loadMerchants(); loadStats(); }
      catch (e) { alert(e.message); }
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  ANNOUNCEMENTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function switchAnnSub(sub, btn) {
      btn.closest('.sub-tabs').querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('ann-sub-compose').style.display = sub === 'compose' ? 'block' : 'none';
      document.getElementById('ann-sub-history').style.display = sub === 'history' ? 'block' : 'none';
      if (sub === 'history') loadAnnHistory();
    }

    function pickType(t, el) {
      selectedPriority = t;
      el.closest('.type-pills').querySelectorAll('.type-pill').forEach(p => p.classList.remove('active'));
      el.classList.add('active');
    }

    function pickTarget(t, el) {
      selectedTarget = t;
      el.closest('.type-pills').querySelectorAll('.type-pill').forEach(p => p.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('target-section').classList.toggle('visible', t === 'selected');
      if (t === 'selected' && allMerchants.length === 0) loadMerchantChips();
    }

    async function loadMerchantChips() {
      try {
        const data = await adminCall('/announcements/merchants');
        allMerchants = data.merchants;
        const container = document.getElementById('merchant-chips');
        container.innerHTML = allMerchants.map(m =>
          `<div class="merch-chip" data-id="${m.id}" onclick="toggleChip(${m.id},this)">${esc(m.business_name)}</div>`
        ).join('');
      } catch (e) { console.error(e); }
    }

    function toggleChip(id, el) {
      el.classList.toggle('selected');
      if (selectedMerchantIds.includes(id)) {
        selectedMerchantIds = selectedMerchantIds.filter(x => x !== id);
      } else {
        selectedMerchantIds.push(id);
      }
    }

    function resetComposeForm() {
      editingAnnId = null;
      document.getElementById('ann-title').value = '';
      document.getElementById('ann-content').value = '';
      document.getElementById('ann-expires').value = '';
      selectedPriority = 'info';
      selectedTarget = 'all';
      selectedMerchantIds = [];
      document.getElementById('target-section').classList.remove('visible');
      document.getElementById('ann-submit-btn').textContent = "Publier l'annonce";
      // Reset pills
      document.querySelectorAll('#ann-sub-compose .type-pill').forEach(p => p.classList.remove('active'));
      document.querySelector('.t-info').classList.add('active');
      document.querySelector('#ann-sub-compose .type-pills:nth-of-type(1)').closest('.fg').nextElementSibling.nextElementSibling.nextElementSibling.querySelector('.type-pill:first-child').classList.add('active');
    }

    async function submitAnnouncement() {
      clearAlert('compose-alert');
      const title = document.getElementById('ann-title').value.trim();
      const content = document.getElementById('ann-content').value.trim();
      const expiresRaw = document.getElementById('ann-expires').value;

      if (!title) { showAlert('compose-alert', 'Titre requis', 'error'); return; }
      if (!content) { showAlert('compose-alert', 'Contenu requis', 'error'); return; }
      if (selectedTarget === 'selected' && selectedMerchantIds.length === 0) {
        showAlert('compose-alert', 'S√©lectionnez au moins un commerce', 'error'); return;
      }

      const payload = {
        title, content,
        priority: selectedPriority,
        targetType: selectedTarget,
        merchantIds: selectedMerchantIds,
        expiresAt: expiresRaw ? new Date(expiresRaw).toISOString() : null,
      };

      try {
        if (editingAnnId) {
          await adminCall(`/announcements/${editingAnnId}`, { method: 'PUT', body: JSON.stringify(payload) });
          showAlert('compose-alert', 'Annonce mise √† jour', 'success');
        } else {
          await adminCall('/announcements', { method: 'POST', body: JSON.stringify(payload) });
          showAlert('compose-alert', 'Annonce publi√©e !', 'success');
        }

        // Reset
        document.getElementById('ann-title').value = '';
        document.getElementById('ann-content').value = '';
        document.getElementById('ann-expires').value = '';
        editingAnnId = null;
        document.getElementById('ann-submit-btn').textContent = "Publier l'annonce";
        selectedMerchantIds = [];
      } catch (e) {
        showAlert('compose-alert', e.message, 'error');
      }
    }

    async function loadAnnHistory() {
      const container = document.getElementById('ann-history');
      try {
        const data = await adminCall('/announcements');
        const anns = data.announcements;

        if (anns.length === 0) {
          container.innerHTML = '<div class="adm-empty">Aucune annonce publi√©e</div>';
          return;
        }

        const prioLabels = { info: 'info', warning: 'warning', critical: 'urgent' };

        let html = `<table class="adm-table"><thead><tr>
          <th>Date</th><th>Type</th><th>Titre</th><th>Cible</th><th>Lu</th><th></th>
        </tr></thead><tbody>`;

        anns.forEach(a => {
          const d = new Date(a.created_at + 'Z');
          const target = a.target_type === 'all'
            ? 'Tous'
            : a.targets.map(t => t.business_name).join(', ');
          const isExpired = a.expires_at && new Date(a.expires_at) < new Date();

          html += `<tr ${isExpired ? 'style="opacity:.5"' : ''}>
            <td>${d.toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'})}</td>
            <td><span class="badge-sm ${a.priority}">${prioLabels[a.priority]}</span></td>
            <td style="font-weight:600;max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
              ${esc(a.title)}${isExpired ? ' <span style="color:var(--slate-400);font-weight:400;font-size:.6rem">EXPIR√âE</span>' : ''}
            </td>
            <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${target}</td>
            <td>${a.read_count}</td>
            <td>
              <button class="edit-btn" onclick="editAnnouncement(${a.id})">Modifier</button>
              <button class="del-btn" onclick="deleteAnnouncement(${a.id})">Supprimer</button>
            </td>
          </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (e) {
        container.innerHTML = `<div class="adm-alert error">${e.message}</div>`;
      }
    }

    async function editAnnouncement(id) {
      try {
        const data = await adminCall('/announcements');
        const ann = data.announcements.find(a => a.id === id);
        if (!ann) return;

        editingAnnId = id;
        document.getElementById('ann-title').value = ann.title;
        document.getElementById('ann-content').value = ann.content;
        document.getElementById('ann-submit-btn').textContent = "Mettre √† jour";

        // Priority
        selectedPriority = ann.priority;
        document.querySelectorAll('#ann-sub-compose .t-info, #ann-sub-compose .t-maint, #ann-sub-compose .t-urgent').forEach(p => p.classList.remove('active'));
        const prioMap = { info: '.t-info', warning: '.t-maint', critical: '.t-urgent' };
        document.querySelector(`#ann-sub-compose ${prioMap[ann.priority]}`)?.classList.add('active');

        // Target
        selectedTarget = ann.target_type === 'selected' ? 'selected' : 'all';

        // Expires
        if (ann.expires_at) {
          const d = new Date(ann.expires_at + 'Z');
          document.getElementById('ann-expires').value = d.toISOString().slice(0, 16);
        } else {
          document.getElementById('ann-expires').value = '';
        }

        if (ann.target_type === 'selected') {
          document.getElementById('target-section').classList.add('visible');
          await loadMerchantChips();
          const targetIds = ann.targets.map(t => t.merchant_id);
          selectedMerchantIds = [...targetIds];
          document.querySelectorAll('.merch-chip').forEach(el => {
            if (targetIds.includes(parseInt(el.dataset.id))) el.classList.add('selected');
          });
        }

        // Switch to compose sub-tab
        document.querySelectorAll('#panel-annonces .sub-tab').forEach(t => t.classList.remove('active'));
        document.querySelector('#panel-annonces .sub-tab:first-child').classList.add('active');
        document.getElementById('ann-sub-compose').style.display = 'block';
        document.getElementById('ann-sub-history').style.display = 'none';

        clearAlert('compose-alert');
      } catch (e) { console.error(e); }
    }

    async function deleteAnnouncement(id) {
      if (!confirm('üóëÔ∏è Supprimer cette annonce ?')) return;
      try { await adminCall(`/announcements/${id}`, { method: 'DELETE' }); loadAnnHistory(); }
      catch (e) { alert(e.message); }
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  INVOICES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function switchInvSub(sub, btn) {
      btn.closest('.sub-tabs').querySelectorAll('.sub-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('inv-sub-new').style.display = sub === 'new' ? 'block' : 'none';
      document.getElementById('inv-sub-list').style.display = sub === 'list' ? 'block' : 'none';
      if (sub === 'list') loadInvoiceList();
    }

    function pickInvStatus(s, el) {
      selectedInvStatus = s;
      el.closest('.type-pills').querySelectorAll('.type-pill').forEach(p => p.classList.remove('active'));
      el.classList.add('active');
    }

    function handlePDF(input) {
      const file = input.files[0];
      if (!file) return;
      if (file.type !== 'application/pdf') { alert('PDF uniquement'); return; }
      if (file.size > 8 * 1024 * 1024) { alert('Taille max : 8 Mo'); return; }
      pdfFileName = file.name;
      const reader = new FileReader();
      reader.onload = () => {
        pdfBase64 = reader.result.split(',')[1];
        document.getElementById('pdf-name').textContent = file.name;
        document.getElementById('pdf-name').style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    // Drag & drop
    const pdfZone = document.getElementById('pdf-zone');
    pdfZone.addEventListener('dragover', e => { e.preventDefault(); pdfZone.classList.add('drag'); });
    pdfZone.addEventListener('dragleave', () => pdfZone.classList.remove('drag'));
    pdfZone.addEventListener('drop', e => {
      e.preventDefault();
      pdfZone.classList.remove('drag');
      const file = e.dataTransfer.files[0];
      if (file) {
        const dt = new DataTransfer();
        dt.items.add(file);
        document.getElementById('pdf-input').files = dt.files;
        handlePDF(document.getElementById('pdf-input'));
      }
    });

    async function createInvoice() {
      clearAlert('invoice-alert');
      const merchantId = document.getElementById('inv-merchant').value;
      const month = document.getElementById('inv-month').value;
      const amount = document.getElementById('inv-amount').value;
      const label = document.getElementById('inv-label').value.trim();
      const notes = document.getElementById('inv-notes').value.trim();

      if (!merchantId) { showAlert('invoice-alert', 'S√©lectionnez un commerce', 'error'); return; }
      if (!month) { showAlert('invoice-alert', 'Mois requis', 'error'); return; }
      if (!amount || parseFloat(amount) <= 0) { showAlert('invoice-alert', 'Montant invalide', 'error'); return; }
      if (!label) { showAlert('invoice-alert', 'Libell√© requis', 'error'); return; }

      try {
        await adminCall('/messages/invoices', {
          method: 'POST',
          body: JSON.stringify({
            merchantId: parseInt(merchantId), month, label,
            amount: parseFloat(amount),
            status: selectedInvStatus,
            fileBase64: pdfBase64, fileName: pdfFileName,
            notes: notes || undefined,
          }),
        });
        showAlert('invoice-alert', 'Facture cr√©√©e', 'success');
        document.getElementById('inv-month').value = '';
        document.getElementById('inv-amount').value = '';
        document.getElementById('inv-label').value = '';
        document.getElementById('inv-notes').value = '';
        pdfBase64 = null; pdfFileName = null;
        document.getElementById('pdf-name').style.display = 'none';
        document.getElementById('pdf-input').value = '';
      } catch (e) {
        showAlert('invoice-alert', e.message, 'error');
      }
    }

    async function loadInvoiceList() {
      const container = document.getElementById('inv-list');
      try {
        const data = await adminCall('/messages/invoices');
        const invs = data.invoices;

        if (invs.length === 0) {
          container.innerHTML = '<div class="adm-empty">Aucune facture</div>';
          return;
        }

        let html = `<table class="adm-table"><thead><tr>
          <th>Commerce</th><th>Mois</th><th>Libell√©</th><th>Montant</th><th>Statut</th><th></th>
        </tr></thead><tbody>`;

        invs.forEach(inv => {
          html += `<tr>
            <td style="font-weight:600">${esc(inv.business_name)}</td>
            <td>${esc(inv.month)}</td>
            <td>${esc(inv.label)}</td>
            <td style="font-weight:600">${Format.currency(inv.amount)}</td>
            <td>
              <select class="status-select" onchange="updateInvStatus(${inv.id},this.value)">
                <option value="pending"${inv.status==='pending'?' selected':''}>En attente</option>
                <option value="paid"${inv.status==='paid'?' selected':''}>Pay√©e</option>
                <option value="overdue"${inv.status==='overdue'?' selected':''}>En retard</option>
              </select>
            </td>
            <td><button class="del-btn" onclick="deleteInvoice(${inv.id})">Supprimer</button></td>
          </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (e) {
        container.innerHTML = `<div class="adm-alert error">${e.message}</div>`;
      }
    }

    async function updateInvStatus(id, status) {
      try { await adminCall(`/messages/invoices/${id}/status`, { method: 'PATCH', body: JSON.stringify({ status }) }); }
      catch (e) { alert(e.message); loadInvoiceList(); }
    }

    async function deleteInvoice(id) {
      if (!confirm('Supprimer cette facture ?')) return;
      try { await adminCall(`/messages/invoices/${id}`, { method: 'DELETE' }); loadInvoiceList(); }
      catch (e) { alert(e.message); }
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    loadStats();
    loadMerchants();

    // Pre-load merchant list for invoice dropdown
    (async () => {
      try {
        const data = await adminCall('/merchants?status=active');
        allMerchants = data.merchants;
        const sel = document.getElementById('inv-merchant');
        allMerchants.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.business_name;
          sel.appendChild(opt);
        });
      } catch (e) { console.error(e); }
    })();
  </script>
</body>
</html>
