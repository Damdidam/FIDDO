<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Messages &amp; Factures — FIDDO Admin</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{font-family:'DM Sans',sans-serif}
    :root{--g-from:#1F2937;--g-to:#111827;--gradient:linear-gradient(135deg,var(--g-from),var(--g-to));--primary:#0891B2;--primary-light:#ECFEFF;--slate-900:#0F172A;--slate-700:#334155;--slate-500:#64748B;--slate-400:#94A3B8;--slate-200:#E2E8F0;--slate-100:#F1F5F9;--slate-50:#F8FAFC;--green-600:#059669;--green-100:#D1FAE5;--red-600:#DC2626;--red-100:#FEE2E2;--amber-600:#D97706;--amber-100:#FEF3C7;--blue-600:#2563EB;--blue-100:#DBEAFE;--radius:10px}
    body{background:var(--slate-50);color:var(--slate-900)}
    .admin-nav{background:#111827}

    /* ─── Hero ──── */
    .adm-hero{background:var(--gradient);padding:2rem;color:#fff}
    .adm-hero-title{font-size:1.4rem;font-weight:700;margin:0 0 .25rem}
    .adm-hero-sub{font-size:.82rem;opacity:.7;margin:0}

    /* ─── Tabs ──── */
    .adm-tabs{display:flex;gap:.5rem;padding:1.2rem 2rem 0;background:#fff;border-bottom:1.5px solid var(--slate-200)}
    .adm-tab{display:inline-flex;align-items:center;gap:.4rem;padding:.55rem 1rem;font-size:.75rem;font-weight:600;color:var(--slate-500);background:none;border:none;border-bottom:2.5px solid transparent;cursor:pointer;margin-bottom:-1.5px;transition:all .2s}
    .adm-tab:hover{color:var(--primary)}
    .adm-tab.active{color:var(--primary);border-bottom-color:var(--primary)}

    /* ─── Content ── */
    .adm-wrap{max-width:1200px;margin:0 auto;padding:1.5rem 2rem 3rem}
    .tab-panel{display:none}
    .tab-panel.active{display:block}

    /* ─── Cards ──── */
    .adm-card{background:#fff;border:1.5px solid var(--slate-200);border-radius:var(--radius);padding:1.2rem 1.5rem;margin-bottom:1rem}
    .adm-card-title{font-size:.85rem;font-weight:700;color:var(--slate-900);margin-bottom:1rem}

    /* ─── Form ───── */
    .fg{margin-bottom:1rem}
    .fg label{display:block;font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--slate-500);margin-bottom:.35rem}
    .fg input,.fg select,.fg textarea{width:100%;padding:.55rem .75rem;border:1.5px solid var(--slate-200);border-radius:8px;font-size:.82rem;font-family:inherit;transition:border-color .2s}
    .fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--primary)}
    .fg textarea{resize:vertical;min-height:80px}
    .fg .help{font-size:.62rem;color:var(--slate-400);margin-top:.25rem}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:1rem}

    /* ─── Type pills ─ */
    .type-pills{display:flex;gap:.4rem;flex-wrap:wrap}
    .type-pill{padding:.4rem .85rem;font-size:.7rem;font-weight:600;border:1.5px solid var(--slate-200);border-radius:8px;background:#fff;cursor:pointer;transition:all .15s}
    .type-pill:hover{border-color:var(--primary)}
    .type-pill.active{border-color:var(--primary);background:var(--primary-light);color:var(--primary)}
    .type-pill.t-info.active{border-color:var(--blue-600);background:var(--blue-100);color:var(--blue-600)}
    .type-pill.t-maint.active{border-color:var(--amber-600);background:var(--amber-100);color:var(--amber-600)}
    .type-pill.t-urgent.active{border-color:var(--red-600);background:var(--red-100);color:var(--red-600)}

    /* ─── Target ──── */
    .target-section{margin-top:.75rem;padding:.75rem;background:var(--slate-50);border-radius:8px;border:1px solid var(--slate-200);display:none}
    .target-section.visible{display:block}
    .merch-chips{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.5rem}
    .merch-chip{padding:.3rem .7rem;font-size:.68rem;font-weight:600;border:1.5px solid var(--slate-200);border-radius:20px;cursor:pointer;transition:all .15s}
    .merch-chip:hover{border-color:var(--primary)}
    .merch-chip.selected{border-color:var(--primary);background:var(--primary-light);color:var(--primary)}

    /* ─── Save btn ── */
    .save-btn{display:inline-flex;align-items:center;gap:.4rem;padding:.6rem 1.4rem;background:linear-gradient(135deg,var(--primary),#06B6D4);color:#fff;border:none;border-radius:8px;font-size:.75rem;font-weight:700;cursor:pointer;transition:all .2s;font-family:inherit}
    .save-btn:hover{opacity:.9;transform:translateY(-1px)}
    .save-btn:disabled{opacity:.45;transform:none;cursor:not-allowed}
    .save-btn.red{background:linear-gradient(135deg,var(--red-600),#F87171)}
    .save-row{display:flex;justify-content:flex-end;gap:.5rem;margin-top:1rem}

    /* ─── Alert ───── */
    .adm-alert{padding:.6rem 1rem;border-radius:8px;font-size:.78rem;font-weight:500;margin-bottom:1rem;border-left:3px solid}
    .adm-alert.success{background:var(--green-100);color:var(--green-600);border-color:var(--green-600)}
    .adm-alert.error{background:var(--red-100);color:var(--red-600);border-color:var(--red-600)}

    /* ─── History table ─ */
    .hist-table{width:100%;border-collapse:collapse;font-size:.75rem}
    .hist-table thead{background:var(--slate-100)}
    .hist-table th{text-align:left;padding:.6rem .75rem;font-weight:600;font-size:.65rem;text-transform:uppercase;letter-spacing:.5px;color:var(--slate-500);border-bottom:1.5px solid var(--slate-200)}
    .hist-table td{padding:.6rem .75rem;border-bottom:1px solid var(--slate-100);color:var(--slate-700)}
    .hist-table tbody tr:hover{background:var(--slate-50)}
    .badge-sm{display:inline-block;padding:1px 8px;border-radius:10px;font-size:.6rem;font-weight:700;text-transform:uppercase}
    .badge-sm.info{background:var(--blue-100);color:var(--blue-600)}
    .badge-sm.maintenance{background:var(--amber-100);color:var(--amber-600)}
    .badge-sm.urgent{background:var(--red-100);color:var(--red-600)}
    .badge-sm.paid{background:var(--green-100);color:var(--green-600)}
    .badge-sm.pending{background:var(--amber-100);color:var(--amber-600)}
    .badge-sm.overdue{background:var(--red-100);color:var(--red-600)}
    .del-btn{background:none;border:none;color:var(--red-600);cursor:pointer;font-size:.72rem;font-weight:600;padding:.2rem .5rem;border-radius:4px}
    .del-btn:hover{background:var(--red-100)}
    .status-select{padding:.2rem .4rem;font-size:.68rem;border:1px solid var(--slate-200);border-radius:4px;font-family:inherit}

    /* ─── Invoice upload ─ */
    .file-zone{border:2px dashed var(--slate-200);border-radius:8px;padding:1.5rem;text-align:center;cursor:pointer;transition:all .2s}
    .file-zone:hover,.file-zone.drag{border-color:var(--primary);background:var(--primary-light)}
    .file-zone p{font-size:.75rem;color:var(--slate-400);margin:.3rem 0 0}
    .file-name{font-size:.72rem;color:var(--primary);font-weight:600;margin-top:.5rem}

    @media(max-width:768px){
      .adm-hero{padding:1.4rem 1.2rem}
      .adm-tabs{padding:1rem 1.2rem 0}
      .adm-wrap{padding:1.2rem}
      .form-row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <nav class="navbar admin-nav">
    <a href="/admin/dashboard" class="navbar-brand">FIDDO<span> Admin</span></a>
    <div class="navbar-menu">
      <a href="/admin/dashboard" class="navbar-link">Commerces</a>
      <a href="/admin/messages" class="navbar-link active">Messages</a>
      <button class="btn btn-outline btn-sm" onclick="adminLogout()">Déconnexion</button>
    </div>
  </nav>

  <div class="adm-hero">
    <div class="adm-hero-title">Messages et Factures</div>
    <div class="adm-hero-sub">Diffuser des annonces et gérer la facturation</div>
  </div>

  <div class="adm-tabs">
    <button class="adm-tab active" onclick="switchTab('compose',this)">Nouveau message</button>
    <button class="adm-tab" onclick="switchTab('history',this)">Historique</button>
    <button class="adm-tab" onclick="switchTab('invoice-new',this)">Nouvelle facture</button>
    <button class="adm-tab" onclick="switchTab('invoice-list',this)">Factures</button>
  </div>

  <div class="adm-wrap">

    <!-- ═══ COMPOSE ═══ -->
    <div class="tab-panel active" id="panel-compose">
      <div class="adm-card">
        <div class="adm-card-title">Rédiger un message</div>
        <div id="compose-alert"></div>

        <div class="fg">
          <label>Type</label>
          <div class="type-pills">
            <div class="type-pill t-info active" onclick="pickType('info',this)">Information</div>
            <div class="type-pill t-maint" onclick="pickType('maintenance',this)">Maintenance</div>
            <div class="type-pill t-urgent" onclick="pickType('urgent',this)">Urgent</div>
          </div>
        </div>

        <div class="fg">
          <label>Titre</label>
          <input type="text" id="msg-title" placeholder="Mise à jour de la plateforme..." maxlength="200">
        </div>

        <div class="fg">
          <label>Contenu</label>
          <textarea id="msg-body" rows="5" placeholder="Détails du message..."></textarea>
        </div>

        <div class="fg">
          <label>Destinataires</label>
          <div class="type-pills">
            <div class="type-pill active" onclick="pickTarget('all',this)">Tous les commerces</div>
            <div class="type-pill" onclick="pickTarget('selected',this)">Sélection</div>
          </div>
          <div class="target-section" id="target-section">
            <label style="font-size:.68rem;color:var(--slate-500);display:block;margin-bottom:.4rem">Sélectionnez les commerces :</label>
            <div class="merch-chips" id="merchant-chips"></div>
          </div>
        </div>

        <div class="save-row">
          <button class="save-btn" onclick="sendMessage()">Envoyer le message</button>
        </div>
      </div>
    </div>

    <!-- ═══ HISTORY ═══ -->
    <div class="tab-panel" id="panel-history">
      <div class="adm-card" style="padding:.5rem">
        <div id="msg-history"></div>
      </div>
    </div>

    <!-- ═══ NEW INVOICE ═══ -->
    <div class="tab-panel" id="panel-invoice-new">
      <div class="adm-card">
        <div class="adm-card-title">Créer une facture</div>
        <div id="invoice-alert"></div>

        <div class="fg">
          <label>Commerce</label>
          <select id="inv-merchant"><option value="">-- Sélectionner --</option></select>
        </div>

        <div class="form-row">
          <div class="fg">
            <label>Mois</label>
            <input type="month" id="inv-month">
          </div>
          <div class="fg">
            <label>Montant (EUR)</label>
            <input type="number" id="inv-amount" step="0.01" min="0.01" placeholder="49.00">
          </div>
        </div>

        <div class="fg">
          <label>Libellé</label>
          <input type="text" id="inv-label" placeholder="Abonnement FIDDO - Janvier 2026" maxlength="200">
        </div>

        <div class="fg">
          <label>Statut</label>
          <div class="type-pills">
            <div class="type-pill active" onclick="pickInvStatus('pending',this)">En attente</div>
            <div class="type-pill" onclick="pickInvStatus('paid',this)">Payée</div>
            <div class="type-pill" onclick="pickInvStatus('overdue',this)">En retard</div>
          </div>
        </div>

        <div class="fg">
          <label>Document PDF (optionnel)</label>
          <div class="file-zone" id="pdf-zone" onclick="document.getElementById('pdf-input').click()">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--slate-400)" stroke-width="1.5"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            <p>Cliquez ou glissez un PDF ici</p>
            <div class="file-name" id="pdf-name" style="display:none"></div>
          </div>
          <input type="file" id="pdf-input" accept=".pdf" style="display:none" onchange="handlePDF(this)">
        </div>

        <div class="fg">
          <label>Notes (optionnel)</label>
          <input type="text" id="inv-notes" placeholder="Remarque pour le marchand...">
        </div>

        <div class="save-row">
          <button class="save-btn" onclick="createInvoice()">Créer la facture</button>
        </div>
      </div>
    </div>

    <!-- ═══ INVOICE LIST ═══ -->
    <div class="tab-panel" id="panel-invoice-list">
      <div class="adm-card" style="padding:.5rem">
        <div id="inv-list"></div>
      </div>
    </div>

  </div>

  <script src="/js/app.js"></script>
  <script>
    const ADMIN_API = API_BASE_URL + '/admin';

    async function adminCall(endpoint, options = {}) {
      const config = { headers: { 'Content-Type': 'application/json' }, credentials: 'include', ...options };
      const resp = await fetch(`${ADMIN_API}${endpoint}`, config);
      if (resp.status === 401 || resp.status === 403) { window.location.href = '/admin'; return; }
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || 'Erreur');
      return data;
    }

    function adminLogout() {
      adminCall('/auth/logout', { method: 'POST' }).finally(() => window.location.href = '/admin');
    }

    // ─── State ───
    let selectedType = 'info';
    let selectedTarget = 'all';
    let selectedMerchantIds = [];
    let allMerchants = [];
    let selectedInvStatus = 'pending';
    let pdfBase64 = null;
    let pdfFileName = null;

    // ─── Tabs ───
    function switchTab(tab, btn) {
      document.querySelectorAll('.adm-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('panel-' + tab).classList.add('active');
      if (tab === 'history') loadHistory();
      if (tab === 'invoice-list') loadInvoiceList();
    }

    // ─── Alert ───
    function showAlert(id, msg, type) {
      document.getElementById(id).innerHTML = `<div class="adm-alert ${type}">${esc(msg)}</div>`;
    }
    function clearAlert(id) { document.getElementById(id).innerHTML = ''; }

    // ═══════════════════════════════════════════
    //  COMPOSE MESSAGE
    // ═══════════════════════════════════════════

    function pickType(t, el) {
      selectedType = t;
      el.closest('.type-pills').querySelectorAll('.type-pill').forEach(p => p.classList.remove('active'));
      el.classList.add('active');
    }

    function pickTarget(t, el) {
      selectedTarget = t;
      el.closest('.type-pills').querySelectorAll('.type-pill').forEach(p => p.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('target-section').classList.toggle('visible', t === 'selected');
      if (t === 'selected' && allMerchants.length === 0) loadMerchantChips();
    }

    async function loadMerchantChips() {
      try {
        const data = await adminCall('/merchants?status=active');
        allMerchants = data.merchants;
        const container = document.getElementById('merchant-chips');
        container.innerHTML = allMerchants.map(m =>
          `<div class="merch-chip" data-id="${m.id}" onclick="toggleMerchant(${m.id},this)">${esc(m.business_name)}</div>`
        ).join('');
      } catch (e) { console.error(e); }
    }

    function toggleMerchant(id, el) {
      el.classList.toggle('selected');
      if (selectedMerchantIds.includes(id)) {
        selectedMerchantIds = selectedMerchantIds.filter(x => x !== id);
      } else {
        selectedMerchantIds.push(id);
      }
    }

    async function sendMessage() {
      clearAlert('compose-alert');
      const title = document.getElementById('msg-title').value.trim();
      const body = document.getElementById('msg-body').value.trim();

      if (!title) { showAlert('compose-alert', 'Titre requis', 'error'); return; }
      if (!body) { showAlert('compose-alert', 'Contenu requis', 'error'); return; }
      if (selectedTarget === 'selected' && selectedMerchantIds.length === 0) {
        showAlert('compose-alert', 'Sélectionnez au moins un commerce', 'error'); return;
      }

      try {
        await adminCall('/messages', {
          method: 'POST',
          body: JSON.stringify({
            title,
            body,
            msgType: selectedType,
            targetType: selectedTarget,
            targetMerchantIds: selectedTarget === 'selected' ? selectedMerchantIds : undefined,
          }),
        });

        showAlert('compose-alert', 'Message envoyé avec succès', 'success');
        document.getElementById('msg-title').value = '';
        document.getElementById('msg-body').value = '';
      } catch (e) {
        showAlert('compose-alert', e.message, 'error');
      }
    }

    // ═══════════════════════════════════════════
    //  MESSAGE HISTORY
    // ═══════════════════════════════════════════

    async function loadHistory() {
      const container = document.getElementById('msg-history');
      try {
        const data = await adminCall('/messages');
        const msgs = data.messages;

        if (msgs.length === 0) {
          container.innerHTML = '<p style="padding:1.5rem;text-align:center;color:var(--slate-400);font-size:.78rem">Aucun message envoyé</p>';
          return;
        }

        let html = `<table class="hist-table"><thead><tr>
          <th>Date</th><th>Type</th><th>Titre</th><th>Cible</th><th>Lu</th><th></th>
        </tr></thead><tbody>`;

        msgs.forEach(m => {
          const d = new Date(m.created_at + 'Z');
          const target = m.target_type === 'all' ? 'Tous' : `${m.recipient_count} commerce(s)`;
          html += `<tr>
            <td>${d.toLocaleDateString('fr-FR',{day:'2-digit',month:'short'})}</td>
            <td><span class="badge-sm ${m.msg_type}">${m.msg_type}</span></td>
            <td style="font-weight:600;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(m.title)}</td>
            <td>${target}</td>
            <td>${m.read_count}/${m.recipient_count}</td>
            <td><button class="del-btn" onclick="deleteMessage(${m.id})">Supprimer</button></td>
          </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (e) {
        container.innerHTML = '<p style="padding:1.5rem;color:var(--red-600);font-size:.78rem">Erreur de chargement</p>';
      }
    }

    async function deleteMessage(id) {
      if (!confirm('Supprimer ce message ?')) return;
      try {
        await adminCall(`/messages/${id}`, { method: 'DELETE' });
        loadHistory();
      } catch (e) { alert(e.message); }
    }

    // ═══════════════════════════════════════════
    //  NEW INVOICE
    // ═══════════════════════════════════════════

    function pickInvStatus(s, el) {
      selectedInvStatus = s;
      el.closest('.type-pills').querySelectorAll('.type-pill').forEach(p => p.classList.remove('active'));
      el.classList.add('active');
    }

    function handlePDF(input) {
      const file = input.files[0];
      if (!file) return;
      if (file.type !== 'application/pdf') { alert('PDF uniquement'); return; }
      if (file.size > 8 * 1024 * 1024) { alert('Taille max : 8 Mo'); return; }

      pdfFileName = file.name;
      const reader = new FileReader();
      reader.onload = () => {
        pdfBase64 = reader.result.split(',')[1];
        document.getElementById('pdf-name').textContent = file.name;
        document.getElementById('pdf-name').style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    // Drag & drop
    const pdfZone = document.getElementById('pdf-zone');
    pdfZone.addEventListener('dragover', e => { e.preventDefault(); pdfZone.classList.add('drag'); });
    pdfZone.addEventListener('dragleave', () => pdfZone.classList.remove('drag'));
    pdfZone.addEventListener('drop', e => {
      e.preventDefault();
      pdfZone.classList.remove('drag');
      const file = e.dataTransfer.files[0];
      if (file) {
        const dt = new DataTransfer();
        dt.items.add(file);
        document.getElementById('pdf-input').files = dt.files;
        handlePDF(document.getElementById('pdf-input'));
      }
    });

    async function createInvoice() {
      clearAlert('invoice-alert');
      const merchantId = document.getElementById('inv-merchant').value;
      const month = document.getElementById('inv-month').value;
      const amount = document.getElementById('inv-amount').value;
      const label = document.getElementById('inv-label').value.trim();
      const notes = document.getElementById('inv-notes').value.trim();

      if (!merchantId) { showAlert('invoice-alert', 'Sélectionnez un commerce', 'error'); return; }
      if (!month) { showAlert('invoice-alert', 'Mois requis', 'error'); return; }
      if (!amount || parseFloat(amount) <= 0) { showAlert('invoice-alert', 'Montant invalide', 'error'); return; }
      if (!label) { showAlert('invoice-alert', 'Libellé requis', 'error'); return; }

      try {
        await adminCall('/messages/invoices', {
          method: 'POST',
          body: JSON.stringify({
            merchantId: parseInt(merchantId),
            month,
            label,
            amount: parseFloat(amount),
            status: selectedInvStatus,
            fileBase64: pdfBase64,
            fileName: pdfFileName,
            notes: notes || undefined,
          }),
        });

        showAlert('invoice-alert', 'Facture créée avec succès', 'success');
        document.getElementById('inv-month').value = '';
        document.getElementById('inv-amount').value = '';
        document.getElementById('inv-label').value = '';
        document.getElementById('inv-notes').value = '';
        pdfBase64 = null;
        pdfFileName = null;
        document.getElementById('pdf-name').style.display = 'none';
        document.getElementById('pdf-input').value = '';
      } catch (e) {
        showAlert('invoice-alert', e.message, 'error');
      }
    }

    // ═══════════════════════════════════════════
    //  INVOICE LIST
    // ═══════════════════════════════════════════

    async function loadInvoiceList() {
      const container = document.getElementById('inv-list');
      try {
        const data = await adminCall('/messages/invoices');
        const invs = data.invoices;

        if (invs.length === 0) {
          container.innerHTML = '<p style="padding:1.5rem;text-align:center;color:var(--slate-400);font-size:.78rem">Aucune facture</p>';
          return;
        }

        const statusLabels = { paid:'Payée', pending:'En attente', overdue:'En retard' };

        let html = `<table class="hist-table"><thead><tr>
          <th>Commerce</th><th>Mois</th><th>Libellé</th><th>Montant</th><th>Statut</th><th></th>
        </tr></thead><tbody>`;

        invs.forEach(inv => {
          html += `<tr>
            <td style="font-weight:600">${esc(inv.business_name)}</td>
            <td>${esc(inv.month)}</td>
            <td>${esc(inv.label)}</td>
            <td style="font-weight:600">${Format.currency(inv.amount)}</td>
            <td>
              <select class="status-select" onchange="updateInvStatus(${inv.id},this.value)">
                <option value="pending"${inv.status==='pending'?' selected':''}>En attente</option>
                <option value="paid"${inv.status==='paid'?' selected':''}>Payée</option>
                <option value="overdue"${inv.status==='overdue'?' selected':''}>En retard</option>
              </select>
            </td>
            <td><button class="del-btn" onclick="deleteInvoice(${inv.id})">Supprimer</button></td>
          </tr>`;
        });

        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (e) {
        container.innerHTML = '<p style="padding:1.5rem;color:var(--red-600);font-size:.78rem">Erreur de chargement</p>';
      }
    }

    async function updateInvStatus(id, status) {
      try {
        await adminCall(`/messages/invoices/${id}/status`, {
          method: 'PATCH',
          body: JSON.stringify({ status }),
        });
      } catch (e) { alert(e.message); loadInvoiceList(); }
    }

    async function deleteInvoice(id) {
      if (!confirm('Supprimer cette facture ?')) return;
      try {
        await adminCall(`/messages/invoices/${id}`, { method: 'DELETE' });
        loadInvoiceList();
      } catch (e) { alert(e.message); }
    }

    // ─── Utility ───
    function esc(str) {
      if (!str) return '';
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    // ─── Init: load merchant list for invoice dropdown ───
    (async () => {
      try {
        const data = await adminCall('/merchants?status=active');
        allMerchants = data.merchants;
        const sel = document.getElementById('inv-merchant');
        allMerchants.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.business_name;
          sel.appendChild(opt);
        });
      } catch (e) { console.error(e); }
    })();
  </script>
</body>
</html>
