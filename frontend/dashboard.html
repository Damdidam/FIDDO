<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord â€” FIDDO</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    /* â”€â”€ Dashboard layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dash-wrap {
      max-width: 1320px;
      margin: 0 auto;
      padding: 1.25rem 1.5rem 3rem;
    }

    .dash-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.25rem;
    }
    .dash-header h1 {
      font-size: 1.35rem;
      font-weight: 700;
      color: var(--secondary);
      margin: 0;
    }
    .dash-header-right {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    /* â”€â”€ Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dash-toolbar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .filter-chip {
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      border: 1.5px solid var(--border);
      background: #fff;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      color: var(--text-light);
      transition: all 0.15s;
      font-family: inherit;
    }
    .filter-chip:hover { border-color: var(--primary); color: var(--primary); }
    .filter-chip.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .dash-search {
      margin-left: auto;
      position: relative;
    }
    .dash-search input {
      width: 240px;
      padding: 0.4rem 0.7rem 0.4rem 2rem;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-size: 0.85rem;
      font-family: inherit;
      transition: border-color 0.15s;
      background: #fff;
    }
    .dash-search input:focus { outline: none; border-color: var(--primary); }
    .dash-search .ico {
      position: absolute;
      left: 0.6rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.8rem;
      color: var(--text-light);
      pointer-events: none;
    }

    /* â”€â”€ Table card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    .table-card table {
      width: 100%;
      border-collapse: collapse;
    }
    .table-card thead { background: var(--secondary); }
    .table-card th {
      padding: 0.6rem 0.75rem;
      text-align: left;
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: rgba(255,255,255,0.85);
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
      transition: color 0.15s;
    }
    .table-card th:hover { color: #fff; }
    .table-card th .arrow {
      margin-left: 3px;
      font-size: 0.6rem;
      opacity: 0.4;
    }
    .table-card th.sorted .arrow { opacity: 1; }
    .table-card th.sorted { color: #fff; }

    .table-card td {
      padding: 0.55rem 0.75rem;
      font-size: 0.85rem;
      color: var(--text);
      border-bottom: 1px solid #f0f1f3;
      vertical-align: middle;
    }
    .table-card tbody tr { transition: background 0.1s; }
    .table-card tbody tr:hover { background: #f7fafa; }
    .table-card tbody tr:last-child td { border-bottom: none; }

    /* â”€â”€ Type badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tx-type {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .tx-credit { background: var(--primary-light, #CFFAFE); color: var(--primary); }
    .tx-reward { background: #fef3c7; color: #b45309; }
    .tx-adjustment { background: #ede9fe; color: #7c3aed; }
    .tx-merge { background: #f3e8ff; color: #9333ea; }

    /* â”€â”€ Points â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pts-pos { color: var(--primary); font-weight: 700; }
    .pts-neg { color: var(--danger); font-weight: 700; }

    /* â”€â”€ Client cell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .client-cell {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .client-star { color: #f59e0b; font-size: 0.9rem; flex-shrink: 0; }
    .client-name { font-weight: 500; }
    .client-sub { font-size: 0.75rem; color: var(--text-light); }

    /* â”€â”€ Other cells â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .staff-cell { font-size: 0.8rem; color: var(--text-light); }
    .staff-cell strong { color: var(--text); }
    .amount-cell { font-variant-numeric: tabular-nums; }
    .notes-cell {
      font-size: 0.8rem;
      color: var(--text-light);
      min-width: 180px;
      white-space: normal;
      word-break: break-word;
    }
    .date-cell .day { font-weight: 500; font-size: 0.82rem; }
    .date-cell .time { font-size: 0.72rem; color: var(--text-light); }
    .balance-cell { font-size: 0.8rem; color: var(--text-light); font-variant-numeric: tabular-nums; }

    /* â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dash-pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.65rem 0.75rem;
      border-top: 1px solid #f0f1f3;
      font-size: 0.8rem;
      color: var(--text-light);
    }
    .dash-pagination button {
      padding: 0.3rem 0.65rem;
      border: 1.5px solid var(--border);
      border-radius: 6px;
      background: #fff;
      font-size: 0.78rem;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
    }
    .dash-pagination button:hover:not(:disabled) {
      border-color: var(--primary);
      color: var(--primary);
    }
    .dash-pagination button:disabled { opacity: 0.35; cursor: not-allowed; }
    .page-btns { display: flex; gap: 0.35rem; }

    /* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dash-empty {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--text-light);
    }
    .dash-empty .e-ico { font-size: 2.5rem; margin-bottom: 0.5rem; }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 900px) {
      .dash-toolbar { flex-direction: column; align-items: stretch; }
      .dash-search { margin-left: 0; }
      .dash-search input { width: 100%; }
      .table-card { overflow-x: auto; }
      .hide-mobile { display: none; }
    }
    @media (max-width: 600px) {
      .dash-wrap { padding: 1rem; }
      .dash-header h1 { font-size: 1.15rem; }
      .table-card td, .table-card th { padding: 0.4rem 0.5rem; font-size: 0.78rem; }
      .filter-chip { font-size: 0.72rem; padding: 0.3rem 0.6rem; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="/dashboard" class="navbar-brand">FIDDO<span></span></a>
    <div class="navbar-menu"></div>
  </nav>

  <div class="dash-wrap">

    <!-- Header -->
    <div class="dash-header">
      <h1>Tableau de bord</h1>
      <div class="dash-header-right">
        <a href="/credit" class="btn btn-primary btn-sm">â• CrÃ©diter</a>
        <button onclick="refreshAll()" class="btn btn-outline btn-sm" title="RafraÃ®chir">â†»</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="dash-toolbar">
      <button class="filter-chip active" data-filter="all">Tout</button>
      <button class="filter-chip" data-filter="credit">CrÃ©dits</button>
      <button class="filter-chip" data-filter="reward">RÃ©compenses</button>
      <button class="filter-chip" data-filter="adjustment">Ajustements</button>
      <div class="dash-search">
        <span class="ico">ğŸ”</span>
        <input type="text" id="dash-search" placeholder="Rechercherâ€¦">
      </div>
    </div>

    <!-- Table -->
    <div class="table-card">
      <table id="activity-table">
        <thead>
          <tr>
            <th data-col="date" class="sorted">Date <span class="arrow">â–¼</span></th>
            <th data-col="type">Type <span class="arrow">â–¼</span></th>
            <th data-col="client">Client <span class="arrow">â–¼</span></th>
            <th data-col="amount">Montant <span class="arrow">â–¼</span></th>
            <th data-col="points">Points <span class="arrow">â–¼</span></th>
            <th data-col="balance" class="hide-mobile">Solde <span class="arrow">â–¼</span></th>
            <th data-col="staff">Staff <span class="arrow">â–¼</span></th>
            <th data-col="notes" class="hide-mobile">Notes <span class="arrow">â–¼</span></th>
          </tr>
        </thead>
        <tbody id="activity-body">
          <tr><td colspan="8"><div class="dash-empty"><div class="e-ico">â³</div><p>Chargementâ€¦</p></div></td></tr>
        </tbody>
      </table>
      <div class="dash-pagination" id="pagination" style="display:none;">
        <span id="page-info"></span>
        <div class="page-btns">
          <button id="btn-prev" onclick="changePage(-1)">â† PrÃ©c.</button>
          <button id="btn-next" onclick="changePage(1)">Suiv. â†’</button>
        </div>
      </div>
    </div>

  </div>

  <script src="/js/app.js"></script>
  <script>
    if (!requireManager()) throw 'Not authorized';

    const merchant = Auth.getMerchant();

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let allRows = [];
    let filteredRows = [];
    let sortCol = 'date';
    let sortAsc = false;
    let currentFilter = 'all';
    let searchTerm = '';
    const PAGE_SIZE = 30;
    let currentPage = 0;

    const TYPE_LABELS = { credit: 'CrÃ©dit', reward: 'RÃ©comp.', adjustment: 'Ajust.', merge: 'Fusion' };

    // â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadActivity() {
      try {
        const data = await API.call('/clients/recent-activity?limit=300');
        allRows = data.transactions.map(t => ({
          id: t.id,
          date: t.created_at,
          dateObj: new Date(t.created_at),
          type: t.transaction_type,
          clientName: t.client_name || '',
          clientEmail: t.client_email || '',
          clientPhone: t.client_phone || '',
          clientDisplay: t.client_name || t.client_email || t.client_phone || 'â€”',
          canRedeem: t.can_redeem || false,
          hasCustomReward: t.has_custom_reward || false,
          customReward: t.custom_reward || null,
          amount: t.amount,
          points: t.points_delta,
          balance: t.current_balance,
          staff: t.staff_name || 'SystÃ¨me',
          staffRole: t.staff_role || '',
          notes: t.notes || '',
          mcId: t.merchant_client_id,
        }));
        applyFilters();
      } catch (err) {
        console.error('Activity load error:', err);
        document.getElementById('activity-body').innerHTML =
          `<tr><td colspan="8"><div class="dash-empty"><div class="e-ico">âš ï¸</div><p>${escHtml(err.message)}</p></div></td></tr>`;
      }
    }

    function refreshAll() { loadActivity(); }

    // â”€â”€ Filter + sort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function applyFilters() {
      filteredRows = allRows.filter(r => {
        if (currentFilter !== 'all' && r.type !== currentFilter) return false;
        if (searchTerm) {
          const s = searchTerm.toLowerCase();
          const hay = (r.clientDisplay + ' ' + r.clientEmail + ' ' + r.clientPhone + ' ' + r.staff + ' ' + r.notes).toLowerCase();
          if (!hay.includes(s)) return false;
        }
        return true;
      });
      applySort();
    }

    function applySort() {
      filteredRows.sort((a, b) => {
        let va, vb;
        switch (sortCol) {
          case 'date':    va = a.dateObj; vb = b.dateObj; break;
          case 'type':    va = a.type; vb = b.type; break;
          case 'client':  va = a.clientDisplay.toLowerCase(); vb = b.clientDisplay.toLowerCase(); break;
          case 'amount':  va = a.amount || 0; vb = b.amount || 0; break;
          case 'points':  va = a.points; vb = b.points; break;
          case 'balance': va = a.balance || 0; vb = b.balance || 0; break;
          case 'staff':   va = a.staff.toLowerCase(); vb = b.staff.toLowerCase(); break;
          case 'notes':   va = a.notes.toLowerCase(); vb = b.notes.toLowerCase(); break;
          default:        va = a.dateObj; vb = b.dateObj;
        }
        if (va < vb) return sortAsc ? -1 : 1;
        if (va > vb) return sortAsc ? 1 : -1;
        return 0;
      });
      currentPage = 0;
      render();
    }

    // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function render() {
      const tbody = document.getElementById('activity-body');
      const start = currentPage * PAGE_SIZE;
      const page = filteredRows.slice(start, start + PAGE_SIZE);

      if (filteredRows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="8"><div class="dash-empty"><div class="e-ico">ğŸ“‹</div><p>Aucune activitÃ© trouvÃ©e</p></div></td></tr>`;
        document.getElementById('pagination').style.display = 'none';
        return;
      }

      let html = '';
      page.forEach(r => {
        const sign = r.points >= 0 ? '+' : '';
        const ptsCls = r.points >= 0 ? 'pts-pos' : 'pts-neg';
        const typeLabel = TYPE_LABELS[r.type] || r.type;

        // Star: â­ if custom reward, ğŸ if can redeem (default reward)
        let starHtml = '';
        if (r.hasCustomReward) {
          starHtml = `<span class="client-star" title="RÃ©compense perso: ${escAttr(r.customReward)}">â­</span>`;
        } else if (r.canRedeem) {
          starHtml = `<span class="client-star" title="RÃ©compense disponible">ğŸ</span>`;
        }

        html += `<tr>
          <td class="date-cell"><span class="day">${fmtDate(r.dateObj)}</span><br><span class="time">${fmtTime(r.dateObj)}</span></td>
          <td><span class="tx-type tx-${r.type}">${typeLabel}</span></td>
          <td>
            <div class="client-cell">
              ${starHtml}
              <div>
                <div class="client-name">${escHtml(r.clientDisplay)}</div>
                ${r.clientEmail && r.clientDisplay !== r.clientEmail ? `<div class="client-sub">${escHtml(r.clientEmail)}</div>` : ''}
              </div>
            </div>
          </td>
          <td class="amount-cell">${r.amount != null ? Format.currency(r.amount) : 'â€”'}</td>
          <td><span class="${ptsCls}">${sign}${r.points}</span></td>
          <td class="balance-cell hide-mobile">${r.balance != null ? r.balance + ' pts' : 'â€”'}</td>
          <td class="staff-cell"><strong>${escHtml(r.staff)}</strong></td>
          <td class="notes-cell hide-mobile">${escHtml(r.notes) || 'â€”'}</td>
        </tr>`;
      });
      tbody.innerHTML = html;

      // Pagination
      const totalPages = Math.ceil(filteredRows.length / PAGE_SIZE);
      const pag = document.getElementById('pagination');
      pag.style.display = 'flex';
      document.getElementById('page-info').textContent =
        `${start + 1}â€“${Math.min(start + PAGE_SIZE, filteredRows.length)} sur ${filteredRows.length}`;
      document.getElementById('btn-prev').disabled = currentPage === 0;
      document.getElementById('btn-next').disabled = currentPage >= totalPages - 1;
    }

    function changePage(dir) {
      currentPage += dir;
      render();
      document.querySelector('.table-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // â”€â”€ Column sort click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.querySelectorAll('#activity-table th[data-col]').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.col;
        if (sortCol === col) { sortAsc = !sortAsc; }
        else { sortCol = col; sortAsc = (col === 'client' || col === 'staff'); }
        document.querySelectorAll('#activity-table th').forEach(h => {
          h.classList.remove('sorted');
          h.querySelector('.arrow').textContent = 'â–¼';
        });
        th.classList.add('sorted');
        th.querySelector('.arrow').textContent = sortAsc ? 'â–²' : 'â–¼';
        applySort();
      });
    });

    // â”€â”€ Filter chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        currentFilter = chip.dataset.filter;
        applyFilters();
      });
    });

    // â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let searchTimeout;
    document.getElementById('dash-search').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchTerm = e.target.value.trim();
        applyFilters();
      }, 200);
    });

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function escHtml(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function escAttr(s) { if (!s) return ''; return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    function fmtDate(dt) {
      const now = new Date();
      const diff = Math.floor((now - dt) / 86400000);
      if (diff === 0) return "Auj.";
      if (diff === 1) return "Hier";
      if (diff < 7) return dt.toLocaleDateString('fr-FR', { weekday: 'short' });
      return dt.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' });
    }
    function fmtTime(dt) { return dt.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }); }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    loadActivity();
  </script>
</body>
</html>
