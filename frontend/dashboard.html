<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord ‚Äî FIDDO</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    /* Announcements */
    .announcements-section { margin-bottom: 1.5rem; }
    .ann-banner {
      padding: 1rem 1.25rem;
      border-radius: 10px;
      margin-bottom: 0.75rem;
      border-left: 4px solid var(--primary);
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .ann-banner:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(0,0,0,0.12); }
    .ann-banner.priority-warning { border-left-color: var(--warning); background: #fffbeb; }
    .ann-banner.priority-urgent { border-left-color: var(--danger); background: #fef2f2; }
    .ann-banner.is-read { opacity: 0.7; }
    .ann-banner .ann-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 0.25rem; }
    .ann-banner .ann-date { font-size: 0.75rem; color: var(--text-light); }
    .ann-banner .ann-preview { font-size: 0.85rem; color: var(--text); margin-top: 0.25rem; }
    .ann-unread-dot {
      display: inline-block;
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--primary);
      margin-right: 0.5rem;
      vertical-align: middle;
    }
    .ann-toggle { text-align: center; margin-top: 0.5rem; }
    .ann-toggle a { color: var(--primary); cursor: pointer; font-size: 0.85rem; font-weight: 500; }

    /* Feedback */
    .feedback-card {
      background: linear-gradient(135deg, var(--secondary), #111827);
      color: white;
      border-radius: 10px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .feedback-card:hover { transform: translateY(-2px); }
    .feedback-card h3 { margin: 0 0 0.25rem; font-size: 1rem; }
    .feedback-card p { margin: 0; font-size: 0.85rem; opacity: 0.8; }

    /* Notification badge */
    .notif-badge {
      background: var(--danger);
      color: white;
      font-size: 0.65rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      margin-left: 4px;
      vertical-align: top;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="/dashboard" class="navbar-brand">FIDDO<span></span></a>
    <div class="navbar-menu"></div>
  </nav>

  <div class="container">
    <h1 style="margin: 1.5rem 0;">Tableau de bord</h1>

    <!-- Announcements Section -->
    <div class="announcements-section" id="announcements-section" style="display: none;">
      <div class="flex-between mb-1">
        <h3 style="margin: 0;">üì¢ Annonces <span id="unread-badge"></span></h3>
      </div>
      <div id="announcements-list"></div>
    </div>

    <!-- Stats -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="stat-clients">-</div>
        <div class="stat-label">Clients</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-active">-</div>
        <div class="stat-label">Actifs (30j)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-points">-</div>
        <div class="stat-label">Points distribu√©s</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-rewards">-</div>
        <div class="stat-label">R√©compenses</div>
      </div>
    </div>

    <div class="grid grid-2">
      <!-- Recent clients -->
      <div class="card">
        <div class="card-header">
          Derniers clients
          <a href="/clients" class="btn btn-primary btn-sm">Voir tous</a>
        </div>
        <div id="recent-clients"></div>
      </div>

      <!-- Quick actions + Settings + Feedback -->
      <div>
        <div class="card">
          <div class="card-header">Actions rapides</div>
          <a href="/credit" class="btn btn-primary btn-block mb-1">‚ûï Cr√©diter des points</a>
          <a href="/clients" class="btn btn-secondary btn-block mb-1">üë• Voir les clients</a>
          <button onclick="API.clients.exportCSV()" class="btn btn-outline btn-block">üì• Exporter CSV</button>
        </div>

        <!-- Feedback card -->
        <div class="feedback-card" onclick="showFeedbackModal()">
          <h3>üí¨ Contacter FIDDO</h3>
          <p>Une question, suggestion ou probl√®me ? Envoyez-nous un message.</p>
        </div>

        <div class="card" id="settings-card" style="display: none;">
          <div class="card-header">‚öôÔ∏è Param√®tres de fid√©lit√©</div>
          <div id="settings-alert"></div>
          <form id="settings-form">
            <div class="form-group">
              <label class="form-label">Points par euro</label>
              <input type="number" id="set-ppe" class="form-control" step="0.1" min="0.1">
            </div>
            <div class="form-group">
              <label class="form-label">Points pour r√©compense</label>
              <input type="number" id="set-pfr" class="form-control" min="1">
            </div>
            <div class="form-group">
              <label class="form-label">Description r√©compense</label>
              <input type="text" id="set-desc" class="form-control" placeholder="Boisson offerte">
            </div>
            <button type="submit" class="btn btn-primary btn-block">Enregistrer</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Announcement Detail Modal -->
  <div id="ann-detail-modal" class="modal">
    <div class="modal-content" style="max-width: 550px;">
      <div class="modal-header">
        <h2 id="ann-detail-title">Annonce</h2>
        <button class="close-modal" onclick="closeAnnDetail()">√ó</button>
      </div>
      <div class="modal-body" id="ann-detail-body"></div>
    </div>
  </div>

  <!-- Feedback Modal -->
  <div id="feedback-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2>üí¨ Contacter FIDDO</h2>
        <button class="close-modal" onclick="closeFeedbackModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div id="feedback-alert"></div>
        <div class="form-group">
          <label class="form-label">Sujet (optionnel)</label>
          <input type="text" id="fb-subject" class="form-control" placeholder="Ex: Question sur les r√©compenses">
        </div>
        <div class="form-group">
          <label class="form-label">Votre message *</label>
          <textarea id="fb-message" class="form-control" rows="5" placeholder="D√©crivez votre question ou suggestion..."></textarea>
        </div>
        <button class="btn btn-primary btn-block" id="fb-submit" onclick="submitFeedback()">Envoyer</button>
      </div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    if (!requireManager()) throw 'Not authorized';

    const staff = Auth.getStaff();
    const merchant = Auth.getMerchant();

    // Show settings card for owner
    if (staff.role === 'owner') {
      document.getElementById('settings-card').style.display = 'block';
      document.getElementById('set-ppe').value = merchant.points_per_euro;
      document.getElementById('set-pfr').value = merchant.points_for_reward;
      document.getElementById('set-desc').value = merchant.reward_description;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ANNOUNCEMENTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    let allAnnouncements = [];

    async function loadAnnouncements() {
      try {
        const data = await API.call('/announcements');
        allAnnouncements = data.announcements;

        if (allAnnouncements.length === 0) return;

        const section = document.getElementById('announcements-section');
        section.style.display = 'block';

        // Unread badge
        const unreadCount = data.unread_count;
        const badge = document.getElementById('unread-badge');
        badge.innerHTML = unreadCount > 0
          ? `<span class="notif-badge">${unreadCount}</span>`
          : '';

        // Show max 3, expand to show all
        renderAnnouncements(false);
      } catch (err) {
        console.error('Announcements error:', err);
      }
    }

    function renderAnnouncements(showAll) {
      const list = document.getElementById('announcements-list');
      const toShow = showAll ? allAnnouncements : allAnnouncements.slice(0, 3);
      const prioIcons = { info: '‚ÑπÔ∏è', warning: '‚ö†Ô∏è', urgent: 'üö®' };

      let html = '';
      toShow.forEach(a => {
        const preview = a.content.length > 120 ? a.content.substring(0, 120) + '...' : a.content;
        html += `
          <div class="ann-banner priority-${a.priority} ${a.is_read ? 'is-read' : ''}" onclick="showAnnDetail(${a.id})">
            <div class="flex-between">
              <div class="ann-title">
                ${!a.is_read ? '<span class="ann-unread-dot"></span>' : ''}
                ${prioIcons[a.priority]} ${a.title}
              </div>
              <span class="ann-date">${Format.timeSince(a.created_at)}</span>
            </div>
            <div class="ann-preview">${preview}</div>
          </div>
        `;
      });

      if (!showAll && allAnnouncements.length > 3) {
        html += `<div class="ann-toggle"><a onclick="renderAnnouncements(true)">Voir toutes les annonces (${allAnnouncements.length})</a></div>`;
      } else if (showAll && allAnnouncements.length > 3) {
        html += `<div class="ann-toggle"><a onclick="renderAnnouncements(false)">R√©duire</a></div>`;
      }

      list.innerHTML = html;
    }

    async function showAnnDetail(id) {
      const a = allAnnouncements.find(x => x.id === id);
      if (!a) return;

      const prioLabels = { info: 'Information', warning: 'Important', urgent: 'Urgent' };
      const prioColors = { info: 'var(--primary)', warning: 'var(--warning)', urgent: 'var(--danger)' };

      document.getElementById('ann-detail-title').textContent = a.title;
      document.getElementById('ann-detail-body').innerHTML = `
        <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">
          <span class="badge" style="background: ${prioColors[a.priority]}20; color: ${prioColors[a.priority]};">${prioLabels[a.priority]}</span>
          <span class="text-muted text-sm">${Format.datetime(a.created_at)}</span>
        </div>
        <div style="white-space: pre-wrap; line-height: 1.7; font-size: 0.95rem;">${a.content}</div>
      `;

      document.getElementById('ann-detail-modal').classList.add('active');

      // Mark as read
      if (!a.is_read) {
        try {
          await API.call(`/announcements/${id}/read`, { method: 'POST' });
          a.is_read = 1;
          // Update badge
          const unread = allAnnouncements.filter(x => !x.is_read).length;
          document.getElementById('unread-badge').innerHTML = unread > 0
            ? `<span class="notif-badge">${unread}</span>` : '';
        } catch (e) { /* silent */ }
      }
    }

    function closeAnnDetail() {
      document.getElementById('ann-detail-modal').classList.remove('active');
      renderAnnouncements(false); // Refresh read state visually
    }
    document.getElementById('ann-detail-modal').addEventListener('click', (e) => {
      if (e.target.id === 'ann-detail-modal') closeAnnDetail();
    });


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FEEDBACK
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function showFeedbackModal() {
      document.getElementById('fb-subject').value = '';
      document.getElementById('fb-message').value = '';
      UI.clearAlert('feedback-alert');
      document.getElementById('fb-submit').disabled = false;
      document.getElementById('feedback-modal').classList.add('active');
    }

    function closeFeedbackModal() {
      document.getElementById('feedback-modal').classList.remove('active');
    }
    document.getElementById('feedback-modal').addEventListener('click', (e) => {
      if (e.target.id === 'feedback-modal') closeFeedbackModal();
    });

    async function submitFeedback() {
      const subject = document.getElementById('fb-subject').value.trim();
      const message = document.getElementById('fb-message').value.trim();

      if (!message) {
        UI.showAlert('feedback-alert', 'Veuillez √©crire un message', 'error');
        return;
      }

      try {
        document.getElementById('fb-submit').disabled = true;
        UI.showAlert('feedback-alert', 'Envoi en cours...', 'info');

        await API.call('/announcements/feedback', {
          method: 'POST',
          body: JSON.stringify({ subject, message }),
        });

        UI.showAlert('feedback-alert', '‚úÖ Message envoy√© ! L\'√©quipe FIDDO vous r√©pondra rapidement.', 'success');
        document.getElementById('fb-subject').value = '';
        document.getElementById('fb-message').value = '';

        setTimeout(() => closeFeedbackModal(), 2000);
      } catch (err) {
        UI.showAlert('feedback-alert', err.message, 'error');
        document.getElementById('fb-submit').disabled = false;
      }
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DASHBOARD DATA
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async function loadDashboard() {
      try {
        const data = await API.clients.getAll();
        const clients = data.clients;

        const total = clients.length;
        const active = clients.filter(c => {
          const days = (Date.now() - new Date(c.last_visit)) / 86400000;
          return days <= 30;
        }).length;
        const totalPoints = clients.reduce((s, c) => s + c.points_balance, 0);
        const visits = clients.reduce((s, c) => s + c.visit_count, 0);

        document.getElementById('stat-clients').textContent = total;
        document.getElementById('stat-active').textContent = active;
        document.getElementById('stat-points').textContent = totalPoints.toLocaleString('fr-FR');
        document.getElementById('stat-rewards').textContent = visits;

        // Recent clients
        const container = document.getElementById('recent-clients');
        if (clients.length === 0) {
          container.innerHTML = '<div class="empty-state"><p class="text-muted">Aucun client pour le moment</p></div>';
          return;
        }

        const recent = clients.slice(0, 5);
        let html = '<table class="table"><thead><tr><th>Client</th><th>Points</th><th>Visites</th><th>Derni√®re visite</th></tr></thead><tbody>';
        recent.forEach(c => {
          html += `<tr>
            <td><a href="/clients" style="color: var(--primary); text-decoration: none;">${c.email || c.phone || c.name || 'N/A'}</a></td>
            <td><strong class="text-primary">${c.points_balance} pts</strong></td>
            <td>${c.visit_count}</td>
            <td class="text-muted">${Format.timeSince(c.last_visit)}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;

      } catch (err) {
        console.error('Dashboard error:', err);
      }
    }

    // Settings form (owner only)
    document.getElementById('settings-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const settings = {
          pointsPerEuro: parseFloat(document.getElementById('set-ppe').value),
          pointsForReward: parseInt(document.getElementById('set-pfr').value),
          rewardDescription: document.getElementById('set-desc').value,
        };
        await API.auth.updateSettings(settings);

        merchant.points_per_euro = settings.pointsPerEuro;
        merchant.points_for_reward = settings.pointsForReward;
        merchant.reward_description = settings.rewardDescription;
        Auth.setSession(staff, merchant);

        UI.showAlert('settings-alert', 'Param√®tres mis √† jour !', 'success');
        setTimeout(() => UI.clearAlert('settings-alert'), 3000);
      } catch (err) {
        UI.showAlert('settings-alert', err.message, 'error');
      }
    });

    // Init
    loadAnnouncements();
    loadDashboard();
  </script>
</body>
</html>
