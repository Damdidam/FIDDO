<!DOCTYPE html>
<html lang="fr">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <link rel="manifest" href="/manifest.json">
 <meta name="apple-mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
 <meta name="apple-mobile-web-app-title" content="FIDDO">
 <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">
 <meta name="theme-color" content="#0891B2">
 <title>Tableau de bord ‚Äî FIDDO</title>
 <link rel="stylesheet" href="/css/styles.css">
 <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
 <style>
 :root {
 --primary-light: #CFFAFE;
 --gradient: linear-gradient(135deg, var(--primary), var(--primary-dark));
 }

 .dash { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; }
 .dash * { box-sizing: border-box; }
 .dash-wrap { max-width: 820px; margin: 0 auto; padding: 1rem; }

 .pg-title {
 font-size: 1.05rem; font-weight: 700; color: #1E293B;
 margin: 0.3rem 0 0.6rem; letter-spacing: -0.3px;
 }

 /* ‚ïê‚ïê‚ïê TOOLBAR ‚ïê‚ïê‚ïê */

 .toolbar {
 display: flex; align-items: center; gap: 0.35rem;
 margin-bottom: 0.9rem; flex-wrap: wrap;
 }
 .period-pill {
 padding: 0.3rem 0.7rem; border: 1.5px solid #E2E8F0;
 border-radius: 16px; background: white; font-family: inherit;
 font-size: 0.75rem; font-weight: 500; color: #64748B;
 cursor: pointer; transition: all 0.12s; white-space: nowrap;
 }
 .period-pill.active {
 border-color: var(--primary); background: color-mix(in srgb, var(--primary-light) 45%, white);
 color: var(--primary-dark); font-weight: 600;
 }
 .period-pill:hover:not(.active) { border-color: #CBD5E1; }
 .toolbar-spacer { flex: 1; }

 .period-dates {
 display: none; align-items: center; gap: 0.4rem; margin-left: 0.35rem;
 }
 .period-dates.show { display: flex; }
 .period-dates input[type="text"] {
 padding: 0.22rem 0.4rem; border: 1.5px solid #E2E8F0;
 border-radius: 5px; font-family: inherit; font-size: 0.72rem;
 color: #475569; background: white; width: 88px; text-align: center;
 }
 .period-dates input[type="text"]:focus { outline: none; border-color: var(--primary); }
 .period-dates .sep { color: #94A3B8; font-size: 0.72rem; }

 /* ‚ïê‚ïê‚ïê STAT CARDS ‚ïê‚ïê‚ïê */

 .stats-row {
 display: flex; gap: 0.4rem; margin-bottom: 0.9rem;
 overflow-x: auto; -webkit-overflow-scrolling: touch;
 scrollbar-width: none; padding-bottom: 2px;
 }
 .stats-row::-webkit-scrollbar { display: none; }
 .st {
 background: white; border-radius: 8px; padding: 0.35rem 0.55rem;
 text-align: center; box-shadow: 0 1px 4px rgba(0,0,0,0.05);
 min-width: 0; flex: 1 0 auto; white-space: nowrap;
 }
 .st.st-click {
 cursor: pointer; transition: all 0.15s; border: 1.5px solid transparent;
 }
 .st.st-click:hover { border-color: var(--primary); background: color-mix(in srgb, var(--primary-light) 30%, white); }
 .st.st-click:active { transform: scale(0.97); }
 .st.st-click.active { border-color: var(--primary); background: color-mix(in srgb, var(--primary-light) 40%, white); }
 .st.st-click.active .st-lbl { color: var(--primary-dark); }
 .st.st-bday { border: 1.5px solid transparent; cursor: pointer; transition: all 0.15s; }
 .st.st-bday:hover { border-color: #9333EA; background: #FAF5FF; }
 .st.st-bday .st-val { color: #9333EA; display: flex; align-items: center; justify-content: center; gap: 4px; }
 .st.st-bday .st-lbl { color: #9333EA; opacity: 0.7; }
 .st.st-reward-ready { border: 1.5px solid transparent; cursor: pointer; transition: all 0.15s; }
 .st.st-reward-ready:hover { border-color: #D97706; background: #FFFBEB; }
 .st.st-reward-ready.active { border-color: #D97706; background: #FEF3C7; }
 .st.st-reward-ready .st-val { color: #D97706; display: flex; align-items: center; justify-content: center; gap: 4px; }
 .st.st-reward-ready .st-lbl { color: #D97706; opacity: 0.7; }
 .st-val {
 font-size: 1.05rem; font-weight: 700; color: var(--primary);
 line-height: 1.15; letter-spacing: -0.5px;
 }
 .st-val.green { color: #059669; }
 .st-val.amber { color: #D97706; }
 .st-lbl {
 font-size: 0.5rem; color: #94A3B8; text-transform: uppercase;
 letter-spacing: 0.3px; margin-top: 0.05rem; font-weight: 600;
 }
 .st.st-action {
 cursor: pointer; transition: all 0.15s; border: 1.5px solid #E2E8F0;
 }
 .st.st-action:hover { border-color: var(--primary); }
 .st.st-action .st-icon { color: #64748B; margin-bottom: 1px; }
 .st.st-action .st-icon svg { width: 18px; height: 18px; }
 .st.st-action:hover .st-icon { color: var(--primary); }

 /* ‚ïê‚ïê‚ïê ACTIVITY FEED ‚ïê‚ïê‚ïê */

 .feed-card {
 background: white; border-radius: 10px;
 box-shadow: 0 1px 4px rgba(0,0,0,0.05); overflow: hidden;
 }
 .feed-hdr {
 padding: 0.6rem 0.85rem; border-bottom: 1px solid #F1F5F9;
 display: flex; align-items: center; justify-content: space-between;
 }
 .feed-title { font-weight: 600; font-size: 0.88rem; color: #1E293B; }

 /* ‚îÄ‚îÄ Type tabs ‚îÄ‚îÄ */
 .feed-tabs {
 display: flex; gap: 0; background: #F8FAFC;
 border-bottom: 1px solid #F1F5F9;
 }
 .feed-tab {
 padding: 0.4rem 0.75rem; border: none; background: transparent;
 font-family: inherit; font-size: 0.72rem; font-weight: 500;
 color: #64748B; cursor: pointer; border-bottom: 2px solid transparent;
 transition: all 0.12s; white-space: nowrap;
 }
 .feed-tab.active {
 color: var(--primary-dark); border-bottom-color: var(--primary); font-weight: 600;
 }
 .feed-tab:hover:not(.active) { color: #475569; }
 .feed-tab .cnt {
 display: inline-block; background: #E2E8F0;
 padding: 0 5px; border-radius: 8px; font-size: 0.62rem;
 margin-left: 3px; font-weight: 600; min-width: 16px; text-align: center;
 }
 .feed-tab.active .cnt {
 background: color-mix(in srgb, var(--primary-light) 55%, white);
 color: var(--primary-dark);
 }

 /* ‚îÄ‚îÄ Column headers (sortable) ‚îÄ‚îÄ */
 .col-hdr {
 display: grid;
 grid-template-columns: 72px 1fr 80px 80px 80px;
 gap: 0.3rem;
 padding: 0.35rem 0.85rem;
 background: #F8FAFC;
 border-bottom: 1px solid #E2E8F0;
 }
 .col-th {
 font-size: 0.62rem; font-weight: 700; text-transform: uppercase;
 letter-spacing: 0.4px; color: #94A3B8; cursor: pointer;
 user-select: none; display: flex; align-items: center; gap: 3px;
 transition: color 0.12s; white-space: nowrap;
 }
 .col-th:hover { color: #475569; }
 .col-th.active { color: var(--primary-dark); }
 .col-th .arrow {
 font-size: 0.55rem; opacity: 0; transition: opacity 0.12s;
 }
 .col-th.active .arrow { opacity: 1; }
    .arrow.asc::before { content: ''; display: inline-block; width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-bottom: 5px solid currentColor; }
    .arrow.desc::before { content: ''; display: inline-block; width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-top: 5px solid currentColor; }
 .col-th-right { justify-content: flex-end; }

 /* ‚îÄ‚îÄ Date separator ‚îÄ‚îÄ */
 .date-sep {
 padding: 0.25rem 0.85rem; background: #F8FAFC;
 font-size: 0.62rem; font-weight: 600; color: #94A3B8;
 text-transform: uppercase; letter-spacing: 0.4px;
 border-bottom: 1px solid #F1F5F9;
 }

 /* ‚îÄ‚îÄ Transaction rows ‚îÄ‚îÄ */
 .feed-body { max-height: 560px; overflow-y: auto; }

 .tx-row {
 display: grid;
 grid-template-columns: 72px 1fr 80px 80px 80px;
 gap: 0.3rem;
 padding: 0.45rem 0.85rem;
 border-bottom: 1px solid #F8FAFC;
 align-items: center;
 font-size: 0.82rem;
 }
 .tx-row:last-child { border-bottom: none; }
 .tx-row:hover { background: #FAFBFC; }

 .tx-time { font-size: 0.72rem; color: #64748B; font-weight: 500; font-variant-numeric: tabular-nums; }
 .tx-date-sub { font-size: 0.6rem; color: #CBD5E1; }

 .tx-info { min-width: 0; }
 .tx-client {
 font-weight: 600; color: #1E293B; font-size: 0.82rem;
 white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
 cursor: pointer; transition: color 0.12s;
 }
 .tx-client:hover { color: var(--primary); }
 .tx-meta {
 font-size: 0.66rem; color: #94A3B8; margin-top: 1px;
 white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
 }

 .tx-badge {
 display: inline-block; padding: 2px 7px; border-radius: 8px;
 font-size: 0.6rem; font-weight: 600; text-transform: uppercase;
 letter-spacing: 0.2px; text-align: center;
 }
 .tx-badge.credit { background: color-mix(in srgb, var(--primary-light) 50%, white); color: var(--primary-dark); }
 .tx-badge.reward { background: #D1FAE5; color: #047857; }
 .tx-badge.adjustment { background: #FEF3C7; color: #92400E; }
 .tx-badge.merge { background: #EDE9FE; color: #6D28D9; }
 .tx-badge.gift_out { background: #FCE7F3; color: #BE185D; }
 .tx-badge.gift_in { background: #CCFBF1; color: #0F766E; }
 .tx-badge.gift_refund { background: #FEF3C7; color: #92400E; }

 .tx-pts { font-weight: 700; font-size: 0.85rem; text-align: right; white-space: nowrap; }
 .tx-pts.credit { color: var(--primary); }
 .tx-pts.reward { color: #059669; }
 .tx-pts.adjustment { color: #D97706; }
 .tx-pts.merge { color: #7C3AED; }

 .tx-amount { font-size: 0.78rem; color: #64748B; text-align: right; font-variant-numeric: tabular-nums; }

 /* ‚îÄ‚îÄ Empty / Loading / More ‚îÄ‚îÄ */
 .feed-empty { padding: 2.5rem 1rem; text-align: center; color: #94A3B8; font-size: 0.85rem; }
 .feed-empty-icon { font-size: 2rem; margin-bottom: 0.4rem; }
 .feed-loading { padding: 1.5rem; text-align: center; color: #94A3B8; font-size: 0.78rem; }
 .feed-more { padding: 0.5rem; text-align: center; border-top: 1px solid #F1F5F9; }
 .feed-more button {
 padding: 0.3rem 1rem; border: 1.5px solid #E2E8F0; border-radius: 14px;
 background: white; font-family: inherit; font-size: 0.72rem;
 color: #64748B; cursor: pointer; font-weight: 500;
 }
 .feed-more button:hover { border-color: var(--primary); color: var(--primary); }

 /* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */

 @media (max-width: 768px) {
 .dash-wrap { padding: 0.4rem; }
 .pg-title { font-size: 0.95rem; }
 .stats-row { gap: 0.35rem; }
 .st-val { font-size: 0.95rem; }
 .feed-body { max-height: 420px; }

 /* Period pills ‚Äî bigger tap targets */
 .period-pill { min-height: 36px; padding: 0.35rem 0.75rem; font-size: 0.75rem; }
 .toolbar { gap: 0.3rem; flex-wrap: wrap; }

 /* Transaction rows */
 .col-hdr, .tx-row {
 grid-template-columns: 52px 1fr 60px 60px;
 gap: 0.2rem; padding-left: 0.5rem; padding-right: 0.5rem;
 }
 .tx-row { min-height: 44px; }
 .col-th-amount, .tx-amount-cell { display: none; }

 /* Feed tabs */
 .feed-tab { min-height: 36px; padding: 0.4rem 0.65rem; }
 }
 @media (max-width: 480px) {
 .stats-row { gap: 0.3rem; }
 .st { padding: 0.3rem 0.4rem; }
 .st-val { font-size: 1rem; }
 .feed-tab { padding: 0.35rem 0.5rem; font-size: 0.7rem; }
 }
 </style>
</head>
<body class="dash">
 <nav class="navbar">
 <a href="/dashboard" class="navbar-brand">FIDDO<span></span></a>
 <div class="navbar-menu"></div>
 </nav>

 <div class="dash-wrap">
 <h1 class="pg-title">Tableau de bord</h1>

 <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOOLBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
 <div class="toolbar">
 <button class="period-pill active" onclick="setPeriod('today',this)">Aujourd'hui</button>
 <button class="period-pill" onclick="setPeriod('7d',this)">7 jours</button>
 <button class="period-pill" onclick="setPeriod('30d',this)">30 jours</button>
 <button class="period-pill" onclick="setPeriod('all',this)">Tout</button>
 <button class="period-pill" onclick="setPeriod('custom',this)"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> P√©riode</button>
 <div class="period-dates" id="custom-dates">
 <input type="text" id="date-from" placeholder="jj/mm/aaaa" maxlength="10">
 <span class="sep">‚Üí</span>
 <input type="text" id="date-to" placeholder="jj/mm/aaaa" maxlength="10">
 </div>
 <span class="toolbar-spacer"></span>
 </div>

 <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
 <div class="stats-row">
 <div class="st st-click" onclick="statFilter('credit')" id="st-visits" title="Filtrer les cr√©dits"><div class="st-val" id="s-visits">‚Äì</div><div class="st-lbl">Passages</div></div>
 <div class="st"><div class="st-val" id="s-pts-out">‚Äì</div><div class="st-lbl">Points distribu√©s</div></div>
 <div class="st st-click" onclick="statFilter('reward')" id="st-rewards" title="Filtrer les r√©compenses"><div class="st-val green" id="s-rewards">‚Äì</div><div class="st-lbl">R√©compenses</div></div>
 <div class="st st-reward-ready" id="st-reward-ready" onclick="toggleRewardReady()" title="Clients pr√™ts pour r√©compense"><div class="st-val"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#D97706" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2z"/></svg> <span id="s-reward-ready">0</span></div><div class="st-lbl">Seuil atteint</div></div>
 <div class="st st-click" onclick="toggleNewClients()" id="st-new" title="Nouveaux clients"><div class="st-val" id="s-new">‚Äì</div><div class="st-lbl">Nouveaux clients</div></div>
 <div class="st st-click" onclick="toggleActiveClients()" id="st-active" title="Clients actifs"><div class="st-val amber" id="s-active">‚Äì</div><div class="st-lbl">Clients actifs</div></div>
 <div class="st st-bday" id="st-bday" onclick="toggleBirthdays()" title="Anniversaires cette semaine"><div class="st-val"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#9333EA" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"/><path d="M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5 2 4 2 2-1 2-1"/><path d="M2 21h20"/><path d="M7 8v3"/><path d="M12 8v3"/><path d="M17 8v3"/><path d="M7 4h.01"/><path d="M12 4h.01"/><path d="M17 4h.01"/></svg> <span id="s-bday">0</span></div><div class="st-lbl">Anniversaires</div></div>
 <div class="st st-action" onclick="API.clients.exportCSV()" title="Exporter les clients">
 <div class="st-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></div>
 <div class="st-lbl">Export CSV</div>
 </div>
 </div>

 <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ACTIVITY FEED ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
 <div class="feed-card">
 <div class="feed-hdr">
 <span class="feed-title">Activit√©</span>
 <span id="feed-total" style="font-size:0.68rem;color:#94A3B8;"></span>
 </div>

 <!-- Type filter tabs -->
 <div class="feed-tabs">
 <button class="feed-tab active" onclick="setType('',this)">Tous <span class="cnt" id="cnt-all"></span></button>
 <button class="feed-tab" onclick="setType('credit',this)">Cr√©dits <span class="cnt" id="cnt-credit"></span></button>
 <button class="feed-tab" onclick="setType('reward',this)">R√©compenses <span class="cnt" id="cnt-reward"></span></button>
 <button class="feed-tab" onclick="setType('adjustment',this)">Ajustements <span class="cnt" id="cnt-adj"></span></button>
 <button class="feed-tab" onclick="setType('gift',this)">Transferts <span class="cnt" id="cnt-gift"></span></button>
 </div>

 <!-- Sortable column headers -->
 <div class="col-hdr">
 <div class="col-th active" onclick="sortBy('time',this)" data-col="time">
 Heure <span class="arrow"></span>
 </div>
 <div class="col-th" onclick="sortBy('client',this)" data-col="client">
 Client <span class="arrow"></span>
 </div>
 <div class="col-th" onclick="sortBy('type',this)" data-col="type">
 Type <span class="arrow"></span>
 </div>
 <div class="col-th col-th-right" onclick="sortBy('points',this)" data-col="points">
 Points <span class="arrow"></span>
 </div>
 <div class="col-th col-th-right col-th-amount" onclick="sortBy('amount',this)" data-col="amount">
 Montant <span class="arrow"></span>
 </div>
 </div>

 <div class="feed-body" id="feed-body"></div>

 <div class="feed-more" id="feed-more" style="display:none;">
 <button onclick="loadMore()">Charger plus</button>
 </div>
 </div>


 </div>

 <script src="/js/app.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
 <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/fr.js"></script>
 <script>
 if (!requireManager()) throw 'Not authorized';

 const staff = Auth.getStaff();
 const merchant = Auth.getMerchant();

 let currentPeriod = 'today';
 let currentType = '';
 let currentOffset = 0;
 let allTransactions = [];
 let sortCol = 'time';
 let sortAsc = false; // default: newest first

 // ‚ïê‚ïê‚ïê DATE HELPERS ‚ïê‚ïê‚ïê

 function periodDates(period) {
 const now = new Date();
 let from, to;
 if (period === 'today') {
 from = new Date(now.getFullYear(), now.getMonth(), now.getDate());
 to = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
 } else if (period === '7d') {
 from = new Date(now); from.setDate(from.getDate() - 7); from.setHours(0,0,0,0);
 to = now;
 } else if (period === '30d') {
 from = new Date(now); from.setDate(from.getDate() - 30); from.setHours(0,0,0,0);
 to = now;
 } else if (period === 'custom') {
 const f = document.getElementById('date-from').value;
 const t = document.getElementById('date-to').value;
 var pf = parseBE(f);
 var pt = parseBE(t);
 if (pf) { pf.setHours(0,0,0,0); from = pf; }
 if (pt) { pt.setHours(23,59,59,0); to = pt; }
 } else {
 return {};
 }
 const r = {};
 if (from) r.from = from.toISOString().replace('T', ' ').substring(0, 19);
 if (to) r.to = to.toISOString().replace('T', ' ').substring(0, 19);
 return r;
 }

 // ‚ïê‚ïê‚ïê PERIOD ‚ïê‚ïê‚ïê

 function setPeriod(period, btn) {
 currentPeriod = period;
 document.querySelectorAll('.period-pill').forEach(p => p.classList.remove('active'));
 if (btn) btn.classList.add('active');
 const custom = document.getElementById('custom-dates');
 if (period === 'custom') {
 custom.classList.add('show');
 if (parseBE(document.getElementById('date-from').value) && parseBE(document.getElementById('date-to').value)) reload();
 return;
 }
 custom.classList.remove('show');
 reload();
 }

 // flatpickr onChange handles custom period reload

 // ‚ïê‚ïê‚ïê TYPE FILTER ‚ïê‚ïê‚ïê

 function setType(type, btn) {
 currentType = type;
 document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
 if (btn) btn.classList.add('active');
 // Sync stat tile highlights
 document.querySelectorAll('.st.st-click').forEach(s => s.classList.remove('active'));
 if (type === 'credit') document.getElementById('st-visits').classList.add('active');
 else if (type === 'reward') document.getElementById('st-rewards').classList.add('active');
 currentOffset = 0;
 allTransactions = [];
 loadActivity();
 }

 function statFilter(type) {
 // If a tile view is active, restore first
 if (activeTileView || rewardReadyActive) restoreFeed();
 // Toggle: click again to reset
 var newType = (currentType === type) ? '' : type;
 // Find matching feed tab button
 var tabs = document.querySelectorAll('.feed-tab');
 var matchBtn = null;
 tabs.forEach(function(t) {
 if (newType === '' && t.textContent.trim().startsWith('Tous')) matchBtn = t;
 else if (newType === 'credit' && t.textContent.trim().startsWith('Cr√©dits')) matchBtn = t;
 else if (newType === 'reward' && t.textContent.trim().startsWith('R√©compenses')) matchBtn = t;
 });
 setType(newType, matchBtn);
 }

 function goClients(filter) {
 navigateTo('/clients' + (filter ? '?filter=' + filter : ''));
 }

 // ‚ïê‚ïê‚ïê COLUMN SORT ‚ïê‚ïê‚ïê

 function sortBy(col, el) {
 if (sortCol === col) {
 sortAsc = !sortAsc;
 } else {
 sortCol = col;
 sortAsc = col === 'client' || col === 'type'; // alpha = asc by default, rest = desc
 }

 // Update header UI
 document.querySelectorAll('.col-th').forEach(th => th.classList.remove('active'));
 el.classList.add('active');
 var aw = el.querySelector('.arrow'); aw.className = 'arrow ' + (sortAsc ? 'asc' : 'desc');

 renderFeed(allTransactions);
 }

 function getSortedTxs(txs) {
 const sorted = [...txs];
 const dir = sortAsc ? 1 : -1;

 sorted.sort((a, b) => {
 switch (sortCol) {
 case 'time':
 return dir * (a.created_at < b.created_at ? -1 : a.created_at > b.created_at ? 1 : 0);
 case 'client': {
 const ca = (a.client_name || a.client_email || a.client_phone || '').toLowerCase();
 const cb = (b.client_name || b.client_email || b.client_phone || '').toLowerCase();
 return dir * ca.localeCompare(cb);
 }
 case 'type':
 return dir * a.transaction_type.localeCompare(b.transaction_type);
 case 'points':
 return dir * (a.points_delta - b.points_delta);
 case 'amount':
 return dir * ((a.amount || 0) - (b.amount || 0));
 default:
 return 0;
 }
 });
 return sorted;
 }

 // ‚ïê‚ïê‚ïê LOAD STATS ‚ïê‚ïê‚ïê

 async function loadStats() {
 try {
 const dates = periodDates(currentPeriod);
 const qs = new URLSearchParams();
 if (dates.from) qs.set('from', dates.from);
 if (dates.to) qs.set('to', dates.to);
 const s = await API.call('/dashboard/stats?' + qs.toString());
 document.getElementById('s-visits').textContent = fmtNum(s.visits);
 document.getElementById('s-pts-out').textContent = fmtNum(s.pointsOut);
 document.getElementById('s-rewards').textContent = fmtNum(s.rewards);
 document.getElementById('s-new').textContent = fmtNum(s.newClients);
 document.getElementById('s-active').textContent = fmtNum(s.activeClients);
 document.getElementById('s-reward-ready').textContent = fmtNum(s.rewardReady);
 } catch (e) {
 console.error('Stats error:', e);
 }
 }

 function fmtNum(n) {
 if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
 return n.toString();
 }

 // ‚ïê‚ïê‚ïê LOAD ACTIVITY ‚ïê‚ïê‚ïê

 async function loadActivity() {
 const body = document.getElementById('feed-body');
 if (currentOffset === 0) {
 body.innerHTML = '<div class="feed-loading">Chargement‚Ä¶</div>';
 allTransactions = [];
 }
 try {
 const dates = periodDates(currentPeriod);
 const qs = new URLSearchParams();
 if (dates.from) qs.set('from', dates.from);
 if (dates.to) qs.set('to', dates.to);
 if (currentType) qs.set('type', currentType);
 qs.set('limit', '50');
 qs.set('offset', currentOffset.toString());

 const data = await API.call('/dashboard/activity?' + qs.toString());
 allTransactions = allTransactions.concat(data.transactions);
 renderFeed(allTransactions);
 document.getElementById('feed-total').textContent = data.total + ' transaction(s)';
 document.getElementById('feed-more').style.display = data.hasMore ? '' : 'none';
 if (currentOffset === 0) updateCounts();
 } catch (e) {
 body.innerHTML = '<div class="feed-empty"><div class="feed-empty-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>Erreur de chargement</div>';
 console.error('Activity error:', e);
 }
 }

 function loadMore() { currentOffset += 50; loadActivity(); }

 // ‚ïê‚ïê‚ïê TAB COUNTS ‚ïê‚ïê‚ïê

 async function updateCounts() {
 try {
 const dates = periodDates(currentPeriod);
 const qs = new URLSearchParams();
 if (dates.from) qs.set('from', dates.from);
 if (dates.to) qs.set('to', dates.to);
 const all = await API.call('/dashboard/activity?' + qs.toString() + '&limit=0');
 document.getElementById('cnt-all').textContent = all.total;
 for (const t of ['credit', 'reward', 'adjustment', 'gift']) {
 const r = await API.call('/dashboard/activity?' + qs.toString() + '&type=' + t + '&limit=0');
 const elId = t === 'adjustment' ? 'cnt-adj' : 'cnt-' + t;
 document.getElementById(elId).textContent = r.total;
 }
 } catch (e) {}
 }

 // ‚ïê‚ïê‚ïê RENDER FEED ‚ïê‚ïê‚ïê

 function renderFeed(txs) {
 const body = document.getElementById('feed-body');
 if (txs.length === 0) {
 body.innerHTML = '<div class="feed-empty"><div class="feed-empty-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/></svg></div>Aucune activit√© sur cette p√©riode</div>';
 return;
 }

 const sorted = getSortedTxs(txs);
 const showDateSeps = sortCol === 'time'; // date separators only make sense when sorted by time

 let html = '';
 let lastDateStr = '';

 sorted.forEach(tx => {
 const dt = new Date(tx.created_at + 'Z');
 const dateStr = dt.toLocaleDateString('fr-FR', { weekday: 'short', day: '2-digit', month: 'short' });
 const timeStr = dt.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
 const type = tx.transaction_type;

 // Date separator
 if (showDateSeps && dateStr !== lastDateStr) {
 html += '<div class="date-sep">' + dateStr + '</div>';
 lastDateStr = dateStr;
 }

 const clientLabel = tx.client_name || tx.client_email || tx.client_phone || 'Client';
 const clientEmail = tx.client_name && tx.client_email ? tx.client_email : '';
 const sign = tx.points_delta >= 0 ? '+' : '';
 const metaParts = [tx.staff_name, tx.notes ? truncate(tx.notes, 30) : ''].filter(Boolean).join(' ¬∑ ');

 const badges = { credit: 'cr√©dit', reward: 'r√©compense', adjustment: 'ajust.', merge: 'fusion', gift_out: 'transfert ‚Üó', gift_in: 'transfert ‚Üô', gift_refund: 'rembours√© ‚Ü©' };
 const amountStr = tx.amount ? Format.currency(tx.amount) : '‚Äì';

 // Gift display: show sender ‚Üí receiver
 let giftMeta = '';
 if (type === 'gift_out') {
 const to = tx.gift_to || (tx.gift_status === 'pending' ? 'en attente‚Ä¶' : tx.gift_status === 'expired' ? 'expir√©' : '?');
 giftMeta = '‚Üí ' + to;
 } else if (type === 'gift_in') {
 giftMeta = '‚Üê ' + (tx.gift_from || '?');
 }

 html += '<div class="tx-row">';

 // Col 1: Time
 html += '<div>';
 html += '<div class="tx-time">' + timeStr + '</div>';
 if (!showDateSeps) html += '<div class="tx-date-sub">' + dateStr + '</div>';
 html += '</div>';

 // Col 2: Client + meta
 html += '<div class="tx-info">';
 html += '<div class="tx-client" onclick="navigateTo(\'/clients?open=' + tx.merchant_client_id + '\')">' + esc(clientLabel) + '</div>';
 if (clientEmail) html += '<div class="tx-meta">' + esc(clientEmail) + '</div>';
 if (giftMeta) {
 html += '<div class="tx-meta" style="color:' + (type === 'gift_out' ? '#BE185D' : '#0F766E') + ';">' + esc(giftMeta) + '</div>';
 } else if (metaParts) {
 html += '<div class="tx-meta">' + esc(metaParts) + '</div>';
 }
 html += '</div>';

 // Col 3: Type badge
 html += '<div><span class="tx-badge ' + type + '">' + (badges[type] || type) + '</span></div>';

 // Col 4: Points
 html += '<div class="tx-pts ' + type + '" style="text-align:right;">' + sign + tx.points_delta + '</div>';

 // Col 5: Amount
 html += '<div class="tx-amount tx-amount-cell">' + amountStr + '</div>';

 html += '</div>';
 });

 body.innerHTML = html;
 }

 function truncate(s, n) { return s.length > n ? s.substring(0, n) + '‚Ä¶' : s; }
 // esc() is now global via app.js

 // ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê

 function reload() { restoreFeed(); currentOffset = 0; allTransactions = []; loadStats(); loadActivity(); loadBirthdays(); }

 async function loadBirthdays() {
 try {
 const data = await API.call('/dashboard/birthdays');
 var statVal = document.getElementById('s-bday');
 statVal.textContent = (data.birthdays && data.birthdays.length) || 0;
 } catch (e) {
 console.error('Erreur chargement anniversaires:', e);
 }
 }

 // ‚ïê‚ïê‚ïê REWARD-READY ‚ïê‚ïê‚ïê

 let rewardReadyActive = false;

 function toggleRewardReady() {
 if (!enterTileView('st-reward-ready', 'Seuil atteint')) return;
 rewardReadyActive = true;
 document.getElementById('st-reward-ready').classList.add('active');
 loadRewardReady();
 }

 async function loadRewardReady() {
 try {
 var data = await API.call('/dashboard/reward-ready');
 var unit = data.loyaltyMode === 'visits' ? 'visites' : 'pts';
 document.getElementById('feed-total').textContent = data.count + ' client(s) ‚â• ' + data.threshold + ' ' + unit;
 renderRewardReady(data.clients, data.threshold, unit);
 } catch (e) {
 document.getElementById('feed-body').innerHTML = '<div class="feed-empty">Erreur de chargement</div>';
 }
 }

 function renderRewardReady(clients, threshold, unit) {
 var body = document.getElementById('feed-body');
 if (clients.length === 0) {
 body.innerHTML = '<div class="feed-empty"><div class="feed-empty-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2z"/></svg></div>Aucun client n\'a atteint le seuil de ' + threshold + ' ' + unit + '</div>';
 return;
 }
 var html = '<div style="display:flex;padding:0.35rem 0.5rem;font-size:0.6rem;color:#94A3B8;text-transform:uppercase;font-weight:600;letter-spacing:0.3px;border-bottom:1px solid #F1F5F9;"><div style="flex:2;">Client</div><div style="flex:1;text-align:right;">Solde</div><div style="flex:1;text-align:right;">Visites</div><div style="flex:1.2;text-align:right;">Derni√®re visite</div></div>';
 clients.forEach(function(c) {
 var name = esc(c.name || c.email || c.phone || 'N/A');
 var sub = c.name && c.email ? '<div class="tx-meta">' + esc(c.email) + '</div>' : '';
 var lastV = c.last_visit ? new Date(c.last_visit + 'Z').toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }) : '‚Äì';
 var excess = c.points_balance - threshold;
 var excessLabel = excess > 0 ? ' <span style="font-size:0.65rem;color:#94A3B8;">(+' + excess + ')</span>' : '';
 html += '<div class="tx-row" style="cursor:pointer;" onclick="navigateTo(\'/clients?open=' + c.id + '\')">';
 html += '<div style="flex:2;" class="tx-info"><div class="tx-client">' + name + '</div>' + sub + '</div>';
 html += '<div style="flex:1;text-align:right;font-weight:600;color:#D97706;">' + c.points_balance + excessLabel + '</div>';
 html += '<div style="flex:1;text-align:right;color:#64748B;">' + c.visit_count + '</div>';
 html += '<div style="flex:1.2;text-align:right;color:#94A3B8;font-size:0.75rem;">' + lastV + '</div>';
 html += '</div>';
 });
 body.innerHTML = html;
 }

 function restoreFeed() {
 rewardReadyActive = false;
 activeTileView = null;
 document.getElementById('st-reward-ready').classList.remove('active');
 document.getElementById('st-new').classList.remove('active');
 document.getElementById('st-active').classList.remove('active');
 document.getElementById('st-bday').classList.remove('active');
 document.querySelector('.feed-tabs').style.display = '';
 document.querySelector('.col-hdr').style.display = '';
 document.querySelector('.feed-title').textContent = 'Activit√©';
 }

 // ‚ïê‚ïê‚ïê GENERIC TILE VIEW ‚ïê‚ïê‚ïê

 let activeTileView = null;

 function enterTileView(tileId, title) {
 // If same tile, toggle off
 if (activeTileView === tileId) { restoreFeed(); reload(); return false; }
 // If another tile view was active, clear it
 if (activeTileView || rewardReadyActive) restoreFeed();
 activeTileView = tileId;
 // Deactivate stat tiles
 document.querySelectorAll('.st.st-click').forEach(s => s.classList.remove('active'));
 document.getElementById(tileId).classList.add('active');
 document.querySelector('.feed-tabs').style.display = 'none';
 document.querySelector('.col-hdr').style.display = 'none';
 document.getElementById('feed-more').style.display = 'none';
 document.querySelector('.feed-title').textContent = title;
 document.getElementById('feed-body').innerHTML = '<div class="feed-loading">Chargement‚Ä¶</div>';
 return true;
 }

 function renderClientList(clients, columns) {
 var body = document.getElementById('feed-body');
 if (clients.length === 0) {
 body.innerHTML = '<div class="feed-empty"><div class="feed-empty-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 15h8"/><circle cx="9" cy="9" r="1"/><circle cx="15" cy="9" r="1"/></svg></div>Aucun client</div>';
 return;
 }
 var html = '<div style="display:flex;padding:0.35rem 0.5rem;font-size:0.6rem;color:#94A3B8;text-transform:uppercase;font-weight:600;letter-spacing:0.3px;border-bottom:1px solid #F1F5F9;">';
 columns.forEach(function(col) { html += '<div style="flex:' + col.flex + ';text-align:' + (col.align || 'left') + ';">' + col.label + '</div>'; });
 html += '</div>';
 clients.forEach(function(c) {
 var name = esc(c.name || c.email || c.phone || 'N/A');
 var sub = c.name && c.email ? '<div class="tx-meta">' + esc(c.email) + '</div>' : '';
 html += '<div class="tx-row" style="cursor:pointer;" onclick="navigateTo(\'/clients?open=' + c.id + '\')">';
 html += '<div style="flex:2;" class="tx-info"><div class="tx-client">' + name + '</div>' + sub + '</div>';
 columns.slice(1).forEach(function(col) {
 html += '<div style="flex:' + col.flex + ';text-align:' + (col.align || 'left') + ';color:' + (col.color || '#64748B') + ';font-size:0.8rem;' + (col.bold ? 'font-weight:600;' : '') + '">' + col.render(c) + '</div>';
 });
 html += '</div>';
 });
 body.innerHTML = html;
 }

 // ‚ïê‚ïê‚ïê NEW CLIENTS TILE ‚ïê‚ïê‚ïê

 async function toggleNewClients() {
 if (!enterTileView('st-new', 'Nouveaux clients')) return;
 try {
 var dates = periodDates(currentPeriod);
 var qs = new URLSearchParams();
 if (dates.from) qs.set('from', dates.from);
 if (dates.to) qs.set('to', dates.to);
 var data = await API.call('/dashboard/new-clients?' + qs.toString());
 document.getElementById('feed-total').textContent = data.count + ' client(s)';
 renderClientList(data.clients, [
 { label: 'Client', flex: 2 },
 { label: 'Solde', flex: 1, align: 'right', color: 'var(--primary)', bold: true, render: function(c) { return c.points_balance; } },
 { label: 'Visites', flex: 1, align: 'right', render: function(c) { return c.visit_count; } },
 { label: 'Inscrit le', flex: 1.2, align: 'right', color: '#94A3B8', render: function(c) {
   return c.joined_at ? new Date(c.joined_at + 'Z').toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }) : '‚Äì'; } }
 ]);
 } catch (e) { document.getElementById('feed-body').innerHTML = '<div class="feed-empty">Erreur de chargement</div>'; }
 }

 // ‚ïê‚ïê‚ïê ACTIVE CLIENTS TILE ‚ïê‚ïê‚ïê

 async function toggleActiveClients() {
 if (!enterTileView('st-active', 'Clients actifs')) return;
 try {
 var dates = periodDates(currentPeriod);
 var qs = new URLSearchParams();
 if (dates.from) qs.set('from', dates.from);
 if (dates.to) qs.set('to', dates.to);
 var data = await API.call('/dashboard/active-clients?' + qs.toString());
 document.getElementById('feed-total').textContent = data.count + ' client(s)';
 renderClientList(data.clients, [
 { label: 'Client', flex: 2 },
 { label: 'Solde', flex: 1, align: 'right', color: '#D97706', bold: true, render: function(c) { return c.points_balance; } },
 { label: 'Visites', flex: 1, align: 'right', render: function(c) { return c.visit_count; } },
 { label: 'Derni√®re visite', flex: 1.2, align: 'right', color: '#94A3B8', render: function(c) {
   return c.last_visit ? new Date(c.last_visit + 'Z').toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }) : '‚Äì'; } }
 ]);
 } catch (e) { document.getElementById('feed-body').innerHTML = '<div class="feed-empty">Erreur de chargement</div>'; }
 }

 // ‚ïê‚ïê‚ïê BIRTHDAYS TILE ‚ïê‚ïê‚ïê

 async function toggleBirthdays() {
 if (!enterTileView('st-bday', 'Anniversaires')) return;
 document.getElementById('st-bday').classList.add('active');
 try {
 var data = await API.call('/dashboard/birthdays');
 var list = data.birthdays || [];
 document.getElementById('feed-total').textContent = list.length + ' anniversaire(s)';
 if (list.length === 0) {
 document.getElementById('feed-body').innerHTML = '<div class="feed-empty"><div class="feed-empty-icon"><svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"/><path d="M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5 2 4 2 2-1 2-1"/><path d="M2 21h20"/></svg></div>Aucun anniversaire cette semaine</div>';
 return;
 }
 renderClientList(list, [
 { label: 'Client', flex: 2 },
 { label: 'Solde', flex: 1, align: 'right', color: '#9333EA', bold: true, render: function(c) { return c.pointsBalance; } },
 { label: 'Visites', flex: 1, align: 'right', render: function(c) { return c.visitCount; } },
 { label: 'Anniversaire', flex: 1.2, align: 'right', color: '#9333EA', render: function(c) {
   var d = c.daysUntil;
   return d === 0 ? 'üéÇ Aujourd\'hui' : d === 1 ? 'Demain' : 'Dans ' + d + 'j'; } }
 ]);
 } catch (e) { document.getElementById('feed-body').innerHTML = '<div class="feed-empty">Erreur de chargement</div>'; }
 }

 // ‚ïê‚ïê‚ïê FLATPICKR DATE PICKERS ‚ïê‚ïê‚ïê
 var fpConfig = { locale: 'fr', dateFormat: 'd/m/Y', allowInput: true, disableMobile: true };
 var fpFrom = flatpickr('#date-from', Object.assign({}, fpConfig, {
   defaultDate: new Date(),
   onChange: function() { if (currentPeriod === 'custom') reload(); }
 }));
 var fpTo = flatpickr('#date-to', Object.assign({}, fpConfig, {
   defaultDate: new Date(),
   onChange: function() { if (currentPeriod === 'custom') reload(); }
 }));

 function parseBE(s) {
 if (!s) return null;
 var p = s.split('/');
 if (p.length !== 3) return null;
 var d = parseInt(p[0]), m = parseInt(p[1]) - 1, y = parseInt(p[2]);
 if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
 return new Date(y, m, d);
 }

 reload();
 </script>
</body>
</html>
