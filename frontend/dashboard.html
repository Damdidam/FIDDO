<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord â€” FIDDO</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap" rel="stylesheet">
  <style>
    /* â”€â”€ Dashboard overrides â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dash-wrap {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 1320px;
      margin: 0 auto;
      padding: 1.25rem 1.5rem 3rem;
    }

    /* â”€â”€ Header row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dash-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }
    .dash-header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--secondary);
      margin: 0;
    }
    .dash-header-right {
      display: flex;
      gap: 0.625rem;
      align-items: center;
    }

    /* â”€â”€ Toolbar (filters + search) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dash-toolbar {
      display: flex;
      align-items: center;
      gap: 0.625rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }
    .filter-chip {
      padding: 0.4rem 0.85rem;
      border-radius: 20px;
      border: 1.5px solid var(--border);
      background: #fff;
      font-size: 0.82rem;
      font-weight: 500;
      cursor: pointer;
      color: var(--text-light);
      transition: all 0.15s;
      font-family: inherit;
    }
    .filter-chip:hover { border-color: var(--primary); color: var(--primary); }
    .filter-chip.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .dash-search {
      margin-left: auto;
      position: relative;
    }
    .dash-search input {
      width: 260px;
      padding: 0.45rem 0.75rem 0.45rem 2.1rem;
      border: 1.5px solid var(--border);
      border-radius: 8px;
      font-size: 0.85rem;
      font-family: inherit;
      transition: border-color 0.15s;
      background: #fff;
    }
    .dash-search input:focus { outline: none; border-color: var(--primary); }
    .dash-search .ico {
      position: absolute;
      left: 0.65rem;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.85rem;
      color: var(--text-light);
      pointer-events: none;
    }

    /* â”€â”€ Table card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .table-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04);
      overflow: hidden;
    }
    .table-card table {
      width: 100%;
      border-collapse: collapse;
    }
    .table-card thead {
      background: #f8f9fb;
      border-bottom: 1.5px solid #ebedf0;
    }
    .table-card th {
      padding: 0.7rem 1rem;
      text-align: left;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-light);
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    .table-card th:hover { color: var(--primary); }
    .table-card th .arrow {
      display: inline-block;
      margin-left: 0.3rem;
      font-size: 0.6rem;
      opacity: 0.35;
      transition: opacity 0.15s;
    }
    .table-card th.sorted .arrow { opacity: 1; color: var(--primary); }
    .table-card th.sorted { color: var(--primary); }

    .table-card td {
      padding: 0.65rem 1rem;
      font-size: 0.88rem;
      color: var(--text);
      border-bottom: 1px solid #f0f1f3;
      vertical-align: middle;
    }
    .table-card tbody tr {
      transition: background 0.12s;
    }
    .table-card tbody tr:hover { background: #f7fafa; }
    .table-card tbody tr:last-child td { border-bottom: none; }

    /* â”€â”€ Type badges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .type-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .type-credit { background: #e0f7f3; color: #0d9488; }
    .type-reward { background: #fef3c7; color: #b45309; }
    .type-adjustment { background: #ede9fe; color: #7c3aed; }
    .type-merge { background: #f3e8ff; color: #9333ea; }

    /* â”€â”€ Points cell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pts-positive { color: var(--success); font-weight: 600; }
    .pts-negative { color: var(--danger); font-weight: 600; }

    /* â”€â”€ Client cell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .client-cell {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .client-cell .star {
      color: #f59e0b;
      font-size: 1rem;
      flex-shrink: 0;
    }
    .client-name {
      font-weight: 500;
      color: var(--text);
    }
    .client-sub {
      font-size: 0.78rem;
      color: var(--text-light);
    }

    /* â”€â”€ Amount â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .amount-cell { font-variant-numeric: tabular-nums; }

    /* â”€â”€ Staff â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .staff-cell {
      font-size: 0.82rem;
      color: var(--text-light);
    }

    /* â”€â”€ Notes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .notes-cell {
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 0.82rem;
      color: var(--text-light);
    }

    /* â”€â”€ Date cell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .date-cell .day {
      font-weight: 500;
      font-size: 0.85rem;
    }
    .date-cell .time {
      font-size: 0.75rem;
      color: var(--text-light);
    }

    /* â”€â”€ Empty / loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dash-empty {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-light);
    }
    .dash-empty .ico { font-size: 2.5rem; margin-bottom: 0.75rem; }
    .dash-empty p { font-size: 0.95rem; }

    /* â”€â”€ Pagination â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dash-pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      border-top: 1px solid #f0f1f3;
      font-size: 0.82rem;
      color: var(--text-light);
    }
    .dash-pagination button {
      padding: 0.35rem 0.75rem;
      border: 1.5px solid var(--border);
      border-radius: 6px;
      background: #fff;
      font-size: 0.8rem;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
    }
    .dash-pagination button:hover:not(:disabled) {
      border-color: var(--primary);
      color: var(--primary);
    }
    .dash-pagination button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .page-btns { display: flex; gap: 0.4rem; }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 900px) {
      .dash-toolbar { flex-direction: column; align-items: flex-start; }
      .dash-search { margin-left: 0; width: 100%; }
      .dash-search input { width: 100%; }
      .table-card { overflow-x: auto; }
      .notes-cell { max-width: 120px; }
    }
    @media (max-width: 600px) {
      .dash-wrap { padding: 1rem; }
      .dash-header h1 { font-size: 1.25rem; }
      .table-card td, .table-card th { padding: 0.5rem 0.65rem; font-size: 0.8rem; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="/dashboard" class="navbar-brand">FIDDO<span></span></a>
    <div class="navbar-menu"></div>
  </nav>

  <div class="dash-wrap">

    <!-- Header -->
    <div class="dash-header">
      <h1>Tableau de bord</h1>
      <div class="dash-header-right">
        <a href="/credit" class="btn btn-primary btn-sm">â• CrÃ©diter</a>
        <button onclick="loadActivity()" class="btn btn-outline btn-sm">â†» RafraÃ®chir</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="dash-toolbar">
      <button class="filter-chip active" data-filter="all">Tout</button>
      <button class="filter-chip" data-filter="credit">CrÃ©dits</button>
      <button class="filter-chip" data-filter="reward">RÃ©compenses</button>
      <button class="filter-chip" data-filter="adjustment">Ajustements</button>
      <div class="dash-search">
        <span class="ico">ğŸ”</span>
        <input type="text" id="dash-search" placeholder="Rechercher un clientâ€¦">
      </div>
    </div>

    <!-- Table -->
    <div class="table-card">
      <table id="activity-table">
        <thead>
          <tr>
            <th data-col="date" class="sorted">Date <span class="arrow">â–¼</span></th>
            <th data-col="type">Type <span class="arrow">â–¼</span></th>
            <th data-col="client">Client <span class="arrow">â–¼</span></th>
            <th data-col="amount">Montant <span class="arrow">â–¼</span></th>
            <th data-col="points">Points <span class="arrow">â–¼</span></th>
            <th data-col="staff">Staff <span class="arrow">â–¼</span></th>
            <th data-col="notes">Notes <span class="arrow">â–¼</span></th>
          </tr>
        </thead>
        <tbody id="activity-body">
          <tr><td colspan="7"><div class="dash-empty"><div class="ico">â³</div><p>Chargementâ€¦</p></div></td></tr>
        </tbody>
      </table>
      <div class="dash-pagination" id="pagination" style="display:none;">
        <span id="page-info"></span>
        <div class="page-btns">
          <button id="btn-prev" onclick="changePage(-1)">â† PrÃ©cÃ©dent</button>
          <button id="btn-next" onclick="changePage(1)">Suivant â†’</button>
        </div>
      </div>
    </div>

  </div>

  <script src="/js/app.js"></script>
  <script>
    if (!requireManager()) throw 'Not authorized';

    const merchant = Auth.getMerchant();

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let allRows = [];
    let filteredRows = [];
    let sortCol = 'date';
    let sortAsc = false;
    let currentFilter = 'all';
    let searchTerm = '';
    const PAGE_SIZE = 25;
    let currentPage = 0;

    // â”€â”€ Type labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const TYPE_LABELS = {
      credit: 'CrÃ©dit',
      reward: 'RÃ©compense',
      adjustment: 'Ajustement',
      merge: 'Fusion',
    };

    // â”€â”€ Load activity from API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadActivity() {
      try {
        const data = await API.call('/clients/activity?limit=500');
        allRows = data.activity.map(t => ({
          id: t.id,
          date: t.created_at,
          dateObj: new Date(t.created_at),
          type: t.transaction_type,
          clientName: t.client_name || '',
          clientEmail: t.email || '',
          clientPhone: t.phone || '',
          clientDisplay: t.client_name || t.email || t.phone || 'â€”',
          canRedeem: t.can_redeem || false,
          amount: t.amount,
          points: t.points_delta,
          staff: t.staff_name || 'â€”',
          notes: t.notes || '',
        }));
        applyFilters();
      } catch (err) {
        console.error('Activity load error:', err);
        document.getElementById('activity-body').innerHTML =
          `<tr><td colspan="7"><div class="dash-empty"><div class="ico">âš ï¸</div><p>${err.message}</p></div></td></tr>`;
      }
    }

    // â”€â”€ Filtering + sorting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function applyFilters() {
      filteredRows = allRows.filter(r => {
        if (currentFilter !== 'all' && r.type !== currentFilter) return false;
        if (searchTerm) {
          const s = searchTerm.toLowerCase();
          const haystack = (r.clientDisplay + ' ' + r.clientEmail + ' ' + r.clientPhone + ' ' + r.staff + ' ' + r.notes).toLowerCase();
          if (!haystack.includes(s)) return false;
        }
        return true;
      });
      applySort();
    }

    function applySort() {
      filteredRows.sort((a, b) => {
        let va, vb;
        switch (sortCol) {
          case 'date':    va = a.dateObj; vb = b.dateObj; break;
          case 'type':    va = a.type; vb = b.type; break;
          case 'client':  va = a.clientDisplay.toLowerCase(); vb = b.clientDisplay.toLowerCase(); break;
          case 'amount':  va = a.amount || 0; vb = b.amount || 0; break;
          case 'points':  va = a.points; vb = b.points; break;
          case 'staff':   va = a.staff.toLowerCase(); vb = b.staff.toLowerCase(); break;
          case 'notes':   va = a.notes.toLowerCase(); vb = b.notes.toLowerCase(); break;
          default:        va = a.dateObj; vb = b.dateObj;
        }
        if (va < vb) return sortAsc ? -1 : 1;
        if (va > vb) return sortAsc ? 1 : -1;
        return 0;
      });
      currentPage = 0;
      render();
    }

    // â”€â”€ Render table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function render() {
      const tbody = document.getElementById('activity-body');
      const start = currentPage * PAGE_SIZE;
      const page = filteredRows.slice(start, start + PAGE_SIZE);

      if (filteredRows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7"><div class="dash-empty"><div class="ico">ğŸ“‹</div><p>Aucune activitÃ© trouvÃ©e</p></div></td></tr>`;
        document.getElementById('pagination').style.display = 'none';
        return;
      }

      let html = '';
      page.forEach(r => {
        const dateStr = r.dateObj.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const timeStr = r.dateObj.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        const sign = r.points >= 0 ? '+' : '';
        const ptsCls = r.points >= 0 ? 'pts-positive' : 'pts-negative';

        html += `<tr>
          <td class="date-cell"><span class="day">${dateStr}</span><br><span class="time">${timeStr}</span></td>
          <td><span class="type-badge type-${r.type}">${TYPE_LABELS[r.type] || r.type}</span></td>
          <td>
            <div class="client-cell">
              ${r.canRedeem ? '<span class="star" title="RÃ©compense disponible">â­</span>' : ''}
              <div>
                <div class="client-name">${escHtml(r.clientDisplay)}</div>
                ${r.clientEmail && r.clientDisplay !== r.clientEmail ? `<div class="client-sub">${escHtml(r.clientEmail)}</div>` : ''}
              </div>
            </div>
          </td>
          <td class="amount-cell">${r.amount != null ? Format.currency(r.amount) : 'â€”'}</td>
          <td><span class="${ptsCls}">${sign}${r.points}</span></td>
          <td class="staff-cell">${escHtml(r.staff)}</td>
          <td class="notes-cell" title="${escAttr(r.notes)}">${escHtml(r.notes) || 'â€”'}</td>
        </tr>`;
      });
      tbody.innerHTML = html;

      // Pagination
      const totalPages = Math.ceil(filteredRows.length / PAGE_SIZE);
      const pag = document.getElementById('pagination');
      if (totalPages > 1) {
        pag.style.display = 'flex';
        document.getElementById('page-info').textContent =
          `${start + 1}â€“${Math.min(start + PAGE_SIZE, filteredRows.length)} sur ${filteredRows.length}`;
        document.getElementById('btn-prev').disabled = currentPage === 0;
        document.getElementById('btn-next').disabled = currentPage >= totalPages - 1;
      } else {
        pag.style.display = filteredRows.length > 0 ? 'flex' : 'none';
        document.getElementById('page-info').textContent = `${filteredRows.length} rÃ©sultat${filteredRows.length > 1 ? 's' : ''}`;
        document.getElementById('btn-prev').disabled = true;
        document.getElementById('btn-next').disabled = true;
      }
    }

    function changePage(dir) {
      currentPage += dir;
      render();
      document.querySelector('.table-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // â”€â”€ Column sort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.querySelectorAll('#activity-table th[data-col]').forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.col;
        if (sortCol === col) {
          sortAsc = !sortAsc;
        } else {
          sortCol = col;
          sortAsc = col === 'client' || col === 'staff'; // alpha default asc
        }
        // Update UI
        document.querySelectorAll('#activity-table th').forEach(h => {
          h.classList.remove('sorted');
          h.querySelector('.arrow').textContent = 'â–¼';
        });
        th.classList.add('sorted');
        th.querySelector('.arrow').textContent = sortAsc ? 'â–²' : 'â–¼';
        applySort();
      });
    });

    // â”€â”€ Filter chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        currentFilter = chip.dataset.filter;
        applyFilters();
      });
    });

    // â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let searchTimeout;
    document.getElementById('dash-search').addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchTerm = e.target.value.trim();
        applyFilters();
      }, 200);
    });

    // â”€â”€ Escape helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function escHtml(s) {
      if (!s) return '';
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function escAttr(s) {
      if (!s) return '';
      return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    loadActivity();
  </script>
</body>
</html>
