<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tableau de bord — FIDDO</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    /* ── Compact activity table ── */
    .activity-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .activity-table thead { background: var(--secondary); color: white; position: sticky; top: 0; }
    .activity-table th { padding: 8px 10px; text-align: left; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; cursor: pointer; user-select: none; transition: background 0.15s; }
    .activity-table th:hover { background: rgba(255,255,255,0.1); }
    .sort-arrow { margin-left: 4px; font-size: 0.65rem; opacity: 0.4; }
    .sort-arrow.active { opacity: 1; }
    .activity-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
    .activity-table tbody tr:hover { background: #f0fdf4; }
    .activity-table tbody tr:last-child td { border-bottom: none; }

    .tx-type { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
    .tx-credit { background: #CFFAFE; color: var(--primary); }
    .tx-reward { background: #e8f5e9; color: var(--success); }
    .tx-adjustment { background: #fff3e0; color: var(--warning); }

    .activity-scroll { max-height: 500px; overflow-y: auto; border-radius: 0 0 10px 10px; }

    /* Staff pill */
    .staff-pill { font-size: 0.75rem; color: var(--text-light); }
    .staff-pill strong { color: var(--text); }

    /* Points display */
    .pts-positive { color: var(--primary); font-weight: 700; }
    .pts-negative { color: var(--danger); font-weight: 700; }

    /* Settings compact */
    .settings-grid { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 0.75rem; align-items: end; }
    @media (max-width: 768px) { .settings-grid { grid-template-columns: 1fr 1fr; } }

    /* Mobile table */
    @media (max-width: 600px) {
      .activity-table { font-size: 0.8rem; }
      .activity-table th, .activity-table td { padding: 6px 6px; }
      .hide-mobile { display: none; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="/dashboard" class="navbar-brand">FIDDO<span></span></a>
    <div class="navbar-menu"></div>
  </nav>

  <div class="container">
    <h1 style="margin: 1rem 0 0.75rem; font-size: 1.3rem;">Tableau de bord</h1>

    <!-- Stats -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="stat-clients">-</div>
        <div class="stat-label">Clients</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-active">-</div>
        <div class="stat-label">Actifs (30j)</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-revenue">-</div>
        <div class="stat-label">CA Total</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-avg">-</div>
        <div class="stat-label">Panier moyen</div>
      </div>
    </div>

    <!-- Recent Activity (full width) -->
    <div class="card" style="padding: 0; overflow: hidden;">
      <div class="card-header" style="padding: 1rem 1rem 0.75rem;">
        Activité récente
        <a href="/clients" class="btn btn-primary btn-sm">Voir tous les clients</a>
      </div>
      <div class="activity-scroll" id="activity-container">
        <div class="loading" style="padding: 2rem;">Chargement...</div>
      </div>
    </div>

    <!-- Settings (owner only) -->
    <div class="card" id="settings-card" style="display: none;">
      <div class="card-header" style="margin-bottom: 0.75rem;">⚙️ Paramètres de fidélité</div>
      <div id="settings-alert"></div>
      <form id="settings-form">
        <div class="settings-grid">
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Points / €</label>
            <input type="number" id="set-ppe" class="form-control" step="0.1" min="0.1">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Pts récompense</label>
            <input type="number" id="set-pfr" class="form-control" min="1">
          </div>
          <div class="form-group" style="margin-bottom: 0;">
            <label class="form-label">Description</label>
            <input type="text" id="set-desc" class="form-control" placeholder="Boisson offerte">
          </div>
          <button type="submit" class="btn btn-primary btn-sm" style="height: 40px;">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    if (!requireManager()) throw 'Not authorized';

    const staff = Auth.getStaff();
    const merchant = Auth.getMerchant();

    // Settings (owner)
    if (staff.role === 'owner') {
      document.getElementById('settings-card').style.display = 'block';
      document.getElementById('set-ppe').value = merchant.points_per_euro;
      document.getElementById('set-pfr').value = merchant.points_for_reward;
      document.getElementById('set-desc').value = merchant.reward_description;
    }

    // ── Load stats from enriched endpoint ──
    async function loadStats() {
      try {
        const data = await API.call('/clients/enriched');
        const clients = data.clients;

        const total = clients.length;
        const active = clients.filter(c => (Date.now() - new Date(c.last_visit)) / 86400000 <= 30).length;
        const revenue = clients.reduce((s, c) => s + c.total_spent, 0);
        const visits = clients.reduce((s, c) => s + c.visit_count, 0);
        const avg = visits > 0 ? revenue / visits : 0;

        document.getElementById('stat-clients').textContent = total;
        document.getElementById('stat-active').textContent = active;
        document.getElementById('stat-revenue').textContent = Format.currency(revenue);
        document.getElementById('stat-avg').textContent = Format.currency(avg);
      } catch (err) { console.error('Stats error:', err); }
    }

    // ── Load recent activity ──
    let allTxs = [];
    let sortCol = 'date';
    let sortDir = 'desc';

    async function loadActivity() {
      try {
        const data = await API.call('/clients/recent-activity?limit=30');
        allTxs = data.transactions;
        renderActivity();
      } catch (err) {
        console.error('Activity error:', err);
        document.getElementById('activity-container').innerHTML = '<div class="alert alert-error" style="margin:1rem">Erreur de chargement</div>';
      }
    }

    function sortActivity(col) {
      if (sortCol === col) { sortDir = sortDir === 'asc' ? 'desc' : 'asc'; }
      else { sortCol = col; sortDir = col === 'date' ? 'desc' : 'asc'; }
      renderActivity();
    }

    function renderActivity() {
      const container = document.getElementById('activity-container');
      if (allTxs.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding:2rem"><p class="text-muted">Aucune activité</p></div>';
        return;
      }

      const sorted = [...allTxs].sort((a, b) => {
        let va, vb;
        switch (sortCol) {
          case 'client':  va = (a.client_name || a.client_email || a.client_phone || '').toLowerCase(); vb = (b.client_name || b.client_email || b.client_phone || '').toLowerCase(); break;
          case 'points':  va = a.points_delta; vb = b.points_delta; break;
          case 'amount':  va = a.amount || 0; vb = b.amount || 0; break;
          case 'type':    va = a.transaction_type; vb = b.transaction_type; break;
          case 'staff':   va = (a.staff_name || '').toLowerCase(); vb = (b.staff_name || '').toLowerCase(); break;
          case 'date':    va = a.created_at; vb = b.created_at; break;
          default:        va = 0; vb = 0;
        }
        if (va < vb) return sortDir === 'asc' ? -1 : 1;
        if (va > vb) return sortDir === 'asc' ? 1 : -1;
        return 0;
      });

      function arrow(col) {
        if (sortCol !== col) return '<span class="sort-arrow">↕</span>';
        return `<span class="sort-arrow active">${sortDir === 'asc' ? '▲' : '▼'}</span>`;
      }

      let html = `<table class="activity-table"><thead><tr>
          <th onclick="sortActivity('client')">Client ${arrow('client')}</th>
          <th onclick="sortActivity('points')">Points ${arrow('points')}</th>
          <th class="hide-mobile" onclick="sortActivity('amount')">Montant ${arrow('amount')}</th>
          <th onclick="sortActivity('type')">Type ${arrow('type')}</th>
          <th onclick="sortActivity('staff')">Par ${arrow('staff')}</th>
          <th onclick="sortActivity('date')">Date ${arrow('date')}</th>
        </tr></thead><tbody>`;

      sorted.forEach(t => {
        const client = t.client_name || t.client_email || t.client_phone || '—';
        const sign = t.points_delta >= 0 ? '+' : '';
        const ptsClass = t.points_delta >= 0 ? 'pts-positive' : 'pts-negative';
        const typeLabel = { credit: 'Crédit', reward: 'Récomp.', adjustment: 'Ajust.', merge: 'Fusion' }[t.transaction_type] || t.transaction_type;
        const typeClass = `tx-${t.transaction_type}`;

        html += `<tr>
            <td><strong>${escHtml(client)}</strong></td>
            <td class="${ptsClass}">${sign}${t.points_delta}</td>
            <td class="hide-mobile">${t.amount ? Format.currency(t.amount) : '—'}</td>
            <td><span class="tx-type ${typeClass}">${typeLabel}</span></td>
            <td class="staff-pill"><strong>${escHtml(t.staff_name || 'Système')}</strong></td>
            <td class="staff-pill">${formatShortDate(t.created_at)}</td>
          </tr>`;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // ── Helpers ──
    function escHtml(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    function formatShortDate(d) {
      const dt = new Date(d);
      const now = new Date();
      const diffMs = now - dt;
      const diffDays = Math.floor(diffMs / 86400000);
      const time = dt.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

      if (diffDays === 0) return `Auj. ${time}`;
      if (diffDays === 1) return `Hier ${time}`;
      if (diffDays < 7) return `${dt.toLocaleDateString('fr-FR', { weekday: 'short' })} ${time}`;
      return dt.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' }) + ' ' + time;
    }

    // ── Settings form ──
    document.getElementById('settings-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const settings = {
          pointsPerEuro: parseFloat(document.getElementById('set-ppe').value),
          pointsForReward: parseInt(document.getElementById('set-pfr').value),
          rewardDescription: document.getElementById('set-desc').value,
        };
        await API.auth.updateSettings(settings);
        merchant.points_per_euro = settings.pointsPerEuro;
        merchant.points_for_reward = settings.pointsForReward;
        merchant.reward_description = settings.rewardDescription;
        Auth.setSession(staff, merchant);
        UI.showAlert('settings-alert', 'Paramètres mis à jour !', 'success');
        setTimeout(() => UI.clearAlert('settings-alert'), 3000);
      } catch (err) { UI.showAlert('settings-alert', err.message, 'error'); }
    });

    // Init
    loadStats();
    loadActivity();
  </script>
</body>
</html>
