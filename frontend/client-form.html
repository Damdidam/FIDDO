<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0F172A">
  <title>FIDDO â€” FidÃ©litÃ©</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --accent: #0891B2;
      --accent-dark: #0E7490;
      --accent-light: #ECFEFF;
      --accent-glow: rgba(8,145,178,0.18);
      --dark: #0F172A;
      --card: #FFFFFF;
      --bg: #F1F5F9;
      --gradient: linear-gradient(135deg, var(--accent), var(--accent-dark));
    }

    [data-theme="navy"]   { --accent: #1E40AF; --accent-dark: #1E3A8A; --accent-light: #DBEAFE; --accent-glow: rgba(30,64,175,0.18); }
    [data-theme="violet"] { --accent: #7C3AED; --accent-dark: #6D28D9; --accent-light: #EDE9FE; --accent-glow: rgba(124,58,237,0.18); }
    [data-theme="forest"] { --accent: #059669; --accent-dark: #047857; --accent-light: #D1FAE5; --accent-glow: rgba(5,150,105,0.18); }
    [data-theme="brick"]  { --accent: #DC2626; --accent-dark: #B91C1C; --accent-light: #FEE2E2; --accent-glow: rgba(220,38,38,0.18); }
    [data-theme="amber"]  { --accent: #D97706; --accent-dark: #B45309; --accent-light: #FEF3C7; --accent-glow: rgba(217,119,6,0.18); }
    [data-theme="slate"]  { --accent: #475569; --accent-dark: #334155; --accent-light: #F1F5F9; --accent-glow: rgba(71,85,105,0.18); }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--dark);
      color: #1E293B;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Dark top area â”€â”€ */
    .top-zone {
      background: var(--dark);
      padding: 2.5rem 1.5rem 3.5rem;
      text-align: center;
      position: relative;
    }
    .top-zone::after {
      content: '';
      position: absolute;
      bottom: -1px; left: 0; right: 0;
      height: 32px;
      background: var(--bg);
      border-radius: 24px 24px 0 0;
    }

    .brand {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--accent);
      letter-spacing: -0.5px;
      margin-bottom: 0.75rem;
    }
    .merchant-name {
      font-size: 1.15rem;
      font-weight: 700;
      color: #FFFFFF;
      margin-bottom: 0.25rem;
    }
    .merchant-sub {
      font-size: 0.78rem;
      color: #94A3B8;
    }

    /* â”€â”€ Content area â”€â”€ */
    .content {
      flex: 1;
      background: var(--bg);
      padding: 0 1.25rem 2rem;
    }
    .content-inner {
      max-width: 400px;
      margin: 0 auto;
    }

    /* â”€â”€ Card â”€â”€ */
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    }

    /* â”€â”€ Form â”€â”€ */
    .form-group { margin-bottom: 1rem; }
    .form-label {
      display: block;
      font-size: 0.75rem;
      font-weight: 700;
      color: #64748B;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-control {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #E2E8F0;
      border-radius: 12px;
      font-size: 1rem;
      font-family: inherit;
      transition: all 0.25s;
      background: #F8FAFC;
      color: #1E293B;
    }
    .form-control:focus {
      outline: none;
      border-color: var(--accent);
      background: white;
      box-shadow: 0 0 0 4px var(--accent-glow);
    }
    .form-control::placeholder { color: #CBD5E1; }

    /* â”€â”€ Segment toggle â”€â”€ */
    .seg {
      display: flex;
      background: #F1F5F9;
      border-radius: 12px;
      padding: 3px;
      margin-bottom: 1rem;
    }
    .seg button {
      flex: 1;
      padding: 10px;
      border: none;
      background: none;
      border-radius: 10px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #94A3B8;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.25s;
    }
    .seg button.active {
      background: white;
      color: var(--accent);
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    /* â”€â”€ Button â”€â”€ */
    .btn-submit {
      display: block;
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 14px;
      font-size: 1.05rem;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      background: var(--gradient);
      color: white;
      transition: all 0.25s;
      margin-top: 0.5rem;
      position: relative;
      overflow: hidden;
    }
    .btn-submit:hover { transform: translateY(-1px); box-shadow: 0 6px 20px var(--accent-glow); }
    .btn-submit:active { transform: translateY(0); }
    .btn-submit:disabled { opacity: 0.5; transform: none; cursor: not-allowed; }

    /* â”€â”€ Alert â”€â”€ */
    .alert {
      padding: 0.7rem 0.9rem;
      border-radius: 10px;
      font-size: 0.85rem;
      margin-bottom: 0.75rem;
      animation: slideIn 0.3s ease;
    }
    .alert-error { background: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; }

    @keyframes slideIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }

    /* â”€â”€ Reward info â”€â”€ */
    .reward-info {
      background: var(--accent-light);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      text-align: center;
      font-size: 0.82rem;
      color: var(--accent-dark);
      margin-bottom: 1rem;
      font-weight: 500;
    }

    /* â”€â”€ Success screen â”€â”€ */
    .success-card {
      text-align: center;
      padding: 2rem 1.5rem;
      animation: pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .success-icon {
      width: 72px;
      height: 72px;
      background: linear-gradient(135deg, #10B981, #059669);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
      font-size: 2rem;
      box-shadow: 0 8px 24px rgba(16,185,129,0.25);
    }
    .success-card h2 { font-size: 1.2rem; color: #166534; margin-bottom: 0.5rem; }
    .success-card p { font-size: 0.88rem; color: #64748B; line-height: 1.5; }
    .success-points {
      display: inline-block;
      background: var(--accent-light);
      color: var(--accent-dark);
      font-weight: 700;
      padding: 0.4rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      margin-top: 0.75rem;
    }

    @keyframes pop {
      0% { transform: scale(0.85); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* â”€â”€ Error screen â”€â”€ */
    .error-card {
      text-align: center;
      padding: 2rem 1.5rem;
    }

    /* â”€â”€ Loading â”€â”€ */
    .spinner {
      width: 36px; height: 36px;
      border: 3px solid rgba(255,255,255,0.15);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      margin: 3rem auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Screens â”€â”€ */
    .screen { display: none; }
    .screen.active { display: block; }

    /* â”€â”€ Footer â”€â”€ */
    .footer {
      background: var(--bg);
      text-align: center;
      padding: 0.75rem;
      font-size: 0.68rem;
      color: #CBD5E1;
    }

    /* â•â•â• RESPONSIVE â•â•â• */
    @media (max-width: 480px) {
      .hero { padding: 1.75rem 1rem 2.5rem; }
      .hero h1 { font-size: 1.25rem; }
      .hero .merchant-name { font-size: 1rem; }
      .main { padding: 0 0.75rem 1.5rem; }
      .form-card { padding: 1.25rem; }
      .form-input { padding: 13px 14px; }
      .btn-submit { min-height: 48px; padding: 14px; }
      .lang-bar { gap: 2px; }
      .lang-btn { padding: 8px; min-width: 44px; }
    }
  </style>
</head>
<body>

  <!-- â•â•â• DARK TOP â•â•â• -->
  <div class="top-zone">
    <div class="merchant-name" id="merchant-name">Chargementâ€¦</div>
    <div class="merchant-sub">Programme de fidÃ©litÃ©</div>
  </div>

  <!-- â•â•â• CONTENT â•â•â• -->
  <div class="content">
    <div class="content-inner">

      <!-- LOADING -->
      <div id="screen-loading" class="screen active">
        <div class="spinner"></div>
      </div>

      <!-- ERROR -->
      <div id="screen-error" class="screen">
        <div class="card error-card">
          <div style="font-size:2.5rem; margin-bottom:0.75rem;">ğŸ˜•</div>
          <h2 style="font-size:1.1rem; margin-bottom:0.5rem;" id="error-title">Commerce non trouvÃ©</h2>
          <p style="font-size:0.85rem; color:#64748B;" id="error-msg">Ce QR code n'est pas valide ou le commerce n'est plus actif.</p>
        </div>
      </div>

      <!-- FORM -->
      <div id="screen-form" class="screen">
        <div id="reward-info" class="reward-info"></div>

        <div class="card">
          <div id="form-alert"></div>

          <div class="seg">
            <button type="button" id="seg-email" class="active" onclick="setMode('email')">@ Email</button>
            <button type="button" id="seg-phone" onclick="setMode('phone')"># TÃ©lÃ©phone</button>
          </div>

          <div class="form-group" id="group-email">
            <label class="form-label">Adresse email</label>
            <input type="email" id="inp-email" class="form-control" placeholder="votre@email.com" autocomplete="email" inputmode="email">
          </div>

          <div class="form-group" id="group-phone" style="display:none;">
            <label class="form-label">NumÃ©ro de tÃ©lÃ©phone</label>
            <input type="tel" id="inp-phone" class="form-control" placeholder="+32 497 12 34 56" autocomplete="tel" inputmode="tel">
          </div>

          <div class="form-group">
            <label class="form-label">Nom / prÃ©nom <span style="font-weight:400; text-transform:none; letter-spacing:0;">(optionnel)</span></label>
            <input type="text" id="inp-name" class="form-control" placeholder="Pierre" autocomplete="name">
          </div>

          <button class="btn-submit" id="btn-submit" onclick="doSubmit()">
            âœ“ C'est moi !
          </button>
        </div>
      </div>

      <!-- SUCCESS -->
      <div id="screen-success" class="screen">
        <div class="card success-card">
          <div class="success-icon">âœ“</div>
          <h2 id="success-title">Vous Ãªtes identifiÃ© !</h2>
          <p id="success-msg">Le commerce va crÃ©diter vos points. Bon appÃ©tit !</p>
          <div class="success-points" id="success-points" style="display:none;"></div>
        </div>
      </div>

    </div>
  </div>

  <div class="footer">PropulsÃ© par FIDDO</div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIG & STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const API_BASE = window.location.hostname === 'localhost'
      ? 'http://localhost:3000/api' : '/api';

    let qrToken = null;
    let merchantInfo = null;
    let mode = 'email';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    (async function init() {
      // Extract token: /q/ABC123
      const parts = window.location.pathname.split('/');
      if (parts[1] === 'q' && parts[2]) {
        qrToken = parts[2];
      } else {
        const p = new URLSearchParams(window.location.search);
        qrToken = p.get('s') || p.get('token');
      }

      if (!qrToken) {
        showError('Lien invalide', 'Ce lien ne contient pas de code QR valide.');
        return;
      }

      try {
        const resp = await fetch(`${API_BASE}/qr/info/${qrToken}`);
        if (!resp.ok) {
          showError('Commerce non trouvÃ©', 'Ce QR code n\'est pas valide ou le commerce n\'est plus actif.');
          return;
        }
        merchantInfo = await resp.json();

        // Theme
        document.body.setAttribute('data-theme', merchantInfo.theme || 'teal');
        document.getElementById('merchant-name').textContent = merchantInfo.merchantName;
        document.title = `${merchantInfo.merchantName} â€” FidÃ©litÃ©`;

        const themeColors = {
          teal: '#0891B2', navy: '#1E40AF', violet: '#7C3AED',
          forest: '#059669', brick: '#DC2626', amber: '#D97706', slate: '#475569'
        };
        document.querySelector('meta[name="theme-color"]').content = themeColors[merchantInfo.theme] || '#0891B2';

        // Reward info
        document.getElementById('reward-info').innerHTML =
          'ğŸ ' + merchantInfo.pointsPerEuro + ' pt/â‚¬ Â· RÃ©compense Ã  ' +
          merchantInfo.pointsForReward + ' pts â€” <strong>' + merchantInfo.rewardDescription + '</strong>';

        // Check if already identified (session ID from previous submit)
        const savedIdentId = sessionStorage.getItem('fiddo_ident_' + qrToken);
        if (savedIdentId) {
          try {
            const check = await fetch(`${API_BASE}/qr/status/${savedIdentId}?qrToken=${qrToken}`);
            const status = await check.json();
            if (status.active) {
              showSuccess(status);
              return;
            }
          } catch (e) {}
          sessionStorage.removeItem('fiddo_ident_' + qrToken);
        }

        showScreen('screen-form');

        // Focus first field
        setTimeout(() => document.getElementById('inp-email').focus(), 400);

      } catch (e) {
        showError('Erreur de connexion', 'Impossible de contacter le serveur.');
      }
    })();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SCREENS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function showError(title, msg) {
      document.getElementById('error-title').textContent = title;
      document.getElementById('error-msg').textContent = msg;
      document.getElementById('merchant-name').textContent = 'FIDDO';
      showScreen('screen-error');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MODE TOGGLE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function setMode(m) {
      mode = m;
      document.getElementById('seg-email').classList.toggle('active', m === 'email');
      document.getElementById('seg-phone').classList.toggle('active', m === 'phone');
      document.getElementById('group-email').style.display = m === 'email' ? '' : 'none';
      document.getElementById('group-phone').style.display = m === 'phone' ? '' : 'none';

      const inp = document.getElementById(m === 'email' ? 'inp-email' : 'inp-phone');
      setTimeout(() => inp.focus(), 100);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SUBMIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function doSubmit() {
      document.getElementById('form-alert').innerHTML = '';

      const email = mode === 'email' ? document.getElementById('inp-email').value.trim() : null;
      const phone = mode === 'phone' ? document.getElementById('inp-phone').value.trim() : null;
      const name = document.getElementById('inp-name').value.trim() || null;

      // Validation
      if (mode === 'email' && !email) {
        showAlert('Saisissez votre adresse email'); return;
      }
      if (mode === 'email' && !/\S+@\S+\.\S+/.test(email)) {
        showAlert('Adresse email invalide'); return;
      }
      if (mode === 'phone' && !phone) {
        showAlert('Saisissez votre numÃ©ro de tÃ©lÃ©phone'); return;
      }

      const btn = document.getElementById('btn-submit');
      btn.disabled = true;
      btn.textContent = 'Envoiâ€¦';

      try {
        const resp = await fetch(`${API_BASE}/qr/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ qrToken, email, phone, name }),
        });

        const data = await resp.json();

        if (!resp.ok) {
          showAlert(data.error || 'Erreur');
          btn.disabled = false;
          btn.textContent = 'âœ“ C\'est moi !';
          return;
        }

        // Success â€” save session ID
        sessionStorage.setItem('fiddo_ident_' + qrToken, data.identId);

        showSuccess(data);

      } catch (e) {
        showAlert('Erreur rÃ©seau. RÃ©essayez.');
        btn.disabled = false;
        btn.textContent = 'âœ“ C\'est moi !';
      }
    }

    function showSuccess(data) {
      if (data.isNew) {
        document.getElementById('success-title').textContent = 'Bienvenue ! ğŸ‰';
        document.getElementById('success-msg').textContent =
          'Vous Ãªtes enregistrÃ© chez ' + merchantInfo.merchantName + '. Vos premiers points arrivent !';
      } else {
        document.getElementById('success-title').textContent = 'Content de vous revoir !';
        document.getElementById('success-msg').textContent =
          (data.clientName ? data.clientName + ', v' : 'V') + 'ous Ãªtes identifiÃ©. Vos points arrivent !';
        if (data.pointsBalance > 0) {
          const el = document.getElementById('success-points');
          el.textContent = 'ğŸ’° Solde actuel : ' + data.pointsBalance + ' pts';
          el.style.display = 'inline-block';
        }
      }
      showScreen('screen-success');
    }

    function showAlert(msg) {
      document.getElementById('form-alert').innerHTML =
        '<div class="alert alert-error">' + msg + '</div>';
    }

    // Submit on Enter
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && document.getElementById('screen-form').classList.contains('active')) {
        e.preventDefault();
        doSubmit();
      }
    });
  </script>
</body>
</html>
