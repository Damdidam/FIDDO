<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0891B2">
  <title>FIDDO â€” Mon compte fidÃ©litÃ©</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="/logo-fiddo.png">
  <link rel="apple-touch-icon" href="/logo-fiddo.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --accent: #0891B2;
      --accent-dark: #0E7490;
      --accent-light: #ECFEFF;
      --accent-glow: rgba(8,145,178,0.12);
      --dark: #1F2937;
      --gradient: linear-gradient(135deg, var(--accent), var(--accent-dark));
    }

    [data-theme="navy"]   { --accent: #1E40AF; --accent-dark: #1E3A8A; --accent-light: #DBEAFE; --accent-glow: rgba(30,64,175,0.12); --dark: #1E293B; }
    [data-theme="violet"] { --accent: #7C3AED; --accent-dark: #6D28D9; --accent-light: #EDE9FE; --accent-glow: rgba(124,58,237,0.12); --dark: #1E1B4B; }
    [data-theme="forest"] { --accent: #059669; --accent-dark: #047857; --accent-light: #D1FAE5; --accent-glow: rgba(5,150,105,0.12); --dark: #1A2E1A; }
    [data-theme="brick"]  { --accent: #DC2626; --accent-dark: #B91C1C; --accent-light: #FEE2E2; --accent-glow: rgba(220,38,38,0.12); --dark: #2D1B1B; }
    [data-theme="amber"]  { --accent: #D97706; --accent-dark: #B45309; --accent-light: #FEF3C7; --accent-glow: rgba(217,119,6,0.12); --dark: #2D2415; }
    [data-theme="slate"]  { --accent: #475569; --accent-dark: #334155; --accent-light: #F1F5F9; --accent-glow: rgba(71,85,105,0.12); --dark: #0F172A; }

    body {
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #F1F5F9;
      color: #1E293B;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Header â”€â”€ */
    .hdr {
      background: var(--gradient);
      color: white;
      padding: 1.1rem 1rem 0.9rem;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    .hdr::after {
      content: '';
      position: absolute;
      bottom: -1px; left: 0; right: 0;
      height: 20px;
      background: #F1F5F9;
      border-radius: 50% 50% 0 0 / 100% 100% 0 0;
    }
    .hdr h1 { font-size: 1.15rem; font-weight: 700; }
    .hdr p { font-size: 0.75rem; opacity: 0.85; margin-top: 2px; }

    /* â”€â”€ Main â”€â”€ */
    .main {
      flex: 1;
      padding: 0.75rem 1rem 2rem;
      max-width: 420px;
      margin: 0 auto;
      width: 100%;
    }

    /* â”€â”€ Card â”€â”€ */
    .card {
      background: white;
      border-radius: 14px;
      padding: 1.25rem;
      box-shadow: 0 2px 12px rgba(0,0,0,0.06);
      margin-bottom: 0.75rem;
    }

    /* â”€â”€ Form â”€â”€ */
    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; font-size: 0.8rem; font-weight: 600; color: #64748B; margin-bottom: 0.3rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-control {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #E2E8F0;
      border-radius: 10px;
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s;
      background: white;
    }
    .form-control:focus { outline: none; border-color: var(--accent); }
    .form-hint { font-size: 0.72rem; color: #94A3B8; margin-top: 3px; }

    /* â”€â”€ Segment toggle â”€â”€ */
    .seg {
      display: flex;
      background: #F1F5F9;
      border-radius: 10px;
      padding: 3px;
      margin-bottom: 1rem;
    }
    .seg button {
      flex: 1;
      padding: 8px;
      border: none;
      background: none;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #64748B;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }
    .seg button.active {
      background: white;
      color: var(--accent);
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    /* â”€â”€ PIN input â”€â”€ */
    .pin-row {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 0.5rem 0;
    }
    .pin-digit {
      width: 52px;
      height: 56px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      border: 2px solid #E2E8F0;
      border-radius: 10px;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    .pin-digit:focus { outline: none; border-color: var(--accent); }

    /* â”€â”€ Buttons â”€â”€ */
    .btn {
      display: block;
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--gradient); color: white; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 16px var(--accent-glow); }
    .btn-primary:disabled { opacity: 0.5; transform: none; cursor: not-allowed; }

    .btn-identify {
      background: linear-gradient(135deg, #10B981, #059669);
      color: white;
      font-size: 1.1rem;
      padding: 18px;
      border-radius: 14px;
    }
    .btn-identify:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(16,185,129,0.3); }
    .btn-identify:disabled { opacity: 0.5; transform: none; }

    .btn-outline {
      background: none;
      border: 2px solid #E2E8F0;
      color: #64748B;
      font-size: 0.85rem;
      padding: 10px;
    }
    .btn-outline:hover { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ Alert â”€â”€ */
    .alert {
      padding: 0.65rem 0.85rem;
      border-radius: 10px;
      font-size: 0.85rem;
      margin-bottom: 0.75rem;
    }
    .alert-error { background: #FEF2F2; color: #DC2626; border: 1px solid #FECACA; }
    .alert-success { background: #F0FDF4; color: #166534; border: 1px solid #BBF7D0; }
    .alert-info { background: var(--accent-light); color: var(--accent-dark); border: 1px solid var(--accent); border-opacity: 0.3; }

    /* â”€â”€ Points display â”€â”€ */
    .pts-hero {
      text-align: center;
      padding: 1.5rem 0 0.75rem;
    }
    .pts-hero .value {
      font-size: 3.5rem;
      font-weight: 800;
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1;
    }
    .pts-hero .label {
      font-size: 0.85rem;
      color: #64748B;
      margin-top: 4px;
    }

    /* â”€â”€ Progress bar â”€â”€ */
    .progress-wrap { margin: 0.75rem 0; }
    .progress-bar {
      height: 10px;
      background: #E2E8F0;
      border-radius: 5px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: var(--gradient);
      border-radius: 5px;
      transition: width 0.6s ease;
    }
    .progress-text {
      display: flex;
      justify-content: space-between;
      font-size: 0.72rem;
      color: #94A3B8;
      margin-top: 4px;
    }

    /* â”€â”€ Reward banner â”€â”€ */
    .reward-banner {
      background: linear-gradient(135deg, #10B981, #059669);
      color: white;
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 0.75rem;
    }
    .reward-banner h3 { font-size: 1.1rem; margin-bottom: 4px; }
    .reward-banner p { font-size: 0.8rem; opacity: 0.9; }

    /* â”€â”€ Stats â”€â”€ */
    .stats-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .stats-row .stat {
      background: #F8FAFC;
      border-radius: 10px;
      padding: 0.75rem;
      text-align: center;
    }
    .stats-row .stat .val { font-size: 1.3rem; font-weight: 700; color: var(--accent); }
    .stats-row .stat .lbl { font-size: 0.7rem; color: #94A3B8; text-transform: uppercase; }

    /* â”€â”€ Identified confirmation â”€â”€ */
    .identified {
      background: #F0FDF4;
      border: 2px solid #BBF7D0;
      border-radius: 14px;
      padding: 1.5rem;
      text-align: center;
      margin-bottom: 0.75rem;
      animation: pop 0.4s ease;
    }
    .identified .icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .identified h3 { color: #166534; font-size: 1rem; }
    .identified p { color: #64748B; font-size: 0.8rem; margin-top: 4px; }

    @keyframes pop {
      0% { transform: scale(0.9); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* â”€â”€ Loading â”€â”€ */
    .spinner {
      width: 32px; height: 32px;
      border: 3px solid #E2E8F0;
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 2rem auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Footer â”€â”€ */
    .footer {
      text-align: center;
      padding: 1rem;
      font-size: 0.7rem;
      color: #94A3B8;
    }
    .footer a { color: var(--accent); text-decoration: none; }

    /* â”€â”€ Screens â”€â”€ */
    .screen { display: none; }
    .screen.active { display: block; }

    /* â”€â”€ Install prompt â”€â”€ */
    .install-hint {
      background: var(--accent-light);
      border-radius: 10px;
      padding: 0.6rem 0.85rem;
      font-size: 0.75rem;
      color: var(--accent-dark);
      margin-bottom: 0.75rem;
      text-align: center;
    }
  </style>
</head>
<body>

  <div class="hdr">
    <h1 id="merchant-name">Chargementâ€¦</h1>
    <p>Programme de fidÃ©litÃ©</p>
  </div>

  <div class="main">

    <!-- â•â•â• LOADING â•â•â• -->
    <div id="screen-loading" class="screen active">
      <div class="spinner"></div>
    </div>

    <!-- â•â•â• ERROR â•â•â• -->
    <div id="screen-error" class="screen">
      <div class="card" style="text-align:center; padding:2rem;">
        <div style="font-size:2.5rem; margin-bottom:0.75rem;">ğŸ˜•</div>
        <h2 style="font-size:1.1rem; margin-bottom:0.5rem;" id="error-title">Commerce non trouvÃ©</h2>
        <p style="font-size:0.85rem; color:#64748B;" id="error-msg">Ce QR code n'est pas valide ou le commerce n'est plus actif.</p>
      </div>
    </div>

    <!-- â•â•â• AUTH â•â•â• -->
    <div id="screen-auth" class="screen">
      <div class="card">
        <h2 style="font-size:1rem; font-weight:700; margin-bottom:1rem; text-align:center;">Identifiez-vous</h2>

        <div id="auth-alert"></div>

        <div class="seg">
          <button type="button" id="seg-email" class="active" onclick="setAuthMode('email')">@ Email</button>
          <button type="button" id="seg-phone" onclick="setAuthMode('phone')"># TÃ©lÃ©phone</button>
        </div>

        <div class="form-group" id="auth-email-group">
          <label class="form-label">Adresse email</label>
          <input type="email" id="auth-email" class="form-control" placeholder="votre@email.com" autocomplete="email" inputmode="email">
        </div>

        <div class="form-group" id="auth-phone-group" style="display:none;">
          <label class="form-label">NumÃ©ro de tÃ©lÃ©phone</label>
          <input type="tel" id="auth-phone" class="form-control" placeholder="+32 497 12 34 56" autocomplete="tel" inputmode="tel">
        </div>

        <div class="form-group">
          <label class="form-label">Code PIN (4 chiffres)</label>
          <div class="pin-row">
            <input type="tel" class="pin-digit" maxlength="1" inputmode="numeric" data-pin="0" autocomplete="off">
            <input type="tel" class="pin-digit" maxlength="1" inputmode="numeric" data-pin="1" autocomplete="off">
            <input type="tel" class="pin-digit" maxlength="1" inputmode="numeric" data-pin="2" autocomplete="off">
            <input type="tel" class="pin-digit" maxlength="1" inputmode="numeric" data-pin="3" autocomplete="off">
          </div>
          <p class="form-hint" style="text-align:center;">Le code PIN attribuÃ© par le commerce</p>
        </div>

        <button class="btn btn-primary" id="btn-login" onclick="doLogin()">Se connecter</button>
      </div>
    </div>

    <!-- â•â•â• DASHBOARD â•â•â• -->
    <div id="screen-dashboard" class="screen">

      <div id="dash-reward-banner"></div>

      <div class="card">
        <div class="pts-hero">
          <div class="value" id="dash-points">0</div>
          <div class="label">points</div>
        </div>

        <div class="progress-wrap">
          <div class="progress-bar">
            <div class="progress-fill" id="dash-progress" style="width:0%;"></div>
          </div>
          <div class="progress-text">
            <span id="dash-prog-left">0 pts</span>
            <span id="dash-prog-right">RÃ©compense : 0 pts</span>
          </div>
        </div>
      </div>

      <div id="dash-identified" style="display:none;">
        <div class="identified">
          <div class="icon">âœ…</div>
          <h3>Vous Ãªtes identifiÃ© !</h3>
          <p>Le commerce va crÃ©diter vos points.</p>
        </div>
      </div>

      <div id="dash-identify-btn">
        <button class="btn btn-identify" id="btn-identify" onclick="doIdentify()">
          ğŸ“ Je suis lÃ  !
        </button>
        <p style="text-align:center; font-size:0.72rem; color:#94A3B8; margin-top:6px;">
          Appuyez pour signaler votre prÃ©sence au commerce
        </p>
      </div>

      <div class="stats-row" style="margin-top:0.75rem;">
        <div class="stat">
          <div class="val" id="dash-visits">0</div>
          <div class="lbl">Visites</div>
        </div>
        <div class="stat">
          <div class="val" id="dash-spent">0 â‚¬</div>
          <div class="lbl">DÃ©pensÃ©</div>
        </div>
      </div>

      <div id="install-hint" class="install-hint" style="display:none;">
        ğŸ’¡ Ajoutez cette page Ã  votre Ã©cran d'accueil pour un accÃ¨s rapide !
      </div>

      <button class="btn btn-outline" onclick="doLogout()" style="margin-top:0.5rem;">DÃ©connexion</button>
    </div>

  </div>

  <div class="footer">
    PropulsÃ© par <a href="https://fiddo.be">FIDDO</a> ğŸ•
  </div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIG & STATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const API_BASE = window.location.hostname === 'localhost'
      ? 'http://localhost:3000/api'
      : '/api';

    let qrToken = null;  // merchant QR token from URL
    let clientToken = null;
    let merchantInfo = null;
    let clientData = null;
    let authMode = 'email';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT â€” extract token from URL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    (async function init() {
      // Extract token: /q/ABC123 or /client-form?s=TOKEN
      const pathParts = window.location.pathname.split('/');
      if (pathParts[1] === 'q' && pathParts[2]) {
        qrToken = pathParts[2];
      } else {
        const params = new URLSearchParams(window.location.search);
        qrToken = params.get('s') || params.get('token');
      }

      if (!qrToken) {
        showError('Lien invalide', 'Ce lien ne contient pas de code QR valide.');
        return;
      }

      // Fetch merchant info
      try {
        const resp = await fetch(`${API_BASE}/qr/info/${qrToken}`);
        if (!resp.ok) {
          showError('Commerce non trouvÃ©', 'Ce QR code n\'est pas valide ou le commerce n\'est plus actif.');
          return;
        }
        merchantInfo = await resp.json();

        // Apply theme
        document.body.setAttribute('data-theme', merchantInfo.theme || 'teal');
        document.getElementById('merchant-name').textContent = merchantInfo.merchantName;
        document.title = `${merchantInfo.merchantName} â€” FidÃ©litÃ©`;

        // Update theme-color meta
        const themeColors = {
          teal: '#0891B2', navy: '#1E40AF', violet: '#7C3AED',
          forest: '#059669', brick: '#DC2626', amber: '#D97706', slate: '#475569'
        };
        document.querySelector('meta[name="theme-color"]').content = themeColors[merchantInfo.theme] || '#0891B2';

      } catch (e) {
        showError('Erreur de connexion', 'Impossible de contacter le serveur. VÃ©rifiez votre connexion.');
        return;
      }

      // Check saved session
      const saved = localStorage.getItem('fiddo_client_' + qrToken);
      if (saved) {
        try {
          const session = JSON.parse(saved);
          clientToken = session.token;
          // Validate token by fetching fresh data
          const freshData = await fetchClientData();
          if (freshData) {
            clientData = freshData;
            showDashboard();
            return;
          }
        } catch (e) {
          // Invalid session, clear it
          localStorage.removeItem('fiddo_client_' + qrToken);
        }
      }

      // Show auth
      showScreen('screen-auth');
    })();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SCREENS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function showError(title, msg) {
      document.getElementById('error-title').textContent = title;
      document.getElementById('error-msg').textContent = msg;
      document.getElementById('merchant-name').textContent = 'FIDDO';
      showScreen('screen-error');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function setAuthMode(mode) {
      authMode = mode;
      document.getElementById('seg-email').classList.toggle('active', mode === 'email');
      document.getElementById('seg-phone').classList.toggle('active', mode === 'phone');
      document.getElementById('auth-email-group').style.display = mode === 'email' ? '' : 'none';
      document.getElementById('auth-phone-group').style.display = mode === 'phone' ? '' : 'none';
    }

    // PIN digit auto-advance
    document.querySelectorAll('.pin-digit').forEach((el, i, all) => {
      el.addEventListener('input', (e) => {
        el.value = el.value.replace(/\D/g, '').slice(-1);
        if (el.value && i < 3) all[i + 1].focus();
        // Auto-submit when all 4 digits entered
        if (i === 3 && el.value) {
          const pin = Array.from(all).map(d => d.value).join('');
          if (pin.length === 4) setTimeout(doLogin, 100);
        }
      });
      el.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !el.value && i > 0) {
          all[i - 1].focus();
          all[i - 1].value = '';
        }
      });
      // Paste support
      el.addEventListener('paste', (e) => {
        e.preventDefault();
        const text = (e.clipboardData.getData('text') || '').replace(/\D/g, '').slice(0, 4);
        text.split('').forEach((ch, j) => { if (all[j]) all[j].value = ch; });
        if (text.length >= 4) all[3].focus();
        else if (all[text.length]) all[text.length].focus();
      });
    });

    function getPin() {
      return Array.from(document.querySelectorAll('.pin-digit')).map(d => d.value).join('');
    }

    function clearPin() {
      document.querySelectorAll('.pin-digit').forEach(d => d.value = '');
      document.querySelector('.pin-digit').focus();
    }

    function showAuthAlert(msg, type) {
      const el = document.getElementById('auth-alert');
      el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    }

    function clearAuthAlert() {
      document.getElementById('auth-alert').innerHTML = '';
    }

    async function doLogin() {
      clearAuthAlert();

      const email = authMode === 'email' ? document.getElementById('auth-email').value.trim() : null;
      const phone = authMode === 'phone' ? document.getElementById('auth-phone').value.trim() : null;
      const pin = getPin();

      if (!email && !phone) {
        showAuthAlert(authMode === 'email' ? 'Saisissez votre email' : 'Saisissez votre tÃ©lÃ©phone', 'error');
        return;
      }
      if (pin.length !== 4) {
        showAuthAlert('Saisissez votre code PIN (4 chiffres)', 'error');
        return;
      }

      const btn = document.getElementById('btn-login');
      btn.disabled = true;
      btn.textContent = 'Connexionâ€¦';

      try {
        const resp = await fetch(`${API_BASE}/qr/client-auth`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ qrToken, email, phone, pin }),
        });

        const data = await resp.json();

        if (!resp.ok) {
          showAuthAlert(data.error || 'Erreur de connexion', 'error');
          clearPin();
          btn.disabled = false;
          btn.textContent = 'Se connecter';
          return;
        }

        // Success
        clientToken = data.token;
        clientData = data;

        // Save session
        localStorage.setItem('fiddo_client_' + qrToken, JSON.stringify({
          token: clientToken,
          clientName: data.client.name,
        }));

        showDashboard();

      } catch (e) {
        showAuthAlert('Erreur rÃ©seau. RÃ©essayez.', 'error');
      }

      btn.disabled = false;
      btn.textContent = 'Se connecter';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DASHBOARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function showDashboard() {
      showScreen('screen-dashboard');
      updateDashboard();
      checkInstallHint();
    }

    function updateDashboard() {
      if (!clientData) return;

      const pts = clientData.points;
      const m = clientData.merchant;

      if (pts) {
        document.getElementById('dash-points').textContent = pts.balance;
        const pct = Math.min((pts.balance / m.pointsForReward) * 100, 100);
        document.getElementById('dash-progress').style.width = pct + '%';
        document.getElementById('dash-prog-left').textContent = pts.balance + ' pts';
        document.getElementById('dash-prog-right').textContent = 'RÃ©compense : ' + m.pointsForReward + ' pts';
        document.getElementById('dash-visits').textContent = pts.visitCount;
        document.getElementById('dash-spent').textContent = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(pts.totalSpent);

        // Reward banner
        if (pts.canRedeem) {
          document.getElementById('dash-reward-banner').innerHTML =
            '<div class="reward-banner"><h3>ğŸ RÃ©compense disponible !</h3><p>' +
            (pts.customReward || m.rewardDescription) +
            '</p></div>';
        } else {
          const remaining = m.pointsForReward - pts.balance;
          document.getElementById('dash-reward-banner').innerHTML =
            '<div style="background:var(--accent-light);border-radius:12px;padding:0.75rem;text-align:center;margin-bottom:0.75rem;font-size:0.85rem;color:var(--accent-dark);">' +
            'Plus que <strong>' + remaining + ' points</strong> avant : ' + m.rewardDescription + '</div>';
        }
      } else {
        // First visit
        document.getElementById('dash-points').textContent = '0';
        document.getElementById('dash-progress').style.width = '0%';
        document.getElementById('dash-prog-left').textContent = '0 pts';
        document.getElementById('dash-prog-right').textContent = 'RÃ©compense : ' + m.pointsForReward + ' pts';
        document.getElementById('dash-visits').textContent = '0';
        document.getElementById('dash-spent').textContent = '0,00 â‚¬';
        document.getElementById('dash-reward-banner').innerHTML =
          '<div style="background:var(--accent-light);border-radius:12px;padding:0.75rem;text-align:center;margin-bottom:0.75rem;font-size:0.85rem;color:var(--accent-dark);">' +
          'ğŸ†• PremiÃ¨re visite ! Gagnez ' + m.pointsForReward + ' points pour : ' + m.rewardDescription + '</div>';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // IDENTIFY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function doIdentify() {
      const btn = document.getElementById('btn-identify');
      btn.disabled = true;
      btn.textContent = 'â³ Envoiâ€¦';

      try {
        const resp = await fetch(`${API_BASE}/qr/identify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ clientToken, qrToken }),
        });

        const data = await resp.json();

        if (!resp.ok) {
          if (resp.status === 401) {
            // Token expired, force re-auth
            doLogout();
            return;
          }
          alert(data.error || 'Erreur');
          btn.disabled = false;
          btn.textContent = 'ğŸ“ Je suis lÃ  !';
          return;
        }

        // Show confirmation
        document.getElementById('dash-identify-btn').style.display = 'none';
        document.getElementById('dash-identified').style.display = 'block';

        // Refresh data after a delay (merchant may credit quickly)
        setTimeout(refreshDashboard, 8000);
        setTimeout(refreshDashboard, 20000);

      } catch (e) {
        alert('Erreur rÃ©seau. RÃ©essayez.');
      }

      btn.disabled = false;
      btn.textContent = 'ğŸ“ Je suis lÃ  !';
    }

    async function refreshDashboard() {
      const freshData = await fetchClientData();
      if (freshData) {
        clientData = freshData;
        updateDashboard();
      }
    }

    async function fetchClientData() {
      try {
        const resp = await fetch(`${API_BASE}/qr/client-data?qrToken=${qrToken}`, {
          headers: { 'Authorization': 'Bearer ' + clientToken },
        });
        if (!resp.ok) return null;
        return await resp.json();
      } catch (e) {
        return null;
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LOGOUT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function doLogout() {
      localStorage.removeItem('fiddo_client_' + qrToken);
      clientToken = null;
      clientData = null;

      // Reset UI
      document.getElementById('auth-email').value = '';
      document.getElementById('auth-phone').value = '';
      clearPin();
      clearAuthAlert();
      document.getElementById('dash-identified').style.display = 'none';
      document.getElementById('dash-identify-btn').style.display = 'block';

      showScreen('screen-auth');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PWA INSTALL HINT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function checkInstallHint() {
      // Show hint on mobile if not in standalone mode
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
      const isMobile = /iPhone|iPad|Android/i.test(navigator.userAgent);
      if (isMobile && !isStandalone) {
        document.getElementById('install-hint').style.display = 'block';
      }
    }
  </script>
</body>
</html>
