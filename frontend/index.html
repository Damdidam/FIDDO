<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FIDDO ‚Äî Connexion</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    #register-form { display: none; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }
    .section-title { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--primary); margin: 1.5rem 0 0.75rem; font-weight: 600; }
    .reward-preview {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin-top: 0.75rem;
      font-size: 0.85rem;
      line-height: 1.5;
    }
    .reward-preview strong { font-size: 1rem; }
  </style>
</head>
<body>
  <div class="auth-container">
    <div class="auth-box">
      <div class="auth-logo">FIDDO üêï</div>
      <p class="auth-subtitle">Programme de fid√©lit√© pour restaurateurs</p>

      <!-- ‚ïê‚ïê‚ïê LOGIN ‚ïê‚ïê‚ïê -->
      <form id="login-form">
        <h2 class="text-center mb-2" style="font-size: 1.2rem;">Connexion</h2>
        <div id="login-alert"></div>

        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" id="login-email" class="form-control" placeholder="votre@email.com" required>
        </div>
        <div class="form-group">
          <label class="form-label">Mot de passe</label>
          <input type="password" id="login-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>
        <button type="submit" class="btn btn-primary btn-block">Se connecter</button>
        <div class="toggle-form">
          Pas encore de compte ? <a class="toggle-link" onclick="showRegister()">S'inscrire</a>
        </div>
      </form>

      <!-- ‚ïê‚ïê‚ïê REGISTER ‚ïê‚ïê‚ïê -->
      <form id="register-form">
        <h2 class="text-center mb-2" style="font-size: 1.2rem;">Inscription</h2>
        <div id="register-alert"></div>

        <div class="section-title">üè™ Votre commerce</div>
        <div class="form-group">
          <label class="form-label">Nom du commerce *</label>
          <input type="text" id="reg-business" class="form-control" placeholder="Mon Restaurant" required>
        </div>
        <div class="form-group">
          <label class="form-label">Adresse *</label>
          <input type="text" id="reg-address" class="form-control" placeholder="1 Rue de la Paix, 1000 Bruxelles" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">N¬∞ TVA *</label>
            <input type="text" id="reg-vat" class="form-control" placeholder="BE0123456789" required>
          </div>
          <div class="form-group">
            <label class="form-label">T√©l√©phone commerce *</label>
            <input type="tel" id="reg-phone" class="form-control" placeholder="+32 2 123 45 67" required>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Email commerce *</label>
          <input type="email" id="reg-biz-email" class="form-control" placeholder="contact@monresto.be" required>
        </div>

        <div class="section-title">üéÅ Programme de fid√©lit√©</div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Points par euro d√©pens√©</label>
            <input type="number" id="reg-ppe" class="form-control" step="0.1" min="0.1" value="1" placeholder="1">
            <small class="form-help">Ex : 1 = 1 point par euro</small>
          </div>
          <div class="form-group">
            <label class="form-label">Points pour la r√©compense</label>
            <input type="number" id="reg-pfr" class="form-control" min="1" value="100" placeholder="100">
            <small class="form-help">Seuil √† atteindre par le client</small>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Description de la r√©compense *</label>
          <input type="text" id="reg-reward-desc" class="form-control" maxlength="200" placeholder="Ex : 10% offerts sur votre prochain passage" value="">
          <small class="form-help">Ce que le client re√ßoit une fois le seuil atteint (max 200 car.)</small>
        </div>
        <div id="reward-preview" class="reward-preview" style="display: none;"></div>

        <div class="section-title">üë§ Responsable (propri√©taire)</div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Nom complet *</label>
            <input type="text" id="reg-owner-name" class="form-control" placeholder="Jean Dupont" required>
          </div>
          <div class="form-group">
            <label class="form-label">T√©l√©phone personnel *</label>
            <input type="tel" id="reg-owner-phone" class="form-control" placeholder="+32 497 12 34 56" required>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Email de connexion *</label>
          <input type="email" id="reg-owner-email" class="form-control" placeholder="jean@email.com" required>
          <small class="form-help">Cet email sera utilis√© pour vous connecter</small>
        </div>
        <div class="form-group">
          <label class="form-label">Mot de passe *</label>
          <input type="password" id="reg-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" minlength="6" required>
          <small class="form-help">Minimum 6 caract√®res</small>
        </div>

        <button type="submit" class="btn btn-primary btn-block">Cr√©er mon compte</button>
        <div class="toggle-form">
          D√©j√† un compte ? <a class="toggle-link" onclick="showLogin()">Se connecter</a>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    if (Auth.isAuthenticated()) {
      const staff = Auth.getStaff();
      window.location.href = (staff.role === 'cashier') ? '/credit' : '/dashboard';
    }

    function showRegister() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'block';
    }
    function showLogin() {
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('login-form').style.display = 'block';
    }

    // ‚îÄ‚îÄ‚îÄ Reward Preview (live) ‚îÄ‚îÄ‚îÄ
    function updateRewardPreview() {
      const ppe = parseFloat(document.getElementById('reg-ppe').value) || 1;
      const pfr = parseInt(document.getElementById('reg-pfr').value) || 100;
      const desc = document.getElementById('reg-reward-desc').value.trim();
      const preview = document.getElementById('reward-preview');

      if (!desc) {
        preview.style.display = 'none';
        return;
      }

      const eurosNeeded = pfr / ppe;
      preview.style.display = 'block';
      preview.innerHTML = `
        <strong>Aper√ßu pour vos clients :</strong><br>
        D√©pensez <strong>${Math.ceil(eurosNeeded)} ‚Ç¨</strong> au total
        ‚Üí accumulez <strong>${pfr} points</strong>
        ‚Üí <strong>${desc}</strong>
      `;
    }

    document.getElementById('reg-ppe').addEventListener('input', updateRewardPreview);
    document.getElementById('reg-pfr').addEventListener('input', updateRewardPreview);
    document.getElementById('reg-reward-desc').addEventListener('input', updateRewardPreview);

    // ‚îÄ‚îÄ‚îÄ Login ‚îÄ‚îÄ‚îÄ
    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      try {
        UI.showAlert('login-alert', 'Connexion en cours...', 'info');
        const data = await API.auth.login({ email, password });
        Auth.setSession(data.staff, data.merchant);
        UI.showAlert('login-alert', 'Connexion r√©ussie !', 'success');
        setTimeout(() => {
          window.location.href = (data.staff.role === 'cashier') ? '/credit' : '/dashboard';
        }, 300);
      } catch (err) {
        UI.showAlert('login-alert', err.message, 'error');
      }
    });

    // ‚îÄ‚îÄ‚îÄ Register ‚îÄ‚îÄ‚îÄ
    document.getElementById('register-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const rewardDesc = document.getElementById('reg-reward-desc').value.trim();
      if (!rewardDesc) {
        UI.showAlert('register-alert', 'Veuillez d√©crire la r√©compense offerte √† vos clients', 'error');
        document.getElementById('reg-reward-desc').focus();
        return;
      }

      try {
        UI.showAlert('register-alert', 'Cr√©ation du compte...', 'info');
        await API.auth.register({
          businessName: document.getElementById('reg-business').value,
          address: document.getElementById('reg-address').value,
          vatNumber: document.getElementById('reg-vat').value,
          email: document.getElementById('reg-biz-email').value,
          phone: document.getElementById('reg-phone').value,
          ownerPhone: document.getElementById('reg-owner-phone').value,
          ownerEmail: document.getElementById('reg-owner-email').value,
          ownerPassword: document.getElementById('reg-password').value,
          ownerName: document.getElementById('reg-owner-name').value,
          pointsPerEuro: parseFloat(document.getElementById('reg-ppe').value) || 1,
          pointsForReward: parseInt(document.getElementById('reg-pfr').value) || 100,
          rewardDescription: rewardDesc,
        });
        UI.showAlert('register-alert',
          'Demande envoy√©e ! Votre compte sera activ√© apr√®s validation par notre √©quipe. Vous recevrez un email de confirmation.',
          'success'
        );
      } catch (err) {
        UI.showAlert('register-alert', err.message, 'error');
      }
    });
  </script>
</body>
</html>
