<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PrÃ©fÃ©rences â€” FIDDO</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    /* â”€â”€â”€ Tabs â”€â”€â”€ */
    .pref-tabs { display: flex; gap: 0; border-bottom: 2px solid var(--border); margin-bottom: 1.5rem; overflow-x: auto; }
    .pref-tab {
      padding: 0.75rem 1.25rem; cursor: pointer; border-bottom: 3px solid transparent;
      margin-bottom: -2px; font-weight: 500; color: var(--text-light); transition: all 0.2s;
      background: none; border-top: none; border-left: none; border-right: none;
      font-size: 0.9rem; white-space: nowrap;
    }
    .pref-tab:hover { color: var(--text); }
    .pref-tab.active { color: var(--primary); border-bottom-color: var(--primary); }
    .pref-section { display: none; }
    .pref-section.active { display: block; }

    /* â”€â”€â”€ Theme picker â”€â”€â”€ */
    .theme-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; }
    .theme-option {
      border: 3px solid var(--border); border-radius: 12px; padding: 1rem;
      cursor: pointer; transition: all 0.2s; text-align: center; position: relative;
    }
    .theme-option:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .theme-option.selected { border-color: var(--success); box-shadow: 0 0 0 2px var(--success); }
    .theme-option .swatch {
      width: 100%; height: 50px; border-radius: 8px; margin-bottom: 0.5rem;
    }
    .theme-option .name { font-weight: 600; font-size: 0.85rem; }
    .theme-option .check {
      display: none; position: absolute; top: 8px; right: 8px;
      background: var(--success); color: white; width: 22px; height: 22px;
      border-radius: 50%; font-size: 0.75rem; line-height: 22px; text-align: center;
    }
    .theme-option.selected .check { display: block; }

    /* â”€â”€â”€ Preview card â”€â”€â”€ */
    .preview-card {
      border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem;
      color: white; line-height: 1.7;
    }
    .preview-card strong { font-size: 1.05rem; }
    .preview-card .preview-example {
      background: rgba(255,255,255,0.15); border-radius: 8px;
      padding: 1rem; margin-top: 1rem; font-size: 0.9rem;
    }

    /* â”€â”€â”€ Backup â”€â”€â”€ */
    .backup-drop {
      border: 2px dashed var(--border); border-radius: 10px; padding: 2rem;
      text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 1rem;
    }
    .backup-drop:hover, .backup-drop.dragover {
      border-color: var(--primary); background: rgba(8,145,178,0.05);
    }
    .backup-drop-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .backup-preview { background: var(--light); border-radius: 8px; padding: 1rem; margin: 1rem 0; font-size: 0.9rem; }

    /* â”€â”€â”€ Password strength â”€â”€â”€ */
    .pw-strength { height: 4px; border-radius: 2px; background: #e5e7eb; margin-top: 0.5rem; overflow: hidden; }
    .pw-strength-fill { height: 100%; border-radius: 2px; transition: all 0.3s; width: 0; }
    .pw-strength-text { font-size: 0.75rem; margin-top: 0.25rem; }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="/dashboard" class="navbar-brand">FIDDO<span></span></a>
    <div class="navbar-menu"></div>
  </nav>

  <div class="container">
    <h1 style="margin: 1.5rem 0;">âš™ï¸ PrÃ©fÃ©rences</h1>

    <!-- â•â•â• TABS â•â•â• -->
    <div class="pref-tabs">
      <button class="pref-tab active" onclick="switchTab('reward')">ğŸ RÃ©compenses</button>
      <button class="pref-tab" onclick="switchTab('theme')">ğŸ¨ ThÃ¨me</button>
      <button class="pref-tab" onclick="switchTab('info')">ğŸª Mon commerce</button>
      <button class="pref-tab" onclick="switchTab('password')">ğŸ”’ Mot de passe</button>
      <button class="pref-tab" onclick="switchTab('backup')">ğŸ’¾ Sauvegarde</button>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         TAB 1: REWARD CONFIGURATION
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="tab-reward" class="pref-section active">
      <div class="grid grid-2">
        <div>
          <div class="card">
            <div class="card-header">SystÃ¨me de rÃ©compenses</div>
            <div id="reward-alert"></div>

            <form id="reward-form">
              <div class="form-group">
                <label class="form-label">Points par euro dÃ©pensÃ©</label>
                <input type="number" id="set-ppe" class="form-control" step="0.1" min="0.1">
                <small class="form-help">Nombre de points gagnÃ©s pour chaque euro dÃ©pensÃ©</small>
              </div>

              <div class="form-group">
                <label class="form-label">Points nÃ©cessaires pour la rÃ©compense</label>
                <input type="number" id="set-pfr" class="form-control" min="1">
                <small class="form-help">Seuil Ã  atteindre pour dÃ©bloquer la rÃ©compense</small>
              </div>

              <div class="form-group">
                <label class="form-label">Description de la rÃ©compense</label>
                <input type="text" id="set-desc" class="form-control" maxlength="200" placeholder="Ex : Boisson offerte, 10% de rÃ©duction...">
                <small class="form-help">Texte affichÃ© au client et dans les emails (max 200 car.)</small>
              </div>

              <button type="submit" class="btn btn-primary btn-block">Enregistrer</button>
            </form>
          </div>
        </div>

        <div>
          <div class="preview-card" id="reward-preview" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark));">
          </div>
          <div class="card">
            <div class="card-header">â„¹ï¸ Comment Ã§a marche</div>
            <p style="font-size: 0.9rem; color: var(--text-light); line-height: 1.7;">
              Chaque passage client â†’ les points sont calculÃ©s automatiquement.<br><br>
              Une fois le seuil atteint, la rÃ©compense s'affiche sur l'Ã©cran du caissier.<br><br>
              <strong>Note :</strong> modifier ces paramÃ¨tres n'affecte que les futurs crÃ©dits.
              Les soldes existants ne sont pas recalculÃ©s.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         TAB 2: THEME SELECTION
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="tab-theme" class="pref-section">
      <div class="card">
        <div class="card-header">Choisissez votre thÃ¨me couleur</div>
        <div id="theme-alert"></div>
        <p class="text-muted text-sm mb-2">Le thÃ¨me s'applique Ã  toutes les pages de votre espace FIDDO.</p>
        <div class="theme-grid" id="theme-grid"></div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         TAB 3: MERCHANT INFO
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="tab-info" class="pref-section">
      <div class="grid grid-2">
        <div class="card">
          <div class="card-header">Informations de mon commerce</div>
          <div id="info-alert"></div>

          <form id="info-form">
            <div class="form-group">
              <label class="form-label">Nom du commerce *</label>
              <input type="text" id="info-business" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label">Adresse *</label>
              <input type="text" id="info-address" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label">NÂ° TVA *</label>
              <input type="text" id="info-vat" class="form-control" required>
              <small class="form-help">Format : BE0123456789</small>
            </div>
            <div class="form-group">
              <label class="form-label">Email du commerce *</label>
              <input type="email" id="info-email" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label">TÃ©lÃ©phone du commerce *</label>
              <input type="tel" id="info-phone" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label">TÃ©lÃ©phone propriÃ©taire *</label>
              <input type="tel" id="info-owner-phone" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label">Nom du propriÃ©taire</label>
              <input type="text" id="info-owner-name" class="form-control">
            </div>

            <button type="submit" class="btn btn-primary btn-block">Enregistrer les modifications</button>
          </form>
        </div>

        <div>
          <div class="card">
            <div class="card-header">â„¹ï¸ Informations</div>
            <p style="font-size: 0.9rem; color: var(--text-light); line-height: 1.7;">
              Toute modification de vos informations sera <strong>notifiÃ©e Ã  l'administrateur FIDDO</strong> par email pour des raisons de sÃ©curitÃ©.<br><br>
              Le numÃ©ro de TVA doit Ãªtre au format belge (BE0 suivi de 9 chiffres).<br><br>
              Votre email de connexion ne peut pas Ãªtre modifiÃ© ici. Contactez le support si nÃ©cessaire.
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         TAB 4: PASSWORD CHANGE
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="tab-password" class="pref-section">
      <div class="grid grid-2">
        <div class="card">
          <div class="card-header">Modifier mon mot de passe</div>
          <div id="pw-alert"></div>

          <form id="pw-form">
            <div class="form-group">
              <label class="form-label">Mot de passe actuel *</label>
              <input type="password" id="pw-current" class="form-control" required>
            </div>
            <div class="form-group">
              <label class="form-label">Nouveau mot de passe *</label>
              <input type="password" id="pw-new" class="form-control" minlength="6" required>
              <div class="pw-strength"><div class="pw-strength-fill" id="pw-strength-fill"></div></div>
              <div class="pw-strength-text" id="pw-strength-text"></div>
              <small class="form-help">Minimum 6 caractÃ¨res</small>
            </div>
            <div class="form-group">
              <label class="form-label">Confirmer le nouveau mot de passe *</label>
              <input type="password" id="pw-confirm" class="form-control" minlength="6" required>
            </div>

            <button type="submit" class="btn btn-primary btn-block">Modifier le mot de passe</button>
          </form>
        </div>

        <div class="card">
          <div class="card-header">ğŸ”’ SÃ©curitÃ©</div>
          <p style="font-size: 0.9rem; color: var(--text-light); line-height: 1.7;">
            Un <strong>email de confirmation</strong> sera envoyÃ© Ã  votre adresse aprÃ¨s le changement de mot de passe.<br><br>
            Si vous n'Ãªtes pas Ã  l'origine de ce changement, contactez immÃ©diatement le support.<br><br>
            AprÃ¨s 5 tentatives Ã©chouÃ©es, votre compte sera temporairement verrouillÃ© pendant 15 minutes.
          </p>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         TAB 5: BACKUP & RESTORE
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="tab-backup" class="pref-section">
      <div class="grid grid-2">
        <!-- Export -->
        <div class="card">
          <div class="card-header">ğŸ“¤ Exporter mes donnÃ©es</div>
          <p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 1rem; line-height: 1.6;">
            TÃ©lÃ©chargez un fichier JSON contenant toutes vos donnÃ©es :
            paramÃ¨tres, clients, historique de transactions, prÃ©fÃ©rences.
          </p>
          <button class="btn btn-primary btn-block" onclick="exportBackup()">
            ğŸ“¥ TÃ©lÃ©charger le backup (JSON)
          </button>
          <div id="export-alert" style="margin-top: 1rem;"></div>
        </div>

        <!-- Import -->
        <div class="card">
          <div class="card-header">ğŸ“¥ Restaurer des donnÃ©es</div>
          <div id="import-alert"></div>

          <div class="backup-drop" id="backup-drop" onclick="document.getElementById('backup-file').click();">
            <div class="backup-drop-icon">ğŸ“</div>
            <p><strong>Cliquez ici</strong> ou glissez votre fichier JSON</p>
            <small class="text-muted">Fichier .json gÃ©nÃ©rÃ© par FIDDO uniquement</small>
          </div>
          <input type="file" id="backup-file" accept=".json" style="display:none;">

          <div id="backup-preview-container" style="display: none;">
            <div class="backup-preview" id="backup-preview"></div>
            <div class="alert alert-warning">
              âš ï¸ <strong>Attention :</strong> la restauration remplacera TOUTES vos donnÃ©es actuelles
              (clients, transactions, paramÃ¨tres). Cette action est irrÃ©versible.
            </div>
            <button class="btn btn-danger btn-block" id="import-btn" onclick="importBackup()">
              âš ï¸ Restaurer ces donnÃ©es
            </button>
            <button class="btn btn-outline btn-block mt-1" onclick="cancelImport()">Annuler</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    if (!requireOwner()) throw 'Not authorized';

    const staff = Auth.getStaff();
    const merchant = Auth.getMerchant();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB SWITCHING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function switchTab(tab) {
      document.querySelectorAll('.pref-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.pref-section').forEach(s => s.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('tab-' + tab).classList.add('active');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB 1: REWARD CONFIGURATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    document.getElementById('set-ppe').value = merchant.points_per_euro;
    document.getElementById('set-pfr').value = merchant.points_for_reward;
    document.getElementById('set-desc').value = merchant.reward_description;

    function updateRewardPreview() {
      const ppe = parseFloat(document.getElementById('set-ppe').value) || 1;
      const pfr = parseInt(document.getElementById('set-pfr').value) || 100;
      const desc = document.getElementById('set-desc').value.trim() || 'RÃ©compense offerte';
      const eurosNeeded = Math.ceil(pfr / ppe);

      document.getElementById('reward-preview').innerHTML = `
        <strong>ğŸ AperÃ§u du programme</strong>
        <div class="preview-example">
          <strong>1 â‚¬</strong> dÃ©pensÃ© = <strong>${ppe} point${ppe > 1 ? 's' : ''}</strong><br>
          Seuil : <strong>${pfr} points</strong> (â‰ˆ <strong>${eurosNeeded} â‚¬</strong>)<br><br>
          âœ <strong>${desc}</strong>
        </div>
      `;
    }

    document.getElementById('set-ppe').addEventListener('input', updateRewardPreview);
    document.getElementById('set-pfr').addEventListener('input', updateRewardPreview);
    document.getElementById('set-desc').addEventListener('input', updateRewardPreview);
    updateRewardPreview();

    document.getElementById('reward-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const ppe = parseFloat(document.getElementById('set-ppe').value);
      const pfr = parseInt(document.getElementById('set-pfr').value);
      const desc = document.getElementById('set-desc').value.trim();

      if (!ppe || ppe <= 0) return UI.showAlert('reward-alert', 'Points par euro doit Ãªtre > 0', 'error');
      if (!pfr || pfr <= 0) return UI.showAlert('reward-alert', 'Points pour rÃ©compense doit Ãªtre > 0', 'error');
      if (!desc) return UI.showAlert('reward-alert', 'Description requise', 'error');

      try {
        await API.auth.updateSettings({ pointsPerEuro: ppe, pointsForReward: pfr, rewardDescription: desc });
        merchant.points_per_euro = ppe;
        merchant.points_for_reward = pfr;
        merchant.reward_description = desc;
        Auth.setSession(staff, merchant);
        UI.showAlert('reward-alert', 'ParamÃ¨tres de rÃ©compense mis Ã  jour !', 'success');
        setTimeout(() => UI.clearAlert('reward-alert'), 4000);
      } catch (err) {
        UI.showAlert('reward-alert', err.message, 'error');
      }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB 2: THEME SELECTION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const THEMES = [
      { id: 'teal',   name: 'Teal',    colors: ['#0891B2', '#0E7490'] },
      { id: 'navy',   name: 'Navy',    colors: ['#2563EB', '#1D4ED8'] },
      { id: 'violet', name: 'Violet',  colors: ['#7C3AED', '#6D28D9'] },
      { id: 'forest', name: 'Forest',  colors: ['#059669', '#047857'] },
      { id: 'brick',  name: 'Brick',   colors: ['#DC2626', '#B91C1C'] },
      { id: 'amber',  name: 'Amber',   colors: ['#D97706', '#B45309'] },
      { id: 'slate',  name: 'Slate',   colors: ['#475569', '#334155'] },
    ];

    let currentTheme = 'teal';

    function renderThemes() {
      const grid = document.getElementById('theme-grid');
      grid.innerHTML = THEMES.map(t => `
        <div class="theme-option ${t.id === currentTheme ? 'selected' : ''}"
             onclick="selectTheme('${t.id}')" id="theme-${t.id}">
          <div class="check">âœ“</div>
          <div class="swatch" style="background: linear-gradient(135deg, ${t.colors[0]}, ${t.colors[1]});"></div>
          <div class="name">${t.name}</div>
        </div>
      `).join('');
    }

    async function selectTheme(themeId) {
      try {
        await API.preferences.setTheme(themeId);
        currentTheme = themeId;
        renderThemes();

        // Apply theme live
        const t = THEMES.find(x => x.id === themeId);
        if (t) {
          document.documentElement.style.setProperty('--primary', t.colors[0]);
          document.documentElement.style.setProperty('--primary-dark', t.colors[1]);
          document.getElementById('reward-preview').style.background =
            `linear-gradient(135deg, ${t.colors[0]}, ${t.colors[1]})`;
        }

        UI.showAlert('theme-alert', `ThÃ¨me "${t.name}" appliquÃ© !`, 'success');
        setTimeout(() => UI.clearAlert('theme-alert'), 3000);
      } catch (err) {
        UI.showAlert('theme-alert', err.message, 'error');
      }
    }

    // Load current theme from preferences
    (async () => {
      try {
        const data = await API.preferences.get();
        if (data.preferences && data.preferences.theme) {
          currentTheme = data.preferences.theme;
          const t = THEMES.find(x => x.id === currentTheme);
          if (t) {
            document.documentElement.style.setProperty('--primary', t.colors[0]);
            document.documentElement.style.setProperty('--primary-dark', t.colors[1]);
            document.getElementById('reward-preview').style.background =
              `linear-gradient(135deg, ${t.colors[0]}, ${t.colors[1]})`;
          }
        }
      } catch (e) { /* use default */ }
      renderThemes();
    })();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB 3: MERCHANT INFO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadMerchantInfo() {
      try {
        const data = await API.preferences.getMerchantInfo();
        document.getElementById('info-business').value = data.businessName || '';
        document.getElementById('info-address').value = data.address || '';
        document.getElementById('info-vat').value = data.vatNumber || '';
        document.getElementById('info-email').value = data.email || '';
        document.getElementById('info-phone').value = data.phone || '';
        document.getElementById('info-owner-phone').value = data.ownerPhone || '';
        document.getElementById('info-owner-name').value = data.ownerName || '';
      } catch (err) {
        UI.showAlert('info-alert', 'Impossible de charger les informations', 'error');
      }
    }
    loadMerchantInfo();

    document.getElementById('info-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = {
        businessName:  document.getElementById('info-business').value.trim(),
        address:       document.getElementById('info-address').value.trim(),
        vatNumber:     document.getElementById('info-vat').value.trim(),
        email:         document.getElementById('info-email').value.trim(),
        phone:         document.getElementById('info-phone').value.trim(),
        ownerPhone:    document.getElementById('info-owner-phone').value.trim(),
        ownerName:     document.getElementById('info-owner-name').value.trim(),
      };

      if (!payload.businessName || !payload.address || !payload.vatNumber || !payload.email || !payload.phone || !payload.ownerPhone) {
        return UI.showAlert('info-alert', 'Tous les champs marquÃ©s * sont requis', 'error');
      }

      try {
        const result = await API.preferences.updateMerchantInfo(payload);

        if (result.changes && result.changes.length > 0) {
          if (result.merchant) Auth.setSession(staff, result.merchant);
          const changeList = result.changes.map(c => `<strong>${c.field}</strong> : ${c.old} â†’ ${c.new}`).join('<br>');
          UI.showAlert('info-alert',
            `Informations mises Ã  jour !<br><small>${changeList}</small><br><small class="text-muted">L'administrateur a Ã©tÃ© notifiÃ© par email.</small>`,
            'success'
          );
        } else {
          UI.showAlert('info-alert', 'Aucune modification dÃ©tectÃ©e', 'info');
        }
        setTimeout(() => UI.clearAlert('info-alert'), 6000);
      } catch (err) {
        UI.showAlert('info-alert', err.message, 'error');
      }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB 4: PASSWORD CHANGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Password strength indicator
    document.getElementById('pw-new').addEventListener('input', (e) => {
      const pw = e.target.value;
      let score = 0;
      if (pw.length >= 6) score++;
      if (pw.length >= 10) score++;
      if (/[A-Z]/.test(pw) && /[a-z]/.test(pw)) score++;
      if (/\d/.test(pw)) score++;
      if (/[^A-Za-z0-9]/.test(pw)) score++;

      const fill = document.getElementById('pw-strength-fill');
      const text = document.getElementById('pw-strength-text');
      const levels = [
        { w: '0%', c: '#e5e7eb', t: '' },
        { w: '20%', c: '#EF4444', t: 'TrÃ¨s faible' },
        { w: '40%', c: '#F59E0B', t: 'Faible' },
        { w: '60%', c: '#F59E0B', t: 'Moyen' },
        { w: '80%', c: '#10B981', t: 'Fort' },
        { w: '100%', c: '#059669', t: 'TrÃ¨s fort' },
      ];
      const lvl = levels[Math.min(score, 5)];
      fill.style.width = lvl.w;
      fill.style.background = lvl.c;
      text.textContent = lvl.t;
      text.style.color = lvl.c;
    });

    document.getElementById('pw-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const current = document.getElementById('pw-current').value;
      const newPw = document.getElementById('pw-new').value;
      const confirmPw = document.getElementById('pw-confirm').value;

      if (!current || !newPw || !confirmPw) {
        return UI.showAlert('pw-alert', 'Tous les champs sont requis', 'error');
      }
      if (newPw.length < 6) {
        return UI.showAlert('pw-alert', 'Le nouveau mot de passe doit contenir au moins 6 caractÃ¨res', 'error');
      }
      if (newPw !== confirmPw) {
        return UI.showAlert('pw-alert', 'Les deux mots de passe ne correspondent pas', 'error');
      }
      if (current === newPw) {
        return UI.showAlert('pw-alert', 'Le nouveau mot de passe doit Ãªtre diffÃ©rent de l\'actuel', 'error');
      }

      try {
        await API.preferences.changePassword({ currentPassword: current, newPassword: newPw });
        UI.showAlert('pw-alert', 'Mot de passe modifiÃ© avec succÃ¨s ! Un email de confirmation a Ã©tÃ© envoyÃ©.', 'success');
        document.getElementById('pw-form').reset();
        document.getElementById('pw-strength-fill').style.width = '0';
        document.getElementById('pw-strength-text').textContent = '';
      } catch (err) {
        UI.showAlert('pw-alert', err.message, 'error');
      }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB 5: BACKUP & RESTORE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let pendingBackupData = null;

    function exportBackup() {
      UI.showAlert('export-alert', 'PrÃ©paration du backup...', 'info');
      API.preferences.exportBackup(); // triggers download via redirect
      setTimeout(() => {
        UI.showAlert('export-alert', 'Backup tÃ©lÃ©chargÃ© !', 'success');
        setTimeout(() => UI.clearAlert('export-alert'), 3000);
      }, 1500);
    }

    // Drag & drop
    const dropZone = document.getElementById('backup-drop');
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) handleBackupFile(file);
    });

    document.getElementById('backup-file').addEventListener('change', (e) => {
      if (e.target.files[0]) handleBackupFile(e.target.files[0]);
    });

    async function handleBackupFile(file) {
      if (!file.name.endsWith('.json')) {
        return UI.showAlert('import-alert', 'Seuls les fichiers .json sont acceptÃ©s', 'error');
      }

      try {
        UI.showAlert('import-alert', 'Validation du fichier...', 'info');
        const text = await file.text();
        const data = JSON.parse(text);

        const result = await API.preferences.validateBackup(data);

        if (!result.valid) {
          UI.showAlert('import-alert', 'Fichier invalide : ' + result.errors.join(', '), 'error');
          return;
        }

        // Show preview
        pendingBackupData = data;
        const p = result.preview;
        document.getElementById('backup-preview').innerHTML = `
          <strong>ğŸ“‹ AperÃ§u du backup</strong><br><br>
          <strong>Commerce :</strong> ${p.business_name}<br>
          <strong>Date d'export :</strong> ${Format.datetime(p.exported_at)}<br>
          <strong>Version :</strong> ${p.version}<br><br>
          <strong>${p.clients}</strong> clients Â· <strong>${p.transactions}</strong> transactions<br>
          <strong>${Format.currency(p.total_spent)}</strong> de CA Â· <strong>${p.total_points}</strong> points
        `;

        document.getElementById('backup-preview-container').style.display = 'block';
        dropZone.style.display = 'none';
        UI.clearAlert('import-alert');

      } catch (err) {
        if (err instanceof SyntaxError) {
          UI.showAlert('import-alert', 'Le fichier n\'est pas un JSON valide', 'error');
        } else {
          UI.showAlert('import-alert', err.message, 'error');
        }
      }
    }

    async function importBackup() {
      if (!pendingBackupData) return;

      if (!confirm('âš ï¸ ATTENTION :\n\nToutes vos donnÃ©es actuelles (clients, transactions) seront REMPLACÃ‰ES par celles du backup.\n\nCette action est IRRÃ‰VERSIBLE.\n\nConfirmer la restauration ?')) {
        return;
      }

      try {
        document.getElementById('import-btn').disabled = true;
        UI.showAlert('import-alert', 'Restauration en cours...', 'info');

        const result = await API.preferences.importBackup(pendingBackupData);
        UI.showAlert('import-alert',
          `Restauration rÃ©ussie !<br>
           ${result.result.clients_restored} clients Â· ${result.result.transactions_restored} transactions restaurÃ©es`,
          'success'
        );
        cancelImport();

        // Refresh session
        const verifyData = await API.auth.verify();
        Auth.setSession(verifyData.staff, verifyData.merchant);

      } catch (err) {
        UI.showAlert('import-alert', err.message, 'error');
      } finally {
        document.getElementById('import-btn').disabled = false;
      }
    }

    function cancelImport() {
      pendingBackupData = null;
      document.getElementById('backup-preview-container').style.display = 'none';
      document.getElementById('backup-drop').style.display = 'block';
      document.getElementById('backup-file').value = '';
    }
  </script>
</body>
</html>
