<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pr√©f√©rences ‚Äî FIDDO</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .pref-layout {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 0;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      overflow: hidden;
      min-height: 480px;
    }
    .pref-nav {
      background: #f8f9fa;
      border-right: 1px solid var(--border);
      padding: 0.75rem 0;
    }
    .pref-nav-item {
      display: flex; align-items: center; gap: 8px;
      padding: 9px 16px; font-size: 0.82rem; color: var(--text-light);
      cursor: pointer; border: none; background: none; width: 100%; text-align: left;
      transition: all 0.15s; border-left: 3px solid transparent;
    }
    .pref-nav-item:hover { background: #f0f0f0; color: var(--text); }
    .pref-nav-item.active { color: var(--primary); background: white; border-left-color: var(--primary); font-weight: 600; }
    .pref-nav-item .ni { font-size: 0.9rem; width: 20px; text-align: center; }

    .pref-panel { padding: 1.25rem 1.5rem; display: none; }
    .pref-panel.active { display: block; }
    .pref-panel-title { font-size: 1rem; font-weight: 700; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border); }

    /* Theme dots */
    .theme-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .theme-dot {
      width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
      border: 3px solid transparent; transition: all 0.2s; position: relative;
    }
    .theme-dot:hover { transform: scale(1.15); }
    .theme-dot.active { border-color: var(--text); box-shadow: 0 0 0 2px white, 0 0 0 4px var(--text); }

    /* Toggle rows */
    .opt-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
    .opt-row:last-child { border-bottom: none; }
    .opt-label { font-size: 0.82rem; }
    .opt-desc { font-size: 0.7rem; color: var(--text-light); }
    .toggle-switch { position: relative; display: inline-block; width: 38px; height: 20px; flex-shrink: 0; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; border-radius: 20px; transition: 0.2s; }
    .toggle-slider:before { content: ''; position: absolute; height: 16px; width: 16px; left: 2px; bottom: 2px; background: white; border-radius: 50%; transition: 0.2s; }
    .toggle-switch input:checked + .toggle-slider { background: var(--primary); }
    .toggle-switch input:checked + .toggle-slider:before { transform: translateX(18px); }

    /* Compact form */
    .pref-panel .form-group { margin-bottom: 0.75rem; }
    .pref-panel .form-label { font-size: 0.78rem; margin-bottom: 0.2rem; }
    .pref-panel .form-control { padding: 7px 10px; font-size: 0.85rem; }
    .pref-panel .form-help { font-size: 0.7rem; }
    .fr2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .pref-sep { height: 1px; background: var(--border); margin: 1rem 0; }
    .btn-row { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem; }
    .btn-c { padding: 7px 16px; font-size: 0.8rem; }

    /* Backup zone */
    .bk-zone { border: 2px dashed var(--border); border-radius: 8px; padding: 1rem; text-align: center; cursor: pointer; transition: all 0.2s; font-size: 0.82rem; color: var(--text-light); }
    .bk-zone:hover { border-color: var(--primary); background: #fafafa; }
    .bk-zone.dragover { border-color: var(--primary); background: #f0fdfa; }
    .bk-preview { background: #f8f9fa; border-radius: 8px; padding: 0.75rem; margin-top: 0.75rem; font-size: 0.8rem; }
    .bk-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-top: 0.5rem; }
    .bk-val { font-size: 1rem; font-weight: 700; color: var(--primary); }
    .bk-lbl { font-size: 0.65rem; color: var(--text-light); text-transform: uppercase; }

    @media (max-width: 768px) {
      .pref-layout { grid-template-columns: 1fr; min-height: auto; }
      .pref-nav { display: flex; overflow-x: auto; border-right: none; border-bottom: 1px solid var(--border); padding: 0; scrollbar-width: none; }
      .pref-nav::-webkit-scrollbar { display: none; }
      .pref-nav-item { border-left: none; border-bottom: 2px solid transparent; padding: 8px 12px; white-space: nowrap; font-size: 0.75rem; }
      .pref-nav-item.active { border-left-color: transparent; border-bottom-color: var(--primary); }
      .pref-panel { padding: 1rem; }
      .fr2 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <a href="/credit" class="navbar-brand">FIDDO<span></span></a>
    <div class="navbar-menu"></div>
  </nav>

  <div class="container">
    <h1 style="margin: 1.5rem 0; font-size: 1.3rem;">‚öôÔ∏è Pr√©f√©rences</h1>
    <div id="global-alert"></div>

    <div class="pref-layout">
      <nav class="pref-nav">
        <button class="pref-nav-item active" onclick="showTab('appearance',this)"><span class="ni">üé®</span> Apparence</button>
        <button class="pref-nav-item" onclick="showTab('notifications',this)"><span class="ni">üîî</span> Notifications</button>
        <button class="pref-nav-item" onclick="showTab('merchant',this)"><span class="ni">üè™</span> Commerce</button>
        <button class="pref-nav-item" onclick="showTab('security',this)"><span class="ni">üîê</span> S√©curit√©</button>
        <button class="pref-nav-item" onclick="showTab('backup',this)"><span class="ni">üíæ</span> Backup</button>
      </nav>

      <!-- ‚ïê‚ïê‚ïê Apparence ‚ïê‚ïê‚ïê -->
      <div class="pref-panel active" id="tab-appearance">
        <div class="pref-panel-title">Apparence</div>
        <label class="form-label">Th√®me</label>
        <div class="theme-row" id="theme-row">
          <div class="theme-dot" data-theme="teal" onclick="selectTheme('teal')" style="background:linear-gradient(135deg,#0891B2,#0E7490)"></div>
          <div class="theme-dot" data-theme="navy" onclick="selectTheme('navy')" style="background:linear-gradient(135deg,#1E40AF,#1E3A8A)"></div>
          <div class="theme-dot" data-theme="violet" onclick="selectTheme('violet')" style="background:linear-gradient(135deg,#7C3AED,#6D28D9)"></div>
          <div class="theme-dot" data-theme="forest" onclick="selectTheme('forest')" style="background:linear-gradient(135deg,#059669,#047857)"></div>
          <div class="theme-dot" data-theme="brick" onclick="selectTheme('brick')" style="background:linear-gradient(135deg,#DC2626,#B91C1C)"></div>
          <div class="theme-dot" data-theme="amber" onclick="selectTheme('amber')" style="background:linear-gradient(135deg,#D97706,#B45309)"></div>
          <div class="theme-dot" data-theme="slate" onclick="selectTheme('slate')" style="background:linear-gradient(135deg,#475569,#334155)"></div>
        </div>
        <div class="pref-sep"></div>
        <div class="fr2">
          <div class="form-group">
            <label class="form-label">Langue</label>
            <select id="pref-language" class="form-control">
              <option value="fr">üá´üá∑ Fran√ßais</option>
              <option value="nl">üá≥üá± Nederlands</option>
              <option value="en">üá¨üáß English</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Fuseau horaire</label>
            <select id="pref-timezone" class="form-control">
              <option value="Europe/Brussels">Europe/Brussels</option>
              <option value="Europe/Paris">Europe/Paris</option>
              <option value="Europe/Amsterdam">Europe/Amsterdam</option>
              <option value="Europe/Luxembourg">Europe/Luxembourg</option>
              <option value="Europe/London">Europe/London</option>
            </select>
          </div>
        </div>
        <div class="pref-sep"></div>
        <div class="form-group">
          <label class="form-label">Message de r√©compense</label>
          <textarea id="reward-message" class="form-control" rows="2" placeholder="F√©licitations ! üéÅ" maxlength="200" oninput="document.getElementById('rmcount').textContent=this.value.length"></textarea>
          <small class="form-help"><span id="rmcount">0</span>/200</small>
        </div>
        <div class="btn-row"><button class="btn btn-primary btn-c" onclick="savePreferences()">Enregistrer</button></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê Notifications ‚ïê‚ïê‚ïê -->
      <div class="pref-panel" id="tab-notifications">
        <div class="pref-panel-title">Notifications email</div>
        <div class="opt-row">
          <div><div class="opt-label">Nouveau client</div><div class="opt-desc">Email quand un nouveau client est cr√©√©</div></div>
          <label class="toggle-switch"><input type="checkbox" id="notify-new-client"><span class="toggle-slider"></span></label>
        </div>
        <div class="opt-row">
          <div><div class="opt-label">R√©compense disponible</div><div class="opt-desc">Email quand un client atteint le seuil</div></div>
          <label class="toggle-switch"><input type="checkbox" id="notify-reward-ready"><span class="toggle-slider"></span></label>
        </div>
        <div class="opt-row">
          <div><div class="opt-label">Rapport hebdomadaire</div><div class="opt-desc">R√©sum√© chaque lundi</div></div>
          <label class="toggle-switch"><input type="checkbox" id="notify-weekly-report"><span class="toggle-slider"></span></label>
        </div>
        <div class="btn-row"><button class="btn btn-primary btn-c" onclick="savePreferences()">Enregistrer</button></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê Commerce ‚ïê‚ïê‚ïê -->
      <div class="pref-panel" id="tab-merchant">
        <div class="pref-panel-title">Informations du commerce</div>
        <div id="merchant-info-alert"></div>
        <div class="fr2">
          <div class="form-group"><label class="form-label">Nom du commerce</label><input type="text" id="mi-business-name" class="form-control"></div>
          <div class="form-group"><label class="form-label">N¬∞ TVA</label><input type="text" id="mi-vat" class="form-control"></div>
        </div>
        <div class="form-group"><label class="form-label">Adresse</label><input type="text" id="mi-address" class="form-control"></div>
        <div class="fr2">
          <div class="form-group"><label class="form-label">Email commerce</label><input type="email" id="mi-email" class="form-control"></div>
          <div class="form-group"><label class="form-label">T√©l√©phone commerce</label><input type="tel" id="mi-phone" class="form-control"></div>
        </div>
        <div class="fr2">
          <div class="form-group"><label class="form-label">Responsable</label><input type="text" id="mi-owner-name" class="form-control"></div>
          <div class="form-group"><label class="form-label">T√©l√©phone perso</label><input type="tel" id="mi-owner-phone" class="form-control"></div>
        </div>
        <div class="btn-row"><button class="btn btn-primary btn-c" onclick="saveMerchantInfo()" id="mi-save-btn">Mettre √† jour</button></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê S√©curit√© ‚ïê‚ïê‚ïê -->
      <div class="pref-panel" id="tab-security">
        <div class="pref-panel-title">Mot de passe</div>
        <div id="password-alert"></div>
        <div class="form-group"><label class="form-label">Mot de passe actuel</label><input type="password" id="pw-current" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
        <div class="fr2">
          <div class="form-group"><label class="form-label">Nouveau</label><input type="password" id="pw-new" class="form-control" placeholder="Min. 6 car."></div>
          <div class="form-group"><label class="form-label">Confirmer</label><input type="password" id="pw-confirm" class="form-control" placeholder="Retapez"></div>
        </div>
        <div class="btn-row"><button class="btn btn-primary btn-c" onclick="changePassword()" id="pw-save-btn">Changer le mot de passe</button></div>
      </div>

      <!-- ‚ïê‚ïê‚ïê Backup ‚ïê‚ïê‚ïê -->
      <div class="pref-panel" id="tab-backup">
        <div class="pref-panel-title">Sauvegarde & Restauration</div>
        <div style="margin-bottom:1rem">
          <label class="form-label">üì§ Exporter</label>
          <p style="font-size:0.78rem;color:var(--text-light);margin:0 0 0.5rem">Fichier JSON de toutes vos donn√©es.</p>
          <div id="last-backup-info" style="font-size:0.75rem;color:var(--text-light);margin-bottom:0.4rem"></div>
          <button class="btn btn-primary btn-c" onclick="exportBackup()" id="export-btn">üì• T√©l√©charger</button>
        </div>
        <div class="pref-sep"></div>
        <label class="form-label">üì• Restaurer</label>
        <p style="font-size:0.78rem;color:var(--text-light);margin:0 0 0.5rem">Importez un backup. <span style="color:var(--danger);font-weight:600">Remplace toutes vos donn√©es.</span></p>
        <div class="bk-zone" id="import-zone" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
          üìÅ Glissez un .json ou <strong style="color:var(--primary)">cliquez</strong>
          <input type="file" id="import-file" accept=".json" style="display:none" onchange="handleFileSelect(event)">
        </div>
        <div id="import-preview" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="import-modal" class="modal">
    <div class="modal-content" style="max-width:460px">
      <div class="modal-header"><h2 style="font-size:1.1rem">‚ö†Ô∏è Confirmer la restauration</h2><button class="close-modal" onclick="closeImportModal()">√ó</button></div>
      <div class="modal-body">
        <div class="alert alert-warning" style="font-size:0.82rem">Cette action <strong>remplace toutes vos donn√©es</strong>. Irr√©versible.</div>
        <div id="import-modal-preview"></div>
        <div id="import-alert"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline btn-c" onclick="closeImportModal()">Annuler</button>
        <button class="btn btn-danger btn-c" onclick="confirmImport()" id="confirm-import-btn">üîÑ Restaurer</button>
      </div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    if (!requireOwner()) throw 'Not authorized';
    const staff = Auth.getStaff();
    const merchant = Auth.getMerchant();
    let currentPrefs = null;
    let pendingBackupData = null;

    // ‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê
    function showTab(id, btn) {
      document.querySelectorAll('.pref-panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.pref-nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('tab-' + id).classList.add('active');
      btn.classList.add('active');
    }

    // ‚ïê‚ïê‚ïê LOAD PREFS ‚ïê‚ïê‚ïê
    async function loadPreferences() {
      try {
        const data = await API.call('/preferences');
        currentPrefs = data.preferences;
        applyToForm(currentPrefs);
      } catch (err) { console.error('Erreur prefs:', err); }
    }

    function applyToForm(p) {
      document.querySelectorAll('.theme-dot').forEach(d => d.classList.toggle('active', d.dataset.theme === p.theme));
      document.getElementById('notify-new-client').checked = !!p.notify_new_client;
      document.getElementById('notify-reward-ready').checked = !!p.notify_reward_ready;
      document.getElementById('notify-weekly-report').checked = !!p.notify_weekly_report;
      const msg = document.getElementById('reward-message');
      msg.value = p.reward_message || '';
      document.getElementById('rmcount').textContent = msg.value.length;
      document.getElementById('pref-language').value = p.language || 'fr';
      document.getElementById('pref-timezone').value = p.timezone || 'Europe/Brussels';
      const info = document.getElementById('last-backup-info');
      info.innerHTML = p.last_backup_at ? `‚úÖ Dernier : ${Format.datetime(p.last_backup_at)}` : '‚ö†Ô∏è Aucun backup';
    }

    // ‚ïê‚ïê‚ïê THEME ‚ïê‚ïê‚ïê
    function selectTheme(theme) {
      document.querySelectorAll('.theme-dot').forEach(d => d.classList.toggle('active', d.dataset.theme === theme));
      document.documentElement.setAttribute('data-theme', theme);
      API.call('/preferences/theme', { method: 'PATCH', body: JSON.stringify({ theme }) })
        .then(() => sessionStorage.setItem('fiddo_theme', theme))
        .catch(err => console.error(err));
    }

    // ‚ïê‚ïê‚ïê SAVE PREFS ‚ïê‚ïê‚ïê
    async function savePreferences() {
      try {
        const active = document.querySelector('.theme-dot.active');
        const prefs = {
          theme: active ? active.dataset.theme : 'teal',
          language: document.getElementById('pref-language').value,
          timezone: document.getElementById('pref-timezone').value,
          reward_message: document.getElementById('reward-message').value.trim(),
          notify_new_client: document.getElementById('notify-new-client').checked,
          notify_reward_ready: document.getElementById('notify-reward-ready').checked,
          notify_weekly_report: document.getElementById('notify-weekly-report').checked,
        };
        const data = await API.call('/preferences', { method: 'PUT', body: JSON.stringify(prefs) });
        currentPrefs = data.preferences;
        sessionStorage.setItem('fiddo_theme', prefs.theme);
        UI.showAlert('global-alert', 'Pr√©f√©rences enregistr√©es !', 'success');
        setTimeout(() => UI.clearAlert('global-alert'), 3000);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (err) { UI.showAlert('global-alert', err.message, 'error'); }
    }

    // ‚ïê‚ïê‚ïê MERCHANT INFO ‚ïê‚ïê‚ïê
    function prefillFromSession() {
      if (merchant) {
        document.getElementById('mi-business-name').value = merchant.business_name || '';
        document.getElementById('mi-vat').value = merchant.vat_number || '';
        document.getElementById('mi-address').value = merchant.address || '';
        document.getElementById('mi-email').value = merchant.email || '';
        document.getElementById('mi-phone').value = merchant.phone || '';
        document.getElementById('mi-owner-phone').value = merchant.owner_phone || '';
      }
      if (staff) document.getElementById('mi-owner-name').value = staff.display_name || '';
    }

    async function loadMerchantInfo() {
      try {
        const d = await API.call('/preferences/merchant-info');
        document.getElementById('mi-business-name').value = d.businessName || '';
        document.getElementById('mi-vat').value = d.vatNumber || '';
        document.getElementById('mi-address').value = d.address || '';
        document.getElementById('mi-email').value = d.email || '';
        document.getElementById('mi-phone').value = d.phone || '';
        document.getElementById('mi-owner-name').value = d.ownerName || '';
        document.getElementById('mi-owner-phone').value = d.ownerPhone || '';
      } catch (err) { /* session data already shown */ }
    }

    async function saveMerchantInfo() {
      const btn = document.getElementById('mi-save-btn');
      btn.disabled = true; btn.textContent = '‚è≥ ...';
      try {
        const p = {
          businessName: document.getElementById('mi-business-name').value.trim(),
          address: document.getElementById('mi-address').value.trim(),
          vatNumber: document.getElementById('mi-vat').value.trim(),
          email: document.getElementById('mi-email').value.trim(),
          phone: document.getElementById('mi-phone').value.trim(),
          ownerPhone: document.getElementById('mi-owner-phone').value.trim(),
          ownerName: document.getElementById('mi-owner-name').value.trim(),
        };
        if (!p.businessName || !p.address || !p.vatNumber || !p.email || !p.phone || !p.ownerPhone) {
          UI.showAlert('merchant-info-alert', 'Tous les champs sont requis', 'error'); return;
        }
        const result = await API.call('/preferences/merchant-info', { method: 'PUT', body: JSON.stringify(p) });
        if (result.merchant) Auth.setSession(staff, result.merchant);
        if (result.changes && result.changes.length > 0) {
          UI.showAlert('merchant-info-alert', `‚úÖ Mis √† jour !<br><small>${result.changes.map(c=>`<strong>${c.field}</strong>: ${c.old} ‚Üí ${c.new}`).join('<br>')}</small>`, 'success');
        } else {
          UI.showAlert('merchant-info-alert', 'Aucune modification', 'info');
        }
        setTimeout(() => UI.clearAlert('merchant-info-alert'), 6000);
      } catch (err) { UI.showAlert('merchant-info-alert', err.message, 'error');
      } finally { btn.disabled = false; btn.textContent = 'Mettre √† jour'; }
    }

    // ‚ïê‚ïê‚ïê PASSWORD ‚ïê‚ïê‚ïê
    async function changePassword() {
      const btn = document.getElementById('pw-save-btn');
      const cur = document.getElementById('pw-current').value, nw = document.getElementById('pw-new').value, cf = document.getElementById('pw-confirm').value;
      if (!cur || !nw) { UI.showAlert('password-alert', 'Remplissez les champs', 'error'); return; }
      if (nw.length < 6) { UI.showAlert('password-alert', 'Min. 6 caract√®res', 'error'); return; }
      if (nw !== cf) { UI.showAlert('password-alert', 'Ne correspondent pas', 'error'); return; }
      btn.disabled = true; btn.textContent = '‚è≥ ...';
      try {
        await API.call('/preferences/password', { method: 'PUT', body: JSON.stringify({ currentPassword: cur, newPassword: nw }) });
        UI.showAlert('password-alert', '‚úÖ Mot de passe modifi√© !', 'success');
        document.getElementById('pw-current').value = '';
        document.getElementById('pw-new').value = '';
        document.getElementById('pw-confirm').value = '';
        setTimeout(() => UI.clearAlert('password-alert'), 5000);
      } catch (err) { UI.showAlert('password-alert', err.message, 'error');
      } finally { btn.disabled = false; btn.textContent = 'Changer le mot de passe'; }
    }

    // ‚ïê‚ïê‚ïê BACKUP EXPORT ‚ïê‚ïê‚ïê
    async function exportBackup() {
      const btn = document.getElementById('export-btn');
      btn.disabled = true; btn.textContent = '‚è≥ ...';
      try {
        const resp = await fetch(`${API_BASE_URL}/preferences/backup/export`, { credentials: 'include' });
        if (!resp.ok) throw new Error((await resp.json()).error || 'Erreur');
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const cd = resp.headers.get('Content-Disposition');
        a.download = (cd && cd.match(/filename="(.+)"/)?.[1]) || `fiddo-backup-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        document.getElementById('last-backup-info').innerHTML = `‚úÖ Dernier : ${Format.datetime(new Date().toISOString())}`;
        UI.showAlert('global-alert', 'Backup t√©l√©charg√© !', 'success');
        setTimeout(() => UI.clearAlert('global-alert'), 3000);
      } catch (err) { UI.showAlert('global-alert', err.message, 'error');
      } finally { btn.disabled = false; btn.textContent = 'üì• T√©l√©charger'; }
    }

    // ‚ïê‚ïê‚ïê BACKUP IMPORT ‚ïê‚ïê‚ïê
    document.getElementById('import-zone').addEventListener('click', () => document.getElementById('import-file').click());
    function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('dragover'); }
    function handleDragLeave(e) { e.currentTarget.classList.remove('dragover'); }
    function handleDrop(e) { e.preventDefault(); e.currentTarget.classList.remove('dragover'); if (e.dataTransfer.files[0]) processImportFile(e.dataTransfer.files[0]); }
    function handleFileSelect(e) { if (e.target.files[0]) processImportFile(e.target.files[0]); }

    async function processImportFile(file) {
      if (!file.name.endsWith('.json')) { UI.showAlert('global-alert', 'Fichier .json uniquement', 'error'); return; }
      if (file.size > 10*1024*1024) { UI.showAlert('global-alert', 'Max 10 Mo', 'error'); return; }
      try {
        const data = JSON.parse(await file.text());
        const v = await API.call('/preferences/backup/validate', { method: 'POST', body: JSON.stringify(data) });
        if (!v.valid) {
          const el = document.getElementById('import-preview');
          el.style.display = 'block';
          el.innerHTML = `<div class="alert alert-error" style="font-size:0.8rem;margin-top:0.5rem">${v.errors.map(e=>'‚Ä¢ '+e).join('<br>')}</div>`;
          return;
        }
        pendingBackupData = data;
        showImportPreview(v.preview);
      } catch (err) { UI.showAlert('global-alert', err instanceof SyntaxError ? 'JSON invalide' : err.message, 'error'); }
    }

    function showImportPreview(p) {
      const el = document.getElementById('import-preview');
      el.style.display = 'block';
      el.innerHTML = `<div class="bk-preview"><strong>‚úÖ ${p.business_name}</strong> ‚Äî <small class="text-muted">${Format.datetime(p.exported_at)}</small>
        <div class="bk-grid">
          <div><div class="bk-val">${p.clients}</div><div class="bk-lbl">Clients</div></div>
          <div><div class="bk-val">${p.transactions}</div><div class="bk-lbl">Tx</div></div>
          <div><div class="bk-val">${p.total_points}</div><div class="bk-lbl">Points</div></div>
          <div><div class="bk-val">${Format.currency(p.total_spent)}</div><div class="bk-lbl">CA</div></div>
        </div>
        <button class="btn btn-danger btn-c" style="width:100%;margin-top:0.75rem" onclick="openImportModal()">üîÑ Restaurer</button>
      </div>`;
      document.getElementById('import-modal-preview').innerHTML = `<div class="bk-preview" style="margin-bottom:0.75rem"><strong>${p.business_name}</strong> ‚Äî ${Format.datetime(p.exported_at)}
        <div class="bk-grid"><div><div class="bk-val">${p.clients}</div><div class="bk-lbl">Clients</div></div><div><div class="bk-val">${p.transactions}</div><div class="bk-lbl">Tx</div></div></div></div>`;
    }

    function openImportModal() { document.getElementById('import-modal').classList.add('active'); }
    function closeImportModal() { document.getElementById('import-modal').classList.remove('active'); }
    document.getElementById('import-modal').addEventListener('click', e => { if (e.target.id === 'import-modal') closeImportModal(); });

    async function confirmImport() {
      if (!pendingBackupData) return;
      const btn = document.getElementById('confirm-import-btn');
      btn.disabled = true; btn.textContent = '‚è≥ ...';
      try {
        const r = await API.call('/preferences/backup/import', { method: 'POST', body: JSON.stringify({ data: pendingBackupData, confirmReplace: true }) });
        closeImportModal(); pendingBackupData = null;
        document.getElementById('import-preview').style.display = 'none';
        UI.showAlert('global-alert', `‚úÖ Restaur√© : ${r.result.clients_restored} clients, ${r.result.transactions_restored} transactions`, 'success');
      } catch (err) { UI.showAlert('import-alert', err.message, 'error');
      } finally { btn.disabled = false; btn.textContent = 'üîÑ Restaurer'; }
    }

    // ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
    prefillFromSession();
    loadPreferences();
    loadMerchantInfo();
  </script>
</body>
</html>
