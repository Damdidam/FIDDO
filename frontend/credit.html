<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CrÃ©diter â€” FIDDO</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CREDIT PAGE â€” Single column, no sidebar
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .credit-page { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; }
    .credit-page * { box-sizing: border-box; }

    /* â”€â”€ Centered layout â”€â”€ */
    .credit-wrap {
      max-width: 520px;
      margin: 0 auto;
      padding: 1rem;
    }

    .pg-title {
      font-size: 1.05rem; font-weight: 700; color: #1E293B;
      margin: 0.4rem 0 0.8rem; letter-spacing: -0.3px;
    }

    /* â”€â”€ Card â”€â”€ */
    .c-card {
      background: white; border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      overflow: hidden; position: relative;
    }
    .c-card-hdr {
      padding: 0.7rem 1rem;
      border-bottom: 1px solid #F1F5F9;
      font-weight: 600; font-size: 0.88rem; color: #1E293B;
      display: flex; align-items: center; gap: 0.45rem;
    }
    .c-card-body { padding: 0.9rem 1rem 1rem; }

    /* â”€â”€ Alert â”€â”€ */
    .credit-page .alert {
      border-radius: 7px; font-size: 0.82rem;
      padding: 0.5rem 0.75rem; margin-bottom: 0.75rem;
    }

    /* â”€â”€ Segmented control â”€â”€ */
    .seg {
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      background: #F1F5F9; border-radius: 7px; padding: 3px;
      margin-bottom: 0.9rem;
    }
    .seg button {
      padding: 0.4rem; border: none; background: transparent;
      border-radius: 5px; font-family: inherit; font-weight: 600;
      font-size: 0.78rem; color: #64748B; cursor: pointer;
    }
    .seg button.active {
      background: white; color: var(--primary-dark);
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }

    /* â”€â”€ Form â”€â”€ */
    .credit-page .form-group { margin-bottom: 0.8rem; }
    .credit-page .form-label {
      display: block; font-size: 0.7rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.4px;
      color: #64748B; margin-bottom: 0.25rem;
    }
    .credit-page .form-control {
      width: 100%; padding: 0.5rem 0.65rem;
      border: 1.5px solid #E2E8F0; border-radius: 6px;
      font-family: inherit; font-size: 0.88rem; color: #1E293B;
      background: #FAFBFC;
    }
    .credit-page .form-control:focus {
      outline: none; border-color: var(--primary); background: white;
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary) 10%, transparent);
    }
    .credit-page .form-control::placeholder { color: #94A3B8; }
    .credit-page .form-hint { font-size: 0.68rem; color: #94A3B8; margin-top: 0.15rem; }

    /* â”€â”€ Input wrap + clear â”€â”€ */
    .input-wrap { position: relative; }
    .input-wrap .form-control { padding-right: 26px; }
    .btn-clear {
      position: absolute; right: 6px; top: 50%; transform: translateY(-50%);
      background: none; border: none; font-size: 0.82rem; cursor: pointer;
      color: #94A3B8; padding: 2px 4px; line-height: 1; display: none;
    }
    .btn-clear:hover { color: #EF4444; }
    .input-wrap .form-control:not(:placeholder-shown) ~ .btn-clear,
    .input-wrap .form-control.has-value ~ .btn-clear { display: block; }

    /* â”€â”€ Typo warning â”€â”€ */
    .typo-warning {
      background: #FFFBEB; border: 1px solid #FDE68A; border-radius: 5px;
      padding: 0.35rem 0.6rem; margin-top: 0.25rem; font-size: 0.72rem; color: #92400E;
      display: flex; align-items: center; gap: 0.4rem;
    }
    .typo-warning button {
      background: #F59E0B; color: white; border: none; border-radius: 3px;
      padding: 1px 6px; font-size: 0.68rem; cursor: pointer; font-weight: 600;
      white-space: nowrap; font-family: inherit;
    }

    /* â”€â”€ Autocomplete â”€â”€ */
    .autocomplete-list {
      position: absolute; top: 100%; left: 0; right: 0; z-index: 50;
      background: white; border: 1.5px solid #E2E8F0; border-top: none;
      border-radius: 0 0 6px 6px; max-height: 180px; overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: none;
    }
    .autocomplete-list.show { display: block; }
    .ac-item {
      padding: 0.4rem 0.65rem; cursor: pointer;
      border-bottom: 1px solid #F8FAFC; font-size: 0.78rem;
    }
    .ac-item:last-child { border-bottom: none; }
    .ac-item:hover, .ac-item.selected { background: color-mix(in srgb, var(--primary-light) 40%, white); }
    .ac-item .ac-name { font-weight: 600; color: #1E293B; }
    .ac-item .ac-meta { color: #64748B; font-size: 0.7rem; margin-top: 1px; }
    .ac-item .ac-pts { float: right; color: var(--primary); font-weight: 700; font-size: 0.78rem; }

    /* â”€â”€ Inline lookup strip â”€â”€ */
    .lookup-strip {
      border-radius: 6px; padding: 0.45rem 0.65rem;
      font-size: 0.78rem; margin-top: 0.35rem;
      line-height: 1.5; display: none;
    }
    .lookup-strip.show { display: block; }
    .lookup-strip.found {
      background: color-mix(in srgb, var(--primary-light) 30%, white);
      border: 1px solid color-mix(in srgb, var(--primary-light) 55%, white);
    }
    .lookup-strip.new-client {
      background: #F8FAFC; border: 1px solid #E2E8F0;
    }
    .lookup-strip .l-name { font-weight: 600; }
    .lookup-strip .l-pts { float: right; font-weight: 700; color: var(--primary); }
    .lookup-strip .l-meta { font-size: 0.7rem; color: #64748B; }
    .lookup-strip .l-prog { background: #E2E8F0; height: 3px; border-radius: 2px; margin: 0.25rem 0; overflow: hidden; }
    .lookup-strip .l-prog-fill { height: 100%; background: var(--gradient); border-radius: 2px; }
    .lookup-strip .l-reward {
      background: var(--gradient); color: white;
      padding: 0.3rem 0.5rem; border-radius: 4px; text-align: center;
      margin-top: 0.3rem; cursor: pointer; font-size: 0.72rem; font-weight: 500;
    }

    /* â”€â”€ Amount row + points counter â”€â”€ */
    .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.65rem; }
    .pts-badge {
      display: inline-block; background: var(--gradient); color: white;
      padding: 1px 8px; border-radius: 10px; font-size: 0.72rem; font-weight: 700;
      margin-left: 0.4rem; vertical-align: middle;
    }

    /* â”€â”€ Submit â”€â”€ */
    .btn-credit {
      width: 100%; padding: 0.6rem; border: none; border-radius: 7px;
      background: var(--gradient); color: white; font-family: inherit;
      font-size: 0.88rem; font-weight: 600; cursor: pointer;
      box-shadow: 0 2px 6px color-mix(in srgb, var(--primary) 18%, transparent);
    }
    .btn-credit:hover:not(:disabled) {
      box-shadow: 0 3px 10px color-mix(in srgb, var(--primary) 28%, transparent);
    }
    .btn-credit:disabled { opacity: 0.55; cursor: not-allowed; }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       SUCCESS OVERLAY â€” covers the form, centered
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .success-overlay {
      position: absolute; inset: 0; z-index: 10;
      background: white;
      border-radius: 12px;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem 1.5rem;
    }
    .success-overlay.show { display: flex; }

    .success-pts {
      font-size: 2.5rem; font-weight: 700; color: #059669;
      line-height: 1; letter-spacing: -1px;
    }
    .success-label {
      font-size: 0.75rem; color: #059669; text-transform: uppercase;
      letter-spacing: 0.5px; margin-top: 4px; font-weight: 600;
    }
    .success-info {
      margin-top: 1rem; font-size: 0.85rem; color: #1E293B;
      line-height: 1.7;
      background: #F0FDF4; border: 1px solid #D1FAE5;
      border-radius: 8px; padding: 0.75rem 1.25rem;
      min-width: 240px;
    }
    .success-info strong { color: #047857; }
    .success-info .s-detail { color: #64748B; font-size: 0.78rem; }
    .success-badge {
      display: inline-block; background: color-mix(in srgb, var(--primary-light) 50%, white);
      color: var(--primary-dark); padding: 2px 10px; border-radius: 12px;
      font-size: 0.7rem; font-weight: 600; margin-top: 0.4rem;
    }
    .success-btn {
      margin-top: 1.5rem; padding: 0.55rem 2rem; border: none; border-radius: 7px;
      background: var(--gradient); color: white; font-family: inherit;
      font-size: 0.88rem; font-weight: 600; cursor: pointer;
      box-shadow: 0 2px 6px color-mix(in srgb, var(--primary) 18%, transparent);
    }
    .success-btn:hover {
      box-shadow: 0 3px 10px color-mix(in srgb, var(--primary) 28%, transparent);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       QR â€” Compact
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .qr-box {
      text-align: center; padding: 0.75rem;
      background: #FAFBFC; border: 1.5px solid #E2E8F0;
      border-radius: 7px; margin-bottom: 0.8rem;
    }
    .qr-box .qr-sub { font-size: 0.7rem; color: #64748B; margin-bottom: 0.5rem; }

    .qr-frame {
      position: relative; display: inline-block; padding: 6px;
      background: white; border-radius: 6px; border: 1px solid #E2E8F0;
    }
    .qr-frame img { display: block; border-radius: 2px; }
    .qr-frame::after {
      content: ''; position: absolute; left: 6px; right: 6px; height: 2px;
      background: linear-gradient(90deg, transparent, var(--primary), transparent);
      animation: qrscan 2.5s ease-in-out infinite;
    }
    @keyframes qrscan { 0%{top:6px;opacity:0} 10%{opacity:1} 90%{opacity:1} 100%{top:calc(100% - 6px);opacity:0} }
    .qr-frame.done::after { display: none; }

    .qr-stat {
      display: flex; align-items: center; justify-content: center;
      gap: 0.4rem; margin-top: 0.4rem; font-size: 0.7rem; color: #64748B;
    }
    .qr-stat .dot {
      width: 5px; height: 5px; border-radius: 50%; background: #F59E0B;
      animation: qrp 1.5s ease-in-out infinite;
    }
    @keyframes qrp { 0%,100%{opacity:1} 50%{opacity:.3} }
    .qr-stat.ok .dot { background: var(--primary); animation: none; }
    .qr-stat.ko .dot { background: #EF4444; animation: none; }

    .qr-tmr { width: 100px; height: 2px; background: #E2E8F0; border-radius: 1px; margin: 0.25rem auto 0; overflow: hidden; }
    .qr-tmr-fill { height: 100%; background: var(--primary); border-radius: 1px; width: 100%; }
    .qr-tmr-txt { font-size: 0.62rem; color: #94A3B8; margin-top: 0.1rem; }

    .qr-result {
      padding: 0.5rem; margin-top: 0.35rem;
      background: color-mix(in srgb, var(--primary-light) 35%, white);
      border-radius: 5px; border: 1px solid color-mix(in srgb, var(--primary-light) 55%, white);
      font-size: 0.75rem; color: #1E293B; line-height: 1.5;
    }
    .qr-result strong { color: var(--primary-dark); }

    .qr-redo {
      margin-top: 0.35rem; padding: 0.15rem 0.5rem; border-radius: 4px;
      font-size: 0.68rem; cursor: pointer;
      border: 1px solid #E2E8F0; background: white; color: #64748B;
      font-family: inherit;
    }
    .qr-redo:hover { background: #F1F5F9; }

    /* â”€â”€ Cashier limit info â”€â”€ */
    .config-strip {
      font-size: 0.7rem; color: #94A3B8; margin-bottom: 0.75rem;
      padding: 0.3rem 0.5rem; background: #F8FAFC; border-radius: 5px;
      border: 1px solid #F1F5F9;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       RESPONSIVE
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    @media (max-width: 768px) {
      .credit-wrap { padding: 0.5rem; }
      .c-card-body { padding: 0.75rem; }
      .row-2 { grid-template-columns: 1fr; gap: 0.4rem; }
      .pg-title { font-size: 0.92rem; margin: 0.3rem 0 0.6rem; }
      .success-overlay { padding: 1.5rem 1rem; }
      .success-pts { font-size: 2rem; }
      .success-info { min-width: auto; }
    }

    @media (max-width: 380px) {
      .seg button { font-size: 0.7rem; }
    }
  </style>
</head>
<body class="credit-page">
  <nav class="navbar">
    <a href="/dashboard" class="navbar-brand">FIDDO<span></span></a>
    <div class="navbar-menu"></div>
  </nav>

  <div class="credit-wrap">
    <h1 class="pg-title">CrÃ©diter des points</h1>

    <div class="c-card">
      <div class="c-card-hdr">
        <svg width="14" height="14" viewBox="0 0 16 16" fill="none" style="color:var(--primary)">
          <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5"/>
          <path d="M8 4.5v4M6 6.5l2 2 2-2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Nouveau passage
      </div>

      <div class="c-card-body">
        <div id="credit-alert"></div>

        <!-- Config strip -->
        <div class="config-strip" id="config-strip"></div>

        <form id="credit-form" autocomplete="off">
          <!-- Segment toggle -->
          <div class="seg">
            <button type="button" id="toggle-email" class="active" onclick="switchMode('email')">@ Email</button>
            <button type="button" id="toggle-phone" onclick="switchMode('phone')"># TÃ©l</button>
            <button type="button" id="toggle-qr" onclick="switchMode('qr')">ğŸ“± QR</button>
          </div>

          <!-- Email -->
          <div class="form-group" id="field-email">
            <label class="form-label">Adresse email</label>
            <div class="input-wrap">
              <input type="email" id="client-email" class="form-control" placeholder="client@email.com" autocomplete="off">
              <button type="button" class="btn-clear" onclick="clearField('client-email')">Ã—</button>
              <div class="autocomplete-list" id="ac-email"></div>
            </div>
            <div id="typo-email"></div>
            <div class="lookup-strip" id="lookup-email"></div>
          </div>

          <!-- Phone -->
          <div class="form-group" id="field-phone" style="display:none;">
            <label class="form-label">NumÃ©ro de tÃ©lÃ©phone</label>
            <div class="input-wrap">
              <input type="tel" id="client-phone" class="form-control" placeholder="+32 497 12 34 56" autocomplete="off">
              <button type="button" class="btn-clear" onclick="clearField('client-phone')">Ã—</button>
              <div class="autocomplete-list" id="ac-phone"></div>
            </div>
            <div class="form-hint">+32â€¦, 0032â€¦, 04â€¦</div>
            <div class="lookup-strip" id="lookup-phone"></div>
          </div>

          <!-- QR (static) -->
          <div id="field-qr" style="display:none;">
            <div class="qr-box" id="qr-inline">
              <div class="qr-sub">PrÃ©sentez ce QR au client</div>
              <div class="qr-frame" id="qr-frame"><div id="qr-canvas"></div></div>
              <button type="button" class="qr-redo" onclick="showQRFullscreen()">â›¶ Plein Ã©cran</button>
            </div>

            <!-- Pending identifications -->
            <div id="pending-clients" style="margin-top:0.75rem;"></div>
            <div class="lookup-strip" id="lookup-qr"></div>
          </div>

          <!-- Name -->
          <div class="form-group">
            <label class="form-label">Nom / surnom <span style="font-weight:400;text-transform:none;letter-spacing:0">(opt.)</span></label>
            <div class="input-wrap">
              <input type="text" id="client-name" class="form-control" placeholder="Pierre, Table 5â€¦" autocomplete="off">
              <button type="button" class="btn-clear" onclick="clearField('client-name')">Ã—</button>
            </div>
          </div>

          <!-- Amount + Notes -->
          <div id="pin-group" class="form-group" style="display:none;">
            <label class="form-label">ğŸ”’ Code PIN du client (4 chiffres)</label>
            <div class="input-wrap">
              <input type="tel" id="client-pin" class="form-control" placeholder="1234" maxlength="4" pattern="\d{4}" inputmode="numeric" autocomplete="off" style="text-align:center; font-size:1.3rem; letter-spacing:0.5rem; font-weight:700;">
              <button type="button" class="btn-clear" onclick="clearField('client-pin')">Ã—</button>
            </div>
            <div class="form-hint">Ce code sera demandÃ© au client pour utiliser sa rÃ©compense</div>
          </div>

          <!-- Amount + Notes -->
          <div class="row-2">
            <div class="form-group">
              <label class="form-label">Montant (â‚¬) * <span class="pts-badge" id="pts-badge">0 pts</span></label>
              <div class="input-wrap">
                <input type="number" id="amount" class="form-control" step="0.01" min="0.01" placeholder="25.50" required inputmode="decimal">
                <button type="button" class="btn-clear" onclick="clearField('amount')">Ã—</button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Notes <span style="font-weight:400;text-transform:none;letter-spacing:0">(opt.)</span></label>
              <div class="input-wrap">
                <input type="text" id="notes" class="form-control" placeholder="Menu midiâ€¦" autocomplete="off">
                <button type="button" class="btn-clear" onclick="clearField('notes')">Ã—</button>
              </div>
            </div>
          </div>

          <button type="submit" class="btn-credit" id="submit-btn">CrÃ©diter les points</button>
        </form>
      </div>

      <!-- â•â•â•â•â•â• SUCCESS OVERLAY â€” covers entire card â•â•â•â•â•â• -->
      <div class="success-overlay" id="success-overlay">
        <div class="success-pts" id="s-pts"></div>
        <div class="success-label">CrÃ©ditÃ©s âœ“</div>
        <div class="success-info" id="s-info"></div>
        <button class="success-btn" onclick="resetForm()">Nouveau crÃ©dit</button>
      </div>

    </div>
  </div>

  <!-- Fullscreen QR overlay (for table service) -->
  <div id="qr-fullscreen" style="display:none; position:fixed; inset:0; z-index:9999; background:#fff; flex-direction:column; align-items:center; justify-content:center; cursor:pointer;" onclick="closeQRFullscreen()">
    <div style="text-align:center;">
      <div style="font-size:1.1rem; font-weight:600; color:#1E293B; margin-bottom:0.5rem;" id="qr-fs-merchant"></div>
      <div style="font-size:0.8rem; color:#64748B; margin-bottom:1.5rem;">Scannez pour gagner vos points fidÃ©litÃ©</div>
      <div id="qr-fs-canvas" style="display:inline-block; padding:16px; background:#fff; border-radius:12px; box-shadow:0 4px 24px rgba(0,0,0,0.1);"></div>
      <div style="margin-top:1.5rem; font-size:0.7rem; color:#94A3B8;">Appuyez n'importe oÃ¹ pour fermer</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="/js/app.js"></script>
  <script>
    if (!requireAuth()) throw 'Not authenticated';

    const merchant = Auth.getMerchant();
    const staff = Auth.getStaff();
    let currentMode = 'email';
    let lastCreditKey = null; // anti-double-credit
    let lookupIsNew = false;  // true when current client is new (needs PIN)

    // Config strip
    document.getElementById('config-strip').textContent =
      merchant.points_per_euro + ' pt/â‚¬ Â· RÃ©compense Ã  ' + merchant.points_for_reward + ' pts â€” ' +
      merchant.reward_description +
      (staff.role === 'cashier' ? ' Â· Max 200â‚¬' : '');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LOOKUP â€” inline strip under the active field
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function getLookupEl() {
      return document.getElementById('lookup-' + currentMode);
    }

    function showLookup(data) {
      const el = getLookupEl();
      if (!el) return;

      if (!data.found) {
        lookupIsNew = true;
        el.className = 'lookup-strip show new-client';
        el.innerHTML = 'Nouveau client â€” sera crÃ©Ã© au crÃ©dit.';
        showPinField(true);
        return;
      }
      const c = data.client;
      if (data.isNew) {
        lookupIsNew = true;
        el.className = 'lookup-strip show new-client';
        el.innerHTML = 'PremiÃ¨re visite ici.' + (c.name ? ' Nom : ' + c.name : '');
        if (c.name && !document.getElementById('client-name').value) {
          document.getElementById('client-name').value = c.name;
          document.getElementById('client-name').classList.add('has-value');
        }
        showPinField(!c.has_pin); // only if they don't already have a PIN
        return;
      }

      lookupIsNew = false;
      showPinField(false);
      el.className = 'lookup-strip show found';
      const pct = Math.min((c.points_balance / c.reward_threshold) * 100, 100);
      let h = '<span class="l-pts">' + c.points_balance + ' pts</span>' +
        '<span class="l-name">' + (c.name || c.email || c.phone) + '</span>' +
        (c.is_blocked ? ' <span class="badge badge-danger">BloquÃ©</span>' : '') +
        '<div class="l-meta">' + c.visit_count + ' visite(s) Â· ' + c.points_balance + '/' + c.reward_threshold + '</div>' +
        '<div class="l-prog"><div class="l-prog-fill" style="width:' + pct + '%"></div></div>';
      if (c.can_redeem) {
        h += '<div class="l-reward" onclick="redeemReward(' + c.id + ')">' +
          (c.reward_description || merchant.reward_description) + ' â€” Appliquer</div>';
      }
      el.innerHTML = h;

      if (c.name && !document.getElementById('client-name').value) {
        document.getElementById('client-name').value = c.name;
        document.getElementById('client-name').classList.add('has-value');
      }
    }

    function hideLookup() {
      document.querySelectorAll('.lookup-strip').forEach(el => {
        el.classList.remove('show');
        el.innerHTML = '';
      });
      lookupIsNew = false;
      showPinField(false);
    }

    function showPinField(show) {
      const g = document.getElementById('pin-group');
      if (!g) return;
      g.style.display = show ? 'block' : 'none';
      if (!show) {
        document.getElementById('client-pin').value = '';
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PRE-FILL FROM URL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    (function() {
      const p = new URLSearchParams(window.location.search);
      if (p.get('phone') && !p.get('email')) { switchMode('phone'); document.getElementById('client-phone').value = p.get('phone'); }
      else if (p.get('email')) { document.getElementById('client-email').value = p.get('email'); }
      if (p.get('name')) document.getElementById('client-name').value = p.get('name');
      if (p.get('email') || p.get('phone')) setTimeout(triggerLookup, 500);
      if (p.toString()) window.history.replaceState({}, '', window.location.pathname);
    })();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MODE SWITCH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function switchMode(mode) {
      if (currentMode === 'qr' && mode !== 'qr') {
        stopPendingPoll();
      }
      currentMode = mode;
      document.getElementById('toggle-email').classList.toggle('active', mode === 'email');
      document.getElementById('toggle-phone').classList.toggle('active', mode === 'phone');
      document.getElementById('toggle-qr').classList.toggle('active', mode === 'qr');
      document.getElementById('field-email').style.display = mode === 'email' ? '' : 'none';
      document.getElementById('field-phone').style.display = mode === 'phone' ? '' : 'none';
      document.getElementById('field-qr').style.display = mode === 'qr' ? '' : 'none';
      if (mode !== 'email') { document.getElementById('client-email').value = ''; document.getElementById('ac-email').classList.remove('show'); document.getElementById('typo-email').innerHTML = ''; }
      if (mode !== 'phone') { document.getElementById('client-phone').value = ''; document.getElementById('ac-phone').classList.remove('show'); }
      hideLookup();
      if (mode === 'qr') startPendingPoll();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CLEAR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function clearField(id) {
      const el = document.getElementById(id);
      el.value = ''; el.focus(); el.dispatchEvent(new Event('input'));
      if (id === 'amount') document.getElementById('pts-badge').textContent = '0 pts';
    }
    document.querySelectorAll('.input-wrap .form-control').forEach(el => {
      el.addEventListener('input', () => el.classList.toggle('has-value', el.value.length > 0));
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // POINTS BADGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById('amount').addEventListener('input', (e) => {
      const pts = Math.floor((parseFloat(e.target.value) || 0) * merchant.points_per_euro);
      document.getElementById('pts-badge').textContent = pts + ' pts';
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EMAIL TYPO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const TYPOS = {
      'gmial.com':'gmail.com','gmal.com':'gmail.com','gmaill.com':'gmail.com',
      'gamil.com':'gmail.com','gnail.com':'gmail.com','gmali.com':'gmail.com',
      'gmai.com':'gmail.com','gmail.co':'gmail.com','gmail.be':'gmail.com',
      'hotmal.com':'hotmail.com','hotmai.com':'hotmail.com','hotmaill.com':'hotmail.com',
      'hotmial.com':'hotmail.com','hotamil.com':'hotmail.com',
      'outloo.com':'outlook.com','outlok.com':'outlook.com',
      'yahooo.com':'yahoo.com','yaho.com':'yahoo.com','yahooo.fr':'yahoo.fr',
      'iclould.com':'icloud.com','iclou.com':'icloud.com',
    };
    function checkEmailTypo(v) {
      const c = document.getElementById('typo-email'); c.innerHTML = '';
      if (!v || !v.includes('@')) return;
      const parts = v.split('@'); if (parts.length !== 2) return;
      const fix = TYPOS[parts[1].toLowerCase()];
      if (fix) {
        const corrected = parts[0] + '@' + fix;
        c.innerHTML = '<div class="typo-warning"><span>â†’ <strong>' + corrected + '</strong> ?</span><button type="button" onclick="applyTypo(\'' + corrected + '\')">Corriger</button></div>';
      }
    }
    function applyTypo(v) {
      document.getElementById('client-email').value = v;
      document.getElementById('typo-email').innerHTML = '';
      triggerLookup();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTOCOMPLETE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let acTimer;
    function setupAC(inputId, listId) {
      const inp = document.getElementById(inputId), list = document.getElementById(listId);
      inp.addEventListener('input', () => {
        clearTimeout(acTimer);
        const v = inp.value.trim();
        triggerLookup();
        if (v.length < 3) { list.classList.remove('show'); if (inputId === 'client-email') checkEmailTypo(v); return; }
        if (inputId === 'client-email') checkEmailTypo(v);
        acTimer = setTimeout(async () => {
          try {
            const d = await API.clients.searchGlobal(v);
            if (!d.clients || !d.clients.length) { list.classList.remove('show'); return; }
            list.innerHTML = d.clients.slice(0, 6).map(c =>
              '<div class="ac-item" data-email="' + (c.email || '') + '" data-phone="' + (c.phone || '') + '" data-name="' + (c.name || '') + '">' +
              '<span class="ac-pts">' + (c.is_local ? c.points_balance + ' pts' : '<span class="badge badge-info">Nouveau</span>') + '</span>' +
              '<div class="ac-name">' + (c.name || c.email || c.phone || '?') + '</div>' +
              '<div class="ac-meta">' + (c.email || '') + (c.email && c.phone ? ' Â· ' : '') + (c.phone || '') + (c.is_local ? ' Â· ' + c.visit_count + 'v' : '') + '</div></div>'
            ).join('');
            list.classList.add('show');
            list.querySelectorAll('.ac-item').forEach(item => {
              item.addEventListener('click', () => {
                const e = item.dataset.email, p = item.dataset.phone, n = item.dataset.name;
                if (currentMode === 'email' && e) { inp.value = e; inp.classList.add('has-value'); }
                else if (currentMode === 'phone' && p) { inp.value = p; inp.classList.add('has-value'); }
                else if (e) { switchMode('email'); document.getElementById('client-email').value = e; }
                else if (p) { switchMode('phone'); document.getElementById('client-phone').value = p; }
                if (n) { document.getElementById('client-name').value = n; document.getElementById('client-name').classList.add('has-value'); }
                list.classList.remove('show');
                document.getElementById('typo-email').innerHTML = '';
                triggerLookup();
              });
            });
          } catch (e) { list.classList.remove('show'); }
        }, 350);
      });
      document.addEventListener('click', (e) => { if (!inp.contains(e.target) && !list.contains(e.target)) list.classList.remove('show'); });
    }
    setupAC('client-email', 'ac-email');
    setupAC('client-phone', 'ac-phone');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LOOKUP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let lookupTimer;
    function triggerLookup() {
      clearTimeout(lookupTimer);
      const email = document.getElementById('client-email').value.trim();
      const phone = document.getElementById('client-phone').value.trim();
      if (!email && !phone) { hideLookup(); return; }
      lookupTimer = setTimeout(async () => {
        try {
          const p = {};
          if (email) p.email = email;
          if (phone) p.phone = phone;
          showLookup(await API.clients.lookup(p));
        } catch (e) { console.error(e); }
      }, 300);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REDEEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function redeemReward(mcId) {
      const pin = prompt('ğŸ”’ Code PIN du client (4 chiffres) :');
      if (!pin) return; // cancelled
      if (!/^\d{4}$/.test(pin)) {
        UI.showAlert('credit-alert', 'Le code PIN doit contenir 4 chiffres', 'error');
        return;
      }
      try {
        const r = await API.clients.reward({ merchantClientId: mcId, pin });
        UI.showAlert('credit-alert', 'RÃ©compense appliquÃ©e â€” Solde : ' + r.client.points_balance + ' pts', 'success');
        triggerLookup();
      } catch (e) { UI.showAlert('credit-alert', e.message, 'error'); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SUBMIT â€” with anti-double-credit
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById('credit-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('client-email').value.trim();
      const phone = document.getElementById('client-phone').value.trim();
      const name = document.getElementById('client-name').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      const notes = document.getElementById('notes').value.trim();

      if (!email && !phone) { UI.showAlert('credit-alert', currentMode === 'qr' ? 'Le client n\'a pas scannÃ© le QR' : 'Email ou tÃ©lÃ©phone requis', 'error'); return; }
      if (!amount || amount <= 0) { UI.showAlert('credit-alert', 'Montant invalide', 'error'); return; }

      // â”€â”€ Anti-double-credit: generate unique key per submission â”€â”€
      const creditKey = (email || '') + '|' + (phone || '') + '|' + amount + '|' + Date.now();
      if (lastCreditKey && lastCreditKey === creditKey) {
        UI.showAlert('credit-alert', 'Ce crÃ©dit vient d\'Ãªtre effectuÃ©', 'warning');
        return;
      }

      try {
        document.getElementById('submit-btn').disabled = true;
        document.getElementById('submit-btn').textContent = 'Traitementâ€¦';
        UI.clearAlert('credit-alert');

        const idempotencyKey = 'manual-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
        const pinVal = document.getElementById('client-pin').value.trim();

        const r = await API.clients.credit({
          email: email || undefined, phone: phone || undefined,
          name: name || undefined, amount, notes: notes || undefined,
          idempotencyKey,
          pin: pinVal || undefined,
        });

        // â”€â”€ Mark this credit as done (prevent re-submit) â”€â”€
        lastCreditKey = creditKey;

        // â”€â”€ Show success overlay (blocks form access) â”€â”€
        const n = r.client.name || r.client.email || r.client.phone || 'Client';
        document.getElementById('s-pts').textContent = '+' + r.transaction.points_delta + ' pts';

        let info = '<strong>' + n + '</strong>';
        info += '<br>Nouveau solde : <strong>' + r.client.points_balance + ' points</strong>';
        if (r.client.email) info += '<br><span class="s-detail">' + r.client.email + '</span>';
        if (r.client.phone) info += '<br><span class="s-detail">' + r.client.phone + '</span>';
        if (r.isNewClient) info += '<br><span class="success-badge">Nouveau client</span>';

        document.getElementById('s-info').innerHTML = info;
        document.getElementById('success-overlay').classList.add('show');

      } catch (err) {
        UI.showAlert('credit-alert', err.message, 'error');
      } finally {
        document.getElementById('submit-btn').disabled = false;
        document.getElementById('submit-btn').textContent = 'CrÃ©diter les points';
      }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RESET â€” only way back from success overlay
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function resetForm() {
      // Hide overlay
      document.getElementById('success-overlay').classList.remove('show');

      // Full form reset
      lastCreditKey = null;
      document.getElementById('credit-form').reset();
      document.querySelectorAll('.form-control').forEach(el => el.classList.remove('has-value'));
      document.getElementById('pts-badge').textContent = '0 pts';
      hideLookup();
      UI.clearAlert('credit-alert');

      // QR cleanup â€” poll refresh
      if (currentMode === 'qr') pollPending();
      else {
        stopPendingPoll();
      }

      switchMode('email');
      document.getElementById('client-email').focus();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // QR CODE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // QR STATIC â€” Display + Pending identifications polling
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let merchantQrUrl = null;
    let merchantQrToken = null;
    let qrInst = null;
    let pendingPoll = null;

    async function loadStaticQR() {
      try {
        const resp = await API.call('/qr/token');
        merchantQrToken = resp.token;
        merchantQrUrl = resp.url;

        const cv = document.getElementById('qr-canvas'); cv.innerHTML = '';
        qrInst = new QRCode(cv, { text: resp.url, width: 120, height: 120, colorDark: '#1F2937', colorLight: '#ffffff', correctLevel: QRCode.CorrectLevel.M });
      } catch (e) {
        console.error('QR load error:', e);
      }
    }

    function showQRFullscreen() {
      if (!merchantQrUrl) return;
      const overlay = document.getElementById('qr-fullscreen');
      const cv = document.getElementById('qr-fs-canvas'); cv.innerHTML = '';
      document.getElementById('qr-fs-merchant').textContent = merchant.business_name;
      new QRCode(cv, { text: merchantQrUrl, width: 260, height: 260, colorDark: '#1F2937', colorLight: '#ffffff', correctLevel: QRCode.CorrectLevel.M });
      overlay.style.display = 'flex';
    }

    function closeQRFullscreen() {
      document.getElementById('qr-fullscreen').style.display = 'none';
    }

    // Pending identifications polling
    function startPendingPoll() {
      stopPendingPoll();
      pollPending(); // immediate first call
      pendingPoll = setInterval(pollPending, 3000);
    }

    function stopPendingPoll() {
      if (pendingPoll) { clearInterval(pendingPoll); pendingPoll = null; }
    }

    async function pollPending() {
      try {
        const resp = await API.call('/qr/pending');
        renderPending(resp.clients);
      } catch (e) {}
    }

    function renderPending(clients) {
      const el = document.getElementById('pending-clients');
      if (!clients || clients.length === 0) {
        el.innerHTML = '<div style="text-align:center;padding:0.5rem;color:#94A3B8;font-size:0.75rem;">En attente de clientsâ€¦</div>';
        return;
      }
      let html = '';
      clients.forEach(c => {
        const label = c.name || c.email || c.phone || 'Client';
        const badge = c.isNew
          ? '<span style="font-size:0.65rem;background:#DBEAFE;color:#1E40AF;padding:1px 6px;border-radius:8px;margin-left:4px;">Nouveau</span>'
          : '<span style="font-size:0.65rem;color:#64748B;">' + c.pointsBalance + ' pts Â· ' + c.visitCount + ' visite(s)</span>';
        const ago = c.secondsAgo < 60 ? 'Ã  l\'instant' : Math.floor(c.secondsAgo / 60) + ' min';
        html += '<div style="display:flex;align-items:center;justify-content:space-between;background:#F0FDF4;border:1px solid #BBF7D0;border-radius:8px;padding:0.5rem 0.75rem;margin-bottom:0.35rem;cursor:pointer;" onclick="consumeIdent(\'' + c.identId + '\')">' +
          '<div><strong style="font-size:0.85rem;color:#166534;">âœ“ ' + label + '</strong><br>' + badge + '</div>' +
          '<div style="text-align:right;"><span style="font-size:0.65rem;color:#94A3B8;">' + ago + '</span><br>' +
          '<span style="font-size:0.7rem;color:#059669;font-weight:600;">SÃ©lectionner â†’</span></div></div>';
      });
      el.innerHTML = html;
    }

    async function consumeIdent(identId) {
      try {
        const d = await API.call('/qr/consume/' + identId, { method: 'POST' });

        // Pre-fill the credit form
        if (d.email) {
          switchMode('email');
          document.getElementById('client-email').value = d.email;
          document.getElementById('client-email').classList.add('has-value');
        } else if (d.phone) {
          switchMode('phone');
          document.getElementById('client-phone').value = d.phone;
          document.getElementById('client-phone').classList.add('has-value');
        }
        if (d.name) {
          document.getElementById('client-name').value = d.name;
          document.getElementById('client-name').classList.add('has-value');
        }

        setTimeout(triggerLookup, 300);
        setTimeout(() => document.getElementById('amount').focus(), 600);
      } catch (e) {
        console.error('Consume error:', e);
      }
    }

    // Load QR on page init (lazy)
    loadStaticQR();

    window.addEventListener('beforeunload', stopPendingPoll);
  </script>
</body>
</html>
