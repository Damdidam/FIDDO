<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Créditer — FIDDO</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ═══════════════════════════════════════════════════════
       CREDIT PAGE — Single column, no sidebar
       ═══════════════════════════════════════════════════════ */

    .credit-page { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; }
    .credit-page * { box-sizing: border-box; }

    /* ── Centered layout ── */
    .credit-wrap {
      max-width: 520px;
      margin: 0 auto;
      padding: 1rem;
    }

    .pg-title {
      font-size: 1.05rem; font-weight: 700; color: #1E293B;
      margin: 0.4rem 0 0.8rem; letter-spacing: -0.3px;
    }

    /* ── Card ── */
    .c-card {
      background: white; border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      overflow: hidden; position: relative;
    }
    .c-card-body { padding: 0.9rem 1rem 1rem; }
    /* ── Alert ── */
    .credit-page .alert {
      border-radius: 7px; font-size: 0.82rem;
      padding: 0.5rem 0.75rem; margin-bottom: 0.75rem;
    }

    /* ── Segmented control ── */
    .seg {
      display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;
      background: #F1F5F9; border-radius: 7px; padding: 3px;
      margin-bottom: 0.9rem;
    }
    .seg button {
      padding: 0.4rem; border: none; background: transparent;
      border-radius: 5px; font-family: inherit; font-weight: 600;
      font-size: 0.75rem; color: #64748B; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 4px;
    }
    .seg button svg { width: 13px; height: 13px; flex-shrink: 0; }
    .seg button.active {
      background: white; color: var(--primary-dark);
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }

    /* ── Form ── */
    .credit-page .form-group { margin-bottom: 0.8rem; }
    .credit-page .form-label {
      display: block; font-size: 0.7rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.4px;
      color: #64748B; margin-bottom: 0.25rem;
    }
    .credit-page .form-control {
      width: 100%; padding: 0.5rem 0.65rem;
      border: 1.5px solid #E2E8F0; border-radius: 6px;
      font-family: inherit; font-size: 0.88rem; color: #1E293B;
      background: #FAFBFC;
    }
    .credit-page .form-control:focus {
      outline: none; border-color: var(--primary); background: white;
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary) 10%, transparent);
    }
    .credit-page .form-control::placeholder { color: #94A3B8; }
    .credit-page .form-hint { font-size: 0.68rem; color: #94A3B8; margin-top: 0.15rem; }

    /* ── Input wrap + clear ── */
    .input-wrap { position: relative; }
    .input-wrap .form-control { padding-right: 26px; }
    .btn-clear {
      position: absolute; right: 6px; top: 50%; transform: translateY(-50%);
      background: none; border: none; font-size: 0.82rem; cursor: pointer;
      color: #94A3B8; padding: 2px 4px; line-height: 1; display: none;
    }
    .btn-clear:hover { color: #EF4444; }
    .input-wrap .form-control:not(:placeholder-shown) ~ .btn-clear,
    .input-wrap .form-control.has-value ~ .btn-clear { display: block; }

    /* ── Typo warning ── */
    .typo-warning {
      background: #FFFBEB; border: 1px solid #FDE68A; border-radius: 5px;
      padding: 0.35rem 0.6rem; margin-top: 0.25rem; font-size: 0.72rem; color: #92400E;
      display: flex; align-items: center; gap: 0.4rem;
    }
    .typo-warning button {
      background: #F59E0B; color: white; border: none; border-radius: 3px;
      padding: 1px 6px; font-size: 0.68rem; cursor: pointer; font-weight: 600;
      white-space: nowrap; font-family: inherit;
    }

    /* ── Autocomplete ── */
    .autocomplete-list {
      position: absolute; top: 100%; left: 0; right: 0; z-index: 50;
      background: white; border: 1.5px solid #E2E8F0; border-top: none;
      border-radius: 0 0 6px 6px; max-height: 180px; overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: none;
    }
    .autocomplete-list.show { display: block; }
    .ac-item {
      padding: 0.4rem 0.65rem; cursor: pointer;
      border-bottom: 1px solid #F8FAFC; font-size: 0.78rem;
    }
    .ac-item:last-child { border-bottom: none; }
    .ac-item:hover, .ac-item.selected { background: color-mix(in srgb, var(--primary-light) 40%, white); }
    .ac-item .ac-name { font-weight: 600; color: #1E293B; }
    .ac-item .ac-meta { color: #64748B; font-size: 0.7rem; margin-top: 1px; }
    .ac-item .ac-pts { float: right; color: var(--primary); font-weight: 700; font-size: 0.78rem; }

    /* ── Inline lookup strip ── */
    .lookup-strip {
      border-radius: 6px; padding: 0.45rem 0.65rem;
      font-size: 0.78rem; margin-top: 0.35rem;
      line-height: 1.5; display: none;
    }
    .lookup-strip.show { display: block; }
    .lookup-strip.found {
      background: color-mix(in srgb, var(--primary-light) 30%, white);
      border: 1px solid color-mix(in srgb, var(--primary-light) 55%, white);
    }
    .lookup-strip.new-client {
      background: #F8FAFC; border: 1px solid #E2E8F0;
    }
    .lookup-strip .l-name { font-weight: 600; }
    .lookup-strip .l-pts { float: right; font-weight: 700; color: var(--primary); }
    .lookup-strip .l-meta { font-size: 0.7rem; color: #64748B; }
    .lookup-strip .l-prog { background: #E2E8F0; height: 3px; border-radius: 2px; margin: 0.25rem 0; overflow: hidden; }
    .lookup-strip .l-prog-fill { height: 100%; background: var(--gradient); border-radius: 2px; }
    .lookup-strip .l-reward {
      background: var(--gradient); color: white;
      padding: 0.3rem 0.5rem; border-radius: 4px; text-align: center;
      margin-top: 0.3rem; cursor: pointer; font-size: 0.72rem; font-weight: 500;
    }

    /* ── Amount row + points counter ── */
    .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.65rem; align-items: end; }
    .pts-badge {
      display: inline-block; background: var(--gradient); color: white;
      padding: 1px 8px; border-radius: 10px; font-size: 0.72rem; font-weight: 700;
      margin-left: 0.4rem; vertical-align: middle;
    }

    /* ── Submit ── */
    .btn-credit {
      width: 100%; padding: 0.6rem; border: none; border-radius: 7px;
      background: var(--gradient); color: white; font-family: inherit;
      font-size: 0.88rem; font-weight: 600; cursor: pointer;
      box-shadow: 0 2px 6px color-mix(in srgb, var(--primary) 18%, transparent);
    }
    .btn-credit:hover:not(:disabled) {
      box-shadow: 0 3px 10px color-mix(in srgb, var(--primary) 28%, transparent);
    }
    .btn-credit:disabled { opacity: 0.55; cursor: not-allowed; }

    /* ═══════════════════════════════════════════════════════
       SUCCESS OVERLAY — covers the form, centered
       ═══════════════════════════════════════════════════════ */

    .success-overlay {
      position: absolute; inset: 0; z-index: 10;
      background: white;
      border-radius: 12px;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 2rem 1.5rem;
    }
    .success-overlay.show { display: flex; }

    .success-pts {
      font-size: 2.5rem; font-weight: 700; color: #059669;
      line-height: 1; letter-spacing: -1px;
    }
    .success-label {
      font-size: 0.75rem; color: #059669; text-transform: uppercase;
      letter-spacing: 0.5px; margin-top: 4px; font-weight: 600;
    }
    .success-info {
      margin-top: 1rem; font-size: 0.85rem; color: #1E293B;
      line-height: 1.7;
      background: #F0FDF4; border: 1px solid #D1FAE5;
      border-radius: 8px; padding: 0.75rem 1.25rem;
      min-width: 240px;
    }
    .success-info strong { color: #047857; }
    .success-info .s-detail { color: #64748B; font-size: 0.78rem; }
    .success-badge {
      display: inline-block; background: color-mix(in srgb, var(--primary-light) 50%, white);
      color: var(--primary-dark); padding: 2px 10px; border-radius: 12px;
      font-size: 0.7rem; font-weight: 600; margin-top: 0.4rem;
    }
    .success-btn {
      margin-top: 1.5rem; padding: 0.55rem 2rem; border: none; border-radius: 7px;
      background: var(--gradient); color: white; font-family: inherit;
      font-size: 0.88rem; font-weight: 600; cursor: pointer;
      box-shadow: 0 2px 6px color-mix(in srgb, var(--primary) 18%, transparent);
    }
    .success-btn:hover {
      box-shadow: 0 3px 10px color-mix(in srgb, var(--primary) 28%, transparent);
    }

    /* ═══════════════════════════════════════════════════════
       QR — Compact
       ═══════════════════════════════════════════════════════ */

    .qr-box {
      text-align: center; padding: 1rem;
      background: #FAFBFC; border: 1.5px solid #E2E8F0;
      border-radius: 7px; margin-bottom: 0.8rem;
    }
    .qr-box .qr-sub { font-size: 0.72rem; color: #64748B; margin-bottom: 0.6rem; display: flex; align-items: center; justify-content: center; gap: 5px; }
    .qr-box .qr-sub svg { width: 14px; height: 14px; }

    .qr-frame {
      position: relative; display: inline-block; padding: 6px;
      background: white; border-radius: 6px; border: 1px solid #E2E8F0;
    }
    .qr-frame img { display: block; border-radius: 2px; }
    .qr-frame::after { display: none; }

    .qr-fullscreen-btn {
      display: inline-flex; align-items: center; gap: 5px;
      margin-top: 0.65rem; padding: 6px 14px;
      background: white; border: 1px solid #E2E8F0; border-radius: 6px;
      font-family: inherit; font-size: 0.72rem; font-weight: 600;
      color: #64748B; cursor: pointer; transition: all 0.2s;
    }
    .qr-fullscreen-btn:hover { border-color: var(--primary); color: var(--primary); }
    .qr-fullscreen-btn svg { width: 13px; height: 13px; }

    /* ── Cashier limit info ── */

    /* ── Duplicate warning ── */
    .dup-warning {
      background: #FFFBEB; border: 1px solid #FDE68A; border-radius: 6px;
      padding: 0.5rem 0.65rem; margin-top: 0.35rem; font-size: 0.72rem;
      color: #92400E; line-height: 1.5; animation: fadeSlide 0.3s ease;
    }
    .dup-warning svg { width: 14px; height: 14px; vertical-align: -2px; margin-right: 4px; flex-shrink: 0; }
    .dup-warning-title { font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
    .dup-match {
      display: flex; justify-content: space-between; align-items: center;
      padding: 4px 6px; background: rgba(245,158,11,0.08); border-radius: 4px;
      margin-top: 3px; cursor: pointer; transition: background 0.15s;
    }
    .dup-match:hover { background: rgba(245,158,11,0.15); }
    .dup-match-info { font-size: 0.7rem; }
    .dup-match-name { font-weight: 600; color: #78350F; }
    .dup-match-id { color: #92400E; }
    .dup-match-use { font-size: 0.62rem; color: #B45309; font-weight: 600; white-space: nowrap; }
    @keyframes fadeSlide { from { opacity: 0; transform: translateY(-4px); } }

    /* ═══════════════════════════════════════════════════════
       RESPONSIVE
       ═══════════════════════════════════════════════════════ */

    @media (max-width: 768px) {
      .credit-wrap { padding: 0.4rem; }
      .pg-title { font-size: 0.92rem; margin: 0.3rem 0 0.5rem; }
      .c-card-body { padding: 0.7rem; }

      /* Seg buttons — bigger tap targets */
      .seg { padding: 3px; gap: 2px; }
      .seg button { min-height: 42px; font-size: 0.78rem; padding: 0.35rem 0.2rem; }
      .seg button svg { width: 15px; height: 15px; }

      /* Inputs — 16px prevents iOS zoom */
      .credit-page .form-control { font-size: 1rem; padding: 0.6rem 0.7rem; }
      .credit-page .form-label { font-size: 0.68rem; }

      /* Amount + Notes stacked */
      .row-2 { grid-template-columns: 1fr; gap: 0.5rem; }

      /* Submit button — big tap target */
      .btn-credit { min-height: 48px; font-size: 0.92rem; border-radius: 10px; }

      /* Lookup strip — readable */
      .lookup-strip { font-size: 0.8rem; padding: 0.5rem 0.7rem; }
      .lookup-strip .l-reward { min-height: 40px; display: flex; align-items: center; justify-content: center; font-size: 0.78rem; }

      /* QR box */
      .qr-box { padding: 0.8rem; }
      .qr-fullscreen-btn { min-height: 36px; padding: 8px 16px; font-size: 0.75rem; }

      /* Scanner */
      #scan-reader { min-height: 220px; }

      /* Autocomplete — bigger rows */
      .ac-item { padding: 0.55rem 0.7rem; min-height: 44px; }

      /* Success overlay */
      .success-overlay { padding: 1.5rem 1rem; }
      .success-pts { font-size: 2rem; }
      .success-info { min-width: auto; }

      /* Dup warning — bigger tap */
      .dup-match { min-height: 40px; padding: 6px 8px; }
    }

    @media (max-width: 380px) {
      .seg button { font-size: 0.72rem; }
      .seg button svg { width: 13px; height: 13px; }
      .credit-page .form-control { font-size: 1rem; padding: 0.55rem 0.6rem; }
    }
  </style>
</head>
<body class="credit-page">
  <nav class="navbar">
    <a href="/dashboard" class="navbar-brand">FIDDO<span></span></a>
    <div class="navbar-menu"></div>
  </nav>

  <div class="credit-wrap">
    <h1 class="pg-title">Créditer des points</h1>

    <div class="c-card">
      <div class="c-card-body">
        <div id="credit-alert"></div>

        <form id="credit-form" autocomplete="off">
          <!-- Segment toggle -->
          <div class="seg">
            <button type="button" id="toggle-email" class="active" onclick="switchMode('email')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
              Email
            </button>
            <button type="button" id="toggle-phone" onclick="switchMode('phone')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12" y2="18"/></svg>
              Tél
            </button>
            <button type="button" id="toggle-qr" onclick="switchMode('qr')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/><line x1="21" y1="14" x2="21" y2="14"/><line x1="21" y1="21" x2="21" y2="21"/></svg>
              QR
            </button>
            <button type="button" id="toggle-scan" onclick="switchMode('scan')">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
              Scan
            </button>
          </div>

          <!-- Email -->
          <div class="form-group" id="field-email">
            <label class="form-label">Adresse email</label>
            <div class="input-wrap">
              <input type="text" inputmode="email" id="client-email" class="form-control" placeholder="client@email.com" autocomplete="off" autocorrect="off" autocapitalize="off" data-lpignore="true" data-1p-ignore data-form-type="other">
              <button type="button" class="btn-clear" onclick="clearField('client-email')">×</button>
              <div class="autocomplete-list" id="ac-email"></div>
            </div>
            <div id="typo-email"></div>
            <div class="lookup-strip" id="lookup-email"></div>
          </div>

          <!-- Phone -->
          <div class="form-group" id="field-phone" style="display:none;">
            <label class="form-label">Numéro de téléphone</label>
            <div class="input-wrap">
              <input type="tel" id="client-phone" class="form-control" placeholder="+32 497 12 34 56" autocomplete="off" autocorrect="off" data-lpignore="true" data-1p-ignore data-form-type="other">
              <button type="button" class="btn-clear" onclick="clearField('client-phone')">×</button>
              <div class="autocomplete-list" id="ac-phone"></div>
            </div>
            <div class="form-hint">+32…, 0032…, 04…</div>
            <div class="lookup-strip" id="lookup-phone"></div>
          </div>

          <!-- QR (static) -->
          <div id="field-qr" style="display:none;">
            <div class="qr-box" id="qr-inline">
              <div class="qr-sub">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="3" height="3"/></svg>
                Présentez ce QR au client
              </div>
              <div class="qr-frame" id="qr-frame"><div id="qr-canvas"></div></div>
              <br>
              <button type="button" class="qr-fullscreen-btn" onclick="showQRFullscreen()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
                Plein écran
              </button>
            </div>

            <!-- Pending identifications -->
            <div id="pending-clients" style="margin-top:0.75rem;"></div>
            <div class="lookup-strip" id="lookup-qr"></div>
          </div>

          <!-- Scanner (camera) -->
          <div id="field-scan" style="display:none;">
            <div style="background:#F8FAFC;border:1px solid #E2E8F0;border-radius:12px;overflow:hidden;">
              <div id="scan-reader" style="width:100%;min-height:250px;"></div>
            </div>
            <div id="scan-status" style="text-align:center;padding:0.75rem;font-size:0.8rem;color:#64748B;">
              Scannez le QR du client
            </div>
            <div class="lookup-strip" id="lookup-scan"></div>
          </div>

          <!-- Duplicate warning -->
          <div id="dup-container"></div>

          <!-- Name -->
          <div class="form-group">
            <label class="form-label">Nom / surnom <span style="font-weight:400;text-transform:none;letter-spacing:0">(opt.)</span></label>
            <div class="input-wrap">
              <input type="text" id="client-name" class="form-control" placeholder="Pierre, Table 5…" autocomplete="off" autocorrect="off" data-lpignore="true" data-1p-ignore data-form-type="other">
              <button type="button" class="btn-clear" onclick="clearField('client-name')">×</button>
            </div>
          </div>

          <!-- Amount + Notes -->
          <div id="pin-group" class="form-group" style="display:none;">
            <label class="form-label"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:12px;height:12px;vertical-align:-1px;margin-right:3px;"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>Code PIN du client (4 chiffres)</label>
            <div class="input-wrap">
              <input type="tel" id="client-pin" class="form-control" placeholder="1234" maxlength="4" pattern="\d{4}" inputmode="numeric" autocomplete="off" autocorrect="off" data-lpignore="true" data-1p-ignore data-form-type="other" style="text-align:center; font-size:1.3rem; letter-spacing:0.5rem; font-weight:700;">
              <button type="button" class="btn-clear" onclick="clearField('client-pin')">×</button>
            </div>
            <div class="form-hint">Ce code sera demandé au client pour utiliser sa récompense</div>
          </div>

          <!-- Amount + Notes -->
          <div class="row-2">
            <div class="form-group">
              <label class="form-label">Montant (€) * <span class="pts-badge" id="pts-badge">0 pts</span></label>
              <div class="input-wrap">
                <input type="number" id="amount" class="form-control" step="0.01" min="0.01" placeholder="25.50" required inputmode="decimal" autocomplete="off" data-lpignore="true" data-1p-ignore data-form-type="other">
                <button type="button" class="btn-clear" onclick="clearField('amount')">×</button>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Notes <span style="font-weight:400;text-transform:none;letter-spacing:0">(opt.)</span></label>
              <div class="input-wrap">
                <input type="text" id="notes" class="form-control" placeholder="Menu midi…" autocomplete="off" autocorrect="off" data-lpignore="true" data-1p-ignore data-form-type="other">
                <button type="button" class="btn-clear" onclick="clearField('notes')">×</button>
              </div>
            </div>
          </div>

          <button type="submit" class="btn-credit" id="submit-btn">Créditer les points</button>
        </form>
      </div>

      <!-- ══════ SUCCESS OVERLAY — covers entire card ══════ -->
      <div class="success-overlay" id="success-overlay">
        <div class="success-pts" id="s-pts"></div>
        <div class="success-label">Crédités ✓</div>
        <div class="success-info" id="s-info"></div>
        <button class="success-btn" onclick="resetForm()">Nouveau crédit</button>
      </div>

    </div>
  </div>

  <!-- Fullscreen QR overlay (for table service) -->
  <div id="qr-fullscreen" style="display:none; position:fixed; inset:0; z-index:9999; background:#fff; flex-direction:column; align-items:center; justify-content:center; cursor:pointer;" onclick="closeQRFullscreen()">
    <div style="text-align:center;">
      <div style="font-size:1.1rem; font-weight:600; color:#1E293B; margin-bottom:0.5rem;" id="qr-fs-merchant"></div>
      <div style="font-size:0.8rem; color:#64748B; margin-bottom:1.5rem;">Scannez pour gagner vos points fidélité</div>
      <div id="qr-fs-canvas" style="display:inline-block; padding:16px; background:#fff; border-radius:12px; box-shadow:0 4px 24px rgba(0,0,0,0.1);"></div>
      <div style="margin-top:1.5rem; font-size:0.7rem; color:#94A3B8;">Appuyez n'importe où pour fermer</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="/js/app.js"></script>
  <script>
    if (!requireAuth()) throw 'Not authenticated';

    const merchant = Auth.getMerchant();
    const staff = Auth.getStaff();
    let currentMode = 'email';
    let lastCreditKey = null; // anti-double-credit
    let lookupIsNew = false;  // true when current client is new (needs PIN)

    // ═══════════════════════════════════════════════════════
    // LOOKUP — inline strip under the active field
    // ═══════════════════════════════════════════════════════

    function getLookupEl() {
      return document.getElementById('lookup-' + currentMode);
    }

    function showLookup(data) {
      const el = getLookupEl();
      if (!el) return;

      if (!data.found) {
        lookupIsNew = true;
        el.className = 'lookup-strip show new-client';
        el.innerHTML = 'Nouveau client — sera créé au crédit.';
        showPinField(true);
        checkNearDuplicates();
        return;
      }
      const c = data.client;
      if (data.isNew) {
        lookupIsNew = true;
        el.className = 'lookup-strip show new-client';
        el.innerHTML = 'Première visite ici.' + (c.name ? ' Nom : ' + c.name : '');
        if (c.name && !document.getElementById('client-name').value) {
          document.getElementById('client-name').value = c.name;
          document.getElementById('client-name').classList.add('has-value');
        }
        showPinField(!c.has_pin); // only if they don't already have a PIN
        return;
      }

      lookupIsNew = false;
      showPinField(false);
      el.className = 'lookup-strip show found';
      const pct = Math.min((c.points_balance / c.reward_threshold) * 100, 100);
      let h = '<span class="l-pts">' + c.points_balance + ' pts</span>' +
        '<span class="l-name">' + (c.name || c.email || c.phone) + '</span>' +
        (c.is_blocked ? ' <span class="badge badge-danger">Bloqué</span>' : '') +
        '<div class="l-meta">' + c.visit_count + ' visite(s) · ' + c.points_balance + '/' + c.reward_threshold + '</div>' +
        '<div class="l-prog"><div class="l-prog-fill" style="width:' + pct + '%"></div></div>';
      if (c.can_redeem) {
        h += '<div class="l-reward" onclick="redeemReward(' + c.id + ')">' +
          (c.reward_description || merchant.reward_description) + ' — Appliquer</div>';
      }
      el.innerHTML = h;

      if (c.name && !document.getElementById('client-name').value) {
        document.getElementById('client-name').value = c.name;
        document.getElementById('client-name').classList.add('has-value');
      }
    }

    function hideLookup() {
      document.querySelectorAll('.lookup-strip').forEach(el => {
        el.classList.remove('show');
        el.innerHTML = '';
      });
      document.getElementById('dup-container').innerHTML = '';
      lookupIsNew = false;
      showPinField(false);
    }

    function showPinField(show) {
      const g = document.getElementById('pin-group');
      if (!g) return;
      g.style.display = show ? 'block' : 'none';
      if (!show) {
        document.getElementById('client-pin').value = '';
      }
    }

    // ═══════════════════════════════════════════════════════
    // PRE-FILL FROM URL
    // ═══════════════════════════════════════════════════════
    (function() {
      const p = new URLSearchParams(window.location.search);
      if (p.get('phone') && !p.get('email')) { switchMode('phone'); document.getElementById('client-phone').value = p.get('phone'); }
      else if (p.get('email')) { document.getElementById('client-email').value = p.get('email'); }
      if (p.get('name')) document.getElementById('client-name').value = p.get('name');
      if (p.get('email') || p.get('phone')) setTimeout(triggerLookup, 500);
      if (p.toString()) window.history.replaceState({}, '', window.location.pathname);
    })();

    // ═══════════════════════════════════════════════════════
    // MODE SWITCH
    // ═══════════════════════════════════════════════════════
    function switchMode(mode) {
      if (currentMode === 'qr' && mode !== 'qr') {
        stopPendingPoll();
      }
      if (currentMode === 'scan' && mode !== 'scan') {
        stopScanner();
      }
      currentMode = mode;
      document.getElementById('toggle-email').classList.toggle('active', mode === 'email');
      document.getElementById('toggle-phone').classList.toggle('active', mode === 'phone');
      document.getElementById('toggle-qr').classList.toggle('active', mode === 'qr');
      document.getElementById('toggle-scan').classList.toggle('active', mode === 'scan');
      document.getElementById('field-email').style.display = mode === 'email' ? '' : 'none';
      document.getElementById('field-phone').style.display = mode === 'phone' ? '' : 'none';
      document.getElementById('field-qr').style.display = mode === 'qr' ? '' : 'none';
      document.getElementById('field-scan').style.display = mode === 'scan' ? '' : 'none';
      if (mode !== 'email') { document.getElementById('client-email').value = ''; document.getElementById('ac-email').classList.remove('show'); document.getElementById('typo-email').innerHTML = ''; }
      if (mode !== 'phone') { document.getElementById('client-phone').value = ''; document.getElementById('ac-phone').classList.remove('show'); }
      hideLookup();
      if (mode === 'qr') startPendingPoll();
      if (mode === 'scan') startScanner();
    }

    // ═══════════════════════════════════════════════════════
    // CLEAR
    // ═══════════════════════════════════════════════════════
    function clearField(id) {
      const el = document.getElementById(id);
      el.value = ''; el.focus(); el.dispatchEvent(new Event('input'));
      if (id === 'amount') document.getElementById('pts-badge').textContent = '0 pts';
    }
    document.querySelectorAll('.input-wrap .form-control').forEach(el => {
      el.addEventListener('input', () => el.classList.toggle('has-value', el.value.length > 0));
    });

    // ═══════════════════════════════════════════════════════
    // POINTS BADGE
    // ═══════════════════════════════════════════════════════
    document.getElementById('amount').addEventListener('input', (e) => {
      const pts = Math.floor((parseFloat(e.target.value) || 0) * merchant.points_per_euro);
      document.getElementById('pts-badge').textContent = pts + ' pts';
    });

    // ═══════════════════════════════════════════════════════
    // EMAIL TYPO
    // ═══════════════════════════════════════════════════════
    const TYPOS = {
      'gmial.com':'gmail.com','gmal.com':'gmail.com','gmaill.com':'gmail.com',
      'gamil.com':'gmail.com','gnail.com':'gmail.com','gmali.com':'gmail.com',
      'gmai.com':'gmail.com','gmail.co':'gmail.com','gmail.be':'gmail.com',
      'hotmal.com':'hotmail.com','hotmai.com':'hotmail.com','hotmaill.com':'hotmail.com',
      'hotmial.com':'hotmail.com','hotamil.com':'hotmail.com',
      'outloo.com':'outlook.com','outlok.com':'outlook.com',
      'yahooo.com':'yahoo.com','yaho.com':'yahoo.com','yahooo.fr':'yahoo.fr',
      'iclould.com':'icloud.com','iclou.com':'icloud.com',
    };
    function checkEmailTypo(v) {
      const c = document.getElementById('typo-email'); c.innerHTML = '';
      if (!v || !v.includes('@')) return;
      const parts = v.split('@'); if (parts.length !== 2) return;
      const fix = TYPOS[parts[1].toLowerCase()];
      if (fix) {
        const corrected = parts[0] + '@' + fix;
        c.innerHTML = '<div class="typo-warning"><span>→ <strong>' + corrected + '</strong> ?</span><button type="button" onclick="applyTypo(\'' + corrected + '\')">Corriger</button></div>';
      }
    }
    function applyTypo(v) {
      document.getElementById('client-email').value = v;
      document.getElementById('typo-email').innerHTML = '';
      triggerLookup();
    }

    // ═══════════════════════════════════════════════════════
    // AUTOCOMPLETE
    // ═══════════════════════════════════════════════════════
    let acTimer;
    function setupAC(inputId, listId) {
      const inp = document.getElementById(inputId), list = document.getElementById(listId);
      inp.addEventListener('input', () => {
        clearTimeout(acTimer);
        const v = inp.value.trim();
        triggerLookup();
        if (v.length < 3) { list.classList.remove('show'); if (inputId === 'client-email') checkEmailTypo(v); return; }
        if (inputId === 'client-email') checkEmailTypo(v);
        acTimer = setTimeout(async () => {
          try {
            const d = await API.clients.searchGlobal(v);
            if (!d.clients || !d.clients.length) { list.classList.remove('show'); return; }
            list.innerHTML = d.clients.slice(0, 6).map(c =>
              '<div class="ac-item" data-email="' + (c.email || '') + '" data-phone="' + (c.phone || '') + '" data-name="' + (c.name || '') + '">' +
              '<span class="ac-pts">' + (c.is_local ? c.points_balance + ' pts' : '<span class="badge badge-info">Nouveau</span>') + '</span>' +
              '<div class="ac-name">' + (c.name || c.email || c.phone || '?') + '</div>' +
              '<div class="ac-meta">' + (c.email || '') + (c.email && c.phone ? ' · ' : '') + (c.phone || '') + (c.is_local ? ' · ' + c.visit_count + 'v' : '') + '</div></div>'
            ).join('');
            list.classList.add('show');
            list.querySelectorAll('.ac-item').forEach(item => {
              item.addEventListener('click', () => {
                const e = item.dataset.email, p = item.dataset.phone, n = item.dataset.name;
                if (currentMode === 'email' && e) { inp.value = e; inp.classList.add('has-value'); }
                else if (currentMode === 'phone' && p) { inp.value = p; inp.classList.add('has-value'); }
                else if (e) { switchMode('email'); document.getElementById('client-email').value = e; }
                else if (p) { switchMode('phone'); document.getElementById('client-phone').value = p; }
                if (n) { document.getElementById('client-name').value = n; document.getElementById('client-name').classList.add('has-value'); }
                list.classList.remove('show');
                document.getElementById('typo-email').innerHTML = '';
                triggerLookup();
              });
            });
          } catch (e) { list.classList.remove('show'); }
        }, 350);
      });
      document.addEventListener('click', (e) => { if (!inp.contains(e.target) && !list.contains(e.target)) list.classList.remove('show'); });
    }
    setupAC('client-email', 'ac-email');
    setupAC('client-phone', 'ac-phone');

    // ═══════════════════════════════════════════════════════
    // LOOKUP
    // ═══════════════════════════════════════════════════════
    let lookupTimer;
    function triggerLookup() {
      clearTimeout(lookupTimer);
      const email = document.getElementById('client-email').value.trim();
      const phone = document.getElementById('client-phone').value.trim();
      if (!email && !phone) { hideLookup(); return; }
      lookupTimer = setTimeout(async () => {
        try {
          const p = {};
          if (email) p.email = email;
          if (phone) p.phone = phone;
          showLookup(await API.clients.lookup(p));
        } catch (e) { console.error(e); }
      }, 300);
    }

    // ═══════════════════════════════════════════════════════
    // REDEEM
    // ═══════════════════════════════════════════════════════
    async function redeemReward(mcId) {
      let pin = null;
      if (!qrVerifiedFlag) {
        pin = prompt('Code PIN du client (4 chiffres) :');
        if (!pin) return; // cancelled
        if (!/^\d{4}$/.test(pin)) {
          UI.showAlert('credit-alert', 'Le code PIN doit contenir 4 chiffres', 'error');
          return;
        }
      }
      try {
        const r = await API.clients.reward({
          merchantClientId: mcId,
          pin: pin || undefined,
          qrVerified: qrVerifiedFlag || undefined,
        });
        UI.showAlert('credit-alert', 'Récompense appliquée — Solde : ' + r.client.points_balance + ' pts', 'success');
        triggerLookup();
      } catch (e) { UI.showAlert('credit-alert', e.message, 'error'); }
    }

    // ═══════════════════════════════════════════════════════
    // SUBMIT — with anti-double-credit
    // ═══════════════════════════════════════════════════════
    document.getElementById('credit-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('client-email').value.trim();
      const phone = document.getElementById('client-phone').value.trim();
      const name = document.getElementById('client-name').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      const notes = document.getElementById('notes').value.trim();

      if (!email && !phone) { UI.showAlert('credit-alert', (currentMode === 'qr' || currentMode === 'scan') ? 'Scannez d\'abord le QR du client' : 'Email ou téléphone requis', 'error'); return; }
      if (!amount || amount <= 0) { UI.showAlert('credit-alert', 'Montant invalide', 'error'); return; }

      // ── Anti-double-credit: generate unique key per submission ──
      const creditKey = (email || '') + '|' + (phone || '') + '|' + amount + '|' + Date.now();
      if (lastCreditKey && lastCreditKey === creditKey) {
        UI.showAlert('credit-alert', 'Ce crédit vient d\'être effectué', 'warning');
        return;
      }

      try {
        document.getElementById('submit-btn').disabled = true;
        document.getElementById('submit-btn').textContent = 'Traitement…';
        UI.clearAlert('credit-alert');

        const idempotencyKey = 'manual-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6);
        const pinVal = document.getElementById('client-pin').value.trim();

        const r = await API.clients.credit({
          email: email || undefined, phone: phone || undefined,
          name: name || undefined, amount, notes: notes || undefined,
          idempotencyKey,
          pin: pinVal || undefined,
        });

        // ── Mark this credit as done (prevent re-submit) ──
        lastCreditKey = creditKey;

        // ── Show success overlay (blocks form access) ──
        const n = r.client.name || r.client.email || r.client.phone || 'Client';
        document.getElementById('s-pts').textContent = '+' + r.transaction.points_delta + ' pts';

        let info = '<strong>' + n + '</strong>';
        info += '<br>Nouveau solde : <strong>' + r.client.points_balance + ' points</strong>';
        if (r.client.email) info += '<br><span class="s-detail">' + r.client.email + '</span>';
        if (r.client.phone) info += '<br><span class="s-detail">' + r.client.phone + '</span>';
        if (r.isNewClient) info += '<br><span class="success-badge">Nouveau client</span>';

        document.getElementById('s-info').innerHTML = info;
        document.getElementById('success-overlay').classList.add('show');

      } catch (err) {
        UI.showAlert('credit-alert', err.message, 'error');
      } finally {
        document.getElementById('submit-btn').disabled = false;
        document.getElementById('submit-btn').textContent = 'Créditer les points';
      }
    });

    // ═══════════════════════════════════════════════════════
    // RESET — only way back from success overlay
    // ═══════════════════════════════════════════════════════
    function resetForm() {
      // Hide overlay
      document.getElementById('success-overlay').classList.remove('show');

      // Full form reset
      lastCreditKey = null;
      qrVerifiedFlag = false;
      document.getElementById('credit-form').reset();
      document.querySelectorAll('.form-control').forEach(el => el.classList.remove('has-value'));
      document.getElementById('pts-badge').textContent = '0 pts';
      hideLookup();
      UI.clearAlert('credit-alert');

      // QR cleanup — poll refresh
      if (currentMode === 'qr') pollPending();
      else {
        stopPendingPoll();
      }

      switchMode('email');
      document.getElementById('client-email').focus();
    }

    // ═══════════════════════════════════════════════════════
    // QR CODE
    // ═══════════════════════════════════════════════════════
    // ═══════════════════════════════════════════════════════
    // QR STATIC — Display + Pending identifications polling
    // ═══════════════════════════════════════════════════════

    let merchantQrUrl = null;
    let merchantQrToken = null;
    let qrInst = null;
    let pendingPoll = null;

    async function loadStaticQR() {
      try {
        const resp = await API.call('/qr/token');
        merchantQrToken = resp.token;
        merchantQrUrl = resp.url;

        const cv = document.getElementById('qr-canvas'); cv.innerHTML = '';
        qrInst = new QRCode(cv, { text: resp.url, width: 120, height: 120, colorDark: '#1F2937', colorLight: '#ffffff', correctLevel: QRCode.CorrectLevel.M });
      } catch (e) {
        console.error('QR load error:', e);
      }
    }

    function showQRFullscreen() {
      if (!merchantQrUrl) return;
      const overlay = document.getElementById('qr-fullscreen');
      const cv = document.getElementById('qr-fs-canvas'); cv.innerHTML = '';
      document.getElementById('qr-fs-merchant').textContent = merchant.business_name;
      new QRCode(cv, { text: merchantQrUrl, width: 260, height: 260, colorDark: '#1F2937', colorLight: '#ffffff', correctLevel: QRCode.CorrectLevel.M });
      overlay.style.display = 'flex';
    }

    function closeQRFullscreen() {
      document.getElementById('qr-fullscreen').style.display = 'none';
    }

    // Pending identifications polling
    function startPendingPoll() {
      stopPendingPoll();
      pollPending(); // immediate first call
      pendingPoll = setInterval(pollPending, 3000);
    }

    function stopPendingPoll() {
      if (pendingPoll) { clearInterval(pendingPoll); pendingPoll = null; }
    }

    async function pollPending() {
      try {
        const resp = await API.call('/qr/pending');
        renderPending(resp.clients);
      } catch (e) {}
    }

    function renderPending(clients) {
      const el = document.getElementById('pending-clients');
      if (!clients || clients.length === 0) {
        el.innerHTML = '<div style="text-align:center;padding:0.5rem;color:#94A3B8;font-size:0.75rem;">En attente de clients…</div>';
        return;
      }

      // Auto-select if only one client
      if (clients.length === 1) {
        consumeIdent(clients[0].identId);
        return;
      }

      let html = '';
      clients.forEach(c => {
        const label = c.name || c.email || c.phone || 'Client';
        const badge = c.isNew
          ? '<span style="font-size:0.65rem;background:#DBEAFE;color:#1E40AF;padding:1px 6px;border-radius:8px;margin-left:4px;">Nouveau</span>'
          : '<span style="font-size:0.65rem;color:#64748B;">' + c.pointsBalance + ' pts · ' + c.visitCount + ' visite(s)</span>';
        const ago = c.secondsAgo < 60 ? 'à l\'instant' : Math.floor(c.secondsAgo / 60) + ' min';
        html += '<div style="display:flex;align-items:center;justify-content:space-between;background:#F0FDF4;border:1px solid #BBF7D0;border-radius:8px;padding:0.5rem 0.75rem;margin-bottom:0.35rem;cursor:pointer;" onclick="consumeIdent(\'' + c.identId + '\')">' +
          '<div><strong style="font-size:0.85rem;color:#166534;">✓ ' + label + '</strong><br>' + badge + '</div>' +
          '<div style="text-align:right;"><span style="font-size:0.65rem;color:#94A3B8;">' + ago + '</span><br>' +
          '<span style="font-size:0.7rem;color:#059669;font-weight:600;">Sélectionner →</span></div></div>';
      });
      el.innerHTML = html;
    }

    async function consumeIdent(identId) {
      try {
        const d = await API.call('/qr/consume/' + identId, { method: 'POST' });

        // Pre-fill the credit form
        if (d.email) {
          switchMode('email');
          document.getElementById('client-email').value = d.email;
          document.getElementById('client-email').classList.add('has-value');
        } else if (d.phone) {
          switchMode('phone');
          document.getElementById('client-phone').value = d.phone;
          document.getElementById('client-phone').classList.add('has-value');
        }
        if (d.name) {
          document.getElementById('client-name').value = d.name;
          document.getElementById('client-name').classList.add('has-value');
        }

        setTimeout(triggerLookup, 300);
        setTimeout(() => document.getElementById('amount').focus(), 600);
      } catch (e) {
        console.error('Consume error:', e);
      }
    }

    // ═══════════════════════════════════════════════════════
    // NEAR-DUPLICATE DETECTION
    // ═══════════════════════════════════════════════════════

    async function checkNearDuplicates() {
      const container = document.getElementById('dup-container');
      container.innerHTML = '';

      const email = document.getElementById('client-email').value.trim();
      const phone = document.getElementById('client-phone').value.trim();
      if (!email && !phone) return;

      try {
        const params = new URLSearchParams();
        if (email) params.set('email', email);
        if (phone) params.set('phone', phone);

        const data = await API.call('/clients/near-duplicates?' + params.toString());
        if (!data.matches || data.matches.length === 0) return;

        let html = '<div class="dup-warning">' +
          '<div class="dup-warning-title">' +
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>' +
            'Client similaire trouvé' +
          '</div>';

        data.matches.forEach(m => {
          const identifier = m.email || m.phone || '';
          const useEmail = m.email || '';
          const usePhone = m.phone || '';
          html += '<div class="dup-match" onclick="useDuplicate(\'' +
            useEmail.replace(/'/g, "\\'") + "', '" +
            usePhone.replace(/'/g, "\\'") + "', '" +
            (m.name || '').replace(/'/g, "\\'") + '\')">' +
            '<div class="dup-match-info">' +
              '<span class="dup-match-name">' + (m.name || 'Sans nom') + '</span> ' +
              '<span class="dup-match-id">' + identifier + '</span>' +
              (m.pointsBalance > 0 ? ' · ' + m.pointsBalance + ' pts' : '') +
            '</div>' +
            '<span class="dup-match-use">Utiliser</span>' +
          '</div>';
        });

        html += '</div>';
        container.innerHTML = html;
      } catch (e) {
        // Silent fail
      }
    }

    function useDuplicate(email, phone, name) {
      document.getElementById('dup-container').innerHTML = '';
      if (email) {
        switchMode('email');
        document.getElementById('client-email').value = email;
        document.getElementById('client-email').classList.add('has-value');
      } else if (phone) {
        switchMode('phone');
        document.getElementById('client-phone').value = phone;
        document.getElementById('client-phone').classList.add('has-value');
      }
      if (name) {
        document.getElementById('client-name').value = name;
        document.getElementById('client-name').classList.add('has-value');
      }
      setTimeout(triggerLookup, 200);
    }

    // ═══════════════════════════════════════════════════════
    // QR SCANNER (camera)
    // ═══════════════════════════════════════════════════════

    let html5QrScanner = null;
    let qrVerifiedFlag = false;  // true if client was identified by QR scan
    let scannerBusy = false;     // debounce scan results

    function startScanner() {
      document.getElementById('scan-status').textContent = 'Démarrage de la caméra…';
      document.getElementById('scan-status').style.color = '#64748B';
      scannerBusy = false;

      // Small delay to let the container become visible and get dimensions
      setTimeout(() => {
        try {
          html5QrScanner = new Html5Qrcode('scan-reader');
          html5QrScanner.start(
            { facingMode: 'environment' },
            {
              fps: 10,
              qrbox: function(vw, vh) {
                const s = Math.min(vw, vh) * 0.7;
                return { width: Math.floor(s), height: Math.floor(s) };
              },
              aspectRatio: 1.0,
            },
            onScanSuccess,
            () => {} // ignore scan failures
          ).then(() => {
            document.getElementById('scan-status').textContent = 'Scannez le QR du client';
            document.getElementById('scan-status').style.color = '#64748B';
          }).catch(err => {
            console.error('Scanner start error:', err);
            document.getElementById('scan-status').innerHTML =
              '⚠ Impossible d\'accéder à la caméra<br><span style="font-size:0.7rem;">Vérifiez les permissions du navigateur</span>';
            document.getElementById('scan-status').style.color = '#DC2626';
          });
        } catch (err) {
          console.error('Scanner init error:', err);
          document.getElementById('scan-status').textContent = '⚠ Erreur d\'initialisation du scanner';
          document.getElementById('scan-status').style.color = '#DC2626';
        }
      }, 300);
    }

    function stopScanner() {
      if (html5QrScanner) {
        try {
          html5QrScanner.stop().then(() => {
            html5QrScanner.clear();
            html5QrScanner = null;
          }).catch(() => {
            html5QrScanner = null;
          });
        } catch (e) {
          html5QrScanner = null;
        }
      }
    }

    async function onScanSuccess(decodedText) {
      if (scannerBusy) return;  // debounce
      scannerBusy = true;

      // Extract client token from URL: fiddo.be/c/TOKEN
      let clientQrToken = null;
      try {
        const url = new URL(decodedText);
        const parts = url.pathname.split('/');
        if (parts[1] === 'c' && parts[2]) {
          clientQrToken = parts[2];
        }
      } catch (e) {
        // Not a URL — maybe just the token itself
        if (/^[A-Za-z0-9_-]{6,20}$/.test(decodedText)) {
          clientQrToken = decodedText;
        }
      }

      if (!clientQrToken) {
        document.getElementById('scan-status').textContent = '⚠ QR non reconnu';
        document.getElementById('scan-status').style.color = '#D97706';
        setTimeout(() => { scannerBusy = false; }, 2000);
        return;
      }

      // Stop scanner immediately
      stopScanner();
      document.getElementById('scan-status').textContent = 'QR lu ! Recherche du client…';
      document.getElementById('scan-status').style.color = '#059669';

      // Lookup client
      try {
        const d = await API.call('/qr/client-lookup/' + clientQrToken);

        // Set QR verified flag (for PIN bypass on redeem)
        qrVerifiedFlag = true;

        // Pre-fill credit form
        if (d.email) {
          switchMode('email');
          document.getElementById('client-email').value = d.email;
          document.getElementById('client-email').classList.add('has-value');
        } else if (d.phone) {
          switchMode('phone');
          document.getElementById('client-phone').value = d.phone;
          document.getElementById('client-phone').classList.add('has-value');
        }
        if (d.name) {
          document.getElementById('client-name').value = d.name;
          document.getElementById('client-name').classList.add('has-value');
        }

        UI.showAlert('credit-alert',
          (d.isNew ? 'Nouveau client : ' : 'Client identifié : ') +
          (d.name || d.email || d.phone) +
          (d.pointsBalance > 0 ? ' — ' + d.pointsBalance + ' pts' : ''),
          'success');

        setTimeout(triggerLookup, 300);
        setTimeout(() => document.getElementById('amount').focus(), 600);
      } catch (e) {
        document.getElementById('scan-status').textContent = '⚠ Client non trouvé';
        document.getElementById('scan-status').style.color = '#DC2626';
        scannerBusy = false;
        setTimeout(() => switchMode('scan'), 2000); // restart scanner
      }
    }

    // Load QR on page init (lazy)
    loadStaticQR();

    window.addEventListener('beforeunload', () => { stopPendingPoll(); stopScanner(); });
  </script>
</body>
</html>
