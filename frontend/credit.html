<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CrÃ©diter â€” FIDDO</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       CREDIT PAGE â€” Refined Terminal Style
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    :root {
      --c-bg: #F8F8F7;
      --c-surface: #FFFFFF;
      --c-ink: #1A1A1A;
      --c-ink-soft: #6B6B6B;
      --c-ink-muted: #A0A0A0;
      --c-accent: #0891B2;
      --c-accent-soft: #E0F7FA;
      --c-accent-dark: #0E7490;
      --c-green: #059669;
      --c-green-soft: #ECFDF5;
      --c-red: #DC2626;
      --c-red-soft: #FEF2F2;
      --c-orange: #D97706;
      --c-orange-soft: #FFFBEB;
      --c-border: #E8E8E6;
      --c-border-focus: #0891B2;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.04);
      --font: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      --mono: 'DM Mono', 'SF Mono', monospace;
      --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body.credit-page {
      background: var(--c-bg);
      font-family: var(--font);
      color: var(--c-ink);
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€ Layout â”€â”€ */
    .credit-shell {
      max-width: 480px;
      margin: 0 auto;
      padding: 1.25rem 1rem 3rem;
    }

    .credit-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.25rem;
    }
    .credit-header h1 {
      font-size: 1.15rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      margin: 0;
    }
    .credit-header .cashier-badge {
      font-size: 0.7rem;
      font-weight: 500;
      color: var(--c-ink-soft);
      background: var(--c-border);
      padding: 3px 10px;
      border-radius: 20px;
      letter-spacing: 0.02em;
    }

    /* â”€â”€ Main card â”€â”€ */
    .credit-card {
      background: var(--c-surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      overflow: hidden;
    }

    /* â”€â”€ Points counter (top strip) â”€â”€ */
    .points-strip {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
      background: var(--c-ink);
      color: white;
      position: relative;
      overflow: hidden;
    }
    .points-strip::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, transparent 40%, rgba(8,145,178,0.15) 100%);
      pointer-events: none;
    }
    .points-strip .pts-value {
      font-family: var(--mono);
      font-size: 2rem;
      font-weight: 500;
      letter-spacing: -0.02em;
      line-height: 1;
      transition: all 0.3s ease;
    }
    .points-strip .pts-label {
      font-size: 0.78rem;
      opacity: 0.55;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      margin-top: 0.15rem;
    }
    .points-strip .pts-col {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* â”€â”€ Mode switcher â”€â”€ */
    .mode-bar {
      display: flex;
      border-bottom: 1px solid var(--c-border);
    }
    .mode-btn {
      flex: 1;
      padding: 0.7rem 0.5rem;
      font-family: var(--font);
      font-size: 0.82rem;
      font-weight: 500;
      color: var(--c-ink-muted);
      background: none;
      border: none;
      cursor: pointer;
      transition: color var(--transition), box-shadow var(--transition);
      position: relative;
      letter-spacing: 0.01em;
    }
    .mode-btn:hover { color: var(--c-ink-soft); }
    .mode-btn.active {
      color: var(--c-accent);
    }
    .mode-btn.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 20%;
      right: 20%;
      height: 2px;
      background: var(--c-accent);
      border-radius: 2px 2px 0 0;
    }

    /* â”€â”€ Form area â”€â”€ */
    .credit-form-area {
      padding: 1.25rem;
    }

    /* â”€â”€ Field â”€â”€ */
    .field {
      margin-bottom: 1rem;
      position: relative;
    }
    .field:last-child { margin-bottom: 0; }

    .field-label {
      display: block;
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--c-ink-muted);
      margin-bottom: 0.35rem;
    }
    .field-optional {
      font-weight: 400;
      text-transform: none;
      letter-spacing: normal;
      color: var(--c-ink-muted);
      opacity: 0.7;
    }

    .field-input {
      width: 100%;
      padding: 0.65rem 0.85rem;
      border: 1.5px solid var(--c-border);
      border-radius: var(--radius-sm);
      font-family: var(--font);
      font-size: 0.95rem;
      color: var(--c-ink);
      background: var(--c-surface);
      transition: border-color var(--transition), box-shadow var(--transition);
      outline: none;
    }
    .field-input::placeholder { color: var(--c-ink-muted); font-weight: 300; }
    .field-input:focus {
      border-color: var(--c-border-focus);
      box-shadow: 0 0 0 3px rgba(8,145,178,0.08);
    }

    /* Amount field â€” larger */
    .field-amount .field-input {
      font-family: var(--mono);
      font-size: 1.35rem;
      font-weight: 500;
      letter-spacing: -0.01em;
      padding: 0.75rem 0.85rem;
      text-align: left;
    }
    .field-amount .euro-suffix {
      position: absolute;
      right: 0.85rem;
      bottom: 0.75rem;
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--c-ink-muted);
      pointer-events: none;
    }

    .field-hint {
      font-size: 0.72rem;
      color: var(--c-ink-muted);
      margin-top: 0.3rem;
    }

    /* â”€â”€ Divider â”€â”€ */
    .form-divider {
      height: 1px;
      background: var(--c-border);
      margin: 1.15rem 0;
    }

    /* â”€â”€ Autocomplete â”€â”€ */
    .ac-dropdown {
      position: absolute;
      top: calc(100% + 2px);
      left: 0; right: 0;
      z-index: 50;
      background: var(--c-surface);
      border: 1.5px solid var(--c-accent);
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      box-shadow: var(--shadow-md);
      display: none;
      max-height: 200px;
      overflow-y: auto;
    }
    .ac-dropdown.show { display: block; }
    .ac-item {
      padding: 0.55rem 0.85rem;
      cursor: pointer;
      border-bottom: 1px solid var(--c-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background var(--transition);
      font-size: 0.85rem;
    }
    .ac-item:last-child { border-bottom: none; }
    .ac-item:hover { background: var(--c-accent-soft); }
    .ac-item-info { min-width: 0; }
    .ac-item-name { font-weight: 600; color: var(--c-ink); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ac-item-meta { font-size: 0.72rem; color: var(--c-ink-muted); margin-top: 1px; }
    .ac-item-pts {
      font-family: var(--mono);
      font-weight: 500;
      font-size: 0.82rem;
      color: var(--c-accent);
      white-space: nowrap;
      margin-left: 0.75rem;
    }

    /* â”€â”€ Typo warning â”€â”€ */
    .typo-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      margin-top: 0.35rem;
      padding: 0.4rem 0.7rem;
      background: var(--c-orange-soft);
      border-radius: var(--radius-sm);
      font-size: 0.78rem;
      color: var(--c-orange);
    }
    .typo-bar button {
      background: var(--c-orange);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 2px 10px;
      font-size: 0.72rem;
      font-weight: 600;
      cursor: pointer;
      font-family: var(--font);
      white-space: nowrap;
    }

    /* â”€â”€ Lookup inline â”€â”€ */
    .lookup-inline {
      margin-top: 0.6rem;
      border-radius: var(--radius-sm);
      overflow: hidden;
      animation: lookup-in 0.25s ease;
    }
    @keyframes lookup-in {
      from { opacity: 0; transform: translateY(-4px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .lookup-new {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.55rem 0.75rem;
      background: var(--c-accent-soft);
      border: 1px solid rgba(8,145,178,0.15);
      border-radius: var(--radius-sm);
      font-size: 0.82rem;
      color: var(--c-accent-dark);
    }
    .lookup-new .tag {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: var(--c-accent);
      color: white;
      padding: 1px 6px;
      border-radius: 3px;
      white-space: nowrap;
    }

    .lookup-found {
      border: 1.5px solid var(--c-green);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }
    .lookup-found-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.6rem 0.75rem;
      background: var(--c-green-soft);
    }
    .lookup-found-name {
      font-weight: 600;
      font-size: 0.88rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .lookup-found-pts {
      font-family: var(--mono);
      font-weight: 500;
      font-size: 1.1rem;
      color: var(--c-accent);
    }
    .lookup-found-body {
      padding: 0.55rem 0.75rem;
    }
    .lookup-progress-row {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-size: 0.75rem;
      color: var(--c-ink-muted);
    }
    .lookup-progress-bar {
      flex: 1;
      height: 5px;
      background: #E5E7EB;
      border-radius: 3px;
      overflow: hidden;
    }
    .lookup-progress-fill {
      height: 100%;
      background: var(--c-accent);
      border-radius: 3px;
      transition: width 0.4s ease;
    }
    .lookup-visits {
      font-size: 0.75rem;
      color: var(--c-ink-muted);
      margin-top: 0.3rem;
    }

    .lookup-blocked {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--c-red);
      background: var(--c-red-soft);
      padding: 1px 7px;
      border-radius: 3px;
    }

    /* â”€â”€ Reward banner â”€â”€ */
    .reward-strip {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      padding: 0.6rem 0.75rem;
      background: var(--c-green);
      cursor: pointer;
      transition: background var(--transition);
    }
    .reward-strip:hover { background: #047857; }
    .reward-strip-text {
      font-size: 0.82rem;
      font-weight: 500;
      color: white;
    }
    .reward-strip-text small {
      display: block;
      font-size: 0.7rem;
      font-weight: 400;
      opacity: 0.8;
      margin-top: 1px;
    }
    .reward-strip-icon {
      font-size: 1.3rem;
      flex-shrink: 0;
    }

    /* â”€â”€ Submit button â”€â”€ */
    .submit-btn {
      width: 100%;
      padding: 0.85rem;
      border: none;
      border-radius: var(--radius-sm);
      font-family: var(--font);
      font-size: 0.95rem;
      font-weight: 600;
      color: white;
      background: var(--c-ink);
      cursor: pointer;
      transition: all var(--transition);
      letter-spacing: 0.01em;
      margin-top: 1.15rem;
    }
    .submit-btn:hover:not(:disabled) {
      background: #000;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .submit-btn:active:not(:disabled) { transform: translateY(0); }
    .submit-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    /* â”€â”€ Alert inline â”€â”€ */
    .credit-alert {
      padding: 0.55rem 0.75rem;
      border-radius: var(--radius-sm);
      font-size: 0.82rem;
      margin-bottom: 1rem;
      display: none;
    }
    .credit-alert.show { display: block; }
    .credit-alert.info { background: var(--c-accent-soft); color: var(--c-accent-dark); }
    .credit-alert.error { background: var(--c-red-soft); color: var(--c-red); }
    .credit-alert.success { background: var(--c-green-soft); color: var(--c-green); }

    /* â”€â”€ Success state (replaces form) â”€â”€ */
    .success-state {
      padding: 2rem 1.5rem;
      text-align: center;
      animation: success-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes success-in {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .success-check {
      width: 52px; height: 52px;
      border-radius: 50%;
      background: var(--c-green);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1rem;
    }
    .success-check svg { width: 26px; height: 26px; stroke: white; stroke-width: 2.5; fill: none; }
    .success-pts {
      font-family: var(--mono);
      font-size: 2.5rem;
      font-weight: 500;
      color: var(--c-green);
      line-height: 1;
    }
    .success-pts-label {
      font-size: 0.82rem;
      color: var(--c-ink-muted);
      margin-top: 0.25rem;
    }
    .success-client {
      margin-top: 1rem;
      font-size: 0.85rem;
      color: var(--c-ink-soft);
      line-height: 1.6;
    }
    .success-client strong { color: var(--c-ink); }
    .success-balance {
      display: inline-block;
      margin-top: 0.75rem;
      font-family: var(--mono);
      font-size: 0.85rem;
      font-weight: 500;
      background: var(--c-accent-soft);
      color: var(--c-accent-dark);
      padding: 0.3rem 0.85rem;
      border-radius: 20px;
    }
    .success-new-badge {
      display: inline-block;
      font-size: 0.68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: var(--c-accent);
      color: white;
      padding: 2px 8px;
      border-radius: 3px;
      margin-top: 0.5rem;
    }

    .success-reward-cta {
      margin-top: 1.25rem;
      padding: 0.75rem;
      background: var(--c-green);
      color: white;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--transition), transform var(--transition);
      animation: reward-glow 2s ease-in-out infinite;
    }
    .success-reward-cta:hover {
      background: #047857;
      transform: scale(1.02);
    }
    @keyframes reward-glow {
      0%,100% { box-shadow: 0 0 0 0 rgba(5,150,105,0.3); }
      50% { box-shadow: 0 0 16px 4px rgba(5,150,105,0.15); }
    }
    .success-reward-cta .cta-title {
      font-weight: 600;
      font-size: 0.9rem;
    }
    .success-reward-cta .cta-sub {
      font-size: 0.75rem;
      opacity: 0.85;
      margin-top: 2px;
    }

    .reset-btn {
      width: 100%;
      margin-top: 1.25rem;
      padding: 0.7rem;
      border: 1.5px solid var(--c-border);
      border-radius: var(--radius-sm);
      font-family: var(--font);
      font-size: 0.88rem;
      font-weight: 500;
      color: var(--c-ink);
      background: var(--c-surface);
      cursor: pointer;
      transition: all var(--transition);
    }
    .reset-btn:hover {
      border-color: var(--c-ink);
      background: var(--c-bg);
    }

    /* â”€â”€ Reward applied state â”€â”€ */
    .reward-state {
      padding: 2rem 1.5rem;
      text-align: center;
      animation: success-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .reward-icon { font-size: 3rem; margin-bottom: 0.5rem; }
    .reward-title { font-size: 1.1rem; font-weight: 600; color: var(--c-green); }
    .reward-desc {
      font-size: 0.88rem;
      color: var(--c-ink-soft);
      margin-top: 0.4rem;
    }

    /* â”€â”€ QR section â”€â”€ */
    .qr-area {
      text-align: center;
      padding: 0.5rem 0 0.25rem;
    }
    .qr-subtitle {
      font-size: 0.78rem;
      color: var(--c-ink-muted);
      margin-bottom: 0.75rem;
    }
    .qr-frame {
      display: inline-block;
      padding: 12px;
      background: white;
      border-radius: var(--radius-sm);
      border: 1px solid var(--c-border);
      position: relative;
      overflow: hidden;
    }
    .qr-frame img { display: block; border-radius: 2px; }
    .qr-frame::after {
      content: '';
      position: absolute;
      left: 12px; right: 12px;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--c-accent), transparent);
      animation: qr-scan 2.5s ease-in-out infinite;
      border-radius: 1px;
    }
    @keyframes qr-scan {
      0% { top: 12px; opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { top: calc(100% - 12px); opacity: 0; }
    }
    .qr-frame.received::after { display: none; }

    .qr-status {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      margin-top: 0.6rem;
      padding: 0.25rem 0.7rem;
      border-radius: 20px;
      font-size: 0.72rem;
      font-weight: 500;
      background: var(--c-orange-soft);
      color: var(--c-orange);
    }
    .qr-status .dot {
      width: 5px; height: 5px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse-dot 1.5s ease-in-out infinite;
    }
    @keyframes pulse-dot { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
    .qr-status.ok { background: var(--c-green-soft); color: var(--c-green); }
    .qr-status.ok .dot { animation: none; }
    .qr-status.expired { background: var(--c-red-soft); color: var(--c-red); }
    .qr-status.expired .dot { animation: none; }

    .qr-timer {
      margin-top: 0.3rem;
      font-family: var(--mono);
      font-size: 0.68rem;
      color: var(--c-ink-muted);
    }
    .qr-timer-track {
      width: 140px;
      height: 2px;
      background: var(--c-border);
      border-radius: 1px;
      margin: 0.3rem auto 0;
      overflow: hidden;
    }
    .qr-timer-track-fill {
      height: 100%;
      background: var(--c-accent);
      border-radius: 1px;
      transition: width 1s linear;
      width: 100%;
    }

    .qr-refresh {
      margin-top: 0.6rem;
      font-family: var(--font);
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--c-ink-muted);
      background: none;
      border: 1px solid var(--c-border);
      padding: 0.25rem 0.65rem;
      border-radius: 4px;
      cursor: pointer;
      transition: all var(--transition);
    }
    .qr-refresh:hover { color: var(--c-ink); border-color: var(--c-ink-muted); }

    .qr-confirmed {
      margin-top: 0.75rem;
      padding: 0.6rem 0.75rem;
      background: var(--c-green-soft);
      border: 1px solid rgba(5,150,105,0.15);
      border-radius: var(--radius-sm);
      text-align: left;
      animation: lookup-in 0.3s ease;
    }
    .qr-confirmed-title {
      font-weight: 600;
      font-size: 0.82rem;
      color: var(--c-green);
      margin-bottom: 0.2rem;
    }
    .qr-confirmed-detail {
      font-size: 0.78rem;
      color: var(--c-ink-soft);
      line-height: 1.5;
    }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 540px) {
      .credit-shell { padding: 0.75rem 0.5rem 2rem; }
      .credit-header h1 { font-size: 1.05rem; }
      .points-strip .pts-value { font-size: 1.7rem; }
      .field-amount .field-input { font-size: 1.15rem; }
    }
  </style>
</head>
<body class="credit-page">
  <nav class="navbar">
    <a href="/dashboard" class="navbar-brand">FIDDO<span></span></a>
    <div class="navbar-menu"></div>
  </nav>

  <div class="credit-shell">
    <div class="credit-header">
      <h1>CrÃ©diter des points</h1>
      <span class="cashier-badge" id="role-badge"></span>
    </div>

    <div class="credit-card" id="credit-card">

      <!-- â•â•â• Points counter â•â•â• -->
      <div class="points-strip" id="points-strip">
        <div class="pts-col">
          <span class="pts-value" id="preview-points">0</span>
          <span class="pts-label">points</span>
        </div>
      </div>

      <!-- â•â•â• Mode switcher â•â•â• -->
      <div class="mode-bar">
        <button type="button" class="mode-btn active" id="toggle-email" onclick="switchMode('email')">Email</button>
        <button type="button" class="mode-btn" id="toggle-phone" onclick="switchMode('phone')">TÃ©lÃ©phone</button>
        <button type="button" class="mode-btn" id="toggle-qr" onclick="switchMode('qr')">QR Code</button>
      </div>

      <!-- â•â•â• Form â•â•â• -->
      <div class="credit-form-area" id="form-area">
        <div class="credit-alert" id="credit-alert"></div>

        <form id="credit-form" autocomplete="off">

          <!-- Email field -->
          <div class="field" id="field-email">
            <label class="field-label">Email du client</label>
            <div style="position:relative;">
              <input type="email" id="client-email" class="field-input" placeholder="client@email.com" autocomplete="off">
              <div class="ac-dropdown" id="ac-email"></div>
            </div>
            <div id="typo-email"></div>
            <div id="lookup-email"></div>
          </div>

          <!-- Phone field -->
          <div class="field" id="field-phone" style="display:none;">
            <label class="field-label">TÃ©lÃ©phone</label>
            <div style="position:relative;">
              <input type="tel" id="client-phone" class="field-input" placeholder="+32 497 12 34 56" autocomplete="off">
              <div class="ac-dropdown" id="ac-phone"></div>
            </div>
            <div class="field-hint">+32â€¦, 0032â€¦, 04â€¦</div>
            <div id="lookup-phone"></div>
          </div>

          <!-- QR field -->
          <div id="field-qr" style="display:none;">
            <div class="qr-area">
              <div class="qr-subtitle">Le client scanne ce QR code</div>
              <div class="qr-frame" id="qr-frame">
                <div id="qr-canvas"></div>
              </div>
              <div>
                <div class="qr-status" id="qr-pill">
                  <span class="dot"></span>
                  <span id="qr-pill-text">En attenteâ€¦</span>
                </div>
              </div>
              <div class="qr-timer" id="qr-timer-text"></div>
              <div class="qr-timer-track" id="qr-timer-bar"><div class="qr-timer-track-fill" id="qr-timer-fill"></div></div>
              <div style="margin-top:0.5rem;">
                <button type="button" class="qr-refresh" onclick="refreshQR()">â†» Nouveau QR</button>
              </div>
              <div id="qr-confirmed-container"></div>
            </div>
            <div id="lookup-qr"></div>
          </div>

          <div class="form-divider"></div>

          <!-- Name -->
          <div class="field">
            <label class="field-label">Nom <span class="field-optional">Â· optionnel</span></label>
            <input type="text" id="client-name" class="field-input" placeholder="Pierre, Table 5â€¦" autocomplete="off">
          </div>

          <!-- Amount -->
          <div class="field field-amount">
            <label class="field-label">Montant dÃ©pensÃ©</label>
            <input type="number" id="amount" class="field-input" step="0.01" min="0.01" placeholder="0.00" required inputmode="decimal">
            <span class="euro-suffix">â‚¬</span>
          </div>

          <!-- Notes -->
          <div class="field">
            <label class="field-label">Notes <span class="field-optional">Â· optionnel</span></label>
            <input type="text" id="notes" class="field-input" placeholder="Menu midi, terrasseâ€¦" autocomplete="off">
          </div>

          <button type="submit" class="submit-btn" id="submit-btn">CrÃ©diter</button>
        </form>
      </div>

      <!-- â•â•â• Success state (hidden, replaces form) â•â•â• -->
      <div id="success-area" style="display:none;"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="/js/app.js"></script>
  <script>
    if (!requireAuth()) throw 'Not authenticated';

    const merchant = Auth.getMerchant();
    const staff = Auth.getStaff();
    let currentMode = 'email';

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    document.getElementById('role-badge').textContent =
      staff.role === 'cashier' ? `${staff.display_name} Â· max 200â‚¬`
      : `${staff.display_name} Â· ${staff.role}`;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PRE-FILL FROM URL PARAMS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    (function prefillFromURL() {
      const params = new URLSearchParams(window.location.search);
      const email = params.get('email');
      const phone = params.get('phone');
      const name = params.get('name');

      if (phone && !email) {
        switchMode('phone');
        document.getElementById('client-phone').value = phone;
      } else if (email) {
        document.getElementById('client-email').value = email;
      }
      if (name) document.getElementById('client-name').value = name;
      if (email || phone) setTimeout(() => triggerLookup(), 500);

      if (params.toString()) window.history.replaceState({}, '', window.location.pathname);
    })();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MODE SWITCHER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function switchMode(mode) {
      if (currentMode === 'qr' && mode !== 'qr') {
        stopQRPolling();
        if (qrToken) {
          fetch(`${API_BASE_URL}/qr/session/${qrToken}`, { method: 'DELETE', credentials: 'include' }).catch(() => {});
          qrToken = null;
        }
      }

      currentMode = mode;
      document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(`toggle-${mode}`).classList.add('active');

      document.getElementById('field-email').style.display = mode === 'email' ? 'block' : 'none';
      document.getElementById('field-phone').style.display = mode === 'phone' ? 'block' : 'none';
      document.getElementById('field-qr').style.display = mode === 'qr' ? 'block' : 'none';

      if (mode !== 'email') {
        document.getElementById('client-email').value = '';
        document.getElementById('ac-email').classList.remove('show');
        document.getElementById('typo-email').innerHTML = '';
        document.getElementById('lookup-email').innerHTML = '';
      }
      if (mode !== 'phone') {
        document.getElementById('client-phone').value = '';
        document.getElementById('ac-phone').classList.remove('show');
        document.getElementById('lookup-phone').innerHTML = '';
      }

      if (mode === 'qr') createQRSession();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // POINTS PREVIEW
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById('amount').addEventListener('input', (e) => {
      const val = parseFloat(e.target.value) || 0;
      const pts = Math.floor(val * merchant.points_per_euro);
      document.getElementById('preview-points').textContent = pts;
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EMAIL TYPO DETECTION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const DOMAIN_TYPOS = {
      'gmial.com':'gmail.com','gmal.com':'gmail.com','gmaill.com':'gmail.com',
      'gamil.com':'gmail.com','gnail.com':'gmail.com','gmali.com':'gmail.com',
      'gmai.com':'gmail.com','gmail.co':'gmail.com','gmail.be':'gmail.com',
      'hotmal.com':'hotmail.com','hotmai.com':'hotmail.com','hotmaill.com':'hotmail.com',
      'hotmial.com':'hotmail.com','hotamil.com':'hotmail.com',
      'outloo.com':'outlook.com','outlok.com':'outlook.com',
      'yahooo.com':'yahoo.com','yaho.com':'yahoo.com','yahooo.fr':'yahoo.fr',
      'iclould.com':'icloud.com','iclou.com':'icloud.com',
    };

    function checkEmailTypo(email) {
      const container = document.getElementById('typo-email');
      container.innerHTML = '';
      if (!email || !email.includes('@')) return;
      const parts = email.split('@');
      if (parts.length !== 2) return;
      const suggestion = DOMAIN_TYPOS[parts[1].toLowerCase()];
      if (suggestion) {
        const corrected = parts[0] + '@' + suggestion;
        container.innerHTML = `<div class="typo-bar"><span>${corrected} ?</span><button type="button" onclick="applyTypoFix('${corrected}')">Corriger</button></div>`;
      }
    }
    function applyTypoFix(corrected) {
      document.getElementById('client-email').value = corrected;
      document.getElementById('typo-email').innerHTML = '';
      triggerLookup();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTOCOMPLETE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let searchTimeout;

    function setupAutocomplete(inputId, acListId) {
      const input = document.getElementById(inputId);
      const acList = document.getElementById(acListId);

      input.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        const val = input.value.trim();
        if (val.length < 3) { acList.classList.remove('show'); triggerLookup(); if (inputId === 'client-email') checkEmailTypo(val); return; }
        if (inputId === 'client-email') checkEmailTypo(val);

        searchTimeout = setTimeout(async () => {
          try {
            const data = await API.clients.search(val);
            if (!data.clients || data.clients.length === 0) { acList.classList.remove('show'); triggerLookup(); return; }

            acList.innerHTML = data.clients.slice(0, 5).map(c => `
              <div class="ac-item" data-email="${c.email||''}" data-phone="${c.phone||''}" data-name="${c.name||''}">
                <div class="ac-item-info">
                  <div class="ac-item-name">${c.name || c.email || c.phone || '?'}</div>
                  <div class="ac-item-meta">${c.email ? c.email : ''}${c.email && c.phone ? ' Â· ' : ''}${c.phone || ''}</div>
                </div>
                <span class="ac-item-pts">${c.points_balance} pts</span>
              </div>
            `).join('');

            acList.classList.add('show');
            acList.querySelectorAll('.ac-item').forEach(item => {
              item.addEventListener('click', () => {
                const {email, phone, name} = item.dataset;
                if (currentMode === 'email' && email) {
                  document.getElementById('client-email').value = email;
                } else if (currentMode === 'phone' && phone) {
                  document.getElementById('client-phone').value = phone;
                } else if (email) { switchMode('email'); document.getElementById('client-email').value = email; }
                else if (phone) { switchMode('phone'); document.getElementById('client-phone').value = phone; }
                if (name) document.getElementById('client-name').value = name;
                acList.classList.remove('show');
                document.getElementById('typo-email').innerHTML = '';
                triggerLookup();
              });
            });
          } catch (err) { acList.classList.remove('show'); triggerLookup(); }
        }, 350);
      });

      document.addEventListener('click', (e) => {
        if (!input.contains(e.target) && !acList.contains(e.target)) acList.classList.remove('show');
      });
    }

    setupAutocomplete('client-email', 'ac-email');
    setupAutocomplete('client-phone', 'ac-phone');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CLIENT LOOKUP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let lookupTimeout;

    function getLookupContainer() {
      return document.getElementById(`lookup-${currentMode}`) || document.getElementById('lookup-email');
    }

    function clearAllLookups() {
      ['lookup-email','lookup-phone','lookup-qr'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = '';
      });
    }

    function triggerLookup() {
      clearTimeout(lookupTimeout);
      const email = document.getElementById('client-email').value.trim();
      const phone = document.getElementById('client-phone').value.trim();

      if (!email && !phone) { clearAllLookups(); return; }

      lookupTimeout = setTimeout(async () => {
        try {
          const params = {};
          if (email) params.email = email;
          if (phone) params.phone = phone;
          const data = await API.clients.lookup(params);
          const container = getLookupContainer();

          if (!data.found) {
            container.innerHTML = `<div class="lookup-inline"><div class="lookup-new"><span class="tag">Nouveau</span> Sera crÃ©Ã© automatiquement</div></div>`;
            return;
          }

          const c = data.client;
          if (data.isNew) {
            container.innerHTML = `<div class="lookup-inline"><div class="lookup-new"><span class="tag">1Ã¨re visite</span> Existe dans le systÃ¨me${c.name ? ' Â· ' + c.name : ''}</div></div>`;
            if (c.name && !document.getElementById('client-name').value) document.getElementById('client-name').value = c.name;
            return;
          }

          const progress = Math.min((c.points_balance / c.reward_threshold) * 100, 100);
          let html = `<div class="lookup-inline"><div class="lookup-found">
            <div class="lookup-found-header">
              <span class="lookup-found-name">${c.name || c.email || c.phone}${c.is_blocked ? ' <span class="lookup-blocked">BloquÃ©</span>' : ''}${c.custom_reward ? ' <span style="color:#d97706;font-size:0.7rem" title="RÃ©compense perso">â­</span>' : ''}</span>
              <span class="lookup-found-pts">${c.points_balance} pts</span>
            </div>
            <div class="lookup-found-body">
              <div class="lookup-progress-row">
                <div class="lookup-progress-bar"><div class="lookup-progress-fill" style="width:${progress}%"></div></div>
                <span>${c.points_balance}/${c.reward_threshold}</span>
              </div>
              <div class="lookup-visits">${c.visit_count} visite(s)${c.custom_reward ? ' Â· ğŸ ' + c.reward_description : ''}</div>
            </div>`;

          if (c.can_redeem) {
            html += `<div class="reward-strip" onclick="redeemReward(${c.id})">
              <div class="reward-strip-text">RÃ©compense disponible !<small>${c.reward_description || merchant.reward_description}</small></div>
              <span class="reward-strip-icon">ğŸ</span>
            </div>`;
          }
          html += `</div></div>`;
          container.innerHTML = html;

          if (c.name && !document.getElementById('client-name').value) document.getElementById('client-name').value = c.name;
        } catch (err) { console.error('Lookup error:', err); }
      }, 400);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ALERTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function showAlert(msg, type = 'info') {
      const el = document.getElementById('credit-alert');
      el.className = `credit-alert show ${type}`;
      el.innerHTML = msg;
    }
    function clearAlert() {
      const el = document.getElementById('credit-alert');
      el.className = 'credit-alert';
      el.innerHTML = '';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REDEEM REWARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async function redeemReward(merchantClientId) {
      const desc = merchant.reward_description;
      if (!confirm(`ğŸ Appliquer la rÃ©compense ?\n\nâ†’ ${desc}\n\nLes points seront dÃ©duits.`)) return;
      try {
        const result = await API.clients.reward({ merchantClientId });
        const bal = result.client.points_balance;

        document.getElementById('form-area').style.display = 'none';
        document.getElementById('points-strip').style.display = 'none';
        document.getElementById('success-area').style.display = 'block';
        document.getElementById('success-area').innerHTML = `
          <div class="reward-state">
            <div class="reward-icon">ğŸ‰</div>
            <div class="reward-title">RÃ©compense appliquÃ©e !</div>
            <div class="reward-desc">${desc}</div>
            <div class="success-balance" style="margin-top:1rem;">${bal} pts restants</div>
            <button class="reset-btn" onclick="resetForm()">Nouveau crÃ©dit</button>
          </div>
        `;
      } catch (err) {
        showAlert(err.message, 'error');
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SUBMIT CREDIT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.getElementById('credit-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('client-email').value.trim();
      const phone = document.getElementById('client-phone').value.trim();
      const name = document.getElementById('client-name').value.trim();
      const amount = parseFloat(document.getElementById('amount').value);
      const notes = document.getElementById('notes').value.trim();

      if (!email && !phone) {
        showAlert(currentMode === 'qr' ? 'Le client n\'a pas encore scannÃ© le QR' : 'Email ou tÃ©lÃ©phone requis', 'error');
        return;
      }
      if (!amount || amount <= 0) { showAlert('Montant invalide', 'error'); return; }

      try {
        document.getElementById('submit-btn').disabled = true;
        showAlert('Traitementâ€¦', 'info');

        const result = await API.clients.credit({
          email: email || undefined,
          phone: phone || undefined,
          name: name || undefined,
          amount,
          notes: notes || undefined,
        });

        clearAlert();

        const canRedeem = result.client.points_balance >= merchant.points_for_reward;
        const afterRedeem = result.client.points_balance - merchant.points_for_reward;
        const clientDisplay = result.client.name || result.client.email || result.client.phone || 'Client';

        // Switch to success state
        document.getElementById('form-area').style.display = 'none';
        document.getElementById('points-strip').style.display = 'none';
        document.getElementById('success-area').style.display = 'block';

        document.getElementById('success-area').innerHTML = `
          <div class="success-state">
            <div class="success-check"><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
            <div class="success-pts">+${result.transaction.points_delta}</div>
            <div class="success-pts-label">points crÃ©ditÃ©s</div>
            <div class="success-client">
              <strong>${clientDisplay}</strong><br>
              ${result.client.email ? result.client.email : ''}${result.client.email && result.client.phone ? ' Â· ' : ''}${result.client.phone ? result.client.phone : ''}
            </div>
            <div class="success-balance">Solde : ${result.client.points_balance} pts</div>
            ${result.isNewClient ? '<div class="success-new-badge">Nouveau client</div>' : ''}
            ${canRedeem ? `
              <div class="success-reward-cta" onclick="redeemReward(${result.client.id})">
                <div class="cta-title">ğŸ RÃ©compense disponible !</div>
                <div class="cta-sub">${merchant.reward_description} Â· ${result.client.points_balance} â†’ ${afterRedeem} pts</div>
              </div>
            ` : ''}
            <button class="reset-btn" onclick="resetForm()">Nouveau crÃ©dit</button>
          </div>
        `;
      } catch (err) {
        showAlert(err.message, 'error');
      } finally {
        document.getElementById('submit-btn').disabled = false;
      }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RESET FORM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function resetForm() {
      document.getElementById('form-area').style.display = 'block';
      document.getElementById('points-strip').style.display = 'flex';
      document.getElementById('success-area').style.display = 'none';
      document.getElementById('preview-points').textContent = '0';
      document.getElementById('credit-form').reset();
      clearAllLookups();
      clearAlert();

      if (currentMode === 'qr') {
        document.getElementById('qr-confirmed-container').innerHTML = '';
        refreshQR();
      } else {
        stopQRPolling();
        if (qrToken) {
          fetch(`${API_BASE_URL}/qr/session/${qrToken}`, { method: 'DELETE', credentials: 'include' }).catch(() => {});
          qrToken = null;
        }
      }
      switchMode('email');
      document.getElementById('client-email').focus();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // QR CODE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let qrToken = null;
    let qrPollInterval = null;
    let qrTimerInterval = null;
    let qrExpiresAt = null;
    let qrInstance = null;
    const QR_TTL_MS = 10 * 60 * 1000;

    async function createQRSession() {
      try {
        document.getElementById('qr-confirmed-container').innerHTML = '';
        document.getElementById('qr-frame').classList.remove('received');
        document.getElementById('qr-frame').style.display = 'inline-block';
        const pill = document.getElementById('qr-pill');
        pill.className = 'qr-status';
        pill.style.display = 'inline-flex';
        document.getElementById('qr-pill-text').textContent = 'En attenteâ€¦';
        document.getElementById('qr-timer-bar').style.display = 'block';

        const resp = await API.call('/qr/session', { method: 'POST' });
        qrToken = resp.token;
        qrExpiresAt = Date.now() + (resp.expiresIn * 1000);

        const canvas = document.getElementById('qr-canvas');
        canvas.innerHTML = '';
        qrInstance = new QRCode(canvas, {
          text: resp.url, width: 160, height: 160,
          colorDark: '#1A1A1A', colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.M,
        });

        startQRPolling();
        startQRTimer();
      } catch (err) {
        console.error('QR session error:', err);
        document.getElementById('qr-pill-text').textContent = 'Erreur';
        document.getElementById('qr-pill').className = 'qr-status expired';
      }
    }

    async function refreshQR() {
      stopQRPolling();
      if (qrToken) {
        fetch(`${API_BASE_URL}/qr/session/${qrToken}`, { method: 'DELETE', credentials: 'include' }).catch(() => {});
      }
      await createQRSession();
    }

    function startQRPolling() {
      stopQRPolling();
      qrPollInterval = setInterval(async () => {
        if (!qrToken) return;
        try {
          const resp = await fetch(`${API_BASE_URL}/qr/poll/${qrToken}`, { credentials: 'include' });
          const data = await resp.json();
          if (resp.status === 410 || resp.status === 404) {
            stopQRPolling();
            document.getElementById('qr-pill').className = 'qr-status expired';
            document.getElementById('qr-pill-text').textContent = 'ExpirÃ©';
            return;
          }
          if (!data.pending) { stopQRPolling(); onQRDataReceived(data); }
        } catch (err) { console.error('QR poll error:', err); }
      }, 1500);
    }

    function stopQRPolling() {
      if (qrPollInterval) { clearInterval(qrPollInterval); qrPollInterval = null; }
      if (qrTimerInterval) { clearInterval(qrTimerInterval); qrTimerInterval = null; }
    }

    function startQRTimer() {
      if (qrTimerInterval) clearInterval(qrTimerInterval);
      const fillEl = document.getElementById('qr-timer-fill');
      const textEl = document.getElementById('qr-timer-text');
      qrTimerInterval = setInterval(() => {
        if (!qrExpiresAt) return;
        const elapsed = Date.now() - (qrExpiresAt - QR_TTL_MS);
        const remaining = Math.max(0, Math.ceil((qrExpiresAt - Date.now()) / 1000));
        const pct = Math.max(0, (1 - elapsed / QR_TTL_MS) * 100);
        fillEl.style.width = pct + '%';
        const min = Math.floor(remaining / 60);
        const sec = remaining % 60;
        textEl.textContent = `${min}:${sec.toString().padStart(2,'0')}`;
        if (remaining <= 0) {
          clearInterval(qrTimerInterval);
          textEl.textContent = 'ExpirÃ©';
          document.getElementById('qr-pill').className = 'qr-status expired';
          document.getElementById('qr-pill-text').textContent = 'ExpirÃ©';
        }
      }, 1000);
    }

    function onQRDataReceived(data) {
      document.getElementById('qr-pill').className = 'qr-status ok';
      document.getElementById('qr-pill-text').textContent = 'ReÃ§u !';
      document.getElementById('qr-frame').style.display = 'none';
      document.getElementById('qr-timer-bar').style.display = 'none';
      document.getElementById('qr-timer-text').textContent = '';

      let details = [];
      if (data.email) details.push('ğŸ“§ ' + data.email);
      if (data.phone) details.push('ğŸ“± ' + data.phone);
      if (data.name) details.push('ğŸ‘¤ ' + data.name);

      document.getElementById('qr-confirmed-container').innerHTML = `
        <div class="qr-confirmed">
          <div class="qr-confirmed-title">âœ“ Client identifiÃ©</div>
          <div class="qr-confirmed-detail">${details.join('<br>')}</div>
        </div>
      `;

      if (data.email) document.getElementById('client-email').value = data.email;
      if (data.phone) document.getElementById('client-phone').value = data.phone;
      if (data.name) document.getElementById('client-name').value = data.name;

      setTimeout(() => triggerLookup(), 300);
      setTimeout(() => document.getElementById('amount').focus(), 600);
    }

    window.addEventListener('beforeunload', () => stopQRPolling());
  </script>
</body>
</html>
